{
  "spec": {
    "title": "Push API",
    "url": "https://www.w3.org/TR/push-api/"
  },
  "algorithms": [
    {
      "name": "create a push subscription",
      "href": "https://www.w3.org/TR/push-api/#dfn-create-a-push-subscription",
      "html": "To <dfn id=\"dfn-create-a-push-subscription\" tabindex=\"0\" aria-haspopup=\"dialog\" data-dfn-type=\"dfn\">create a push subscription</dfn>, given an <a data-link-type=\"idl\" data-lt=\"PushSubscriptionOptionsInit\" href=\"https://www.w3.org/TR/push-api/#dom-pushsubscriptionoptionsinit\" class=\"internalDFN\" id=\"ref-for-dom-pushsubscriptionoptionsinit-1\"><code>PushSubscriptionOptionsInit</code></a>\n          <var data-type=\"PushSubscriptionOptionsInit\">optionsDictionary</var>:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "Let <var data-type=\"PushSubscription\">subscription</var> be a new <a data-link-type=\"idl\" data-lt=\"PushSubscription\" href=\"https://www.w3.org/TR/push-api/#dom-pushsubscription\" class=\"internalDFN\" id=\"ref-for-dom-pushsubscription-3\"><code>PushSubscription</code></a>."
        },
        {
          "html": "Let <var data-type=\"PushSubscriptionOptions\">options</var> be a newly created <a data-link-type=\"idl\" data-lt=\"PushSubscriptionOptions\" href=\"https://www.w3.org/TR/push-api/#dom-pushsubscriptionoptions\" class=\"internalDFN\" id=\"ref-for-dom-pushsubscriptionoptions-1\"><code>PushSubscriptionOptions</code></a>\n          object, initializing its attributes with the corresponding members and values of\n          <var data-type=\"PushSubscriptionOptionsInit\">optionsDictionary</var>."
        },
        {
          "html": "Set <var data-type=\"PushSubscription\">subscription</var>'s <a data-link-type=\"idl\" href=\"https://www.w3.org/TR/push-api/#dom-pushsubscription-options\" class=\"internalDFN\" id=\"ref-for-dom-pushsubscription-options-1\"><code>options</code></a> attribute to <var data-type=\"PushSubscriptionOptions\">options</var>."
        },
        {
          "html": "Generate a new P-256 <a href=\"https://www.w3.org/TR/push-api/#dfn-ecdh\" class=\"internalDFN\" data-link-type=\"dfn\" id=\"ref-for-dfn-ecdh-2\"><abbr title=\"elliptic curve Diffie-Hellman\">ECDH</abbr></a> key pair [<cite><a class=\"bibref\" data-link-type=\"biblio\" href=\"https://www.w3.org/TR/push-api/#bib-ansi-x9-62\" title=\"Public Key Cryptography for the Financial Services Industry, The Elliptic Curve Digital Signature Algorithm (ECDSA)\">ANSI-X9-62</a></cite>]. Store the private key in an\n          internal slot on <var data-type=\"PushSubscription\">subscription</var>; this value <em class=\"rfc2119\">MUST NOT</em> be made available to applications.\n          The public key is also stored in an internal slot and can be retrieved by calling the\n          <a data-link-type=\"idl\" data-lt=\"getKey()\" href=\"https://www.w3.org/TR/push-api/#dom-pushsubscription-getkey\" class=\"internalDFN\" id=\"ref-for-dom-pushsubscription-getkey-1\"><code>getKey</code></a><code>()</code> method of the <a data-link-type=\"idl\" data-lt=\"PushSubscription\" href=\"https://www.w3.org/TR/push-api/#dom-pushsubscription\" class=\"internalDFN\" id=\"ref-for-dom-pushsubscription-4\"><code>PushSubscription</code></a> with an argument of\n          \"<a data-link-type=\"idl\" href=\"https://www.w3.org/TR/push-api/#dom-pushencryptionkeyname-p256dh\" class=\"internalDFN\" id=\"ref-for-dom-pushencryptionkeyname-p256dh-1\"><code>p256dh</code></a>\"."
        },
        {
          "html": "Generate a new authentication secret, which is a sequence of octets as defined in\n          [<cite><a class=\"bibref\" data-link-type=\"biblio\" href=\"https://www.w3.org/TR/push-api/#bib-rfc8291\" title=\"Message Encryption for Web Push\">RFC8291</a></cite>]. Store the authentication secret in an internal slot on <var data-type=\"PushSubscription\">subscription</var>. This\n          key can be retrieved by calling the <a data-link-type=\"idl\" data-lt=\"getKey()\" href=\"https://www.w3.org/TR/push-api/#dom-pushsubscription-getkey\" class=\"internalDFN\" id=\"ref-for-dom-pushsubscription-getkey-2\"><code>getKey</code></a><code>()</code> method of the\n          <a data-link-type=\"idl\" data-lt=\"PushSubscription\" href=\"https://www.w3.org/TR/push-api/#dom-pushsubscription\" class=\"internalDFN\" id=\"ref-for-dom-pushsubscription-5\"><code>PushSubscription</code></a> with an argument of \"<a data-link-type=\"idl\" href=\"https://www.w3.org/TR/push-api/#dom-pushencryptionkeyname-auth\" class=\"internalDFN\" id=\"ref-for-dom-pushencryptionkeyname-auth-1\"><code>auth</code></a>\"."
        },
        {
          "html": "Request a new <a href=\"https://www.w3.org/TR/push-api/#dfn-push-subscription\" class=\"internalDFN\" data-link-type=\"dfn\" id=\"ref-for-dfn-push-subscription-12\">push subscription</a>. Include the\n          <a data-link-type=\"idl\" href=\"https://www.w3.org/TR/push-api/#dom-pushsubscriptionoptions-applicationserverkey\" class=\"internalDFN\" id=\"ref-for-dom-pushsubscriptionoptions-applicationserverkey-1\"><code>applicationServerKey</code></a> attribute of <var data-type=\"PushSubscriptionOptions\">options</var> when it has been\n          set. Rethrow any <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-exception\">exceptions</a>."
        },
        {
          "html": "When the <a href=\"https://www.w3.org/TR/push-api/#dfn-push-subscription\" class=\"internalDFN\" data-link-type=\"dfn\" id=\"ref-for-dfn-push-subscription-13\">push subscription</a> request has completed successfully:",
          "rationale": "set",
          "steps": [
            {
              "html": "Set <var data-type=\"PushSubscription\">subscription</var>'s <a data-link-type=\"idl\" href=\"https://www.w3.org/TR/push-api/#dom-pushsubscription-endpoint\" class=\"internalDFN\" id=\"ref-for-dom-pushsubscription-endpoint-1\"><code>endpoint</code></a> attribute to the <a href=\"https://www.w3.org/TR/push-api/#dfn-push-subscription\" class=\"internalDFN\" data-link-type=\"dfn\" id=\"ref-for-dfn-push-subscription-14\">push\n              subscription</a>'s <a href=\"https://www.w3.org/TR/push-api/#dfn-push-endpoint\" class=\"internalDFN\" data-link-type=\"dfn\" id=\"ref-for-dfn-push-endpoint-2\">push endpoint</a>."
            },
            {
              "html": "If provided by the <a href=\"https://www.w3.org/TR/push-api/#dfn-push-subscription\" class=\"internalDFN\" data-link-type=\"dfn\" id=\"ref-for-dfn-push-subscription-15\">push subscription</a>, set <var data-type=\"PushSubscription\">subscription</var>'s\n              <a data-link-type=\"idl\" href=\"https://www.w3.org/TR/push-api/#dom-pushsubscription-expirationtime\" class=\"internalDFN\" id=\"ref-for-dom-pushsubscription-expirationtime-1\"><code>expirationTime</code></a>."
            }
          ]
        },
        {
          "html": "Return <var data-type=\"PushSubscription\">subscription</var>."
        }
      ]
    },
    {
      "name": "PushManager/subscribe()",
      "href": "https://www.w3.org/TR/push-api/#dom-pushmanager-subscribe",
      "html": "The <dfn data-export=\"\" data-dfn-type=\"method\" id=\"dom-pushmanager-subscribe\" data-idl=\"operation\" data-title=\"subscribe()\" data-dfn-for=\"PushManager\" data-type=\"Promise\" data-lt=\"subscribe()|subscribe(options)\" data-local-lt=\"PushManager.subscribe|PushManager.subscribe()|subscribe\" tabindex=\"0\" aria-haspopup=\"dialog\"><code>subscribe()</code></dfn> method when invoked <em class=\"rfc2119\">MUST</em> run the following steps:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "Let <var>promise</var> be <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-new-promise\">a new promise</a>."
        },
        {
          "html": "Let <var>global</var> be <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\">this</a>' <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global\">relevant global object</a>."
        },
        {
          "html": "Return <var>promise</var> and continue <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\">in parallel</a>."
        },
        {
          "html": "If the <var>options</var> argument has a <a data-link-type=\"idl\" href=\"https://www.w3.org/TR/push-api/#dom-pushsubscriptionoptionsinit-uservisibleonly\" class=\"internalDFN\" id=\"ref-for-dom-pushsubscriptionoptionsinit-uservisibleonly-3\"><code>userVisibleOnly</code></a> value\n        set to <code>false</code> and the user agent requires it to be <code>true</code>, <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task\">queue a global task</a> on the\n        <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#networking-task-source\">networking task source</a> using <var>global</var> to <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\">reject</a> <var>promise</var> \"<a data-link-type=\"idl\" data-type=\"exception\" href=\"https://webidl.spec.whatwg.org/#notallowederror\"><code>NotAllowedError</code></a>\"\n        <a data-link-type=\"idl\" data-lt=\"DOMException\" data-type=\"interface\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\"><code>DOMException</code></a>"
        },
        {
          "html": "If the <var>options</var> argument does not include a non-null value for the\n        <a data-link-type=\"idl\" href=\"https://www.w3.org/TR/push-api/#dom-pushsubscriptionoptionsinit-applicationserverkey\" class=\"internalDFN\" id=\"ref-for-dom-pushsubscriptionoptionsinit-applicationserverkey-2\"><code>applicationServerKey</code></a> member, and the <a href=\"https://www.w3.org/TR/push-api/#dfn-push-service\" class=\"internalDFN\" data-link-type=\"dfn\" id=\"ref-for-dfn-push-service-23\">push service</a>\n        requires one to be given, <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task\">queue a global task</a> on the <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#networking-task-source\">networking task source</a> using\n        <var>global</var> to <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\">reject</a> <var>promise</var> with a \"<a data-link-type=\"idl\" data-type=\"exception\" href=\"https://webidl.spec.whatwg.org/#notsupportederror\"><code>NotSupportedError</code></a>\" <a data-link-type=\"idl\" data-lt=\"DOMException\" data-type=\"interface\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\"><code>DOMException</code></a>."
        },
        {
          "html": "If the <var>options</var> argument includes a non-null value for the\n        <a data-link-type=\"idl\" href=\"https://www.w3.org/TR/push-api/#dom-pushsubscriptionoptions-applicationserverkey\" class=\"internalDFN\" id=\"ref-for-dom-pushsubscriptionoptions-applicationserverkey-2\"><code>applicationServerKey</code></a> attribute, run the following sub-steps:",
          "rationale": "if",
          "steps": [
            {
              "html": "If <var>options</var>'s <a data-link-type=\"idl\" href=\"https://www.w3.org/TR/push-api/#dom-pushsubscriptionoptionsinit-applicationserverkey\" class=\"internalDFN\" id=\"ref-for-dom-pushsubscriptionoptionsinit-applicationserverkey-3\"><code>applicationServerKey</code></a> is a\n            <a data-link-type=\"idl\" data-lt=\"DOMString\" data-type=\"interface\" href=\"https://webidl.spec.whatwg.org/#idl-DOMString\"><code>DOMString</code></a>, set its value to an <a data-link-type=\"idl\" data-lt=\"ArrayBuffer\" data-type=\"interface\" href=\"https://webidl.spec.whatwg.org/#idl-ArrayBuffer\"><code>ArrayBuffer</code></a> containing the sequence of octets\n            that result from decoding <var>options</var>'s\n            <a data-link-type=\"idl\" href=\"https://www.w3.org/TR/push-api/#dom-pushsubscriptionoptionsinit-applicationserverkey\" class=\"internalDFN\" id=\"ref-for-dom-pushsubscriptionoptionsinit-applicationserverkey-4\"><code>applicationServerKey</code></a> using the base64url encoding\n            [<cite><a class=\"bibref\" data-link-type=\"biblio\" href=\"https://www.w3.org/TR/push-api/#bib-rfc7515\" title=\"JSON Web Signature (JWS)\">RFC7515</a></cite>]."
            },
            {
              "html": "If decoding fails, <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task\">queue a global task</a> on the <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#networking-task-source\">networking task source</a> using\n            <var>global</var> to <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\">reject</a> <var>promise</var> with an \"<a data-link-type=\"idl\" data-type=\"exception\" href=\"https://webidl.spec.whatwg.org/#invalidcharactererror\"><code>InvalidCharacterError</code></a>\" <a data-link-type=\"idl\" data-lt=\"DOMException\" data-type=\"interface\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\"><code>DOMException</code></a>\n            and terminate these steps."
            },
            {
              "html": "Ensure that <var>options</var>'s <a data-link-type=\"idl\" href=\"https://www.w3.org/TR/push-api/#dom-pushsubscriptionoptionsinit-applicationserverkey\" class=\"internalDFN\" id=\"ref-for-dom-pushsubscriptionoptionsinit-applicationserverkey-5\"><code>applicationServerKey</code></a>\n            describes a valid point on the P-256 curve. If its value is invalid, <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task\">queue a global task</a> on the <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#networking-task-source\">networking task source</a> using <var>global</var> to <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\">reject</a> <var>promise</var> with an\n            \"<a data-link-type=\"idl\" data-type=\"exception\" href=\"https://webidl.spec.whatwg.org/#invalidaccesserror\"><code>InvalidAccessError</code></a>\" <a data-link-type=\"idl\" data-lt=\"DOMException\" data-type=\"interface\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\"><code>DOMException</code></a> and terminate these steps."
            }
          ]
        },
        {
          "html": "Let <var data-type=\"ServiceWorkerRegistration\">registration</var> be <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\">this</a>'s associated <a data-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-registration\">service worker\n        registration</a>."
        },
        {
          "html": "If <var data-type=\"ServiceWorkerRegistration\">registration</var>'s <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-active-worker\">active worker</a> is null, <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task\">queue a global task</a> on the <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#networking-task-source\">networking task source</a> using <var>global</var> to <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\">reject</a> <var>promise</var> with\n        an \"<a data-link-type=\"idl\" data-type=\"exception\" href=\"https://webidl.spec.whatwg.org/#invalidstateerror\"><code>InvalidStateError</code></a>\" <a data-link-type=\"idl\" data-lt=\"DOMException\" data-type=\"interface\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\"><code>DOMException</code></a> and terminate these steps."
        },
        {
          "html": "Let <var>permission</var> be <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://www.w3.org/TR/permissions/#dfn-request-permission-to-use\">request permission to use</a> \"push\"."
        },
        {
          "html": "If <var>permission</var> is \"<a data-link-type=\"idl\" data-type=\"enum-value\" href=\"https://www.w3.org/TR/permissions/#dom-permissionstate-denied\"><code>denied</code></a>\", <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task\">queue a global task</a> on the <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#user-interaction-task-source\">user interaction task source</a> using <var>global</var> to <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\">reject</a> <var>promise</var> with a\n        \"<a data-link-type=\"idl\" data-type=\"exception\" href=\"https://webidl.spec.whatwg.org/#notallowederror\"><code>NotAllowedError</code></a>\" <a data-link-type=\"idl\" data-lt=\"DOMException\" data-type=\"interface\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\"><code>DOMException</code></a> and terminate these steps."
        },
        {
          "html": "If <var data-type=\"ServiceWorkerRegistration\">registration</var> has a <a href=\"https://www.w3.org/TR/push-api/#dfn-push-subscription\" class=\"internalDFN\" data-link-type=\"dfn\" id=\"ref-for-dfn-push-subscription-49\">push subscription</a>:",
          "rationale": "let",
          "steps": [
            {
              "html": "Let <var>subscription</var> be the result of obtaining <var data-type=\"ServiceWorkerRegistration\">registration</var>'s <a href=\"https://www.w3.org/TR/push-api/#dfn-push-subscription\" class=\"internalDFN\" data-link-type=\"dfn\" id=\"ref-for-dfn-push-subscription-50\">push\n            subscription</a>. If there is an error, <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task\">queue a global task</a> on the <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#networking-task-source\">networking task source</a> using <var>global</var> to <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\">reject</a> <var>promise</var> with an \"<a data-link-type=\"idl\" data-type=\"exception\" href=\"https://webidl.spec.whatwg.org/#aborterror\"><code>AbortError</code></a>\"\n            <a data-link-type=\"idl\" data-lt=\"DOMException\" data-type=\"interface\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\"><code>DOMException</code></a> and terminate these steps."
            },
            {
              "html": "Compare the <var>options</var> argument with the <code>options</code> attribute of <var>subscription</var>. The\n            contents of <a data-link-type=\"idl\" data-lt=\"BufferSource\" data-type=\"typedef\" href=\"https://webidl.spec.whatwg.org/#BufferSource\"><code>BufferSource</code></a> values are compared for equality rather than\n            <a data-link-type=\"dfn|abstract-op\" data-lt=\"reference record\" data-type=\"dfn\" href=\"https://tc39.es/ecma262/multipage/ecmascript-data-types-and-values.html#sec-reference-record-specification-type\">reference</a>."
            },
            {
              "html": "If any attribute on <var>options</var> contains a different value to that stored for\n            <var>subscription</var>, then <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task\">queue a global task</a> on the <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#networking-task-source\">networking task source</a> using\n            <var>global</var> to <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\">reject</a> <var>promise</var> with an \"<a data-link-type=\"idl\" data-type=\"exception\" href=\"https://webidl.spec.whatwg.org/#invalidstateerror\"><code>InvalidStateError</code></a>\" <a data-link-type=\"idl\" data-lt=\"DOMException\" data-type=\"interface\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\"><code>DOMException</code></a> and\n            terminate these steps."
            },
            {
              "html": "When the request has been completed, <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task\">queue a global task</a> on the <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#networking-task-source\">networking task source</a> using <var>global</var> to <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#resolve\">resolve</a> <var>promise</var> with <var>subscription</var> and terminate\n            these steps."
            }
          ]
        },
        {
          "html": "Let <var>subscription</var> be the result of trying to <a data-link-type=\"dfn|abstract-op\" href=\"https://www.w3.org/TR/push-api/#dfn-create-a-push-subscription\" class=\"internalDFN\" id=\"ref-for-dfn-create-a-push-subscription-2\">create a push subscription</a> with\n        <var>options</var>. If creating the subscription <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-throw\">throws</a> an <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-exception\">exception</a>, <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task\">queue a global task</a> on the <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#networking-task-source\">networking task source</a> using <var>global</var> to <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\">reject</a> <var>promise</var> with\n        a that <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-exception\">exception</a> and terminate these these steps."
        },
        {
          "html": "Otherwise, <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task\">queue a global task</a> on the <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#networking-task-source\">networking task source</a> using <var>global</var> to\n        <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#resolve\">resolve</a> <var>promise</var> with a <a data-link-type=\"idl\" data-lt=\"PushSubscription\" href=\"https://www.w3.org/TR/push-api/#dom-pushsubscription\" class=\"internalDFN\" id=\"ref-for-dom-pushsubscription-15\"><code>PushSubscription</code></a> providing the details of the new\n        <var>subscription</var>."
        }
      ]
    },
    {
      "name": "PushManager/getSubscription()",
      "href": "https://www.w3.org/TR/push-api/#dom-pushmanager-getsubscription",
      "html": "The <dfn data-dfn-for=\"PushManager\" data-export=\"\" data-dfn-type=\"method\" id=\"dom-pushmanager-getsubscription\" data-idl=\"operation\" data-title=\"getSubscription\" data-type=\"Promise\" data-lt=\"getSubscription()\" data-local-lt=\"PushManager.getSubscription|PushManager.getSubscription()|getSubscription\" tabindex=\"0\" aria-haspopup=\"dialog\"><code>getSubscription</code></dfn> method when invoked <em class=\"rfc2119\">MUST</em> run the\n        following steps:",
      "rationale": "let",
      "steps": [
        {
          "html": "Let <var>promise</var> be <a data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-new-promise\">a new promise</a>."
        },
        {
          "html": "Return <var>promise</var> and continue the following steps asynchronously."
        },
        {
          "html": "If the <a data-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker\">Service Worker</a> is not subscribed, resolve <var>promise</var> with null."
        },
        {
          "html": "Retrieve the <a href=\"https://www.w3.org/TR/push-api/#dfn-push-subscription\" class=\"internalDFN\" data-link-type=\"dfn\" id=\"ref-for-dfn-push-subscription-51\">push subscription</a> associated with the <a data-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker\">Service Worker</a>."
        },
        {
          "html": "If there is an error, reject <var>promise</var> with a <a data-link-type=\"idl\" data-lt=\"DOMException\" data-type=\"interface\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\"><code>DOMException</code></a> whose name is\n        \"<a data-link-type=\"idl\" data-type=\"exception\" href=\"https://webidl.spec.whatwg.org/#aborterror\"><code>AbortError</code></a>\" and terminate these steps."
        },
        {
          "html": "When the request has been completed, resolve <var>promise</var> with a <a data-link-type=\"idl\" data-lt=\"PushSubscription\" href=\"https://www.w3.org/TR/push-api/#dom-pushsubscription\" class=\"internalDFN\" id=\"ref-for-dom-pushsubscription-16\"><code>PushSubscription</code></a>\n        providing the details of the retrieved <a href=\"https://www.w3.org/TR/push-api/#dfn-push-subscription\" class=\"internalDFN\" data-link-type=\"dfn\" id=\"ref-for-dfn-push-subscription-52\">push subscription</a>."
        }
      ]
    },
    {
      "name": "PushManager/permissionState()",
      "href": "https://www.w3.org/TR/push-api/#dom-pushmanager-permissionstate",
      "html": "The <dfn data-dfn-for=\"PushManager\" data-export=\"\" data-dfn-type=\"method\" id=\"dom-pushmanager-permissionstate\" data-idl=\"operation\" data-title=\"permissionState()\" data-type=\"Promise\" data-lt=\"permissionState()|permissionState(options)\" data-local-lt=\"PushManager.permissionState|PushManager.permissionState()|permissionState\" tabindex=\"0\" aria-haspopup=\"dialog\"><code>permissionState()</code></dfn> method when invoked <em class=\"rfc2119\">MUST</em> run\n        the following steps:",
      "rationale": "let",
      "steps": [
        {
          "html": "Let <var>promise</var> be <a data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-new-promise\">a new promise</a>."
        },
        {
          "html": "Return <var>promise</var> and continue the following steps asynchronously."
        },
        {
          "html": "Let <var>descriptor</var> be a new <a data-link-type=\"idl\" data-lt=\"PermissionDescriptor\" data-type=\"dictionary\" href=\"https://www.w3.org/TR/permissions/#dom-permissiondescriptor\"><code>PermissionDescriptor</code></a> with the\n        <a data-link-type=\"idl\" data-type=\"dict-member\" href=\"https://www.w3.org/TR/permissions/#dom-permissiondescriptor-name\"><code>name</code></a> initialized to \"push\"."
        },
        {
          "html": "let <var>state</var> be the <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://www.w3.org/TR/permissions/#dfn-permission-state\">permission state</a> of <var>descriptor</var> and the result."
        },
        {
          "html": "Resolve <var>promise</var> with <var>state</var>."
        }
      ]
    },
    {
      "name": "PushSubscription/getKey()",
      "href": "https://www.w3.org/TR/push-api/#dom-pushsubscription-getkey",
      "html": "The <dfn data-export=\"\" data-dfn-type=\"method\" id=\"dom-pushsubscription-getkey\" data-idl=\"operation\" data-title=\"getKey()\" data-dfn-for=\"PushSubscription\" data-type=\"ArrayBuffer\" data-lt=\"getKey()|getKey(name)\" data-local-lt=\"PushSubscription.getKey|PushSubscription.getKey()|getKey\" tabindex=\"0\" aria-haspopup=\"dialog\"><code>getKey()</code></dfn> method retrieves keying material that can be used for encrypting\n        and authenticating messages. When <a data-link-type=\"idl\" data-lt=\"getKey()\" href=\"https://www.w3.org/TR/push-api/#dom-pushsubscription-getkey\" class=\"internalDFN\" id=\"ref-for-dom-pushsubscription-getkey-5\"><code>getKey</code></a><code>()</code> is invoked the following\n        process is followed:",
      "rationale": "find",
      "steps": [
        {
          "html": "Find the internal slot corresponding to the key named by the <code>name</code> argument."
        },
        {
          "html": "If a slot was not found, return <code>null</code>."
        },
        {
          "html": "Initialize a variable <var>key</var> with a newly instantiated <a data-link-type=\"idl\" data-lt=\"ArrayBuffer\" data-type=\"interface\" href=\"https://webidl.spec.whatwg.org/#idl-ArrayBuffer\"><code>ArrayBuffer</code></a> instance."
        },
        {
          "html": "If the internal slot contains an asymmetric key pair, set the contents of <var>key</var> to the\n        serialized value of the public key from the key pair. This uses the serialization format\n        described in the specification that defines the name. For example, [<cite><a class=\"bibref\" data-link-type=\"biblio\" href=\"https://www.w3.org/TR/push-api/#bib-rfc8291\" title=\"Message Encryption for Web Push\">RFC8291</a></cite>] specifies\n        that the \"<a data-link-type=\"idl\" href=\"https://www.w3.org/TR/push-api/#dom-pushencryptionkeyname-p256dh\" class=\"internalDFN\" id=\"ref-for-dom-pushencryptionkeyname-p256dh-3\"><code>p256dh</code></a>\" public key is encoded using the uncompressed\n        format defined in [<cite><a class=\"bibref\" data-link-type=\"biblio\" href=\"https://www.w3.org/TR/push-api/#bib-ansi-x9-62\" title=\"Public Key Cryptography for the Financial Services Industry, The Elliptic Curve Digital Signature Algorithm (ECDSA)\">ANSI-X9-62</a></cite>] Annex A (that is, a 65 octet sequence that starts with a\n        0x04 octet)."
        },
        {
          "html": "Otherwise, if the internal slot contains a symmetric key, set the contents of <var>key</var> to\n        a copy of the value from the internal slot. For example, the <code>auth</code> parameter contains an\n        octet sequence used by the <a href=\"https://www.w3.org/TR/push-api/#dfn-user-agent\" class=\"internalDFN\" data-link-type=\"dfn\" id=\"ref-for-dfn-user-agent-46\">user agent</a> to authenticate messages sent by an\n        <a href=\"https://www.w3.org/TR/push-api/#dfn-application-server\" class=\"internalDFN\" data-link-type=\"dfn\" id=\"ref-for-dfn-application-server-24\">application server</a>."
        },
        {
          "html": "Return <var>key</var>."
        }
      ]
    },
    {
      "name": "PushSubscription/unsubscribed",
      "href": "https://www.w3.org/TR/push-api/#dom-pushsubscription-unsubscribe",
      "html": "The <dfn data-lt=\"unsubscribed|unsubscribe()\" data-export=\"\" data-dfn-type=\"method\" id=\"dom-pushsubscription-unsubscribe\" data-idl=\"operation\" data-title=\"unsubscribe()\" data-dfn-for=\"PushSubscription\" data-type=\"Promise\" data-local-lt=\"PushSubscription.unsubscribe|PushSubscription.unsubscribe()|unsubscribe\" tabindex=\"0\" aria-haspopup=\"dialog\"><code>unsubscribe()</code></dfn> method when invoked <em class=\"rfc2119\">MUST</em> run the\n        following steps:",
      "rationale": "let",
      "steps": [
        {
          "html": "Let <var>promise</var> be <a data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-new-promise\">a new promise</a>."
        },
        {
          "html": "Return <var>promise</var> and continue the following steps asynchronously."
        },
        {
          "html": "If the <a href=\"https://www.w3.org/TR/push-api/#dfn-push-subscription\" class=\"internalDFN\" data-link-type=\"dfn\" id=\"ref-for-dfn-push-subscription-64\">push subscription</a> has already been <a href=\"https://www.w3.org/TR/push-api/#dfn-deactivate\" class=\"internalDFN\" data-link-type=\"dfn\" id=\"ref-for-dfn-deactivate-8\">deactivated</a>, resolve <var>promise</var>\n        with <code>false</code> and terminate these steps."
        },
        {
          "html": "Run the following step in parallel:",
          "rationale": "deactivate",
          "steps": [
            {
              "html": "<a href=\"https://www.w3.org/TR/push-api/#dfn-deactivate\" class=\"internalDFN\" data-link-type=\"dfn\" id=\"ref-for-dfn-deactivate-9\">Deactivate</a> the <a href=\"https://www.w3.org/TR/push-api/#dfn-push-subscription\" class=\"internalDFN\" data-link-type=\"dfn\" id=\"ref-for-dfn-push-subscription-65\">push subscription</a>. The <a href=\"https://www.w3.org/TR/push-api/#dfn-user-agent\" class=\"internalDFN\" data-link-type=\"dfn\" id=\"ref-for-dfn-user-agent-47\">user agent</a> <em class=\"rfc2119\">MUST NOT</em>\n              deliver any further <a href=\"https://www.w3.org/TR/push-api/#dfn-push-message\" class=\"internalDFN\" data-link-type=\"dfn\" id=\"ref-for-dfn-push-message-34\">push messages</a> for the <a href=\"https://www.w3.org/TR/push-api/#dfn-push-subscription\" class=\"internalDFN\" data-link-type=\"dfn\" id=\"ref-for-dfn-push-subscription-66\">push subscription</a>.\n              <p>\n                If the <a href=\"https://www.w3.org/TR/push-api/#dfn-user-agent\" class=\"internalDFN\" data-link-type=\"dfn\" id=\"ref-for-dfn-user-agent-48\">user agent</a> failed to request the <a href=\"https://www.w3.org/TR/push-api/#dfn-push-service\" class=\"internalDFN\" data-link-type=\"dfn\" id=\"ref-for-dfn-push-service-27\">push service</a> to\n                <a href=\"https://www.w3.org/TR/push-api/#dfn-deactivate\" class=\"internalDFN\" data-link-type=\"dfn\" id=\"ref-for-dfn-deactivate-10\">deactivate</a> the <a href=\"https://www.w3.org/TR/push-api/#dfn-push-subscription\" class=\"internalDFN\" data-link-type=\"dfn\" id=\"ref-for-dfn-push-subscription-67\">push subscription</a>, for example because of network\n                failures, it <em class=\"rfc2119\">SHOULD</em> retry the request to the <a href=\"https://www.w3.org/TR/push-api/#dfn-push-service\" class=\"internalDFN\" data-link-type=\"dfn\" id=\"ref-for-dfn-push-service-28\">push service</a> for a reasonable\n                amount of time.\n              </p>"
            }
          ]
        },
        {
          "html": "Resolve <var>promise</var> with <code>true</code>."
        }
      ]
    },
    {
      "name": "PushSubscription/toJSON()",
      "href": "https://www.w3.org/TR/push-api/#dom-pushsubscription-tojson",
      "html": "The <dfn data-export=\"\" data-dfn-type=\"method\" id=\"dom-pushsubscription-tojson\" data-idl=\"operation\" data-title=\"toJSON()\" data-dfn-for=\"PushSubscription\" data-type=\"PushSubscriptionJSON\" data-lt=\"toJSON()\" data-local-lt=\"PushSubscription.toJSON|PushSubscription.toJSON()|toJSON\" tabindex=\"0\" aria-haspopup=\"dialog\"><code>toJSON()</code></dfn> method when invoked <em class=\"rfc2119\">MUST</em> run the following steps:",
      "rationale": "let",
      "steps": [
        {
          "html": "Let <var data-type=\"PushSubscriptionJSON\">json</var> be a new <a data-link-type=\"idl\" data-lt=\"PushSubscriptionJSON\" href=\"https://www.w3.org/TR/push-api/#dom-pushsubscriptionjson\" class=\"internalDFN\" id=\"ref-for-dom-pushsubscriptionjson-3\"><code>PushSubscriptionJSON</code></a> dictionary."
        },
        {
          "html": "Set <var data-type=\"PushSubscriptionJSON\">json</var>[\"endpoint\"] to the result of <a data-link-type=\"dfn|abstract-op\" href=\"https://www.w3.org/TR/push-api/#dfn-getting-the-endpoint-attribute\" class=\"internalDFN\" id=\"ref-for-dfn-getting-the-endpoint-attribute-1\">getting the <code>endpoint</code> attribute</a> of\n        <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\">this</a>."
        },
        {
          "html": "Set <var data-type=\"PushSubscriptionJSON\">json</var>[\"expirationTime\"] to the result of <a data-link-type=\"dfn|abstract-op\" href=\"https://www.w3.org/TR/push-api/#dfn-getting-the-expirationtime-attribute\" class=\"internalDFN\" id=\"ref-for-dfn-getting-the-expirationtime-attribute-1\">getting the <code>expirationTime</code> attribute</a> of <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\">this</a>."
        },
        {
          "html": "Let <var>keys</var> be a new empty instance of <code>record&lt;DOMString, USVString&gt;</code> ."
        },
        {
          "html": "For each identifier <var>i</var> corresponding to keys in internal slots on the\n        <a data-link-type=\"idl\" data-lt=\"PushSubscription\" href=\"https://www.w3.org/TR/push-api/#dom-pushsubscription\" class=\"internalDFN\" id=\"ref-for-dom-pushsubscription-19\"><code>PushSubscription</code></a>, ordered by the name of the key:",
          "rationale": "if",
          "steps": [
            {
              "html": "If the internal slot corresponds to an asymmetric key pair, let <var>b</var> be the encoded\n            value of the public key corresponding to the key name <var>i</var>, using the encoding defined\n            for the key name (see <a data-link-type=\"idl\" data-lt=\"getKey()\" href=\"https://www.w3.org/TR/push-api/#dom-pushsubscription-getkey\" class=\"internalDFN\" id=\"ref-for-dom-pushsubscription-getkey-6\"><code>getKey</code></a><code>()</code>)."
            },
            {
              "html": "Otherwise, let <var>b</var> be the value as returned by <a data-link-type=\"idl\" href=\"https://www.w3.org/TR/push-api/#dom-pushsubscription-getkey\" class=\"internalDFN\" id=\"ref-for-dom-pushsubscription-getkey-7\"><code>getKey</code></a>."
            },
            {
              "html": "Let <var>s</var> be the URL-safe base64 encoding without padding [<cite><a class=\"bibref\" data-link-type=\"biblio\" href=\"https://www.w3.org/TR/push-api/#bib-rfc4648\" title=\"The Base16, Base32, and Base64 Data Encodings\">RFC4648</a></cite>] of <var>b</var> as a\n            <a data-link-type=\"idl\" data-lt=\"USVString\" data-type=\"interface\" href=\"https://webidl.spec.whatwg.org/#idl-USVString\"><code>USVString</code></a>. The <a href=\"https://www.w3.org/TR/push-api/#dfn-user-agent\" class=\"internalDFN\" data-link-type=\"dfn\" id=\"ref-for-dfn-user-agent-49\">user agent</a> <em class=\"rfc2119\">MUST</em> use a serialization method that does not\n            branch based on the value of <var>b</var>."
            },
            {
              "html": "Set <var>keys</var>[<var>i</var>] to <var>s</var>."
            }
          ]
        },
        {
          "html": "Set <var data-type=\"PushSubscriptionJSON\">json</var>[\"keys\"] to <var>keys</var>."
        },
        {
          "html": "Return <var data-type=\"PushSubscriptionJSON\">json</var>."
        }
      ]
    },
    {
      "name": "extract a byte sequence",
      "href": "https://www.w3.org/TR/push-api/#dfn-extract-a-byte-sequence",
      "html": "To <dfn id=\"dfn-extract-a-byte-sequence\" tabindex=\"0\" aria-haspopup=\"dialog\" data-dfn-type=\"dfn\">extract a byte sequence</dfn> from <var>object</var>, run these steps:",
      "rationale": "let",
      "steps": [
        {
          "html": "Let <var>bytes</var> be an empty byte sequence."
        },
        {
          "html": "Switch on <var>object</var>'s type:\n          <dl data-cite=\"WebIDL\">\n            <dt>\n              <a data-link-type=\"idl\" data-lt=\"BufferSource\" data-type=\"typedef\" href=\"https://webidl.spec.whatwg.org/#BufferSource\"><code>BufferSource</code></a>\n            </dt>\n            <dd>\n              Set <var>bytes</var> to a copy of <var>object</var>'s contents.\n            </dd>\n            <dt>\n              <a data-link-type=\"idl\" data-lt=\"USVString\" data-type=\"interface\" href=\"https://webidl.spec.whatwg.org/#idl-USVString\"><code>USVString</code></a>\n            </dt>\n            <dd data-cite=\"encoding\">\n              Set <var>bytes</var> to the result of running <a data-type=\"dfn\" href=\"https://encoding.spec.whatwg.org/#utf-8-encode\">utf-8 encode</a> on <var>object</var>.\n            </dd>\n          </dl>"
        },
        {
          "html": "Return <var>bytes</var>."
        }
      ]
    },
    {
      "name": "PushEvent/constructor()",
      "href": "https://www.w3.org/TR/push-api/#dom-pushevent-constructor",
      "html": "When a <dfn data-export=\"\" data-dfn-type=\"constructor\" id=\"dom-pushevent-constructor\" data-idl=\"constructor\" data-title=\"constructor\" data-dfn-for=\"PushEvent\" data-lt=\"constructor()|constructor(type)|constructor(type, eventInitDict)\" data-local-lt=\"PushEvent.constructor|PushEvent.constructor()|constructor\" tabindex=\"0\" aria-haspopup=\"dialog\"><code>constructor</code></dfn> of the <a href=\"https://www.w3.org/TR/push-api/#dom-pushevent\" class=\"internalDFN\" data-link-type=\"idl\" id=\"ref-for-dom-pushevent-2\"><code>PushEvent</code></a> interface, or of an interface that\n          inherits from the <a href=\"https://www.w3.org/TR/push-api/#dom-pushevent\" class=\"internalDFN\" data-link-type=\"idl\" id=\"ref-for-dom-pushevent-3\"><code>PushEvent</code></a> interface, is invoked, the usual <a data-type=\"dfn\" href=\"https://dom.spec.whatwg.org/#concept-event-constructor-ext\">event constructing\n          steps</a> are extended to include the following steps:",
      "rationale": "if",
      "steps": [
        {
          "html": "If <var>eventInitDict</var>'s <code>data</code> member is not present, set the <code>data</code> attribute of the\n          event to <code>null</code> and terminate these steps."
        },
        {
          "html": "Set <var>b</var> to the result of <a data-lt=\"extract a byte sequence\" href=\"https://www.w3.org/TR/push-api/#dfn-extract-a-byte-sequence\" class=\"internalDFN\" data-link-type=\"dfn\" id=\"ref-for-dfn-extract-a-byte-sequence-1\">extracting a byte\n          sequence</a> from the \"<code>data</code>\" member of <var>eventInitDict</var>."
        },
        {
          "html": "Set the <code>data</code> attribute of the event to a new <a href=\"https://www.w3.org/TR/push-api/#dom-pushmessagedata\" class=\"internalDFN\" data-link-type=\"idl\" id=\"ref-for-dom-pushmessagedata-4\"><code>PushMessageData</code></a> instance with\n          <code>bytes</code> set to <var>b</var>."
        }
      ]
    },
    {
      "html": "When the <a href=\"https://www.w3.org/TR/push-api/#dfn-user-agent\" class=\"internalDFN\" data-link-type=\"dfn\" id=\"ref-for-dfn-user-agent-51\">user agent</a> receives a <a href=\"https://www.w3.org/TR/push-api/#dfn-push-message\" class=\"internalDFN\" data-link-type=\"dfn\" id=\"ref-for-dfn-push-message-39\">push message</a> from the <a href=\"https://www.w3.org/TR/push-api/#dfn-push-service\" class=\"internalDFN\" data-link-type=\"dfn\" id=\"ref-for-dfn-push-service-29\">push service</a>,\n          it <em class=\"rfc2119\">MUST</em> run the following steps.",
      "rationale": "let",
      "steps": [
        {
          "html": "Let <var>registration</var> be the <a data-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-registration\">service worker registration</a> corresponding to the <a href=\"https://www.w3.org/TR/push-api/#dfn-push-message\" class=\"internalDFN\" data-link-type=\"dfn\" id=\"ref-for-dfn-push-message-40\">\n            push message</a>."
        },
        {
          "html": "If <var>registration</var> is not found, abort these steps."
        },
        {
          "html": "Let <var>subscription</var> be the active <a href=\"https://www.w3.org/TR/push-api/#dfn-push-subscription\" class=\"internalDFN\" data-link-type=\"dfn\" id=\"ref-for-dfn-push-subscription-69\">push subscription</a> for <var>registration</var>."
        },
        {
          "html": "Let <var>bytes</var> be null."
        },
        {
          "html": "If the <a href=\"https://www.w3.org/TR/push-api/#dfn-push-message\" class=\"internalDFN\" data-link-type=\"dfn\" id=\"ref-for-dfn-push-message-41\">push message</a> contains a payload:",
          "rationale": "decrypt",
          "steps": [
            {
              "html": "Decrypt the <a href=\"https://www.w3.org/TR/push-api/#dfn-push-message\" class=\"internalDFN\" data-link-type=\"dfn\" id=\"ref-for-dfn-push-message-42\">push message</a> payload using the private key from the key pair\n              associated with <var>subscription</var> and the process described in [<cite><a class=\"bibref\" data-link-type=\"biblio\" href=\"https://www.w3.org/TR/push-api/#bib-rfc8291\" title=\"Message Encryption for Web Push\">RFC8291</a></cite>]. Set <var>bytes</var>\n              to the resulting <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#byte-sequence\">byte sequence</a>."
            },
            {
              "html": "If the <a href=\"https://www.w3.org/TR/push-api/#dfn-push-message\" class=\"internalDFN\" data-link-type=\"dfn\" id=\"ref-for-dfn-push-message-43\">push message</a> payload could not be decrypted for any reason:",
              "rationale": "acknowledge",
              "steps": [
                {
                  "html": "Acknowledge the receipt of the <a href=\"https://www.w3.org/TR/push-api/#dfn-push-message\" class=\"internalDFN\" data-link-type=\"dfn\" id=\"ref-for-dfn-push-message-44\">push message</a> according to [<cite><a class=\"bibref\" data-link-type=\"biblio\" href=\"https://www.w3.org/TR/push-api/#bib-rfc8030\" title=\"Generic Event Delivery Using HTTP Push\">RFC8030</a></cite>].\n                  Though the message was not successfully received and processed, this prevents the\n                  push service from attempting to retransmit the message; a badly encrypted message\n                  is not recoverable."
                },
                {
                  "html": "Abort these steps."
                }
              ]
            }
          ]
        },
        {
          "html": "Then run the following steps in parallel, with <var>dispatchedEvent</var>:",
          "rationale": "wait",
          "steps": [
            {
              "html": "Wait for all of the promises in the <a data-link-type=\"dfn|abstract-op\" data-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#extendableevent-extend-lifetime-promises\">extend lifetime promises</a>\n              of <var>dispatchedEvent</var> to resolve."
            },
            {
              "html": "If all the promises resolve successfully, acknowledge the receipt of the <a href=\"https://www.w3.org/TR/push-api/#dfn-push-message\" class=\"internalDFN\" data-link-type=\"dfn\" id=\"ref-for-dfn-push-message-46\">push\n              message</a> according to [<cite><a class=\"bibref\" data-link-type=\"biblio\" href=\"https://www.w3.org/TR/push-api/#bib-rfc8030\" title=\"Generic Event Delivery Using HTTP Push\">RFC8030</a></cite>] and abort these steps."
            },
            {
              "html": "<p>\n                  If the same <a href=\"https://www.w3.org/TR/push-api/#dfn-push-message\" class=\"internalDFN\" data-link-type=\"dfn\" id=\"ref-for-dfn-push-message-47\">push message</a> has been delivered to a <a data-type=\"dfn\" href=\"https://www.w3.org/TR/service-workers/#dfn-service-worker-registration\">service worker\n                  registration</a> multiple times unsuccessfully, acknowledge the receipt of the\n                  <a href=\"https://www.w3.org/TR/push-api/#dfn-push-message\" class=\"internalDFN\" data-link-type=\"dfn\" id=\"ref-for-dfn-push-message-48\">push message</a> according to [<cite><a class=\"bibref\" data-link-type=\"biblio\" href=\"https://www.w3.org/TR/push-api/#bib-rfc8030\" title=\"Generic Event Delivery Using HTTP Push\">RFC8030</a></cite>].\n                </p>\n                <p>\n                  Acknowledging the <a href=\"https://www.w3.org/TR/push-api/#dfn-push-message\" class=\"internalDFN\" data-link-type=\"dfn\" id=\"ref-for-dfn-push-message-49\">push message</a> causes the <a href=\"https://www.w3.org/TR/push-api/#dfn-push-service\" class=\"internalDFN\" data-link-type=\"dfn\" id=\"ref-for-dfn-push-service-30\">push service</a> to stop\n                  delivering the message and to report success to the <a href=\"https://www.w3.org/TR/push-api/#dfn-application-server\" class=\"internalDFN\" data-link-type=\"dfn\" id=\"ref-for-dfn-application-server-25\">application server</a>.\n                  This prevents the same <a href=\"https://www.w3.org/TR/push-api/#dfn-push-message\" class=\"internalDFN\" data-link-type=\"dfn\" id=\"ref-for-dfn-push-message-50\">push message</a> from being retried by the <a href=\"https://www.w3.org/TR/push-api/#dfn-push-service\" class=\"internalDFN\" data-link-type=\"dfn\" id=\"ref-for-dfn-push-service-31\">push\n                  service</a> indefinitely.\n                </p>\n                <p>\n                  Acknowledging also means that an <a href=\"https://www.w3.org/TR/push-api/#dfn-application-server\" class=\"internalDFN\" data-link-type=\"dfn\" id=\"ref-for-dfn-application-server-26\">application server</a> could incorrectly\n                  receive a delivery receipt indicating successful delivery of the <a href=\"https://www.w3.org/TR/push-api/#dfn-push-message\" class=\"internalDFN\" data-link-type=\"dfn\" id=\"ref-for-dfn-push-message-51\">push\n                  message</a>. Therefore, multiple rejections <em class=\"rfc2119\">SHOULD</em> be permitted before\n                  acknowledging; allowing at least three attempts is recommended.\n                </p>"
            }
          ]
        }
      ]
    }
  ]
}