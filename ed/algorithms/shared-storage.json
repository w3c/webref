{
  "spec": {
    "title": "Shared Storage API",
    "url": "https://wicg.github.io/shared-storage/"
  },
  "algorithms": [
    {
      "name": "check if user preference setting allows access to shared storage",
      "href": "https://wicg.github.io/shared-storage/#check-if-user-preference-setting-allows-access-to-shared-storage",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"check-if-user-preference-setting-allows-access-to-shared-storage\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">check if user preference setting allows access to shared storage</dfn> given an <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object\" id=\"ref-for-environment-settings-object\">environment settings object</a> <var>environment</var> and an <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin\" id=\"ref-for-concept-origin\">origin</a> <var>origin</var>, run the following step:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Using values available in <var>environment</var> and <var>origin</var> as needed, perform an <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#implementation-defined\" id=\"ref-for-implementation-defined\">implementation-defined</a> algorithm to return either true or false.</p>"
        }
      ]
    },
    {
      "name": "determine whether shared storage is allowed by context",
      "href": "https://wicg.github.io/shared-storage/#determine-whether-shared-storage-is-allowed-by-context",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"determine-whether-shared-storage-is-allowed-by-context\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">determine whether shared storage is allowed by context</dfn>, given an <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object\" id=\"ref-for-environment-settings-object①\">environment settings object</a> <var>environment</var>, an <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin\" id=\"ref-for-concept-origin①\">origin</a> <var>origin</var>, and a boolean <var>allowedInOpaqueOriginContext</var>, run these steps:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If <var>environment</var> is not a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#secure-context\" id=\"ref-for-secure-context\">secure context</a>, then return false.</p>"
        },
        {
          "html": "<p>If <var>allowedInOpaqueOriginContext</var> is false and <var>environment</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin\" id=\"ref-for-concept-settings-object-origin\">origin</a> is an <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-opaque\" id=\"ref-for-concept-origin-opaque\">opaque origin</a>, then return false.</p>"
        },
        {
          "html": "<p>If <var>origin</var> is an <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-opaque\" id=\"ref-for-concept-origin-opaque①\">opaque origin</a>, then return false.</p>"
        },
        {
          "html": "<p>Let <var>globalObject</var> be the <a data-link-type=\"dfn\" href=\"https://tc39.es/ecma262/#current-realm\" id=\"ref-for-current-realm\">current realm</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-realm-global\" id=\"ref-for-concept-realm-global\">global object</a>.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert\">Assert</a>: <var>globalObject</var> is a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#window\" id=\"ref-for-window\">Window</a></code> or a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope\" id=\"ref-for-sharedstorageworkletglobalscope\">SharedStorageWorkletGlobalScope</a></code>.</p>"
        },
        {
          "html": "<p>If <var>globalObject</var> is a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#window\" id=\"ref-for-window①\">Window</a></code>, and if the result of running <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/permissions-policy/#algo-is-feature-enabled\" id=\"ref-for-algo-is-feature-enabled\">Is feature enabled in document for origin?</a> on \"<a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#permissionspolicy-shared-storage\" id=\"ref-for-permissionspolicy-shared-storage\">shared-storage</a>\", <var>globalObject</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#concept-document-window\" id=\"ref-for-concept-document-window\">associated document</a>, and <var>origin</var> returns false, then return false.</p>"
        },
        {
          "html": "<p>If the result of running <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#obtain-a-site\" id=\"ref-for-obtain-a-site\">obtain a site</a> with <var>origin</var> is not <a data-link-type=\"dfn\" href=\"https://github.com/privacysandbox/attestation#enrolled\" id=\"ref-for-enrolled\">enrolled</a>, then return false.</p>"
        },
        {
          "html": "<p>Return true.</p>"
        }
      ]
    },
    {
      "name": "check if addModule is allowed and update state",
      "href": "https://wicg.github.io/shared-storage/#check-if-addmodule-is-allowed-and-update-state",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"check-if-addmodule-is-allowed-and-update-state\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">check if addModule is allowed and update state</dfn> given a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworklet\" id=\"ref-for-sharedstorageworklet⑦\">SharedStorageWorklet</a></code> <var>worklet</var> and a <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url\" id=\"ref-for-concept-url\">URL</a> <var>moduleURLRecord</var>, run the following steps:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If <var>worklet</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworklet-addmodule-initiated\" id=\"ref-for-sharedstorageworklet-addmodule-initiated①\">addModule initiated</a> is true, return \"DisallowedDueToNonPreferenceError\".</p>"
        },
        {
          "html": "<p>Set <var>worklet</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworklet-addmodule-initiated\" id=\"ref-for-sharedstorageworklet-addmodule-initiated②\">addModule initiated</a> to true.</p>"
        },
        {
          "html": "<p>Let <var>workletDataOrigin</var> be the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#current-settings-object\" id=\"ref-for-current-settings-object\">current settings object</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin\" id=\"ref-for-concept-settings-object-origin③\">origin</a>.</p>"
        },
        {
          "html": "<p>If <var>worklet</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworklet-data-origin\" id=\"ref-for-sharedstorageworklet-data-origin\">data origin</a> is <code>\"script-origin\"</code>, set <var>workletDataOrigin</var> to <var>moduleURLRecord</var>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-origin\" id=\"ref-for-concept-url-origin②\">origin</a>.</p>"
        },
        {
          "html": "Otherwise, if <var>worklet</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworklet-data-origin\" id=\"ref-for-sharedstorageworklet-data-origin①\">data origin</a> is not <code>\"context-origin\"</code>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>customOriginUrl</var> be the result of running a <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-parser\" id=\"ref-for-concept-url-parser\">URL parser</a> on <var>worklet</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworklet-data-origin\" id=\"ref-for-sharedstorageworklet-data-origin②\">data origin</a>.</p>"
            },
            {
              "html": "<p>If <var>customOriginUrl</var> is not a valid <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url\" id=\"ref-for-concept-url①\">URL</a>, return \"DisallowedDueToNonPreferenceError\".</p>"
            },
            {
              "html": "<p>Set <var>workletDataOrigin</var> to <var>customOriginUrl</var>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-origin\" id=\"ref-for-concept-url-origin③\">origin</a>.</p>"
            }
          ]
        },
        {
          "html": "<p>Let <var>hasCrossOriginDataOrigin</var> be false.</p>"
        },
        {
          "html": "<p>If <var>workletDataOrigin</var> and the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#current-settings-object\" id=\"ref-for-current-settings-object①\">current settings object</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin\" id=\"ref-for-concept-settings-object-origin④\">origin</a> are not <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#same-origin\" id=\"ref-for-same-origin\">same origin</a>, then set <var>hasCrossOriginDataOrigin</var> to true.</p>"
        },
        {
          "html": "<p>Let <var>allowedInOpaqueOriginContext</var> be <var>hasCrossOriginDataOrigin</var>.</p>"
        },
        {
          "html": "<p>If the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#determine-whether-shared-storage-is-allowed-by-context\" id=\"ref-for-determine-whether-shared-storage-is-allowed-by-context①\">determine whether shared storage is allowed by context</a> given the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#current-settings-object\" id=\"ref-for-current-settings-object②\">current settings object</a>, <var>workletDataOrigin</var>, and <var>allowedInOpaqueOriginContext</var> is false, return \"DisallowedDueToNonPreferenceError\".</p>"
        },
        {
          "html": "<p>Set <var>worklet</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworklet-has-cross-origin-data-origin\" id=\"ref-for-sharedstorageworklet-has-cross-origin-data-origin③\">has cross-origin data origin</a> to <var>hasCrossOriginDataOrigin</var>.</p>"
        },
        {
          "html": "<p>If the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#check-if-user-preference-setting-allows-access-to-shared-storage\" id=\"ref-for-check-if-user-preference-setting-allows-access-to-shared-storage①\">check if user preference setting allows access to shared storage</a> given the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#current-settings-object\" id=\"ref-for-current-settings-object③\">current settings object</a> and <var>workletDataOrigin</var> is false, return \"DisallowedDueToPreferenceError\".</p>"
        },
        {
          "html": "<p>Return \"Allowed\".</p>"
        }
      ]
    },
    {
      "name": "get the select-url result index",
      "href": "https://wicg.github.io/shared-storage/#get-the-select-url-result-index",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"get-the-select-url-result-index\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">get the select-url result index</dfn>, given <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworklet\" id=\"ref-for-sharedstorageworklet①⓪\">SharedStorageWorklet</a></code> <var>worklet</var>, <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMString\" id=\"ref-for-idl-DOMString②\">DOMString</a></code> <var>operationName</var>, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list\">list</a> of <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#string\" id=\"ref-for-string\">strings</a> <var>urlList</var>, an <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin\" id=\"ref-for-concept-origin②\">origin</a> <var>workletDataOrigin</var>, a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#navigable\" id=\"ref-for-navigable\">navigable</a> <var>navigable</var>, <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#dictdef-sharedstoragerunoperationmethodoptions\" id=\"ref-for-dictdef-sharedstoragerunoperationmethodoptions②\">SharedStorageRunOperationMethodOptions</a></code> <var>options</var>, a <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#pre-specified-report-parameters\" id=\"ref-for-pre-specified-report-parameters\">pre-specified report parameters</a> or null <var>preSpecifiedParams</var> and an <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregation-coordinator\" id=\"ref-for-aggregation-coordinator\">aggregation coordinator</a> or null <var>aggregationCoordinator</var>, run the following steps. This algorithm will return a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#tuple\" id=\"ref-for-tuple\">tuple</a> consisting of a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#idl-promise\" id=\"ref-for-idl-promise②\">promise</a> that resolves into an <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-unsigned-long\" id=\"ref-for-idl-unsigned-long\">unsigned long</a></code> whose value is the index of the URL selected from <var>urlList</var> and a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#boolean\" id=\"ref-for-boolean\">boolean</a> indicating whether the <a href=\"https://wicg.github.io/shared-storage/#charge-top-trav-budgets\">top-level traversable’s budgets</a> should be <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#charge-shared-storage-top-level-traversable-budgets\" id=\"ref-for-charge-shared-storage-top-level-traversable-budgets\">charged</a>.",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>promise</var> be a new <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#idl-promise\" id=\"ref-for-idl-promise③\">promise</a>.</p>"
        },
        {
          "html": "<p>Let <var>window</var> be <var>worklet</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object\">relevant settings object</a>.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert①\">Assert</a>: <var>window</var> is a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#window\" id=\"ref-for-window⑦\">Window</a></code>.</p>"
        },
        {
          "html": "<p>If <var>window</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#window-bc\" id=\"ref-for-window-bc\">browsing context</a> is null, then return the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#tuple\" id=\"ref-for-tuple①\">tuple</a> of a (<a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror\">TypeError</a></code>, true).</p>"
        },
        {
          "html": "<p>If <var>window</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#concept-document-window\" id=\"ref-for-concept-document-window①\">associated document</a> is not <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active\" id=\"ref-for-fully-active\">fully active</a>, return the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#tuple\" id=\"ref-for-tuple②\">tuple</a> of a (<a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with①\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror①\">TypeError</a></code>, true).</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert②\">Assert</a>: <var>worklet</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/worklets.html#concept-worklet-global-scopes\" id=\"ref-for-concept-worklet-global-scopes②\">global scopes</a>'s <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-size\" id=\"ref-for-list-size\">size</a> is 1.</p>"
        },
        {
          "html": "<p>Let <var>globalScope</var> be <var>worklet</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/worklets.html#concept-worklet-global-scopes\" id=\"ref-for-concept-worklet-global-scopes③\">global scopes</a>[0].</p>"
        },
        {
          "html": "<p>Let <var>moduleMapKeyTuples</var> be the result of running <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-getting-the-keys\" id=\"ref-for-map-getting-the-keys\">get the keys</a> on <var>globalScope</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object①\">relevant settings object</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/workers.html#concept-workerglobalscope-module-map\" id=\"ref-for-concept-workerglobalscope-module-map\">module map</a>.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert③\">Assert</a>: <var>moduleMapKeyTuples</var> has <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-size\" id=\"ref-for-map-size\">size</a> 1.</p>"
        },
        {
          "html": "<p>Let <var>moduleURLRecord</var> be <var>moduleMapKeyTuples</var>[0][0].</p>"
        },
        {
          "html": "<p>Let <var>savedQueryName</var> be <var>options</var>[\"<code>savedQuery</code>\"].</p>"
        },
        {
          "html": "If <var>savedQueryName</var> is a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#string\" id=\"ref-for-string①\">string</a> that is not the empty string, then:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>callbackTask</var> be the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#obtain-a-callback-to-process-the-saved-index-result\" id=\"ref-for-obtain-a-callback-to-process-the-saved-index-result\">obtain a callback to process the saved index result</a>, given <var>window</var>, <var>urlList</var>, and <var>promise</var>.</p>"
            },
            {
              "html": "<p>Let <var>savedIndex</var> be the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#get-the-index-for-a-saved-query\" id=\"ref-for-get-the-index-for-a-saved-query\">get the index for a saved query</a> on <var>navigable</var>, <var>workletDataOrigin</var>, <var>moduleURLRecord</var>, <var>operationName</var>, <var>savedQueryName</var>, and <var>callbackTask</var>.</p>"
            },
            {
              "html": "<p>If <var>savedIndex</var> is \"pending callback\", then return the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#tuple\" id=\"ref-for-tuple③\">tuple</a> (<var>promise</var>, false).</p>"
            },
            {
              "html": "If <var>savedIndex</var> is an <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-unsigned-long\" id=\"ref-for-idl-unsigned-long①\">unsigned long</a></code>, then:",
              "rationale": "queue",
              "steps": [
                {
                  "html": "<p><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task\" id=\"ref-for-queue-a-global-task\">Queue a global task</a> on the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source\">DOM manipulation task source</a>, given <var>window</var>, to run the steps of <var>callbackTask</var>, given <var>savedIndex</var>.</p>"
                },
                {
                  "html": "<p>Return the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#tuple\" id=\"ref-for-tuple④\">tuple</a> (<var>promise</var>, false).</p>"
                }
              ]
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert④\">Assert</a> that <var>savedIndex</var> is \"pending current operation\".</p>"
            }
          ]
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task\" id=\"ref-for-queue-a-task\">Queue a task</a> on <var>globalScope</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#worklet-event-loop\" id=\"ref-for-worklet-event-loop\">worklet event loop</a> to perform the following steps:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>operationMap</var> be <var>globalScope</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope-operation-map\" id=\"ref-for-sharedstorageworkletglobalscope-operation-map\">operation map</a>.</p>"
            },
            {
              "html": "<p>If <var>operationMap</var> does not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists\">contain</a> <var>operationName</var>, then <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task\" id=\"ref-for-queue-a-global-task①\">queue a global task</a> on the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source①\">DOM manipulation task source</a>, given <var>window</var>, to <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\" id=\"ref-for-reject\">reject</a> <var>promise</var> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror②\">TypeError</a></code>, and abort these steps.</p>"
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert⑤\">Assert</a>: <var>operationMap</var>[<var>operationName</var>]'s <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-associated-realm\" id=\"ref-for-dfn-associated-realm\">associated realm</a> is <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this\">this</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-realm\" id=\"ref-for-concept-relevant-realm\">relevant realm</a>.</p>"
            },
            {
              "html": "<p>Let <var>operation</var> be <var>operationMap</var>[<var>operationName</var>], <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-convert-ecmascript-to-idl-value\" id=\"ref-for-dfn-convert-ecmascript-to-idl-value\">converted</a> to <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#callbackdef-runfunctionforsharedstorageselecturloperation\" id=\"ref-for-callbackdef-runfunctionforsharedstorageselecturloperation\">RunFunctionForSharedStorageSelectURLOperation</a></code>.</p>"
            },
            {
              "html": "<p>Let <var>privateAggregationCompletionTask</var> be the result of <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#set-up-the-private-aggregation-scopes\" id=\"ref-for-set-up-the-private-aggregation-scopes\">setting up the Private Aggregation scopes</a> given <var>workletDataOrigin</var>, <var>preSpecifiedParams</var> and <var>aggregationCoordinator</var>.</p>"
            },
            {
              "html": "<p>Let <var>argumentsList</var> be the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list①\">list</a> « <var>urlList</var> ».</p>"
            },
            {
              "html": "<p>If <var>options</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#dom-sharedstoragerunoperationmethodoptions-data\" id=\"ref-for-dom-sharedstoragerunoperationmethodoptions-data\">data</a></code>\"] <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists①\">exists</a>, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-append\" id=\"ref-for-list-append\">append</a> it to <var>argumentsList</var>.</p>"
            },
            {
              "html": "<p>Let <var>indexPromise</var> be the result of <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#invoke-a-callback-function\" id=\"ref-for-invoke-a-callback-function\">invoking</a> <var>operation</var> with <var>argumentsList</var>.</p>"
            },
            {
              "html": "<a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-perform-steps-once-promise-is-settled\" id=\"ref-for-dfn-perform-steps-once-promise-is-settled\">React</a> to <var>indexPromise</var>:",
              "rationale": ".switch",
              "steps": [
                {
                  "operation": "switch",
                  "steps": [
                    {
                      "case": "If it was fulfilled with value index:",
                      "html": "",
                      "rationale": "if",
                      "steps": [
                        {
                          "html": "If <var>index</var> is greater than <var>urlList</var>’s <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-size\" id=\"ref-for-list-size①\">size</a>, then:",
                          "rationale": "if",
                          "steps": [
                            {
                              "html": "<p>If <var>savedQueryName</var> is a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#string\" id=\"ref-for-string②\">string</a> that is not the empty string, then run <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#store-the-index-for-a-saved-query\" id=\"ref-for-store-the-index-for-a-saved-query\">store the index for a saved query</a> with <var>window</var>, <var>navigable</var>, <var>workletDataOrigin</var>, <var>moduleURLRecord</var>, <var>operationName</var>, <var>savedQueryName</var>, and the <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#default-selecturl-index\" id=\"ref-for-default-selecturl-index\">default selectURL index</a>.</p>"
                            },
                            {
                              "html": "<p><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task\" id=\"ref-for-queue-a-global-task②\">Queue a global task</a> on the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source②\">DOM manipulation task source</a>, given <var>window</var>, to <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\" id=\"ref-for-reject①\">reject</a> <var>promise</var> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror③\">TypeError</a></code>, and abort these steps.</p>"
                            }
                          ],
                          "additional": [
                            {
                              "html": "Otherwise:",
                              "rationale": "if",
                              "steps": [
                                {
                                  "html": "<p>If <var>savedQueryName</var> is a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#string\" id=\"ref-for-string③\">string</a> that is not the empty string, then run <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#store-the-index-for-a-saved-query\" id=\"ref-for-store-the-index-for-a-saved-query①\">store the index for a saved query</a> with <var>window</var>, <var>navigable</var>, <var>workletDataOrigin</var>, <var>moduleURLRecord</var>, <var>operationName</var>, <var>savedQueryName</var>, and <var>index</var>.</p>"
                                },
                                {
                                  "html": "<p><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task\" id=\"ref-for-queue-a-global-task③\">Queue a global task</a> on the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source③\">DOM manipulation task source</a>, given <var>window</var>, to <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#resolve\" id=\"ref-for-resolve\">resolve</a> <var>promise</var> with <var>index</var>.</p>"
                                },
                                {
                                  "html": "<p>Run <var>privateAggregationCompletionTask</var>.</p>"
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "case": "If it was rejected:",
                      "html": "",
                      "rationale": "if",
                      "steps": [
                        {
                          "html": "<p>If <var>savedQueryName</var> is a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#string\" id=\"ref-for-string④\">string</a> that is not the empty string, then run <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#store-the-index-for-a-saved-query\" id=\"ref-for-store-the-index-for-a-saved-query②\">store the index for a saved query</a> with <var>window</var>, <var>navigable</var>, <var>workletDataOrigin</var>, <var>moduleURLRecord</var>, <var>operationName</var>, <var>savedQueryName</var>, and the <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#default-selecturl-index\" id=\"ref-for-default-selecturl-index①\">default selectURL index</a>.</p>"
                        },
                        {
                          "html": "<p><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task\" id=\"ref-for-queue-a-global-task④\">Queue a global task</a> on the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source④\">DOM manipulation task source</a>, given <var>window</var>, to <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\" id=\"ref-for-reject②\">reject</a> <var>promise</var> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror④\">TypeError</a></code>.</p>"
                        },
                        {
                          "html": "<p>Run <var>privateAggregationCompletionTask</var>.</p>"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "html": "<p>Return the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#tuple\" id=\"ref-for-tuple⑤\">tuple</a> (<var>promise</var>, true).</p>"
        }
      ]
    },
    {
      "name": "handle the result of selecting an index",
      "href": "https://wicg.github.io/shared-storage/#handle-the-result-of-selecting-an-index",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"handle-the-result-of-selecting-an-index\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">handle the result of selecting an index</dfn>, given a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworklet\" id=\"ref-for-sharedstorageworklet①①\">SharedStorageWorklet</a></code> <var>worklet</var>, an <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object\" id=\"ref-for-environment-settings-object⑤\">environment settings object</a> <var>environment</var>, a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://dom.spec.whatwg.org/#document\" id=\"ref-for-document\">Document</a></code> <var>document</var>, a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/media-source/#dom-appendmode-sequence\" id=\"ref-for-dom-appendmode-sequence\">sequence</a></code> of <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#dictdef-sharedstorageurlwithmetadata\" id=\"ref-for-dictdef-sharedstorageurlwithmetadata①\">SharedStorageUrlWithMetadata</a></code> <var>urls</var>, a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list②\">list</a> of <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#string\" id=\"ref-for-string⑤\">strings</a> <var>urlList</var>, a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#navigable\" id=\"ref-for-navigable①\">navigable</a> <var>navigable</var>, a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#dictdef-sharedstoragerunoperationmethodoptions\" id=\"ref-for-dictdef-sharedstoragerunoperationmethodoptions③\">SharedStorageRunOperationMethodOptions</a></code> <var>options</var>, a <a data-link-type=\"dfn\" href=\"https://wicg.github.io/fenced-frame/#traversable-navigable-fenced-frame-config-mapping\" id=\"ref-for-traversable-navigable-fenced-frame-config-mapping\">fenced frame config mapping</a> <var>fencedFrameConfigMapping</var>, a <a data-link-type=\"dfn\" href=\"https://www.ietf.org/rfc/rfc4122.txt#urn-uuid\" id=\"ref-for-urn-uuid\">urn uuid</a> <var>urn</var>, a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#boolean\" id=\"ref-for-boolean①\">boolean</a> <var>shouldChargeTopLevelBudgets</var>, a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#boolean\" id=\"ref-for-boolean②\">boolean</a> <var>shouldUseDefaultIndex</var>, and an <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-unsigned-long\" id=\"ref-for-idl-unsigned-long②\">unsigned long</a></code> <var>resultIndex</var>, perform the following steps:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>site</var> be the result of running <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#obtain-a-site\" id=\"ref-for-obtain-a-site①\">obtain a site</a> with <var>document</var>’s <a data-link-type=\"dfn\" href=\"https://dom.spec.whatwg.org/#concept-document-origin\" id=\"ref-for-concept-document-origin\">origin</a>.</p>"
        },
        {
          "html": "<p>Let <var>remainingBudget</var> be the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#determine-remaining-navigation-budget\" id=\"ref-for-determine-remaining-navigation-budget\">determine remaining navigation budget</a> with <var>environment</var> and <var>site</var>.</p>"
        },
        {
          "html": "<p>Let <var>pendingBits</var> be the logarithm base 2 of <var>urlList</var>’s <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-size\" id=\"ref-for-list-size②\">size</a>.</p>"
        },
        {
          "html": "If <var>shouldChargeTopLevelBudgets</var> is true:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>pageBudgetResult</var> be the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#charge-shared-storage-top-level-traversable-budgets\" id=\"ref-for-charge-shared-storage-top-level-traversable-budgets①\">charge shared storage top-level traversable budgets</a> with <var>navigable</var>, <var>site</var>, and <var>pendingBits</var>.</p>"
            },
            {
              "html": "<p>If <var>pageBudgetResult</var> is false, set <var>shouldUseDefaultIndex</var> to true.</p>"
            }
          ]
        },
        {
          "html": "<p>If <var>pendingBits</var> is greather than <var>remainingBudget</var>, set <var>shouldUseDefaultIndex</var> to true.</p>"
        },
        {
          "html": "<p>If <var>shouldUseDefaultIndex</var> is true, set <var>resultIndex</var> to the <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#default-selecturl-index\" id=\"ref-for-default-selecturl-index②\">default selectURL index</a>.</p>"
        },
        {
          "html": "<p>Let <var>finalConfig</var> be a new <a data-link-type=\"dfn\" href=\"https://wicg.github.io/fenced-frame/#fenced-frame-config\" id=\"ref-for-fenced-frame-config\">fenced frame config</a>.</p>"
        },
        {
          "html": "<p>Set <var>finalConfig</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/fenced-frame/#fenced-frame-config-mapped-url\" id=\"ref-for-fenced-frame-config-mapped-url\">mapped url</a> to <var>urlList</var>[<var>resultIndex</var>].</p>"
        },
        {
          "html": "<p>Set <var>finalConfig</var>’s <span class=\"todo\">a \"pending shared storage budget debit\" field</span> to <var>pendingBits</var>.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://wicg.github.io/fenced-frame/#fenced-frame-config-mapping-finalize-a-pending-config\" id=\"ref-for-fenced-frame-config-mapping-finalize-a-pending-config\">Finalize a pending config</a> on <var>fencedFrameConfigMapping</var> with <var>urn</var> and <var>finalConfig</var>.</p>"
        },
        {
          "html": "<p>Let <var>resultURLWithMetadata</var> be <var>urls</var>[<var>resultIndex</var>].</p>"
        },
        {
          "html": "<p>If <var>resultURLWithMetadata</var> has field \"<code>reportingMetadata</code>\", run <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#register-reporting-metadata\" id=\"ref-for-register-reporting-metadata\">register reporting metadata</a> with <var>resultURLWithMetadata</var>[\"<code>reportingMetadata</code>\"].</p>"
        },
        {
          "html": "<p>If <var>options</var>[\"<code>keepAlive</code>\"] is false, run <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/worklets.html#terminate-a-worklet-global-scope\" id=\"ref-for-terminate-a-worklet-global-scope\">terminate a worklet global scope</a> with <var>worklet</var>.</p>"
        }
      ]
    },
    {
      "name": "SharedStorageWorklet/selectURL(name, urls, options)",
      "href": "https://wicg.github.io/shared-storage/#dom-sharedstorageworklet-selecturl",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"SharedStorageWorklet\" data-dfn-type=\"method\" data-export=\"\" data-lt=\"selectURL(name, urls, options)|selectURL(name, urls)\" id=\"dom-sharedstorageworklet-selecturl\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>selectURL(<var>name</var>, <var>urls</var>, <var>options</var>)</code></dfn> method steps are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>resultPromise</var> be a new <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#idl-promise\" id=\"ref-for-idl-promise④\">promise</a>.</p>"
        },
        {
          "html": "<p>If <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this①\">this</a>'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworklet-addmodule-initiated\" id=\"ref-for-sharedstorageworklet-addmodule-initiated③\">addModule initiated</a> is false, then return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with②\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror⑤\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>window</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this②\">this</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object②\">relevant settings object</a>.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert⑥\">Assert</a>: <var>window</var> is a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#window\" id=\"ref-for-window⑧\">Window</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>context</var> be <var>window</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#window-bc\" id=\"ref-for-window-bc①\">browsing context</a>.</p>"
        },
        {
          "html": "<p>If <var>context</var> is null, then return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with③\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror⑥\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>preSpecifiedParams</var> be the result of <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#obtain-the-pre-specified-report-parameters\" id=\"ref-for-obtain-the-pre-specified-report-parameters\">obtaining the pre-specified\nreport parameters</a> given <var>options</var> and <var>context</var>.</p>"
        },
        {
          "html": "<p>If <var>preSpecifiedParams</var> is a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException\">DOMException</a></code>, return <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with④\">a promise rejected\nwith</a> <var>preSpecifiedParams</var>.</p>"
        },
        {
          "html": "<p>Let <var>aggregationCoordinator</var> be the result of <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#obtain-the-aggregation-coordinator\" id=\"ref-for-obtain-the-aggregation-coordinator\">obtaining the aggregation\ncoordinator</a> given <var>options</var>.</p>"
        },
        {
          "html": "<p>If <var>aggregationCoordinator</var> is a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException①\">DOMException</a></code>, return <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with⑤\">a promise\nrejected with</a> <var>aggregationCoordinator</var>.</p>"
        },
        {
          "html": "<p>Let <var>document</var> be <var>context</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document\" id=\"ref-for-nav-document\">active document</a>.</p>"
        },
        {
          "html": "<p>If <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this③\">this</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/worklets.html#concept-worklet-global-scopes\" id=\"ref-for-concept-worklet-global-scopes④\">global scopes</a> is <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-empty\" id=\"ref-for-list-empty\">empty</a>, then return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with⑥\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror⑦\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert⑦\">Assert</a>: <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this④\">this</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/worklets.html#concept-worklet-global-scopes\" id=\"ref-for-concept-worklet-global-scopes⑤\">global scopes</a>'s <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-size\" id=\"ref-for-list-size③\">size</a> is 1.</p>"
        },
        {
          "html": "<p>Let <var>globalScope</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this⑤\">this</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/worklets.html#concept-worklet-global-scopes\" id=\"ref-for-concept-worklet-global-scopes⑥\">global scopes</a>[0].</p>"
        },
        {
          "html": "<p>Let <var>workletDataOrigin</var> be <var>globalScope</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-global-object-realm\" id=\"ref-for-concept-global-object-realm①\">realm</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-realm-settings-object\" id=\"ref-for-concept-realm-settings-object①\">settings object</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin\" id=\"ref-for-concept-settings-object-origin⑤\">origin</a>.</p>"
        },
        {
          "html": "<p>If the result of running <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/permissions-policy/#algo-is-feature-enabled\" id=\"ref-for-algo-is-feature-enabled①\">Is feature enabled in document for origin?</a> on \"<a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#permissionspolicy-shared-storage-select-url\" id=\"ref-for-permissionspolicy-shared-storage-select-url\">shared-storage-select-url</a>\", <var>document</var>, and <var>workletDataOrigin</var> returns false, return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with⑦\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror⑧\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>If the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope-check-whether-addmodule-is-finished\" id=\"ref-for-sharedstorageworkletglobalscope-check-whether-addmodule-is-finished\">check whether addModule is finished</a> for <var>globalScope</var> is false, return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with⑧\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror⑨\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>If <var>urls</var> is empty or if <var>urls</var>’s <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-size\" id=\"ref-for-list-size④\">size</a> is greater than 8, return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with⑨\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror①⓪\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>urlList</var> be an empty <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list③\">list</a>.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-iterate\" id=\"ref-for-map-iterate\">For each</a> <var>urlWithMetadata</var> in <var>urls</var>:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>urlWithMetadata</var> has no field \"<code>url</code>\", return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with①⓪\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror①①\">TypeError</a></code>.</p>"
            },
            {
              "html": "<p>Otherwise, let <var>urlString</var> be <var>urlWithMetadata</var>[\"<code>url</code>\"].</p>"
            },
            {
              "html": "<p>Let <var>serializedUrl</var> be the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#get-the-canonical-url-string-if-valid\" id=\"ref-for-get-the-canonical-url-string-if-valid\">get the canonical URL string if valid</a> with <var>urlString</var>.</p>"
            },
            {
              "html": "<p>If <var>serializedUrl</var> is undefined, return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with①①\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror①②\">TypeError</a></code>.</p>"
            },
            {
              "html": "<p>Otherwise, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-append\" id=\"ref-for-list-append①\">append</a> <var>serializedUrl</var> to <var>urlList</var>.</p>"
            },
            {
              "html": "If <var>urlWithMetadata</var> has field \"<code>reportingMetadata</code>\":",
              "rationale": "let",
              "steps": [
                {
                  "html": "<p>Let <var>reportingMetadata</var> be <var>urlWithMetadata</var>[\"<code>reportingMetadata</code>\"].</p>"
                },
                {
                  "html": "<p>If the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#validate-reporting-metadata\" id=\"ref-for-validate-reporting-metadata\">validate reporting metadata</a> with <var>reportingMetadata</var> is false, <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\" id=\"ref-for-reject③\">reject</a> <var>resultPromise</var> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror①③\">TypeError</a></code> and abort these steps.</p>"
                }
              ]
            }
          ]
        },
        {
          "html": "<p>Let <var>navigable</var> be <var>window</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#concept-document-window\" id=\"ref-for-concept-document-window②\">associated document</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#node-navigable\" id=\"ref-for-node-navigable\">node navigable</a>.</p>"
        },
        {
          "html": "<p>Let <var>fencedFrameConfigMapping</var> be <var>navigable</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-traversable\" id=\"ref-for-nav-traversable\">traversable navigable</a>'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/fenced-frame/#traversable-navigable-fenced-frame-config-mapping\" id=\"ref-for-traversable-navigable-fenced-frame-config-mapping①\">fenced frame config mapping</a>.</p>"
        },
        {
          "html": "<p>Let <var>pendingConfig</var> be a new <a data-link-type=\"dfn\" href=\"https://wicg.github.io/fenced-frame/#fenced-frame-config\" id=\"ref-for-fenced-frame-config①\">fenced frame config</a>.</p>"
        },
        {
          "html": "<p>Let <var>urn</var> be the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/fenced-frame/#fenced-frame-config-mapping-store-a-pending-config\" id=\"ref-for-fenced-frame-config-mapping-store-a-pending-config\">store a pending config</a> on <var>fencedFrameConfigMapping</var> with <var>pendingConfig</var>.</p>"
        },
        {
          "html": "<p>If <var>urn</var> is failure, then return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with①②\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror①④\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>environment</var> be <var>window</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object③\">relevant settings object</a>.</p>"
        },
        {
          "html": "<p>Let <var>allowedInOpaqueOriginContext</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this⑥\">this</a>'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworklet-has-cross-origin-data-origin\" id=\"ref-for-sharedstorageworklet-has-cross-origin-data-origin④\">has cross-origin data origin</a>.</p>"
        },
        {
          "html": "<p>If the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#determine-whether-shared-storage-is-allowed-by-context\" id=\"ref-for-determine-whether-shared-storage-is-allowed-by-context②\">determine whether shared storage is allowed by context</a> given <var>environment</var>, <var>workletDataOrigin</var>, and <var>allowedInOpaqueOriginContext</var> is false, return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with①③\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror①⑤\">TypeError</a></code>.</p>"
        },
        {
          "html": "If the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#check-if-user-preference-setting-allows-access-to-shared-storage\" id=\"ref-for-check-if-user-preference-setting-allows-access-to-shared-storage②\">check if user preference setting allows access to shared storage</a> given <var>environment</var> and <var>workletDataOrigin</var> is false:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this⑦\">this</a>'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworklet-has-cross-origin-data-origin\" id=\"ref-for-sharedstorageworklet-has-cross-origin-data-origin⑤\">has cross-origin data origin</a> is false, return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with①④\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror①⑥\">TypeError</a></code>.</p>"
            }
          ]
        },
        {
          "html": "<p>If <var>options</var>[\"<code>resolveToConfig</code>\"] is true, <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#resolve\" id=\"ref-for-resolve①\">resolve</a> <var>resultPromise</var> with <var>pendingConfig</var>.</p>"
        },
        {
          "html": "<p>Otherwise, <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#resolve\" id=\"ref-for-resolve②\">resolve</a> <var>resultPromise</var> with <var>urn</var>.</p>"
        },
        {
          "html": "<p>Let (<var>indexPromise</var>, <var>shouldChargeTopLevelBudgets</var>) be the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#get-the-select-url-result-index\" id=\"ref-for-get-the-select-url-result-index\">get the select-url result index</a>, given <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this⑧\">this</a>, <var>name</var>, <var>urlList</var>, <var>workletDataOrigin</var>, <var>navigable</var>, <var>options</var>, <var>preSpecifiedParams</var> and <var>aggregationCoordinator</var>.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#upon-fulfillment\" id=\"ref-for-upon-fulfillment\">Upon fulfillment</a> of <var>indexPromise</var> with <var>resultIndex</var>, run <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#handle-the-result-of-selecting-an-index\" id=\"ref-for-handle-the-result-of-selecting-an-index\">handle the result of selecting an index</a> given <var>worklet</var>, <var>environment</var>, <var>document</var>, <var>urls</var>, <var>urlList</var>, <var>navigable</var>, <var>options</var>, <var>fencedFrameConfigMapping</var>, <var>urn</var>, <var>shouldChargeTopLevelBudgets</var>, false, and <var>resultIndex</var>.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#upon-rejection\" id=\"ref-for-upon-rejection\">Upon rejection</a> of <var>indexPromise</var>, run <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#handle-the-result-of-selecting-an-index\" id=\"ref-for-handle-the-result-of-selecting-an-index①\">handle the result of selecting an index</a> given <var>worklet</var>, <var>environment</var>, <var>document</var>, <var>urls</var>, <var>urlList</var>, <var>navigable</var>, <var>options</var>, <var>fencedFrameConfigMapping</var>, <var>urn</var>, <var>shouldChargeTopLevelBudgets</var>, true, and the <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#default-selecturl-index\" id=\"ref-for-default-selecturl-index③\">default selectURL index</a>.</p>"
        },
        {
          "html": "<p>Return <var>resultPromise</var>.</p>"
        }
      ]
    },
    {
      "name": "SharedStorageWorklet/run(name, options)",
      "href": "https://wicg.github.io/shared-storage/#dom-sharedstorageworklet-run",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"SharedStorageWorklet\" data-dfn-type=\"method\" data-export=\"\" data-lt=\"run(name, options)|run(name)\" id=\"dom-sharedstorageworklet-run\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>run(<var>name</var>, <var>options</var>)</code></dfn> method steps are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>promise</var> be a new <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#idl-promise\" id=\"ref-for-idl-promise⑤\">promise</a>.</p>"
        },
        {
          "html": "<p>If <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this⑨\">this</a>'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworklet-addmodule-initiated\" id=\"ref-for-sharedstorageworklet-addmodule-initiated④\">addModule initiated</a> is false, then return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with①⑤\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror①⑦\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>window</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this①⓪\">this</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object④\">relevant settings object</a>.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert⑧\">Assert</a>: <var>window</var> is a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#window\" id=\"ref-for-window⑨\">Window</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>context</var> be <var>window</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#window-bc\" id=\"ref-for-window-bc②\">browsing context</a>.</p>"
        },
        {
          "html": "<p>If <var>context</var> is null, then return <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with①⑥\">a promise rejected with</a> a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror①⑧\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>preSpecifiedParams</var> be the result of <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#obtain-the-pre-specified-report-parameters\" id=\"ref-for-obtain-the-pre-specified-report-parameters①\">obtaining the pre-specified\nreport parameters</a> given <var>options</var> and <var>context</var>.</p>"
        },
        {
          "html": "<p>If <var>preSpecifiedParams</var> is a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException②\">DOMException</a></code>, return <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with①⑦\">a promise rejected\nwith</a> <var>preSpecifiedParams</var>.</p>"
        },
        {
          "html": "<p>Let <var>aggregationCoordinator</var> be the result of <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#obtain-the-aggregation-coordinator\" id=\"ref-for-obtain-the-aggregation-coordinator①\">obtaining the aggregation\ncoordinator</a> given <var>options</var>.</p>"
        },
        {
          "html": "<p>If <var>aggregationCoordinator</var> is a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException③\">DOMException</a></code>, return <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with①⑧\">a promise\nrejected with</a> <var>aggregationCoordinator</var>.</p>"
        },
        {
          "html": "<p>If <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this①①\">this</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/worklets.html#concept-worklet-global-scopes\" id=\"ref-for-concept-worklet-global-scopes⑦\">global scopes</a> is <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-empty\" id=\"ref-for-list-empty①\">empty</a>, then return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with①⑨\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror①⑨\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert⑨\">Assert</a>: <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this①②\">this</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/worklets.html#concept-worklet-global-scopes\" id=\"ref-for-concept-worklet-global-scopes⑧\">global scopes</a>'s <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-size\" id=\"ref-for-list-size⑤\">size</a> is 1.</p>"
        },
        {
          "html": "<p>Let <var>globalScope</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this①③\">this</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/worklets.html#concept-worklet-global-scopes\" id=\"ref-for-concept-worklet-global-scopes⑨\">global scopes</a>[0].</p>"
        },
        {
          "html": "<p>If the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope-check-whether-addmodule-is-finished\" id=\"ref-for-sharedstorageworkletglobalscope-check-whether-addmodule-is-finished①\">check whether addModule is finished</a> for <var>globalScope</var> is false, return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with②⓪\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror②⓪\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>workletDataOrigin</var> be <var>globalScope</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-global-object-realm\" id=\"ref-for-concept-global-object-realm②\">realm</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-realm-settings-object\" id=\"ref-for-concept-realm-settings-object②\">settings object</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin\" id=\"ref-for-concept-settings-object-origin⑥\">origin</a>.</p>"
        },
        {
          "html": "<p>Let <var>allowedInOpaqueOriginContext</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this①④\">this</a>'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworklet-has-cross-origin-data-origin\" id=\"ref-for-sharedstorageworklet-has-cross-origin-data-origin⑥\">has cross-origin data origin</a>.</p>"
        },
        {
          "html": "<p>If the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#determine-whether-shared-storage-is-allowed-by-context\" id=\"ref-for-determine-whether-shared-storage-is-allowed-by-context③\">determine whether shared storage is allowed by context</a> given <var>window</var>, <var>workletDataOrigin</var>, and <var>allowedInOpaqueOriginContext</var> is false, <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\" id=\"ref-for-reject④\">reject</a> <var>promise</var> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror②①\">TypeError</a></code>.</p>"
        },
        {
          "html": "If the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#check-if-user-preference-setting-allows-access-to-shared-storage\" id=\"ref-for-check-if-user-preference-setting-allows-access-to-shared-storage③\">check if user preference setting allows access to shared storage</a> given <var>window</var> and <var>workletDataOrigin</var> is false:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this①⑤\">this</a>'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworklet-has-cross-origin-data-origin\" id=\"ref-for-sharedstorageworklet-has-cross-origin-data-origin⑦\">has cross-origin data origin</a> is false, <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\" id=\"ref-for-reject⑤\">reject</a> <var>promise</var> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror②②\">TypeError</a></code>.</p>"
            },
            {
              "html": "<p>Else, <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#resolve\" id=\"ref-for-resolve③\">resolve</a> <var>promise</var> with undefined.</p>"
            },
            {
              "html": "<p>Return <var>promise</var>.</p>"
            }
          ]
        },
        {
          "html": "Return <var>promise</var>, and immediately <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#obtain-a-worklet-agent\" id=\"ref-for-obtain-a-worklet-agent\">obtaining a worklet agent</a> given <var>window</var> and run the rest of these steps in that agent:",
          "rationale": "queue",
          "steps": [
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task\" id=\"ref-for-queue-a-global-task⑤\">Queue a global task</a> on the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source⑤\">DOM manipulation task source</a>, given <var>window</var>, to <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#resolve\" id=\"ref-for-resolve④\">resolve</a> <var>promise</var> with undefined.</p>"
            },
            {
              "html": "If <var>globalScope</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object⑤\">relevant settings object</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/workers.html#concept-workerglobalscope-module-map\" id=\"ref-for-concept-workerglobalscope-module-map①\">module map</a> is not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org#map-is-empty\" id=\"ref-for-map-is-empty\">empty</a>:",
              "rationale": "let",
              "steps": [
                {
                  "html": "<p>Let <var>operationMap</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this①⑥\">this</a>'s <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope\" id=\"ref-for-sharedstorageworkletglobalscope⑤\">SharedStorageWorkletGlobalScope</a></code>'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope-operation-map\" id=\"ref-for-sharedstorageworkletglobalscope-operation-map①\">operation map</a>.</p>"
                },
                {
                  "html": "If <var>operationMap</var> <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists②\">contains</a> <var>name</var>:",
                  "rationale": "assert",
                  "steps": [
                    {
                      "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert①⓪\">Assert</a>: <var>operationMap</var>[<var>name</var>]'s <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-associated-realm\" id=\"ref-for-dfn-associated-realm①\">associated realm</a> is <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this①⑦\">this</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-realm\" id=\"ref-for-concept-relevant-realm①\">relevant realm</a>.</p>"
                    },
                    {
                      "html": "<p>Let <var>operation</var> be <var>operationMap</var>[<var>name</var>], <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-convert-ecmascript-to-idl-value\" id=\"ref-for-dfn-convert-ecmascript-to-idl-value①\">converted</a> to <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#Function\" id=\"ref-for-Function\">Function</a></code>.</p>"
                    },
                    {
                      "html": "<p>Let <var>privateAggregationCompletionTask</var> be the result of <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#set-up-the-private-aggregation-scopes\" id=\"ref-for-set-up-the-private-aggregation-scopes①\">setting up the Private Aggregation scopes</a> given <var>workletDataOrigin</var>, <var>preSpecifiedParams</var> and <var>aggregationCoordinator</var>.</p>"
                    },
                    {
                      "html": "<p>Let <var>argumentsList</var> be a new <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list④\">list</a>.</p>"
                    },
                    {
                      "html": "<p>If <var>options</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#dom-sharedstoragerunoperationmethodoptions-data\" id=\"ref-for-dom-sharedstoragerunoperationmethodoptions-data①\">data</a></code>\"] <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists③\">exists</a>, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-append\" id=\"ref-for-list-append②\">append</a> it to <var>argumentsList</var>.</p>"
                    },
                    {
                      "html": "<p><a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#invoke-a-callback-function\" id=\"ref-for-invoke-a-callback-function①\">Invoke</a> <var>operation</var> with <var>argumentsList</var> and \"<code>report</code>\".</p>"
                    },
                    {
                      "html": "<p>Wait for <var>operation</var> to finish running, if applicable.</p>"
                    },
                    {
                      "html": "<p>Run <var>privateAggregationCompletionTask</var>.</p>"
                    }
                  ]
                }
              ]
            },
            {
              "html": "If <var>options</var>[\"<code>keepAlive</code>\"] is false:",
              "rationale": "wait",
              "steps": [
                {
                  "html": "<p>Wait for <var>operation</var> to finish running, if applicable.</p>"
                },
                {
                  "html": "<p>Run <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/worklets.html#terminate-a-worklet-global-scope\" id=\"ref-for-terminate-a-worklet-global-scope①\">terminate a worklet global scope</a> with <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this①⑧\">this</a>.</p>"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "obtain the aggregation coordinator",
      "href": "https://wicg.github.io/shared-storage/#obtain-the-aggregation-coordinator",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"obtain-the-aggregation-coordinator\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">obtain the aggregation coordinator</dfn> given a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#dictdef-sharedstoragerunoperationmethodoptions\" id=\"ref-for-dictdef-sharedstoragerunoperationmethodoptions④\">SharedStorageRunOperationMethodOptions</a></code> <var>options</var>, perform the following\n    steps. They return an <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregation-coordinator\" id=\"ref-for-aggregation-coordinator①\">aggregation coordinator</a>, null or a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException④\">DOMException</a></code>:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If <var>options</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#dom-sharedstoragerunoperationmethodoptions-privateaggregationconfig\" id=\"ref-for-dom-sharedstoragerunoperationmethodoptions-privateaggregationconfig\">privateAggregationConfig</a></code>\"]\ndoes not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists④\">exist</a>, return null.</p>"
        },
        {
          "html": "<p>If <var>options</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#dom-sharedstoragerunoperationmethodoptions-privateaggregationconfig\" id=\"ref-for-dom-sharedstoragerunoperationmethodoptions-privateaggregationconfig①\">privateAggregationConfig</a></code>\"][\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#dom-sharedstorageprivateaggregationconfig-aggregationcoordinatororigin\" id=\"ref-for-dom-sharedstorageprivateaggregationconfig-aggregationcoordinatororigin\">aggregationCoordinatorOrigin</a></code>\"]\ndoes not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists⑤\">exist</a>, return null.</p>"
        },
        {
          "html": "<p>Return the result of <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#obtain-the-private-aggregation-coordinator\" id=\"ref-for-obtain-the-private-aggregation-coordinator\">obtaining the Private Aggregation coordinator</a> given <var>options</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#dom-sharedstoragerunoperationmethodoptions-privateaggregationconfig\" id=\"ref-for-dom-sharedstoragerunoperationmethodoptions-privateaggregationconfig②\">privateAggregationConfig</a></code>\"][\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#dom-sharedstorageprivateaggregationconfig-aggregationcoordinatororigin\" id=\"ref-for-dom-sharedstorageprivateaggregationconfig-aggregationcoordinatororigin①\">aggregationCoordinatorOrigin</a></code>\"].</p>"
        }
      ]
    },
    {
      "name": "obtain the pre-specified report parameters",
      "href": "https://wicg.github.io/shared-storage/#obtain-the-pre-specified-report-parameters",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"obtain-the-pre-specified-report-parameters\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">obtain the pre-specified report parameters</dfn> given a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#dictdef-sharedstoragerunoperationmethodoptions\" id=\"ref-for-dictdef-sharedstoragerunoperationmethodoptions⑤\">SharedStorageRunOperationMethodOptions</a></code> <var>options</var> and a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#browsing-context\" id=\"ref-for-browsing-context\">browsing\n    context</a> <var>context</var>, perform the following steps. They return a <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#pre-specified-report-parameters\" id=\"ref-for-pre-specified-report-parameters①\">pre-specified report parameters</a>, null, or a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException⑤\">DOMException</a></code>:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If <var>options</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#dom-sharedstoragerunoperationmethodoptions-privateaggregationconfig\" id=\"ref-for-dom-sharedstoragerunoperationmethodoptions-privateaggregationconfig③\">privateAggregationConfig</a></code>\"]\ndoes not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists⑥\">exist</a>, return null.</p>"
        },
        {
          "html": "<p>Let <var>privateAggregationConfig</var> be <var>options</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#dom-sharedstoragerunoperationmethodoptions-privateaggregationconfig\" id=\"ref-for-dom-sharedstoragerunoperationmethodoptions-privateaggregationconfig④\">privateAggregationConfig</a></code>\"].</p>"
        },
        {
          "html": "<p>Let <var>contextId</var> be null.</p>"
        },
        {
          "html": "<p>If <var>privateAggregationConfig</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#dom-sharedstorageprivateaggregationconfig-contextid\" id=\"ref-for-dom-sharedstorageprivateaggregationconfig-contextid\">contextId</a></code>\"] <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists⑦\">exists</a>, set <var>contextId</var> to <var>privateAggregationConfig</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#dom-sharedstorageprivateaggregationconfig-contextid\" id=\"ref-for-dom-sharedstorageprivateaggregationconfig-contextid①\">contextId</a></code>\"].</p>"
        },
        {
          "html": "<p>If <var>contextId</var>’s <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#string-length\" id=\"ref-for-string-length\">length</a> is greater than 64, return a new <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException⑥\">DOMException</a></code> with name \"<code>DataError</code>\".</p>"
        },
        {
          "html": "<p>Let <var>filteringIdMaxBytes</var> be the <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#default-filtering-id-max-bytes\" id=\"ref-for-default-filtering-id-max-bytes\">default filtering ID max bytes</a>.</p>"
        },
        {
          "html": "<p>If <var>privateAggregationConfig</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#dom-sharedstorageprivateaggregationconfig-filteringidmaxbytes\" id=\"ref-for-dom-sharedstorageprivateaggregationconfig-filteringidmaxbytes\">filteringIdMaxBytes</a></code>\"] <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists⑧\">exists</a>, set <var>filteringIdMaxBytes</var> to <var>privateAggregationConfig</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#dom-sharedstorageprivateaggregationconfig-filteringidmaxbytes\" id=\"ref-for-dom-sharedstorageprivateaggregationconfig-filteringidmaxbytes①\">filteringIdMaxBytes</a></code>\"].</p>"
        },
        {
          "html": "<p>If <var>filteringIdMaxBytes</var> is not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-contain\" id=\"ref-for-list-contain\">contained</a> in the <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#valid-filtering-id-max-bytes-range\" id=\"ref-for-valid-filtering-id-max-bytes-range\">valid filtering ID\nmax bytes range</a>, return a new <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException⑦\">DOMException</a></code> with name \"<code>DataError</code>\".</p>"
        },
        {
          "html": "If <var>context</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/fenced-frame/#browsing-context-fenced-frame-config-instance\" id=\"ref-for-browsing-context-fenced-frame-config-instance\">fenced frame config instance</a> is not null:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>filteringIdMaxBytes</var> is not the <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#default-filtering-id-max-bytes\" id=\"ref-for-default-filtering-id-max-bytes①\">default filtering ID max bytes</a> or <var>contextId</var> is not null, return a new <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException⑧\">DOMException</a></code> with name\n\"<code>DataError</code>\".</p>"
            }
          ]
        },
        {
          "html": "<p>Return a new <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#pre-specified-report-parameters\" id=\"ref-for-pre-specified-report-parameters②\">pre-specified report parameters</a> with the items:</p>\n      <dl>\n       <dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#context-id\" id=\"ref-for-context-id\">context ID</a>\n       </dt><dd data-md=\"\">\n        <p><var>contextId</var></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#filtering-id-max-bytes\" id=\"ref-for-filtering-id-max-bytes\">filtering ID max bytes</a>\n       </dt><dd data-md=\"\">\n        <p><var>filteringIdMaxBytes</var></p>\n      </dd></dl>"
        }
      ]
    },
    {
      "name": "set up the Private Aggregation scopes",
      "href": "https://wicg.github.io/shared-storage/#set-up-the-private-aggregation-scopes",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"set-up-the-private-aggregation-scopes\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">set up the Private Aggregation scopes</dfn> given an <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin\" id=\"ref-for-concept-origin③\">origin</a> <var>workletDataOrigin</var>, a <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#pre-specified-report-parameters\" id=\"ref-for-pre-specified-report-parameters③\">pre-specified report parameters</a> or null <var>preSpecifiedParams</var> and an <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregation-coordinator\" id=\"ref-for-aggregation-coordinator②\">aggregation coordinator</a> or null <var>aggregationCoordinator</var>, peform the following steps. They return an\n    algorithm.",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>batchingScope</var> be a new <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#batching-scope\" id=\"ref-for-batching-scope\">batching scope</a>.</p>"
        },
        {
          "html": "<p>Let <var>debugScope</var> be a new <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#debug-scope\" id=\"ref-for-debug-scope\">debug scope</a>.</p>"
        },
        {
          "html": "<p>Let <var>privateAggregationTimeout</var> be null.</p>"
        },
        {
          "html": "<p>Let <var>hasRunPrivateAggregationCompletionTask</var> be false.</p>"
        },
        {
          "html": "Let <var>privateAggregationCompletionTask</var> be an algorithm to perform the\nfollowing steps:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>hasRunPrivateAggregationCompletionTask</var>, return.</p>"
            },
            {
              "html": "<p>Set <var>hasRunPrivateAggregationCompletionTask</var> to true.</p>"
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#mark-a-debug-scope-complete\" id=\"ref-for-mark-a-debug-scope-complete\">Mark a debug scope complete</a> given <var>debugScope</var>.</p>"
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#process-contributions-for-a-batching-scope\" id=\"ref-for-process-contributions-for-a-batching-scope\">Process contributions for a batching scope</a> given <var>batchingScope</var>, <var>workletDataOrigin</var>, \"<code>shared-storage</code>\"\nand <var>privateAggregationTimeout</var>.</p>"
            }
          ]
        },
        {
          "html": "<p>If <var>aggregationCoordinator</var> is not null, <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#set-the-aggregation-coordinator-for-a-batching-scope\" id=\"ref-for-set-the-aggregation-coordinator-for-a-batching-scope\">set the aggregation coordinator\nfor a batching scope</a> given <var>aggregationCoordinator</var> and <var>batchingScope</var>.</p>"
        },
        {
          "html": "If <var>preSpecifiedParams</var> is not null:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>isDeterministicReport</var> be the result of <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#determine-if-a-report-should-be-sent-deterministically\" id=\"ref-for-determine-if-a-report-should-be-sent-deterministically\">determining if a report\nshould be sent deterministically</a> given <var>preSpecifiedParams</var>.</p>"
            },
            {
              "html": "If <var>isDeterministicReport</var>:",
              "rationale": "set",
              "steps": [
                {
                  "html": "<p>Set <var>privateAggregationTimeout</var> to the <a data-link-type=\"dfn\" href=\"https://w3c.github.io/hr-time/#dfn-current-wall-time\" id=\"ref-for-dfn-current-wall-time\">current wall time</a> plus\nthe <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#deterministic-operation-timeout-duration\" id=\"ref-for-deterministic-operation-timeout-duration\">deterministic operation timeout duration</a>.</p>"
                }
              ]
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#set-the-pre-specified-report-parameters-for-a-batching-scope\" id=\"ref-for-set-the-pre-specified-report-parameters-for-a-batching-scope\">Set the pre-specified report parameters for a batching scope</a> given <var>preSpecifiedParams</var> and <var>batchingScope</var>.</p>"
            },
            {
              "html": "If <var>isDeterministicReport</var>, run the following steps <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel\">in parallel</a>:",
              "rationale": "wait",
              "steps": [
                {
                  "html": "<p>Wait until <var>privateAggregationTimeout</var>.</p>"
                },
                {
                  "html": "<p>Run <var>privateAggregationCompletionTask</var>.</p>"
                }
              ]
            }
          ]
        },
        {
          "html": "<p>Return <var>privateAggregationCompletionTask</var>.</p>"
        }
      ]
    },
    {
      "html": "The <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/worklets.html#set-up-a-worklet-environment-settings-object\" id=\"ref-for-set-up-a-worklet-environment-settings-object①\">set up a worklet environment settings object</a> algorithm will need to include an additional parameter: <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/worklets.html#worklet\" id=\"ref-for-worklet①\">Worklet</a></code> <var>worklet</var>. The step that defines the <var>settingsObject</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin\" id=\"ref-for-concept-settings-object-origin⑦\">origin</a> should be modified as follows:",
      "rationale": "let",
      "steps": [
        {
          "html": "<b>The <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin\" id=\"ref-for-concept-settings-object-origin⑧\">origin</a></b>",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>workletGlobalScope</var> be the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-realm-global\" id=\"ref-for-concept-realm-global①\">global object</a> of <var>realmExecutionContext</var>’s Realm component.</p>"
            },
            {
              "html": "<p>If <var>workletGlobalScope</var> is not <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope\" id=\"ref-for-sharedstorageworkletglobalscope⑥\">SharedStorageWorkletGlobalScope</a></code>, return <var>origin</var>.</p>"
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert①①\">Assert</a> that <var>worklet</var> is a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworklet\" id=\"ref-for-sharedstorageworklet①②\">SharedStorageWorklet</a></code>.</p>"
            },
            {
              "html": "<p>If <var>worklet</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworklet-data-origin\" id=\"ref-for-sharedstorageworklet-data-origin③\">data origin</a> is <code>\"context-origin\"</code>, return <var>outsideSettings</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin\" id=\"ref-for-concept-settings-object-origin⑨\">origin</a>.</p>"
            },
            {
              "html": "Otherwise, if <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworklet-data-origin\" id=\"ref-for-sharedstorageworklet-data-origin④\">data origin</a> is <code>\"script-origin\"</code>:",
              "rationale": "let",
              "steps": [
                {
                  "html": "<p>Let <var>pendingAddedModules</var> be a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-clone\" id=\"ref-for-list-clone\">clone</a> of <var>worklet</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/worklets.html#concept-worklet-added-modules-list\" id=\"ref-for-concept-worklet-added-modules-list\">added modules list</a>.</p>"
                },
                {
                  "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert①②\">Assert</a>: <var>pendingAddedModules</var>’s <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-size\" id=\"ref-for-list-size⑥\">size</a> is 1.</p>"
                },
                {
                  "html": "<p>Let <var>moduleURL</var> be <var>pendingAddedModules</var>[0].</p>"
                },
                {
                  "html": "<p>Return <var>moduleURL</var>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-origin\" id=\"ref-for-concept-url-origin④\">origin</a>.</p>"
                }
              ]
            },
            {
              "html": "<p>Otherwise, let <var>customOriginUrl</var> be the result of running a <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-parser\" id=\"ref-for-concept-url-parser①\">URL parser</a> on <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworklet-data-origin\" id=\"ref-for-sharedstorageworklet-data-origin⑤\">data origin</a>.</p>"
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert①③\">Assert</a> <var>customOriginUrl</var> is a valid <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url\" id=\"ref-for-concept-url②\">URL</a>.</p>"
            },
            {
              "html": "<p>Return <var>customOriginUrl</var>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-origin\" id=\"ref-for-concept-url-origin⑤\">origin</a>.</p>"
            }
          ]
        }
      ]
    },
    {
      "html": "The <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/worklets.html#create-a-worklet-global-scope\" id=\"ref-for-create-a-worklet-global-scope①\">create a worklet global scope</a> algorithm will need to be modified to pass in the <var>worklet</var> parameter:",
      "rationale": "let",
      "steps": [
        {
          "html": "<p>Let <var>insideSettings</var> be the result of <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/worklets.html#set-up-a-worklet-environment-settings-object\" id=\"ref-for-set-up-a-worklet-environment-settings-object②\">setting up a worklet environment settings object</a> given <var>realmExecutionContext</var>, <var>outsideSettings</var>, and <var>worklet</var>.</p>"
        }
      ]
    },
    {
      "html": "The algorithm <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#fetch-a-worklet-script-graph\" id=\"ref-for-fetch-a-worklet-script-graph①\">fetch a worklet script graph</a> calls into the <a href=\"https://html.spec.whatwg.org/multipage/webappapis.html#fetch-a-worklet/module-worker-script-graph\">fetch a worklet/module worker script graph</a> algorithm, which takes in an algorithm parameter <var>processCustomFetchResponse</var>. The definition of that <var>processCustomFetchResponse</var> parameter will need to include the following step before the step \"5. <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-fetch\" id=\"ref-for-concept-fetch\">Fetch</a> <var>request</var>, ...\":",
      "rationale": "if",
      "steps": [
        {
          "html": "If <var>fetchClient</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-global\" id=\"ref-for-concept-settings-object-global\">global object</a> is <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope\" id=\"ref-for-sharedstorageworkletglobalscope⑦\">SharedStorageWorkletGlobalScope</a></code>:",
          "rationale": "set",
          "steps": [
            {
              "html": "<p>Set <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-redirect-mode\" id=\"ref-for-concept-request-redirect-mode\">redirect mode</a> to \"<code>error</code>\".</p>"
            },
            {
              "html": "If <var>fetchClient</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin\" id=\"ref-for-concept-settings-object-origin①②\">origin</a> and <var>settingsObject</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin\" id=\"ref-for-concept-settings-object-origin①③\">origin</a> are not <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#same-origin\" id=\"ref-for-same-origin①\">same origin</a>:",
              "rationale": "let",
              "steps": [
                {
                  "html": "<p>Let <var>dataOriginValue</var> be the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#ascii-serialisation-of-an-origin\" id=\"ref-for-ascii-serialisation-of-an-origin\">serialization</a> of <var>settingsObject</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin\" id=\"ref-for-concept-settings-object-origin①④\">origin</a>.</p>"
                },
                {
                  "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert①④\">Assert</a> that <var>dataOriginValue</var> is not null.</p>"
                },
                {
                  "html": "<p><a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-header-list-append\" id=\"ref-for-concept-header-list-append\">Append</a> the <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-header\" id=\"ref-for-concept-header\">header</a> (<span>`<code><a data-link-type=\"http-header\" href=\"https://wicg.github.io/shared-storage/#http-headerdef-sec-shared-storage-data-origin\" id=\"ref-for-http-headerdef-sec-shared-storage-data-origin\">Sec-Shared-Storage-Data-Origin</a></code>`</span>, <var>dataOriginValue</var>) to <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-header-list\" id=\"ref-for-concept-request-header-list\">header list</a>.</p>"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "html": "The <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/worklets.html#dom-worklet-addmodule\" id=\"ref-for-dom-worklet-addmodule⑧\">addModule()</a></code> method steps for <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/worklets.html#worklet\" id=\"ref-for-worklet②\">Worklet</a></code> will need to include the following step before the step \"Let <var>promise</var> be a new promise\":",
      "rationale": "if",
      "steps": [
        {
          "html": "If <var>this</var> is of type <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworklet\" id=\"ref-for-sharedstorageworklet①③\">SharedStorageWorklet</a></code>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>addModuleAllowedResult</var> be the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#check-if-addmodule-is-allowed-and-update-state\" id=\"ref-for-check-if-addmodule-is-allowed-and-update-state①\">check if addModule is allowed and update state</a> given <var>this</var> and <var>moduleURLRecord</var>.</p>"
            },
            {
              "html": "If <var>addModuleAllowedResult</var> is \"DisallowedDueToNonPreferenceError\":",
              "rationale": "return",
              "steps": [
                {
                  "html": "<p>Return <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with②①\">a promise rejected with</a> a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror②③\">TypeError</a></code>.</p>"
                }
              ]
            },
            {
              "html": "Else if <var>addModuleAllowedResult</var> is \"DisallowedDueToPreferenceError\":",
              "rationale": "if",
              "steps": [
                {
                  "html": "<p>If <var>this</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworklet-has-cross-origin-data-origin\" id=\"ref-for-sharedstorageworklet-has-cross-origin-data-origin⑧\">has cross-origin data origin</a> is false, then return <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with②②\">a promise rejected with</a> a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror②④\">TypeError</a></code>.</p>"
                }
              ]
            },
            {
              "html": "Else:",
              "rationale": "assert",
              "steps": [
                {
                  "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert①⑤\">Assert</a>: <var>addModuleAllowedResult</var> is \"Allowed\".</p>"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "html": "After the step \"Let <var>addedSuccessfully</var> be false\", we need to include the following step:",
      "rationale": "if",
      "steps": [
        {
          "html": "If <var>this</var> is of type <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworklet\" id=\"ref-for-sharedstorageworklet①④\">SharedStorageWorklet</a></code>, <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworklet-has-cross-origin-data-origin\" id=\"ref-for-sharedstorageworklet-has-cross-origin-data-origin⑨\">has cross-origin data origin</a> is true, and <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworklet-data-origin\" id=\"ref-for-sharedstorageworklet-data-origin⑥\">data origin</a> is not <code>\"script-origin\"</code>:",
          "rationale": "assert",
          "steps": [
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert①⑥\">Assert</a> <var>pendingTasks</var> is 1.</p>"
            },
            {
              "html": "<p>Set <var>pendingTasks</var> to 2.</p>"
            },
            {
              "html": "<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task\" id=\"ref-for-queue-a-global-task⑥\">Queue a global task</a> on the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#networking-task-source\" id=\"ref-for-networking-task-source\">networking task source</a> given <var>workletGlobalScope</var> to perform the following steps:",
              "rationale": "let",
              "steps": [
                {
                  "html": "<p>Let <var>customOriginUrl</var> be the result of running a <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-parser\" id=\"ref-for-concept-url-parser②\">URL parser</a> on <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworklet-data-origin\" id=\"ref-for-sharedstorageworklet-data-origin⑦\">data origin</a>.</p>"
                },
                {
                  "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert①⑦\">Assert</a> <var>customOriginUrl</var> is a valid <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url\" id=\"ref-for-concept-url⑥\">URL</a>.</p>"
                },
                {
                  "html": "<p>Set <var>customOriginUrl</var>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-path\" id=\"ref-for-concept-url-path\">path</a> to ≪\".well-known\", \"shared-storage\", \"trusted-origins\"≫.</p>"
                },
                {
                  "html": "<p>Let <var>request</var> be a new <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request\" id=\"ref-for-concept-request\">request</a> whose <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-url\" id=\"ref-for-concept-request-url①\">URL</a> is <var>customOriginUrl</var>, <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-mode\" id=\"ref-for-concept-request-mode\">mode</a> is <code>\"cors\"</code>, <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-referrer\" id=\"ref-for-concept-request-referrer\">referrer</a> is <code>\"client\"</code>, <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-destination\" id=\"ref-for-concept-request-destination\">destination</a> is <code>\"json\"</code>, <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#request-initiator-type\" id=\"ref-for-request-initiator-type\">initiator type</a> is <code>\"script\"</code>, and <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-client\" id=\"ref-for-concept-request-client\">client</a> is <var>outsideSettings</var>.</p>"
                },
                {
                  "html": "<a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-fetch\" id=\"ref-for-concept-fetch①\">Fetch</a> <var>request</var> with <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#process-response-end-of-body\" id=\"ref-for-process-response-end-of-body\">processResponseConsumeBody</a> set to the following algorithm, given <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response\" id=\"ref-for-concept-response\">response</a> <var>response</var> and null, failure or a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#byte-sequence\" id=\"ref-for-byte-sequence\">byte sequence</a> <var>bodyBytes</var>:",
                  "rationale": "if",
                  "steps": [
                    {
                      "html": "then:",
                      "rationale": "set",
                      "steps": [
                        {
                          "html": "<p>Set <var>pendingTasks</var> to −1.</p>"
                        },
                        {
                          "html": "<p><a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\" id=\"ref-for-reject⑥\">Reject</a> <var>promise</var> with an \"TypeError\" DOMException.</p>"
                        },
                        {
                          "html": "<p>Abort these steps.</p>"
                        }
                      ]
                    },
                    {
                      "html": "<p>Let <var>mimeType</var> be the result of <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-header-extract-mime-type\" id=\"ref-for-concept-header-extract-mime-type\">extracting a MIME type</a> from <var>response</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-header-list\" id=\"ref-for-concept-response-header-list\">header list</a>.</p>"
                    },
                    {
                      "html": "If <var>mimeType</var> is not a <a data-link-type=\"dfn\" href=\"https://mimesniff.spec.whatwg.org/#json-mime-type\" id=\"ref-for-json-mime-type\">JSON MIME type</a>, then:",
                      "rationale": "set",
                      "steps": [
                        {
                          "html": "<p>Set <var>pendingTasks</var> to −1.</p>"
                        },
                        {
                          "html": "<p><a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\" id=\"ref-for-reject⑦\">Reject</a> <var>promise</var> with an \"TypeError\" DOMException.</p>"
                        },
                        {
                          "html": "<p>Abort these steps.</p>"
                        }
                      ]
                    },
                    {
                      "html": "<p>Let <var>sourceText</var> be the result of <a data-link-type=\"dfn\" href=\"https://encoding.spec.whatwg.org/#utf-8-decode\" id=\"ref-for-utf-8-decode\">UTF-8 decoding</a> <var>bodyBytes</var>.</p>"
                    },
                    {
                      "html": "<p>Let <var>parsed</var> be the result of <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#parse-a-json-string-to-an-infra-value\" id=\"ref-for-parse-a-json-string-to-an-infra-value\">parsing a JSON string to an Infra value</a> given <var>sourceText</var>.</p>"
                    },
                    {
                      "html": "If <var>parsed</var> is not a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list⑤\">list</a> or if <var>parsed</var> is <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-empty\" id=\"ref-for-list-empty②\">empty</a>, then:",
                      "rationale": "set",
                      "steps": [
                        {
                          "html": "<p>Set <var>pendingTasks</var> to −1.</p>"
                        },
                        {
                          "html": "<p><a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\" id=\"ref-for-reject⑧\">Reject</a> <var>promise</var> with an \"TypeError\" DOMException.</p>"
                        },
                        {
                          "html": "<p>Abort these steps.</p>"
                        }
                      ]
                    },
                    {
                      "html": "<p>Let <var>doesMatch</var> be false.</p>"
                    },
                    {
                      "html": "For each <var>item</var> of <var>parsed</var>:",
                      "rationale": "if",
                      "steps": [
                        {
                          "html": "If <var>item</var> is not an <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#ordered-map\" id=\"ref-for-ordered-map\">ordered map</a>, or if <var>item</var> does not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists⑨\">contain</a> <code>scriptOrigin</code>, or if <var>item</var> does not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists①⓪\">contain</a> <code>contextOrigin</code>:",
                          "rationale": "set",
                          "steps": [
                            {
                              "html": "<p>Set <var>pendingTasks</var> to −1.</p>"
                            },
                            {
                              "html": "<p><a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\" id=\"ref-for-reject⑨\">Reject</a> <var>promise</var> with an \"TypeError\" DOMException.</p>"
                            },
                            {
                              "html": "<p>Abort these steps.</p>"
                            }
                          ]
                        },
                        {
                          "html": "<p>Let <var>doesMatch</var> be the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#check-for-script-and-context-origin-match\" id=\"ref-for-check-for-script-and-context-origin-match\">check for script and context origin match</a> on <var>item</var>[<code>scriptOrigin</code>], <var>moduleURLRecord</var>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-origin\" id=\"ref-for-concept-url-origin①③\">origin</a>, <var>item</var>[<code>contextOrigin</code>], and <var>outsideSettings</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin\" id=\"ref-for-concept-settings-object-origin①⑦\">origin</a>.</p>"
                        },
                        {
                          "html": "If <var>doesMatch</var> is true:",
                          "rationale": "queue",
                          "steps": [
                            {
                              "html": "<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task\" id=\"ref-for-queue-a-global-task⑦\">Queue a global task</a> on the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#networking-task-source\" id=\"ref-for-networking-task-source①\">networking task source</a> given <var>this</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global\" id=\"ref-for-concept-relevant-global\">relevant global object</a> to perform the following steps:",
                              "rationale": "if",
                              "steps": [
                                {
                                  "html": "If <var>pendingTasks</var> is not −1, then:",
                                  "rationale": "set",
                                  "steps": [
                                    {
                                      "html": "<p>Set <var>pendingTasks</var> to <var>pendingTasks</var> − 1.</p>"
                                    },
                                    {
                                      "html": "If <var>pendingTasks</var> is 0, perform the following steps:",
                                      "rationale": "if",
                                      "steps": [
                                        {
                                          "html": "<p>If <var>workletGlobalScope</var> has an associated boolean <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope-addmodule-success\" id=\"ref-for-sharedstorageworkletglobalscope-addmodule-success\">addModule success</a>, set <var>workletGlobalScope</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope-addmodule-success\" id=\"ref-for-sharedstorageworkletglobalscope-addmodule-success①\">addModule success</a> to true.</p>"
                                        },
                                        {
                                          "html": "<p><a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#resolve\" id=\"ref-for-resolve⑤\">Resolve</a> <var>promise</var>.</p>"
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            },
                            {
                              "html": "<p>Break.</p>"
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "html": "If <var>doesMatch</var> is false, then:",
                      "rationale": "set",
                      "steps": [
                        {
                          "html": "<p>Set <var>pendingTasks</var> to −1.</p>"
                        },
                        {
                          "html": "<p><a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\" id=\"ref-for-reject①⓪\">Reject</a> <var>promise</var> with an \"TypeError\" DOMException.</p>"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "html": "The penultimate step (i.e. the final indented step), currently \"If <var>pendingTasks</var> is 0, then <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#resolve\" id=\"ref-for-resolve⑥\">resolve</a> <var>promise</var>.\", should be updated to:",
      "rationale": "if",
      "steps": [
        {
          "html": "If <var>pendingTasks</var> is 0, perform the following steps:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>workletGlobalScope</var> has an associated boolean <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope-addmodule-success\" id=\"ref-for-sharedstorageworkletglobalscope-addmodule-success②\">addModule success</a>, set <var>workletGlobalScope</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope-addmodule-success\" id=\"ref-for-sharedstorageworkletglobalscope-addmodule-success③\">addModule success</a> to true.</p>"
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#resolve\" id=\"ref-for-resolve⑦\">Resolve</a> <var>promise</var>.</p>"
            }
          ]
        }
      ]
    },
    {
      "html": "Just before the final step, currently \"Return <var>promise</var>.\", add the following step:",
      "rationale": "if",
      "steps": [
        {
          "html": "If <var>this</var> is a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworklet\" id=\"ref-for-sharedstorageworklet①⑤\">SharedStorageWorklet</a></code>, <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#upon-fulfillment\" id=\"ref-for-upon-fulfillment①\">upon fulfillment</a> of <var>promise</var> or <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#upon-rejection\" id=\"ref-for-upon-rejection①\">upon rejection</a> of <var>promise</var>, run the following steps:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>globalScopes</var> be <var>this</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/worklets.html#concept-worklet-global-scopes\" id=\"ref-for-concept-worklet-global-scopes①⓪\">global scopes</a>.</p>"
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert①⑧\">Assert</a>: <var>globalScopes</var>’ <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-size\" id=\"ref-for-list-size⑦\">size</a> equals 1.</p>"
            },
            {
              "html": "<p>Let <var>privateAggregationObj</var> be <var>globalScopes</var>[0]'s <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#dom-sharedstorageworkletglobalscope-privateaggregation\" id=\"ref-for-dom-sharedstorageworkletglobalscope-privateaggregation\">privateAggregation</a></code>.</p>"
            },
            {
              "html": "<p>Set <var>privateAggregationObj</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#allowed-to-use\" id=\"ref-for-allowed-to-use\">allowed to use</a> to\nthe result of determining whether <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this①⑨\">this</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global\" id=\"ref-for-concept-relevant-global①\">relevant global\nobject</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#concept-document-window\" id=\"ref-for-concept-document-window③\">associated document</a> is <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/iframe-embed-object.html#allowed-to-use\" id=\"ref-for-allowed-to-use①\">allowed to use</a> the\n\"<code><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#private-aggregation\" id=\"ref-for-private-aggregation\">private-aggregation</a></code>\" <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature\" id=\"ref-for-policy-controlled-feature\">policy-controlled feature</a>.</p>"
            },
            {
              "html": "<p>Set <var>privateAggregationObj</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#privateaggregation-scoping-details\" id=\"ref-for-privateaggregation-scoping-details\">scoping details</a> to a\n    new <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#scoping-details\" id=\"ref-for-scoping-details\">scoping details</a> with the items:</p>\n       <dl>\n        <dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#get-batching-scope-steps\" id=\"ref-for-get-batching-scope-steps\">get batching scope steps</a>\n        </dt><dd data-md=\"\">\n         <p>An algorithm that returns the <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#batching-scope\" id=\"ref-for-batching-scope①\">batching scope</a> that is scheduled to\nbe passed to <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#process-contributions-for-a-batching-scope\" id=\"ref-for-process-contributions-for-a-batching-scope①\">process contributions for a batching scope</a> when the\ncall currently executing in <var>scope</var> returns.</p>\n        </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#get-debug-scope-steps\" id=\"ref-for-get-debug-scope-steps\">get debug scope steps</a>\n        </dt><dd data-md=\"\">\n         <p>An algorithm that returns the <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#debug-scope\" id=\"ref-for-debug-scope①\">debug scope</a> that is scheduled to be\npassed to <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#mark-a-debug-scope-complete\" id=\"ref-for-mark-a-debug-scope-complete①\">mark a debug scope complete</a> when the call currently\nexecuting in <var>scope</var> returns.</p>\n       </dd></dl>"
            }
          ]
        }
      ]
    },
    {
      "name": "check for script and context origin match",
      "href": "https://wicg.github.io/shared-storage/#check-for-script-and-context-origin-match",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"check-for-script-and-context-origin-match\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">check for script and context origin match</dfn>, given <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#trusted-origin-type\" id=\"ref-for-trusted-origin-type\">trusted origin type</a> <var>itemScriptOrigin</var>, <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-origin\" id=\"ref-for-concept-url-origin①④\">origin</a> <var>actualScriptOrigin</var>, <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#trusted-origin-type\" id=\"ref-for-trusted-origin-type①\">trusted origin type</a> <var>itemContextOrigin</var>, and <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin\" id=\"ref-for-concept-settings-object-origin①⑧\">origin</a> <var>actualContextOrigin</var>, peform the following steps:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#check-for-trusted-origin-match\" id=\"ref-for-check-for-trusted-origin-match\">check for trusted origin match</a>, given <var>itemScriptOrigin</var> and <var>actualScriptOrigin</var> is false, return false.</p>"
        },
        {
          "html": "<p>Return the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#check-for-trusted-origin-match\" id=\"ref-for-check-for-trusted-origin-match①\">check for trusted origin match</a>, given <var>itemContextOrigin</var> and <var>actualContextOrigin</var>.</p>"
        }
      ]
    },
    {
      "name": "check for trusted origin match",
      "href": "https://wicg.github.io/shared-storage/#check-for-trusted-origin-match",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"check-for-trusted-origin-match\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">check for trusted origin match</dfn>, given <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#trusted-origin-type\" id=\"ref-for-trusted-origin-type②\">trusted origin type</a> <var>itemOrigin</var> and <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-origin\" id=\"ref-for-concept-url-origin①⑤\">origin</a> <var>actualOrigin</var>, peform the following steps:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If <var>itemOrigin</var> is a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#string\" id=\"ref-for-string⑧\">string</a>, return the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#check-for-trusted-origin-match-on-a-string\" id=\"ref-for-check-for-trusted-origin-match-on-a-string\">check for trusted origin match on a string</a>, given <var>itemOrigin</var> and <var>actualOrigin</var>.</p>"
        },
        {
          "html": "Otherwise, for each <var>originString</var> in <var>itemOrigin</var>:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#check-for-trusted-origin-match-on-a-string\" id=\"ref-for-check-for-trusted-origin-match-on-a-string①\">check for trusted origin match on a string</a> given <var>originString</var> and <var>actualOrigin</var> is true, return true.</p>"
            }
          ]
        },
        {
          "html": "<p>Return false.</p>"
        }
      ]
    },
    {
      "name": "check for trusted origin match on a string",
      "href": "https://wicg.github.io/shared-storage/#check-for-trusted-origin-match-on-a-string",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"check-for-trusted-origin-match-on-a-string\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">check for trusted origin match on a string</dfn>, given <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#string\" id=\"ref-for-string⑨\">string</a> <var>itemOrigin</var> and <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-origin\" id=\"ref-for-concept-url-origin①⑥\">origin</a> <var>actualOrigin</var>, peform the following steps:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If <var>itemOrigin</var> is <code>\"*\"</code>, return true.</p>"
        },
        {
          "html": "<p>Let <var>itemOriginUrl</var> be the result of running a <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-parser\" id=\"ref-for-concept-url-parser③\">URL parser</a> on <var>itemOrigin</var>.</p>"
        },
        {
          "html": "<p>If <var>itemOriginUrl</var> is not a valid <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url\" id=\"ref-for-concept-url⑦\">URL</a>, then return false.</p>"
        },
        {
          "html": "<p>If <var>itemOriginUrl</var>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-origin\" id=\"ref-for-concept-url-origin①⑦\">origin</a> and <var>actualOrigin</var> are <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#same-origin\" id=\"ref-for-same-origin③\">same origin</a>, return true.</p>"
        },
        {
          "html": "<p>Otherwise, return false.</p>"
        }
      ]
    },
    {
      "name": "SharedStorageWorkletGlobalScope/register(name, operationCtor)",
      "href": "https://wicg.github.io/shared-storage/#dom-sharedstorageworkletglobalscope-register",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"SharedStorageWorkletGlobalScope\" data-dfn-type=\"method\" data-export=\"\" id=\"dom-sharedstorageworkletglobalscope-register\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>register(<var>name</var>, <var>operationCtor</var>)</code></dfn> method steps are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If <var>name</var> is missing or empty, throw a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror②⑤\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>operationMap</var> be this <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope\" id=\"ref-for-sharedstorageworkletglobalscope①⑦\">SharedStorageWorkletGlobalScope</a></code>'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope-operation-map\" id=\"ref-for-sharedstorageworkletglobalscope-operation-map②\">operation map</a>.</p>"
        },
        {
          "html": "<p>If <var>operationMap</var> <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists①①\">contains</a> an <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-entry\" id=\"ref-for-map-entry\">entry</a> with <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-key\" id=\"ref-for-map-key\">key</a> <var>name</var>, throw a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror②⑥\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>If <var>operationCtor</var> is missing, throw a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror②⑦\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>operationClassInstance</var> be the result of <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#construct-a-callback-function\" id=\"ref-for-construct-a-callback-function\">constructing</a> <var>operationCtor</var>, with no arguments.</p>"
        },
        {
          "html": "<p>Let <var>runFunction</var> be <a data-link-type=\"dfn\" href=\"https://tc39.es/ecma262/#sec-get-o-p\" id=\"ref-for-sec-get-o-p\">Get</a>(<var>operationClassInstance</var>, \"<code>run</code>\"). Rethrow any exceptions.</p>"
        },
        {
          "html": "<p>If <a data-link-type=\"abstract-op\" href=\"https://tc39.es/ecma262/multipage/abstract-operations.html#sec-iscallable\" id=\"ref-for-sec-iscallable\">IsCallable</a>(<var>runFunction</var>) is false, throw a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror②⑧\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-set\" id=\"ref-for-map-set\">Set</a> the value of <var>operationMap</var>[<var>name</var>] to <var>runFunction</var>.</p>"
        }
      ]
    },
    {
      "name": "SharedStorageWorkletGlobalScope/interestGroups()",
      "href": "https://wicg.github.io/shared-storage/#dom-sharedstorageworkletglobalscope-interestgroups",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"SharedStorageWorkletGlobalScope\" data-dfn-type=\"method\" data-export=\"\" id=\"dom-sharedstorageworkletglobalscope-interestgroups\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>interestGroups()</code></dfn> method steps are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>promise</var> be a new <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#idl-promise\" id=\"ref-for-idl-promise⑧\">promise</a>.</p>"
        },
        {
          "html": "<p>If the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope-check-whether-addmodule-is-finished\" id=\"ref-for-sharedstorageworkletglobalscope-check-whether-addmodule-is-finished②\">check whether addModule is finished</a> for <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#sharedstorage\" id=\"ref-for-sharedstorage③\">SharedStorage</a></code>'s associated <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope\" id=\"ref-for-sharedstorageworkletglobalscope①⑧\">SharedStorageWorkletGlobalScope</a></code> is false, return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with②③\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror②⑨\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>globalObject</var> be the <a data-link-type=\"dfn\" href=\"https://tc39.es/ecma262/#current-realm\" id=\"ref-for-current-realm①\">current realm</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-realm-global\" id=\"ref-for-concept-realm-global②\">global object</a>.</p>"
        },
        {
          "html": "<p>Let <var>context</var> be <var>globalObject</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#window-bc\" id=\"ref-for-window-bc③\">browsing context</a>.</p>"
        },
        {
          "html": "<p>If <var>context</var> is null, return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with②④\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror③⓪\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>document</var> be <var>context</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-window\" id=\"ref-for-nav-window\">active window</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#concept-document-window\" id=\"ref-for-concept-document-window④\">associated document</a>.</p>"
        },
        {
          "html": "<p>If <var>document</var> is not <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active\" id=\"ref-for-fully-active①\">fully active</a>, return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with②⑤\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror③①\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>workletDataOrigin</var> be <a data-link-type=\"dfn\" href=\"https://tc39.es/ecma262/#current-realm\" id=\"ref-for-current-realm②\">current realm</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-realm-settings-object\" id=\"ref-for-concept-realm-settings-object⑥\">settings object</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin\" id=\"ref-for-concept-settings-object-origin①⑨\">origin</a>.</p>"
        },
        {
          "html": "Run the following steps <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel①\">in parallel</a>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>interestGroups</var> be the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/turtledove/#get-storage-interest-groups-for-owner\" id=\"ref-for-get-storage-interest-groups-for-owner\">get storage interest groups for owner</a> given <var>workletDataOrigin</var>.</p>"
            },
            {
              "html": "If <var>interestGroups</var> is failure:",
              "rationale": "queue",
              "steps": [
                {
                  "html": "<p><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task\" id=\"ref-for-queue-a-global-task⑧\">Queue a global task</a> on the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source⑥\">DOM manipulation task source</a>, given <var>realm</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-realm-global\" id=\"ref-for-concept-realm-global③\">global object</a>, to <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\" id=\"ref-for-reject①①\">reject</a> <var>promise</var> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror③②\">TypeError</a></code>.</p>"
                }
              ]
            },
            {
              "html": "Otherwise:",
              "rationale": "queue",
              "steps": [
                {
                  "html": "<p><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task\" id=\"ref-for-queue-a-global-task⑨\">Queue a global task</a> on the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source⑦\">DOM manipulation task source</a>, given <var>realm</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-realm-global\" id=\"ref-for-concept-realm-global④\">global object</a>, to <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#resolve\" id=\"ref-for-resolve⑧\">resolve</a> <var>promise</var> with <var>interestGroups</var>.</p>"
                }
              ]
            }
          ]
        },
        {
          "html": "<p>Return <var>promise</var>.</p>"
        }
      ]
    },
    {
      "name": "SharedStorageWorkletGlobalScope/sharedStorage",
      "href": "https://wicg.github.io/shared-storage/#dom-sharedstorageworkletglobalscope-sharedstorage",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"SharedStorageWorkletGlobalScope\" data-dfn-type=\"attribute\" data-export=\"\" id=\"dom-sharedstorageworkletglobalscope-sharedstorage\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>sharedStorage</code></dfn> <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#getter-steps\" id=\"ref-for-getter-steps\">getter steps</a> are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this②⓪\">this</a>'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope-addmodule-success\" id=\"ref-for-sharedstorageworkletglobalscope-addmodule-success④\">addModule success</a> is true, return <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this②①\">this</a>'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope-shared-storage-instance\" id=\"ref-for-sharedstorageworkletglobalscope-shared-storage-instance\">shared storage instance</a>.</p>"
        },
        {
          "html": "<p>Otherwise, throw a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror③③\">TypeError</a></code>.</p>"
        }
      ]
    },
    {
      "name": "SharedStorageWorkletGlobalScope/navigator",
      "href": "https://wicg.github.io/shared-storage/#dom-sharedstorageworkletglobalscope-navigator",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"SharedStorageWorkletGlobalScope\" data-dfn-type=\"attribute\" data-export=\"\" id=\"dom-sharedstorageworkletglobalscope-navigator\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>navigator</code></dfn> <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#getter-steps\" id=\"ref-for-getter-steps①\">getter steps</a> are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this②②\">this</a>'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope-addmodule-success\" id=\"ref-for-sharedstorageworkletglobalscope-addmodule-success⑤\">addModule success</a> is true, return <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this②③\">this</a>'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope-navigator-instance\" id=\"ref-for-sharedstorageworkletglobalscope-navigator-instance\">navigator instance</a>.</p>"
        },
        {
          "html": "<p>Otherwise, throw a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror③④\">TypeError</a></code>.</p>"
        }
      ]
    },
    {
      "name": "privateAggregation getter",
      "html": "The <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#dom-sharedstorageworkletglobalscope-privateaggregation\" id=\"ref-for-dom-sharedstorageworkletglobalscope-privateaggregation①\">privateAggregation</a></code> <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#getter-steps\" id=\"ref-for-getter-steps②\">getter steps</a> are to:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#get-the-privateaggregation\" id=\"ref-for-get-the-privateaggregation\">Get the privateAggregation</a> given <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this②④\">this</a>.</p>"
        }
      ]
    },
    {
      "name": "SharedStorageWorkletGlobalScope/check whether addModule is finished",
      "href": "https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope-check-whether-addmodule-is-finished",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-for=\"SharedStorageWorkletGlobalScope\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"sharedstorageworkletglobalscope-check-whether-addmodule-is-finished\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">check whether addModule is finished</dfn>, the step is:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Return the value of <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope-addmodule-success\" id=\"ref-for-sharedstorageworkletglobalscope-addmodule-success⑥\">addModule success</a>.</p>"
        }
      ]
    },
    {
      "name": "validate reporting metadata",
      "href": "https://wicg.github.io/shared-storage/#validate-reporting-metadata",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"validate-reporting-metadata\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">validate reporting metadata</dfn>, given an <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-object\" id=\"ref-for-idl-object③\">object</a></code> <var>reportingMetadata</var>, run the following steps:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If <var>reportingMetadata</var> is not a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-dictionary\" id=\"ref-for-dfn-dictionary③\">dictionary</a>, return false.</p>"
        },
        {
          "html": "<p>If <var>reportingMetadata</var> is <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org#map-is-empty\" id=\"ref-for-map-is-empty②\">empty</a>, return true.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-iterate\" id=\"ref-for-map-iterate①\">For each</a> <var>eventType</var> → <var>urlString</var> of <var>reportingMetadata</var>, if the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#get-the-canonical-url-string-if-valid\" id=\"ref-for-get-the-canonical-url-string-if-valid①\">get the canonical URL string if valid</a> with <var>urlString</var> is undefined, return false.</p>"
        },
        {
          "html": "<p>Return true.</p>"
        }
      ]
    },
    {
      "name": "get the canonical URL string if valid",
      "href": "https://wicg.github.io/shared-storage/#get-the-canonical-url-string-if-valid",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"get-the-canonical-url-string-if-valid\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">get the canonical URL string if valid</dfn>, given a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#string\" id=\"ref-for-string①②\">string</a> <var>urlString</var>, run the following steps:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>url</var> be the result of running a <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-parser\" id=\"ref-for-concept-url-parser④\">URL parser</a> on <var>urlString</var>.</p>"
        },
        {
          "html": "<p>If <var>url</var> is not a valid <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url\" id=\"ref-for-concept-url①②\">URL</a>, return undefined.</p>"
        },
        {
          "html": "<p>Otherwise, return the result of running a <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-serializer\" id=\"ref-for-concept-url-serializer\">URL serializer</a> on <var>url</var>.</p>"
        }
      ]
    },
    {
      "name": "register reporting metadata",
      "href": "https://wicg.github.io/shared-storage/#register-reporting-metadata",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"register-reporting-metadata\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">register reporting metadata</dfn>, given an <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-object\" id=\"ref-for-idl-object④\">object</a></code> <var>reportingMetadata</var> and a <a data-link-type=\"dfn\" href=\"https://wicg.github.io/fenced-frame/#fenced-frame-config\" id=\"ref-for-fenced-frame-config②\">fenced frame config</a> <var>fencedFrameConfigStruct</var>, run the following steps:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If <var>reportingMetadata</var> is <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org#map-is-empty\" id=\"ref-for-map-is-empty③\">empty</a>, return.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert①⑨\">Assert</a>: <var>reportingMetadata</var> is a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-dictionary\" id=\"ref-for-dfn-dictionary④\">dictionary</a>.</p>"
        },
        {
          "html": "<p>Let <var>reportingUrlMap</var> be an <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org#map-is-empty\" id=\"ref-for-map-is-empty④\">empty</a> <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#ordered-map\" id=\"ref-for-ordered-map②\">map</a>.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-iterate\" id=\"ref-for-map-iterate②\">For each</a> <var>eventType</var> → <var>urlString</var> of <var>reportingMetadata</var>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>url</var> be the result of running a <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-parser\" id=\"ref-for-concept-url-parser⑤\">URL parser</a> on <var>urlString</var>.</p>"
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert②⓪\">Assert</a>: <var>url</var> is a valid <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url\" id=\"ref-for-concept-url①③\">URL</a>.</p>"
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-set\" id=\"ref-for-map-set①\">Set</a> <var>reportingUrlMap</var>[<var>eventType</var>] to <var>url</var>.</p>"
            }
          ]
        }
      ]
    },
    {
      "name": "get the default selectURL index",
      "href": "https://wicg.github.io/shared-storage/#get-the-default-selecturl-index",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"get-the-default-selecturl-index\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">get the default selectURL index</dfn>, given <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/media-source/#dom-appendmode-sequence\" id=\"ref-for-dom-appendmode-sequence①\">sequence</a></code>&lt;<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-USVString\" id=\"ref-for-idl-USVString④\">USVString</a></code>&gt; <var>urls</var>, run the following steps:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Return 0.</p>"
        }
      ]
    },
    {
      "name": "determine remaining navigation budget",
      "href": "https://wicg.github.io/shared-storage/#determine-remaining-navigation-budget",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"determine-remaining-navigation-budget\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">determine remaining navigation budget</dfn>, given an <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object\" id=\"ref-for-environment-settings-object⑧\">environment settings object</a> <var>environment</var> and a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#site\" id=\"ref-for-site⑧\">site</a> <var>site</var>, run the following steps:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert②①\">Assert</a>: <var>site</var> is not an <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-opaque\" id=\"ref-for-concept-origin-opaque②\">opaque origin</a>.</p>"
        },
        {
          "html": "<p>Let <var>maxBits</var> be the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#user-agent\" id=\"ref-for-user-agent⑤\">user agent</a>'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#navigation-entropy-allowance\" id=\"ref-for-navigation-entropy-allowance④\">navigation entropy allowance</a>.</p>"
        },
        {
          "html": "<p>If the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#user-agent\" id=\"ref-for-user-agent⑥\">user agent</a>'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-navigation-budget-table\" id=\"ref-for-shared-storage-navigation-budget-table①\">shared storage navigation budget table</a> does not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists①②\">contain</a> <var>site</var>, then return <var>maxBits</var>.</p>"
        },
        {
          "html": "<p>Otherwise, let <var>ledger</var> be <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#user-agent\" id=\"ref-for-user-agent⑦\">user agent</a>'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-navigation-budget-table\" id=\"ref-for-shared-storage-navigation-budget-table②\">shared storage navigation budget table</a>[<var>site</var>].</p>"
        },
        {
          "html": "<p>Let <var>debitSum</var> be 0.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-iterate\" id=\"ref-for-map-iterate③\">For each</a> <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-item\" id=\"ref-for-list-item\">item</a> <var>bitDebit</var> in <var>ledger</var>, do the following steps:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>debit</var> be <var>bitDebit</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#bit-debit-bits\" id=\"ref-for-bit-debit-bits\">bits</a>.</p>"
            },
            {
              "html": "<p>If the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#check-whether-a-bit-debit-is-expired\" id=\"ref-for-check-whether-a-bit-debit-is-expired\">check whether a bit debit is expired</a> with <var>environment</var> and <var>bitDebit</var> is false, then increment <var>debitSum</var> by <var>debit</var>.</p>"
            }
          ]
        },
        {
          "html": "<p>Return <var>maxBits</var> − <var>debitSum</var>.</p>"
        }
      ]
    },
    {
      "name": "check whether a bit debit is expired",
      "href": "https://wicg.github.io/shared-storage/#check-whether-a-bit-debit-is-expired",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"check-whether-a-bit-debit-is-expired\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">check whether a bit debit is expired</dfn>, given an <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object\" id=\"ref-for-environment-settings-object⑨\">environment settings object</a> <var>environment</var> and a <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#bit-debit\" id=\"ref-for-bit-debit④\">bit debit</a> <var>bitDebit</var>, run the following steps:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>epochLength</var> be the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#user-agent\" id=\"ref-for-user-agent⑧\">user agent</a>'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#navigation-budget-lifetime\" id=\"ref-for-navigation-budget-lifetime①\">navigation budget lifetime</a>.</p>"
        },
        {
          "html": "<p>Let <var>currentTime</var> be <var>environment</var>’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/hr-time/#dfn-eso-current-wall-time\" id=\"ref-for-dfn-eso-current-wall-time\">current wall time</a>.</p>"
        },
        {
          "html": "<p>Let <var>threshold</var> be <var>currentTime</var> − <var>epochLength</var>.</p>"
        },
        {
          "html": "<p>If <var>bitDebit</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#bit-debit-timestamp\" id=\"ref-for-bit-debit-timestamp③\">timestamp</a> is less than <var>threshold</var>, return true.</p>"
        },
        {
          "html": "<p>Otherwise, return false.</p>"
        }
      ]
    },
    {
      "name": "charge shared storage navigation budget",
      "href": "https://wicg.github.io/shared-storage/#charge-shared-storage-navigation-budget",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"charge-shared-storage-navigation-budget\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">charge shared storage navigation budget</dfn> during a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#beginning-navigation\" id=\"ref-for-beginning-navigation②\">navigation</a> with <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#navigable\" id=\"ref-for-navigable②\">navigable</a> <var>navigable</var> and <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://dom.spec.whatwg.org/#document\" id=\"ref-for-document①\">Document</a></code> <var>sourceDocument</var>, run the following steps:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If <var>navigable</var> is not a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-top\" id=\"ref-for-nav-top⑥\">top-level traversable</a>, return.</p>"
        },
        {
          "html": "<p>Let <var>currentNavigable</var> be <var>sourceDocument</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#node-navigable\" id=\"ref-for-node-navigable①\">node navigable</a>.</p>"
        },
        {
          "html": "While <var>currentNavigable</var> is not null:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>site</var> be the result of running <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#obtain-a-site\" id=\"ref-for-obtain-a-site②\">obtain a site</a> with <var>currentNavigable</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document\" id=\"ref-for-nav-document①\">active document</a>'s <a data-link-type=\"dfn\" href=\"https://dom.spec.whatwg.org/#concept-document-origin\" id=\"ref-for-concept-document-origin①\">origin</a>.</p>"
            },
            {
              "html": "<p>Let <var>instance</var> be <var>currentNavigable</var>’s <a data-link-type=\"dfn\" href=\"https://dom.spec.whatwg.org/#concept-node-document\" id=\"ref-for-concept-node-document③\">node document</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#concept-document-bc\" id=\"ref-for-concept-document-bc③\">browsing context</a>'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/fenced-frame/#browsing-context-fenced-frame-config-instance\" id=\"ref-for-browsing-context-fenced-frame-config-instance⑤\">fenced frame config instance</a>.</p>"
            },
            {
              "html": "<p>Set <var>currentNavigable</var> to <var>currentNavigable</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-parent\" id=\"ref-for-nav-parent\">parent</a>.</p>"
            },
            {
              "html": "<p>If <var>instance</var> is null or <var>site</var> is an <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-opaque\" id=\"ref-for-concept-origin-opaque③\">opaque origin</a>, then <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue\">continue</a>.</p>"
            },
            {
              "html": "<p>Let <var>pendingBits</var> be <var>instance</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#pending-shared-storage-budget-debit\" id=\"ref-for-pending-shared-storage-budget-debit①\">pending shared storage budget debit</a>.</p>"
            },
            {
              "html": "<p>If <var>pendingBits</var> is not greater than 0, then <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue①\">continue</a>.</p>"
            },
            {
              "html": "<p>Let <var>ledger</var> be <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#user-agent\" id=\"ref-for-user-agent①⓪\">user agent</a>'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-navigation-budget-table\" id=\"ref-for-shared-storage-navigation-budget-table⑤\">shared storage navigation budget table</a>[<var>site</var>].</p>"
            },
            {
              "html": "<p>Let <var>bitDebit</var> be a new <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#bit-debit\" id=\"ref-for-bit-debit⑥\">bit debit</a>.</p>"
            },
            {
              "html": "<p>Set <var>bitDebit</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#bit-debit-bits\" id=\"ref-for-bit-debit-bits③\">bits</a> to <var>pendingBits</var>.</p>"
            },
            {
              "html": "<p>Let <var>currentTime</var> be the <a data-link-type=\"dfn\" href=\"https://w3c.github.io/hr-time/#dfn-current-wall-time\" id=\"ref-for-dfn-current-wall-time①\">current wall time</a>.</p>"
            },
            {
              "html": "<p>Set <var>bitDebit</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#bit-debit-timestamp\" id=\"ref-for-bit-debit-timestamp④\">timestamp</a> to <var>currentTime</var>.</p>"
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-append\" id=\"ref-for-list-append③\">Append</a> <var>bitDebit</var> to <var>ledger</var>.</p>"
            },
            {
              "html": "<p>Set <var>pendingBits</var> to 0.</p>"
            }
          ]
        }
      ]
    },
    {
      "name": "purge expired bit debits from all navigation entropy ledgers",
      "href": "https://wicg.github.io/shared-storage/#purge-expired-bit-debits-from-all-navigation-entropy-ledgers",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"purge-expired-bit-debits-from-all-navigation-entropy-ledgers\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">purge expired bit debits from all navigation entropy ledgers</dfn>, run the following steps:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-iterate\" id=\"ref-for-map-iterate④\">For each</a> <var>origin</var> → <var>ledger</var> of <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#user-agent\" id=\"ref-for-user-agent①②\">user agent</a>'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-navigation-budget-table\" id=\"ref-for-shared-storage-navigation-budget-table⑥\">shared storage navigation budget table</a>:",
          "rationale": "for",
          "steps": [
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-iterate\" id=\"ref-for-map-iterate⑤\">For each</a> <var>bitDebit</var> in <var>ledger</var>, if the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#check-whether-a-bit-debit-is-expired\" id=\"ref-for-check-whether-a-bit-debit-is-expired①\">check whether a bit debit is expired</a> with <var>bitDebit</var> is true, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-remove\" id=\"ref-for-list-remove\">remove</a> <var>bitDebit</var> from <var>ledger</var>.</p>"
            }
          ]
        }
      ]
    },
    {
      "html": "Modify the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#initialize-the-navigable\" id=\"ref-for-initialize-the-navigable\">initialize the navigable</a> algorithm by adding the following steps at the end:",
      "rationale": "if",
      "steps": [
        {
          "html": "If <var>parent</var> is null and <var>navigable</var> is a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-traversable\" id=\"ref-for-nav-traversable③\">traversable navigable</a>, then:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>newPageBudget</var> be a <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#traversable-navigable-shared-storage-page-budget\" id=\"ref-for-traversable-navigable-shared-storage-page-budget①\">shared storage page budget</a> with an empty <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-page-budget-site-budget-map\" id=\"ref-for-shared-storage-page-budget-site-budget-map\">site budget map</a>.</p>"
            },
            {
              "html": "<p>Set <var>newPageBudget</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-page-budget-overall-budget\" id=\"ref-for-shared-storage-page-budget-overall-budget\">overall budget</a> to <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#overall-page-entropy-allowance\" id=\"ref-for-overall-page-entropy-allowance\">overall page entropy allowance</a>.</p>"
            },
            {
              "html": "<p>Set <var>navigable</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#traversable-navigable-page-budget\" id=\"ref-for-traversable-navigable-page-budget\">page budget</a> to <var>newPageBudget</var>.</p>"
            }
          ]
        }
      ]
    },
    {
      "name": "get the index for a saved query",
      "href": "https://wicg.github.io/shared-storage/#get-the-index-for-a-saved-query",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"get-the-index-for-a-saved-query\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">get the index for a saved query</dfn>, given <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#navigable\" id=\"ref-for-navigable⑤\">navigable</a> <var>navigable</var>, <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-origin\" id=\"ref-for-concept-url-origin①⑨\">origin</a> <var>origin</var>, <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url\" id=\"ref-for-concept-url①⑦\">URL</a> <var>moduleURLRecord</var>, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#string\" id=\"ref-for-string①⑤\">string</a> <var>operationName</var>, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#string\" id=\"ref-for-string①⑥\">string</a> <var>savedQueryName</var>, and <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-task\" id=\"ref-for-concept-task①\">task</a> <var>callbackTask</var>:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>topLevelTraversable</var> be the result of running <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#nav-top\" id=\"ref-for-nav-top①⓪\">get the top-level traversable</a> for <var>navigable</var>.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert②②\">Assert</a> that <var>topLevelTraversable</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#traversable-navigable-page-budget\" id=\"ref-for-traversable-navigable-page-budget①\">page budget</a> is not null.</p>"
        },
        {
          "html": "If <var>topLevelTraversable</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#traversable-navigable-page-budget\" id=\"ref-for-traversable-navigable-page-budget②\">page budget</a>'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-page-budget-saved-query-map\" id=\"ref-for-shared-storage-page-budget-saved-query-map\">saved query map</a> does not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists①③\">contain</a> (<var>origin</var>, <var>moduleURLRecord</var>, <var>operationName</var>, <var>savedQueryName</var>), then:",
          "rationale": "set",
          "steps": [
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-set\" id=\"ref-for-map-set②\">Set</a> <var>topLevelTraversable</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#traversable-navigable-page-budget\" id=\"ref-for-traversable-navigable-page-budget③\">page budget</a>'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-page-budget-saved-query-map\" id=\"ref-for-shared-storage-page-budget-saved-query-map①\">saved query map</a>[(<var>origin</var>, <var>moduleURLRecord</var>, <var>operationName</var>, <var>savedQueryName</var>)] to a new <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-page-budget-saved-query-data\" id=\"ref-for-shared-storage-page-budget-saved-query-data①\">saved query data</a> struct <var>queryData</var>.</p>"
            },
            {
              "html": "<p>Set <var>queryData</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#saved-query-data-index\" id=\"ref-for-saved-query-data-index\">index</a> value to -1.</p>"
            },
            {
              "html": "<p>Return \"pending current operation\".</p>"
            }
          ]
        },
        {
          "html": "<p>Let <var>savedIndex</var> be <var>topLevelTraversable</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#traversable-navigable-page-budget\" id=\"ref-for-traversable-navigable-page-budget④\">page budget</a>'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-page-budget-saved-query-map\" id=\"ref-for-shared-storage-page-budget-saved-query-map②\">saved query map</a>[(<var>origin</var>, <var>moduleURLRecord</var>, <var>operationName</var>, <var>savedQueryName</var>)]'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#saved-query-data-index\" id=\"ref-for-saved-query-data-index①\">index</a>.</p>"
        },
        {
          "html": "If <var>savedIndex</var> is -1:",
          "rationale": "enqueue",
          "steps": [
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#queue-enqueue\" id=\"ref-for-queue-enqueue\">Enqueue</a> <var>callbackTask</var> to <var>queryData</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#saved-query-data-callbacks\" id=\"ref-for-saved-query-data-callbacks\">callbacks</a>.</p>"
            },
            {
              "html": "<p>Return \"pending callback\".</p>"
            }
          ]
        },
        {
          "html": "<p>Return <var>savedIndex</var>.</p>"
        }
      ]
    },
    {
      "name": "store the index for a saved query",
      "href": "https://wicg.github.io/shared-storage/#store-the-index-for-a-saved-query",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"store-the-index-for-a-saved-query\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">store the index for a saved query</dfn>, given <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#window\" id=\"ref-for-window①②\">Window</a></code> <var>window</var>, <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#navigable\" id=\"ref-for-navigable⑥\">navigable</a> <var>navigable</var>, <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-origin\" id=\"ref-for-concept-url-origin②⓪\">origin</a> <var>origin</var>, <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url\" id=\"ref-for-concept-url①⑧\">URL</a> <var>moduleURLRecord</var>, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#string\" id=\"ref-for-string①⑦\">string</a> <var>operationName</var>, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#string\" id=\"ref-for-string①⑧\">string</a> <var>savedQueryName</var>, and <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-unsigned-long\" id=\"ref-for-idl-unsigned-long⑤\">unsigned long</a></code> <var>index</var>:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>topLevelTraversable</var> be the result of running <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#nav-top\" id=\"ref-for-nav-top①①\">get the top-level traversable</a> for <var>navigable</var>.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert②③\">Assert</a> that <var>topLevelTraversable</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#traversable-navigable-page-budget\" id=\"ref-for-traversable-navigable-page-budget⑤\">page budget</a> is not null.</p>"
        },
        {
          "html": "<p>Let <var>queryData</var> be <var>topLevelTraversable</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#traversable-navigable-page-budget\" id=\"ref-for-traversable-navigable-page-budget⑥\">page budget</a>'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-page-budget-saved-query-map\" id=\"ref-for-shared-storage-page-budget-saved-query-map③\">saved query map</a>[(<var>origin</var>, <var>moduleURLRecord</var>, <var>operationName</var>, <var>savedQueryName</var>)].</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-set\" id=\"ref-for-map-set③\">Set</a> <var>queryData</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#saved-query-data-index\" id=\"ref-for-saved-query-data-index②\">index</a> to <var>index</var>.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-while\" id=\"ref-for-iteration-while\">While</a> <var>queryData</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#saved-query-data-callbacks\" id=\"ref-for-saved-query-data-callbacks①\">callbacks</a> is not empty:",
          "rationale": "dequeue",
          "steps": [
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#queue-dequeue\" id=\"ref-for-queue-dequeue\">Dequeue</a> the next <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-task\" id=\"ref-for-concept-task④\">task</a> <var>callbackTask</var> from <var>queryData</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#saved-query-data-callbacks\" id=\"ref-for-saved-query-data-callbacks②\">callbacks</a>, and <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task\" id=\"ref-for-queue-a-global-task①⓪\">queue a global task</a> on the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source⑧\">DOM manipulation task source</a>, given <var>window</var>, to run the steps of <var>callbackTask</var>, given <var>index</var>.</p>"
            }
          ]
        }
      ]
    },
    {
      "name": "obtain a callback to process the saved index result",
      "href": "https://wicg.github.io/shared-storage/#obtain-a-callback-to-process-the-saved-index-result",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"obtain-a-callback-to-process-the-saved-index-result\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">obtain a callback to process the saved index result</dfn>, given <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#window\" id=\"ref-for-window①③\">Window</a></code> <var>window</var>, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list⑧\">list</a> of <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#dictdef-sharedstorageurlwithmetadata\" id=\"ref-for-dictdef-sharedstorageurlwithmetadata⑤\">SharedStorageUrlWithMetadata</a></code>s <var>urlList</var>, <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#idl-promise\" id=\"ref-for-idl-promise⑨\">promise</a> <var>promise</var>, perform the following steps. They return an algorithm.",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "Let <var>processIndexTask</var> be an algorithm to perform the following steps, given an <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-unsigned-long\" id=\"ref-for-idl-unsigned-long⑥\">unsigned long</a></code> <var>index</var>:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>index</var> is greater than <var>urlList</var>’s <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-size\" id=\"ref-for-list-size⑨\">size</a>, then <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task\" id=\"ref-for-queue-a-global-task①①\">queue a global task</a> on the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source⑨\">DOM manipulation task source</a>, given <var>window</var>, to <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\" id=\"ref-for-reject①②\">reject</a> <var>promise</var> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror③⑤\">TypeError</a></code>.</p>"
            },
            {
              "html": "<p>Otherwise, <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task\" id=\"ref-for-queue-a-global-task①②\">queue a global task</a> on the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source①⓪\">DOM manipulation task source</a>, given <var>window</var>, to <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#resolve\" id=\"ref-for-resolve⑨\">resolve</a> <var>promise</var> with <var>index</var>.</p>"
            }
          ]
        },
        {
          "html": "<p>Return <var>processIndexTask</var>.</p>"
        }
      ]
    },
    {
      "name": "charge shared storage top-level traversable budgets",
      "href": "https://wicg.github.io/shared-storage/#charge-shared-storage-top-level-traversable-budgets",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"charge-shared-storage-top-level-traversable-budgets\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">charge shared storage top-level traversable budgets</dfn> given a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#navigable\" id=\"ref-for-navigable⑦\">navigable</a> <var>navigable</var>, <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#site\" id=\"ref-for-site①①\">site</a> <var>site</var>, and double <var>pendingBits</var>, run the following steps:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>topLevelTraversable</var> be the result of running <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#nav-top\" id=\"ref-for-nav-top①③\">get the top-level traversable</a> for <var>navigable</var>.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert②④\">Assert</a> that <var>topLevelTraversable</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#traversable-navigable-page-budget\" id=\"ref-for-traversable-navigable-page-budget⑦\">page budget</a> is not null.</p>"
        },
        {
          "html": "<p>If <var>pendingBits</var> is greater than <var>topLevelTraversable</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#traversable-navigable-page-budget\" id=\"ref-for-traversable-navigable-page-budget⑧\">page budget</a>'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-page-budget-overall-budget\" id=\"ref-for-shared-storage-page-budget-overall-budget①\">overall budget</a>, then return false and abort these steps.</p>"
        },
        {
          "html": "<p>If <var>topLevelTraversable</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#traversable-navigable-page-budget\" id=\"ref-for-traversable-navigable-page-budget⑨\">page budget</a>'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-page-budget-site-budget-map\" id=\"ref-for-shared-storage-page-budget-site-budget-map①\">site budget map</a> does not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists①④\">contain</a> <var>site</var>, then <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-set\" id=\"ref-for-map-set④\">set</a> <var>topLevelTraversable</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#traversable-navigable-page-budget\" id=\"ref-for-traversable-navigable-page-budget①⓪\">page budget</a>'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-page-budget-site-budget-map\" id=\"ref-for-shared-storage-page-budget-site-budget-map②\">site budget map</a> [<var>site</var>] to <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#site-page-entropy-allowance\" id=\"ref-for-site-page-entropy-allowance\">site page entropy allowance</a>.</p>"
        },
        {
          "html": "<p>If <var>pendingBits</var> is greater than <var>topLevelTraversable</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#traversable-navigable-page-budget\" id=\"ref-for-traversable-navigable-page-budget①①\">page budget</a>'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-page-budget-site-budget-map\" id=\"ref-for-shared-storage-page-budget-site-budget-map③\">site budget map</a> [<var>site</var>], then return false and abort these steps.</p>"
        },
        {
          "html": "<p>Decrement <var>topLevelTraversable</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#traversable-navigable-page-budget\" id=\"ref-for-traversable-navigable-page-budget①②\">page budget</a>'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-page-budget-site-budget-map\" id=\"ref-for-shared-storage-page-budget-site-budget-map④\">site budget map</a> [<var>site</var>] by <var>pendingBits</var>.</p>"
        },
        {
          "html": "<p>Decrement <var>topLevelTraversable</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#traversable-navigable-page-budget\" id=\"ref-for-traversable-navigable-page-budget①③\">page budget</a>'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-page-budget-overall-budget\" id=\"ref-for-shared-storage-page-budget-overall-budget②\">overall budget</a> by <var>pendingBits</var>.</p>"
        },
        {
          "html": "<p>Return true.</p>"
        }
      ]
    },
    {
      "name": "obtain a shared storage shelf",
      "href": "https://wicg.github.io/shared-storage/#obtain-a-shared-storage-shelf",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"obtain-a-shared-storage-shelf\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">obtain a shared storage shelf</dfn>, given a <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-shed\" id=\"ref-for-shared-storage-shed④\">shared storage shed</a> <var>shed</var>, an <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object\" id=\"ref-for-environment-settings-object①⓪\">environment settings object</a> <var>environment</var>, and an <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin\" id=\"ref-for-concept-origin⑥\">origin</a> <var>origin</var>, run these steps:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>allowedInOpaqueOriginContext</var> be false.</p>"
        },
        {
          "html": "<p>If the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#determine-whether-shared-storage-is-allowed-by-context\" id=\"ref-for-determine-whether-shared-storage-is-allowed-by-context④\">determine whether shared storage is allowed by context</a> given <var>environment</var>, <var>origin</var>, and <var>allowedInOpaqueOriginContext</var> is false, then return failure.</p>"
        },
        {
          "html": "<p>If the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#check-if-user-preference-setting-allows-access-to-shared-storage\" id=\"ref-for-check-if-user-preference-setting-allows-access-to-shared-storage④\">check if user preference setting allows access to shared storage</a> given <var>environment</var> and <var>origin</var> is false, then return failure.</p>"
        },
        {
          "html": "<p>If <var>shed</var>[origin] does not exist, then set <var>shed</var>[origin] to the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#create-a-shared-storage-shelf\" id=\"ref-for-create-a-shared-storage-shelf\">create a shared storage shelf</a> with <a data-link-type=\"dfn\" href=\"https://storage.spec.whatwg.org/#storage-type\" id=\"ref-for-storage-type③\">type</a> \"<code>shared</code>\".</p>"
        },
        {
          "html": "<p>Return <var>shed</var>[<var>origin</var>].</p>"
        }
      ]
    },
    {
      "name": "create a shared storage shelf",
      "href": "https://wicg.github.io/shared-storage/#create-a-shared-storage-shelf",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"create-a-shared-storage-shelf\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">create a shared storage shelf</dfn>, run these steps:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>shelf</var> be a new <a data-link-type=\"dfn\" href=\"https://storage.spec.whatwg.org/#storage-shelf\" id=\"ref-for-storage-shelf③\">storage shelf</a>.</p>"
        },
        {
          "html": "<p>Set <var>shelf</var>’s <a data-link-type=\"dfn\" href=\"https://storage.spec.whatwg.org/#bucket-map\" id=\"ref-for-bucket-map①\">bucket map</a>[\"<code>default</code>\"] to the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#create-a-shared-storage-bucket\" id=\"ref-for-create-a-shared-storage-bucket\">create a shared storage bucket</a>.</p>"
        },
        {
          "html": "<p>Return <var>shelf</var>.</p>"
        }
      ]
    },
    {
      "name": "create a shared storage bucket",
      "href": "https://wicg.github.io/shared-storage/#create-a-shared-storage-bucket",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"create-a-shared-storage-bucket\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">create a shared storage bucket</dfn>, run these steps:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>endpoint</var> be the <a data-link-type=\"dfn\" href=\"https://storage.spec.whatwg.org/#storage-endpoint\" id=\"ref-for-storage-endpoint④\">storage endpoint</a> with <a data-link-type=\"dfn\" href=\"https://storage.spec.whatwg.org/#storage-identifier\" id=\"ref-for-storage-identifier①\">storage identifier</a> \"<code>sharedStorage</code>\".</p>"
        },
        {
          "html": "<p>Let <var>bucket</var> be a new <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-bucket\" id=\"ref-for-shared-storage-bucket\">shared storage bucket</a>.</p>"
        },
        {
          "html": "<p>Set <var>bucket</var>’s <a data-link-type=\"dfn\" href=\"https://storage.spec.whatwg.org/#bottle-map\" id=\"ref-for-bottle-map\">bottle map</a>[\"<code>sharedStorage</code>\"] to a new <a data-link-type=\"dfn\" href=\"https://storage.spec.whatwg.org/#storage-bottle\" id=\"ref-for-storage-bottle\">storage bottle</a> whose <a data-link-type=\"dfn\" href=\"https://storage.spec.whatwg.org/#storage-bottle-quota\" id=\"ref-for-storage-bottle-quota\">quota</a> is <var>endpoint</var>’s <a data-link-type=\"dfn\" href=\"https://storage.spec.whatwg.org/#storage-endpoint-quota\" id=\"ref-for-storage-endpoint-quota②\">quota</a>.</p>"
        },
        {
          "html": "<p>Return <var>bucket</var>.</p>"
        }
      ]
    },
    {
      "name": "obtain a shared storage bottle map",
      "href": "https://wicg.github.io/shared-storage/#obtain-a-shared-storage-bottle-map",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"obtain-a-shared-storage-bottle-map\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">obtain a shared storage bottle map</dfn>, given an <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object\" id=\"ref-for-environment-settings-object①①\">environment settings object</a> <var>environment</var> and an <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin\" id=\"ref-for-concept-origin⑦\">origin</a> <var>origin</var>, run these steps:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>shed</var> be the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#user-agent\" id=\"ref-for-user-agent①⑥\">user agent</a>'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-shed\" id=\"ref-for-shared-storage-shed⑥\">shared storage shed</a>.</p>"
        },
        {
          "html": "<p>Let <var>shelf</var> be the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#obtain-a-shared-storage-shelf\" id=\"ref-for-obtain-a-shared-storage-shelf\">obtain a shared storage shelf</a> with <var>shed</var>, <var>environment</var>, and <var>origin</var>.</p>"
        },
        {
          "html": "<p>If <var>shelf</var> is failure, then return failure.</p>"
        },
        {
          "html": "<p>Let <var>bucket</var> be <var>shelf</var>’s <a data-link-type=\"dfn\" href=\"https://storage.spec.whatwg.org/#bucket-map\" id=\"ref-for-bucket-map②\">bucket map</a>[\"<code>default</code>\"].</p>"
        },
        {
          "html": "<p>Let <var>bottle</var> be <var>bucket</var>’s <a data-link-type=\"dfn\" href=\"https://storage.spec.whatwg.org/#bottle-map\" id=\"ref-for-bottle-map②\">bottle map</a>[\"<code>sharedStorage</code>\"].</p>"
        },
        {
          "html": "<p>Let <var>proxyMap</var> be a new <a data-link-type=\"dfn\" href=\"https://storage.spec.whatwg.org/#storage-proxy-map\" id=\"ref-for-storage-proxy-map\">storage proxy map</a> whose <a data-link-type=\"dfn\" href=\"https://storage.spec.whatwg.org/#storage-proxy-map-backing-map\" id=\"ref-for-storage-proxy-map-backing-map\">backing map</a> is <var>bottle</var>’s <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#ordered-map\" id=\"ref-for-ordered-map⑦\">map</a>.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#set-append\" id=\"ref-for-set-append\">Append</a> <var>proxyMap</var> to <var>bottle</var>’s <a data-link-type=\"dfn\" href=\"https://storage.spec.whatwg.org/#storage-bottle-proxy-map-reference-set\" id=\"ref-for-storage-bottle-proxy-map-reference-set\">proxy map reference set</a>.</p>"
        },
        {
          "html": "<p>Return <var>proxyMap</var>.</p>"
        }
      ]
    },
    {
      "name": "shared storage database/store an entry in the database",
      "href": "https://wicg.github.io/shared-storage/#shared-storage-database-store-an-entry-in-the-database",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-for=\"shared storage database\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"shared-storage-database-store-an-entry-in-the-database\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">store an entry in the database</dfn>, given a <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-database-shared-storage-database-queue\" id=\"ref-for-shared-storage-database-shared-storage-database-queue①\">shared storage database queue</a> <var>queue</var>, a <a data-link-type=\"dfn\" href=\"https://storage.spec.whatwg.org/#storage-proxy-map\" id=\"ref-for-storage-proxy-map①\">storage proxy map</a> <var>databaseMap</var>, an <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object\" id=\"ref-for-environment-settings-object①②\">environment settings object</a> <var>environment</var>, a <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#entry-key\" id=\"ref-for-entry-key④\">key</a> <var>key</var>, and a <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#value-struct-value\" id=\"ref-for-value-struct-value①\">value</a> <var>value</var>, run the following steps on <var>queue</var>:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>valueStruct</var> be a new <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#entry-value-struct\" id=\"ref-for-entry-value-struct①\">value struct</a>.</p>"
        },
        {
          "html": "<p>Set <var>valueStruct</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#value-struct-value\" id=\"ref-for-value-struct-value②\">value</a> to <var>value</var>.</p>"
        },
        {
          "html": "<p>Let <var>currentTime</var> be the <var>environment</var>’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/hr-time/#dfn-eso-current-wall-time\" id=\"ref-for-dfn-eso-current-wall-time①\">current wall time</a>.</p>"
        },
        {
          "html": "<p>Set <var>valueStruct</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#value-struct-last-updated\" id=\"ref-for-value-struct-last-updated\">last updated</a> to <var>currentTime</var>.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-set\" id=\"ref-for-map-set⑤\">Set</a> <var>databaseMap</var>[<var>key</var>] to <var>valueStruct</var>.</p>"
        },
        {
          "html": "<p>If <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#an-exception-was-thrown\" id=\"ref-for-an-exception-was-thrown\">an exception was thrown</a>, then return false.</p>"
        },
        {
          "html": "<p>Otherwise, return true.</p>"
        }
      ]
    },
    {
      "name": "shared storage database/retrieve an entry from the database",
      "href": "https://wicg.github.io/shared-storage/#shared-storage-database-retrieve-an-entry-from-the-database",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-for=\"shared storage database\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"shared-storage-database-retrieve-an-entry-from-the-database\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">retrieve an entry from the database</dfn>, given a <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-database-shared-storage-database-queue\" id=\"ref-for-shared-storage-database-shared-storage-database-queue②\">shared storage database queue</a> <var>queue</var>, a <a data-link-type=\"dfn\" href=\"https://storage.spec.whatwg.org/#storage-proxy-map\" id=\"ref-for-storage-proxy-map③\">storage proxy map</a> <var>databaseMap</var>, an <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object\" id=\"ref-for-environment-settings-object①③\">environment settings object</a> <var>environment</var>, and a <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#entry-key\" id=\"ref-for-entry-key⑤\">key</a> <var>key</var>, run the following steps on <var>queue</var>:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If <var>databaseMap</var> does not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists①⑤\">contain</a> <var>key</var>, return undefined.</p>"
        },
        {
          "html": "<p>Let <var>valueStruct</var> be the result of running <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-get\" id=\"ref-for-map-get\">Get</a> on <var>databaseMap</var> with <var>key</var>.</p>"
        },
        {
          "html": "<p>If <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#an-exception-was-thrown\" id=\"ref-for-an-exception-was-thrown①\">an exception was thrown</a>, then return failure.</p>"
        },
        {
          "html": "<p>If the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-database-determine-whether-an-entry-is-expired\" id=\"ref-for-shared-storage-database-determine-whether-an-entry-is-expired\">determine whether an entry is expired</a> with <var>environment</var> and <var>valueStruct</var> is true, return undefined.</p>"
        },
        {
          "html": "<p>Return <var>valueStruct</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#value-struct-value\" id=\"ref-for-value-struct-value③\">value</a>.</p>"
        }
      ]
    },
    {
      "name": "shared storage database/delete an entry from the database",
      "href": "https://wicg.github.io/shared-storage/#shared-storage-database-delete-an-entry-from-the-database",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-for=\"shared storage database\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"shared-storage-database-delete-an-entry-from-the-database\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">delete an entry from the database</dfn>, given a <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-database-shared-storage-database-queue\" id=\"ref-for-shared-storage-database-shared-storage-database-queue③\">shared storage database queue</a> <var>queue</var>, a <a data-link-type=\"dfn\" href=\"https://storage.spec.whatwg.org/#storage-proxy-map\" id=\"ref-for-storage-proxy-map⑤\">storage proxy map</a> <var>databaseMap</var>, and a <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#entry-key\" id=\"ref-for-entry-key⑥\">key</a> <var>key</var>, run the following steps on <var>queue</var>:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-remove\" id=\"ref-for-map-remove\">Remove</a> <var>databaseMap</var>[<var>key</var>].</p>"
        },
        {
          "html": "<p>If <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#an-exception-was-thrown\" id=\"ref-for-an-exception-was-thrown②\">an exception was thrown</a>, then return false.</p>"
        },
        {
          "html": "<p>Return true.</p>"
        }
      ]
    },
    {
      "name": "shared storage database/clear all entries in the database",
      "href": "https://wicg.github.io/shared-storage/#shared-storage-database-clear-all-entries-in-the-database",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-for=\"shared storage database\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"shared-storage-database-clear-all-entries-in-the-database\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">clear all entries in the database</dfn>, given a <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-database-shared-storage-database-queue\" id=\"ref-for-shared-storage-database-shared-storage-database-queue④\">shared storage database queue</a> <var>queue</var> and a <a data-link-type=\"dfn\" href=\"https://storage.spec.whatwg.org/#storage-proxy-map\" id=\"ref-for-storage-proxy-map⑦\">storage proxy map</a> <var>databaseMap</var>, run the following steps on <var>queue</var>:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Run <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-clear\" id=\"ref-for-map-clear\">Clear</a> on <var>databaseMap</var>.</p>"
        },
        {
          "html": "<p>If <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#an-exception-was-thrown\" id=\"ref-for-an-exception-was-thrown③\">an exception was thrown</a>, then return false.</p>"
        },
        {
          "html": "<p>Return true.</p>"
        }
      ]
    },
    {
      "name": "shared storage database/retrieve all entries from the database",
      "href": "https://wicg.github.io/shared-storage/#shared-storage-database-retrieve-all-entries-from-the-database",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-for=\"shared storage database\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"shared-storage-database-retrieve-all-entries-from-the-database\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">retrieve all entries from the database</dfn>, given a <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-database-shared-storage-database-queue\" id=\"ref-for-shared-storage-database-shared-storage-database-queue⑤\">shared storage database queue</a> <var>queue</var> and a <a data-link-type=\"dfn\" href=\"https://storage.spec.whatwg.org/#storage-proxy-map\" id=\"ref-for-storage-proxy-map⑨\">storage proxy map</a> <var>databaseMap</var>, run the following steps on <var>queue</var>:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>values</var> be the result of running <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-getting-the-values\" id=\"ref-for-map-getting-the-values①\">getting the values</a> on <var>databaseMap</var>.</p>"
        },
        {
          "html": "<p>If <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#an-exception-was-thrown\" id=\"ref-for-an-exception-was-thrown④\">an exception was thrown</a>, then return failure.</p>"
        },
        {
          "html": "<p>Return <var>values</var>.</p>"
        }
      ]
    },
    {
      "name": "shared storage database/count entries in the database",
      "href": "https://wicg.github.io/shared-storage/#shared-storage-database-count-entries-in-the-database",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-for=\"shared storage database\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"shared-storage-database-count-entries-in-the-database\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">count entries in the database</dfn>, given a <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-database-shared-storage-database-queue\" id=\"ref-for-shared-storage-database-shared-storage-database-queue⑥\">shared storage database queue</a> <var>queue</var> and a <a data-link-type=\"dfn\" href=\"https://storage.spec.whatwg.org/#storage-proxy-map\" id=\"ref-for-storage-proxy-map①①\">storage proxy map</a> <var>databaseMap</var>, run the following steps on <var>queue</var>:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>size</var> be <var>databaseMap</var>’s <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-size\" id=\"ref-for-map-size②\">size</a>.</p>"
        },
        {
          "html": "<p>If <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#an-exception-was-thrown\" id=\"ref-for-an-exception-was-thrown⑤\">an exception was thrown</a>, then return failure.</p>"
        },
        {
          "html": "<p>Return <var>size</var>.</p>"
        }
      ]
    },
    {
      "name": "shared storage database/purge expired entries from the database",
      "href": "https://wicg.github.io/shared-storage/#shared-storage-database-purge-expired-entries-from-the-database",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-for=\"shared storage database\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"shared-storage-database-purge-expired-entries-from-the-database\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">purge expired entries from the database</dfn>, given a <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-database-shared-storage-database-queue\" id=\"ref-for-shared-storage-database-shared-storage-database-queue⑦\">shared storage database queue</a> <var>queue</var>, a <a data-link-type=\"dfn\" href=\"https://storage.spec.whatwg.org/#storage-proxy-map\" id=\"ref-for-storage-proxy-map①③\">storage proxy map</a> <var>databaseMap</var>, and an <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object\" id=\"ref-for-environment-settings-object①④\">environment settings object</a> <var>environment</var>, run the following steps on <var>queue</var>:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-iterate\" id=\"ref-for-map-iterate⑥\">For each</a> <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#entry-key\" id=\"ref-for-entry-key⑦\">key</a> <var>key</var> in <var>databaseMap</var>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>valueStruct</var> be the result of running <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-get\" id=\"ref-for-map-get①\">Get</a> on <var>databaseMap</var> with <var>key</var>.</p>"
            },
            {
              "html": "<p>If <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#an-exception-was-thrown\" id=\"ref-for-an-exception-was-thrown⑥\">an exception was thrown</a>, then return false.</p>"
            },
            {
              "html": "<p>If the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-database-determine-whether-an-entry-is-expired\" id=\"ref-for-shared-storage-database-determine-whether-an-entry-is-expired①\">determine whether an entry is expired</a> with <var>environment</var> and <var>valueStruct</var> is true, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-remove\" id=\"ref-for-map-remove①\">Remove</a> <var>databaseMap</var>[<var>key</var>].</p>"
            },
            {
              "html": "<p>If <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#an-exception-was-thrown\" id=\"ref-for-an-exception-was-thrown⑦\">an exception was thrown</a>, then return false.</p>"
            }
          ]
        },
        {
          "html": "<p>Return true.</p>"
        }
      ]
    },
    {
      "name": "shared storage database/determine whether an entry is expired",
      "href": "https://wicg.github.io/shared-storage/#shared-storage-database-determine-whether-an-entry-is-expired",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-for=\"shared storage database\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"shared-storage-database-determine-whether-an-entry-is-expired\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">determine whether an entry is expired</dfn>, given an <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object\" id=\"ref-for-environment-settings-object①⑤\">environment settings object</a> <var>environment</var> and a <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#entry-value-struct\" id=\"ref-for-entry-value-struct②\">value struct</a> <var>valueStruct</var>, run the following steps:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>lastUpdated</var> be <var>valueStruct</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#value-struct-last-updated\" id=\"ref-for-value-struct-last-updated①\">last updated</a>.</p>"
        },
        {
          "html": "<p>Let <var>lifetime</var> be <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#user-agent\" id=\"ref-for-user-agent②①\">user agent</a>'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#default-entry-lifetime\" id=\"ref-for-default-entry-lifetime①\">default entry lifetime</a>.</p>"
        },
        {
          "html": "<p>Let <var>expiration</var> be the sum of <var>lastUpdated</var> and <var>lifetime</var>.</p>"
        },
        {
          "html": "<p>Let <var>currentTime</var> be the <var>environment</var>’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/hr-time/#dfn-eso-current-wall-time\" id=\"ref-for-dfn-eso-current-wall-time②\">current wall time</a>.</p>"
        },
        {
          "html": "<p>If <var>expiration</var> is less than or equal to <var>currentTime</var>, return true.</p>"
        },
        {
          "html": "<p>Otherwise, return false.</p>"
        }
      ]
    },
    {
      "name": "Window/sharedStorage getter",
      "href": "https://wicg.github.io/shared-storage/#window-sharedstorage-getter",
      "html": "The <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-for=\"Window\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"window-sharedstorage-getter\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#dom-window-sharedstorage\" id=\"ref-for-dom-window-sharedstorage①\">sharedStorage</a></code> getter</dfn> steps are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this②⑤\">this</a> is <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active\" id=\"ref-for-fully-active②\">fully active</a>, return <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this②⑥\">this</a>'s <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#dom-window-sharedstorage\" id=\"ref-for-dom-window-sharedstorage②\">sharedStorage</a></code>.</p>"
        },
        {
          "html": "<p>Otherwise, return null.</p>"
        }
      ]
    },
    {
      "name": "SharedStorage/selectURL(name, urls, options)",
      "href": "https://wicg.github.io/shared-storage/#dom-sharedstorage-selecturl",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"SharedStorage\" data-dfn-type=\"method\" data-export=\"\" data-lt=\"selectURL(name, urls, options)|selectURL(name, urls)\" id=\"dom-sharedstorage-selecturl\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>selectURL(<var>name</var>, <var>urls</var>, <var>options</var>)</code></dfn> method steps are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>sharedStorage</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this②⑦\">this</a>.</p>"
        },
        {
          "html": "<p>Return <var>sharedStorage</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#dom-sharedstorage-worklet\" id=\"ref-for-dom-sharedstorage-worklet①\">worklet</a></code>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#dom-sharedstorageworklet-selecturl\" id=\"ref-for-dom-sharedstorageworklet-selecturl①⑨\">selectURL</a></code>(<var>name</var>, <var>urls</var>, <var>options</var>).</p>"
        }
      ]
    },
    {
      "name": "SharedStorage/run(name, options)",
      "href": "https://wicg.github.io/shared-storage/#dom-sharedstorage-run",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"SharedStorage\" data-dfn-type=\"method\" data-export=\"\" data-lt=\"run(name, options)|run(name)\" id=\"dom-sharedstorage-run\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>run(<var>name</var>, <var>options</var>)</code></dfn> method steps are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>sharedStorage</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this②⑧\">this</a>.</p>"
        },
        {
          "html": "<p>Return <var>sharedStorage</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#dom-sharedstorage-worklet\" id=\"ref-for-dom-sharedstorage-worklet②\">worklet</a></code>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#dom-sharedstorageworklet-run\" id=\"ref-for-dom-sharedstorageworklet-run⑦\">run</a></code>(<var>name</var>, <var>options</var>).</p>"
        }
      ]
    },
    {
      "name": "SharedStorage/createWorklet(moduleURL, options)",
      "href": "https://wicg.github.io/shared-storage/#dom-sharedstorage-createworklet",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"SharedStorage\" data-dfn-type=\"method\" data-export=\"\" data-lt=\"createWorklet(moduleURL, options)|createWorklet(moduleURL)\" id=\"dom-sharedstorage-createworklet\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>createWorklet(<var>moduleURL</var>, <var>options</var>)</code></dfn> method steps are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>sharedStorageWorklet</var> be a new <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworklet\" id=\"ref-for-sharedstorageworklet②⑥\">SharedStorageWorklet</a></code>.</p>"
        },
        {
          "html": "<p>If <var>options</var> <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists①⑥\">contains</a> \"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#dom-sharedstorageworkletoptions-dataorigin\" id=\"ref-for-dom-sharedstorageworkletoptions-dataorigin\">dataOrigin</a></code>\", set <var>sharedStorageWorklet</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworklet-data-origin\" id=\"ref-for-sharedstorageworklet-data-origin⑧\">data origin</a> to <var>options</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#dom-sharedstorageworkletoptions-dataorigin\" id=\"ref-for-dom-sharedstorageworkletoptions-dataorigin①\">dataOrigin</a></code>\"].</p>"
        },
        {
          "html": "<p>Let <var>addModulePromise</var> be the result of invoking sharedStorageWorklet.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/worklets.html#dom-worklet-addmodule\" id=\"ref-for-dom-worklet-addmodule①①\">addModule</a></code>(<var>moduleURL</var>, <var>options</var>).</p>"
        },
        {
          "html": "<p>Let <var>resultPromise</var> be a new <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#idl-promise\" id=\"ref-for-idl-promise②⓪\">promise</a>.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#upon-fulfillment\" id=\"ref-for-upon-fulfillment②\">Upon fulfillment</a> of <var>addModulePromise</var>, <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#resolve\" id=\"ref-for-resolve①⓪\">resolve</a> <var>resultPromise</var> to <var>sharedStorageWorklet</var>.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#upon-rejection\" id=\"ref-for-upon-rejection②\">Upon rejection</a> of <var>addModulePromise</var>, <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\" id=\"ref-for-reject①③\">reject</a> <var>resultPromise</var> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror③⑥\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>Return <var>resultPromise</var>.</p>"
        }
      ]
    },
    {
      "name": "SharedStorage/set(key, value, options)",
      "href": "https://wicg.github.io/shared-storage/#dom-sharedstorage-set",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"SharedStorage\" data-dfn-type=\"method\" data-export=\"\" data-lt=\"set(key, value, options)|set(key, value)\" id=\"dom-sharedstorage-set\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>set(<var>key</var>, <var>value</var>, <var>options</var>)</code></dfn> method steps are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>promise</var> be a new <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#idl-promise\" id=\"ref-for-idl-promise②①\">promise</a>.</p>"
        },
        {
          "html": "<p>Let <var>globalObject</var> be the <a data-link-type=\"dfn\" href=\"https://tc39.es/ecma262/#current-realm\" id=\"ref-for-current-realm③\">current realm</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-realm-global\" id=\"ref-for-concept-realm-global⑤\">global object</a>.</p>"
        },
        {
          "html": "<p>Let <var>context</var> be null.</p>"
        },
        {
          "html": "If <var>globalObject</var> is a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#window\" id=\"ref-for-window②②\">Window</a></code>:",
          "rationale": "set",
          "steps": [
            {
              "html": "<p>Set <var>context</var> to <var>globalObject</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#window-bc\" id=\"ref-for-window-bc④\">browsing context</a>.</p>"
            }
          ]
        },
        {
          "html": "Else:",
          "rationale": "set",
          "steps": [
            {
              "html": "<p>Set <var>context</var> to <var>globalObject</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope-outside-settings\" id=\"ref-for-sharedstorageworkletglobalscope-outside-settings\">outside settings</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-target-browsing-context\" id=\"ref-for-concept-environment-target-browsing-context\">target browsing context</a>.</p>"
            },
            {
              "html": "<p>If the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope-check-whether-addmodule-is-finished\" id=\"ref-for-sharedstorageworkletglobalscope-check-whether-addmodule-is-finished③\">check whether addModule is finished</a> for <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#sharedstorage\" id=\"ref-for-sharedstorage①⓪\">SharedStorage</a></code>'s associated <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope\" id=\"ref-for-sharedstorageworkletglobalscope②②\">SharedStorageWorkletGlobalScope</a></code> is false, return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with②⑥\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror③⑦\">TypeError</a></code>.</p>"
            }
          ]
        },
        {
          "html": "<p>If <var>context</var> is null, return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with②⑦\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror③⑧\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>If <var>context</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-window\" id=\"ref-for-nav-window①\">active window</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#concept-document-window\" id=\"ref-for-concept-document-window⑤\">associated document</a> is not <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active\" id=\"ref-for-fully-active③\">fully active</a>, return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with②⑧\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror③⑨\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>If <var>key</var>’s <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#string-length\" id=\"ref-for-string-length①\">length</a> exceeds the <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#key-maximum-length\" id=\"ref-for-key-maximum-length\">maximum length</a>, return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with②⑨\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror④⓪\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>If <var>value</var>’s <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#string-length\" id=\"ref-for-string-length②\">length</a> exceeds the <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#value-maximum-length\" id=\"ref-for-value-maximum-length\">maximum length</a>, return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with③⓪\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror④①\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>environment</var> be <var>context</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-window\" id=\"ref-for-nav-window②\">active window</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object⑦\">relevant settings object</a>.</p>"
        },
        {
          "html": "<p>Let <var>databaseMap</var> be the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#obtain-a-shared-storage-bottle-map\" id=\"ref-for-obtain-a-shared-storage-bottle-map①\">obtain a shared storage bottle map</a> given <var>environment</var> and <var>environment</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin\" id=\"ref-for-concept-settings-object-origin②⓪\">origin</a>.</p>"
        },
        {
          "html": "<p>If <var>databaseMap</var> is failure, then return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with③①\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror④②\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>queue</var> be <var>context</var>’s associated <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-database\" id=\"ref-for-shared-storage-database⑧\">database</a>'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-database-shared-storage-database-queue\" id=\"ref-for-shared-storage-database-shared-storage-database-queue⑧\">shared storage database queue</a>.</p>"
        },
        {
          "html": "<p>Let <var>realm</var> be the <a data-link-type=\"dfn\" href=\"https://tc39.es/ecma262/#current-realm\" id=\"ref-for-current-realm④\">current realm</a>.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#enqueue-the-following-steps\" id=\"ref-for-enqueue-the-following-steps\">Enqueue the following steps</a> on <var>queue</var>:",
          "rationale": "if",
          "steps": [
            {
              "html": "If <var>options</var>[\"<code>ignoreIfPresent</code>\"] is true:",
              "rationale": "let",
              "steps": [
                {
                  "html": "<p>Let <var>currentValue</var> be the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-database-retrieve-an-entry-from-the-database\" id=\"ref-for-shared-storage-database-retrieve-an-entry-from-the-database①\">retrieve an entry from the database</a> with <var>queue</var>, <var>databaseMap</var>, <var>environment</var>, and <var>key</var>.</p>"
                },
                {
                  "html": "If <var>currentValue</var> is failure and if <var>globalObject</var> is a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope\" id=\"ref-for-sharedstorageworkletglobalscope②③\">SharedStorageWorkletGlobalScope</a></code>:",
                  "rationale": "queue",
                  "steps": [
                    {
                      "html": "<p><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task\" id=\"ref-for-queue-a-global-task①③\">Queue a global task</a> on the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source①①\">DOM manipulation task source</a>, given <var>realm</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-realm-global\" id=\"ref-for-concept-realm-global⑥\">global object</a>, to <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\" id=\"ref-for-reject①④\">reject</a> <var>promise</var> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror④③\">TypeError</a></code>.</p>"
                    },
                    {
                      "html": "<p>Abort these steps.</p>"
                    }
                  ]
                },
                {
                  "html": "If <var>currentValue</var> is not undefined:",
                  "rationale": "queue",
                  "steps": [
                    {
                      "html": "<p><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task\" id=\"ref-for-queue-a-global-task①④\">Queue a global task</a> on the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source①②\">DOM manipulation task source</a>, given <var>realm</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-realm-global\" id=\"ref-for-concept-realm-global⑦\">global object</a>, to <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#resolve\" id=\"ref-for-resolve①①\">resolve</a> <var>promise</var> with undefined.</p>"
                    },
                    {
                      "html": "<p>Abort these steps.</p>"
                    }
                  ]
                }
              ]
            },
            {
              "html": "<p>Let <var>result</var> be the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-database-store-an-entry-in-the-database\" id=\"ref-for-shared-storage-database-store-an-entry-in-the-database②\">store an entry in the database</a> with <var>queue</var>, <var>databaseMap</var>, <var>environment</var>, <var>key</var>, and <var>value</var>.</p>"
            },
            {
              "html": "If <var>result</var> is false and if <var>globalObject</var> is a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope\" id=\"ref-for-sharedstorageworkletglobalscope②④\">SharedStorageWorkletGlobalScope</a></code>:",
              "rationale": "queue",
              "steps": [
                {
                  "html": "<p><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task\" id=\"ref-for-queue-a-global-task①⑤\">Queue a global task</a> on the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source①③\">DOM manipulation task source</a>, given <var>realm</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-realm-global\" id=\"ref-for-concept-realm-global⑧\">global object</a>, to <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\" id=\"ref-for-reject①⑤\">reject</a> <var>promise</var> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror④④\">TypeError</a></code>.</p>"
                },
                {
                  "html": "<p>Abort these steps.</p>"
                }
              ]
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task\" id=\"ref-for-queue-a-global-task①⑥\">Queue a global task</a> on the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source①④\">DOM manipulation task source</a>, given <var>realm</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-realm-global\" id=\"ref-for-concept-realm-global⑨\">global object</a>, to <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#resolve\" id=\"ref-for-resolve①②\">resolve</a> <var>promise</var> with undefined.</p>"
            }
          ]
        },
        {
          "html": "<p>Return <var>promise</var>.</p>"
        }
      ]
    },
    {
      "name": "SharedStorage/append(key, value)",
      "href": "https://wicg.github.io/shared-storage/#dom-sharedstorage-append",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"SharedStorage\" data-dfn-type=\"method\" data-export=\"\" id=\"dom-sharedstorage-append\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>append(<var>key</var>, <var>value</var>)</code></dfn> method steps are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>promise</var> be a new <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#idl-promise\" id=\"ref-for-idl-promise②②\">promise</a>.</p>"
        },
        {
          "html": "<p>Let <var>globalObject</var> be the <a data-link-type=\"dfn\" href=\"https://tc39.es/ecma262/#current-realm\" id=\"ref-for-current-realm⑤\">current realm</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-realm-global\" id=\"ref-for-concept-realm-global①⓪\">global object</a>.</p>"
        },
        {
          "html": "<p>Let <var>context</var> be null.</p>"
        },
        {
          "html": "If <var>globalObject</var> is a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#window\" id=\"ref-for-window②③\">Window</a></code>:",
          "rationale": "set",
          "steps": [
            {
              "html": "<p>Set <var>context</var> to <var>globalObject</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#window-bc\" id=\"ref-for-window-bc⑤\">browsing context</a>.</p>"
            }
          ]
        },
        {
          "html": "Else:",
          "rationale": "set",
          "steps": [
            {
              "html": "<p>Set <var>context</var> to <var>globalObject</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope-outside-settings\" id=\"ref-for-sharedstorageworkletglobalscope-outside-settings①\">outside settings</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-target-browsing-context\" id=\"ref-for-concept-environment-target-browsing-context①\">target browsing context</a>.</p>"
            },
            {
              "html": "<p>If the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope-check-whether-addmodule-is-finished\" id=\"ref-for-sharedstorageworkletglobalscope-check-whether-addmodule-is-finished④\">check whether addModule is finished</a> for <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#sharedstorage\" id=\"ref-for-sharedstorage①①\">SharedStorage</a></code>'s associated <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope\" id=\"ref-for-sharedstorageworkletglobalscope②⑤\">SharedStorageWorkletGlobalScope</a></code> is false, return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with③②\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror④⑤\">TypeError</a></code>.</p>"
            }
          ]
        },
        {
          "html": "<p>If <var>context</var> is null, return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with③③\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror④⑥\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>If <var>context</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-window\" id=\"ref-for-nav-window③\">active window</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#concept-document-window\" id=\"ref-for-concept-document-window⑥\">associated document</a> is not <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active\" id=\"ref-for-fully-active④\">fully active</a>, return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with③④\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror④⑦\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>If <var>key</var>’s <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#string-length\" id=\"ref-for-string-length③\">length</a> exceeds the <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#key-maximum-length\" id=\"ref-for-key-maximum-length①\">maximum length</a>, return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with③⑤\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror④⑧\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>If <var>value</var>’s <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#string-length\" id=\"ref-for-string-length④\">length</a> exceeds the <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#value-maximum-length\" id=\"ref-for-value-maximum-length①\">maximum length</a>, return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with③⑥\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror④⑨\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>environment</var> be <var>context</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-window\" id=\"ref-for-nav-window④\">active window</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object⑧\">relevant settings object</a>.</p>"
        },
        {
          "html": "<p>Let <var>databaseMap</var> be the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#obtain-a-shared-storage-bottle-map\" id=\"ref-for-obtain-a-shared-storage-bottle-map②\">obtain a shared storage bottle map</a> given <var>environment</var> and <var>environment</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin\" id=\"ref-for-concept-settings-object-origin②①\">origin</a>.</p>"
        },
        {
          "html": "<p>If <var>databaseMap</var> is failure, then return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with③⑦\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror⑤⓪\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>queue</var> be <var>context</var>’s associated <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-database\" id=\"ref-for-shared-storage-database⑨\">database</a>'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-database-shared-storage-database-queue\" id=\"ref-for-shared-storage-database-shared-storage-database-queue⑨\">shared storage database queue</a>.</p>"
        },
        {
          "html": "<p>Let <var>realm</var> be the <a data-link-type=\"dfn\" href=\"https://tc39.es/ecma262/#current-realm\" id=\"ref-for-current-realm⑥\">current realm</a>.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#enqueue-the-following-steps\" id=\"ref-for-enqueue-the-following-steps①\">Enqueue the following steps</a> on <var>queue</var>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>currentValue</var> be the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-database-retrieve-an-entry-from-the-database\" id=\"ref-for-shared-storage-database-retrieve-an-entry-from-the-database②\">retrieve an entry from the database</a> with <var>queue</var>, <var>databaseMap</var>, <var>environment</var>, and <var>key</var>.</p>"
            },
            {
              "html": "If <var>currentValue</var> is failure:",
              "rationale": "if",
              "steps": [
                {
                  "html": "If <var>globalObject</var> is a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#window\" id=\"ref-for-window②④\">Window</a></code>:",
                  "rationale": "queue",
                  "steps": [
                    {
                      "html": "<p><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task\" id=\"ref-for-queue-a-global-task①⑦\">Queue a global task</a> on the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source①⑤\">DOM manipulation task source</a>, given <var>realm</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-realm-global\" id=\"ref-for-concept-realm-global①①\">global object</a>, to <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#resolve\" id=\"ref-for-resolve①③\">resolve</a> <var>promise</var> with undefined.</p>"
                    }
                  ]
                },
                {
                  "html": "Else:",
                  "rationale": "queue",
                  "steps": [
                    {
                      "html": "<p><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task\" id=\"ref-for-queue-a-global-task①⑧\">Queue a global task</a> on the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source①⑥\">DOM manipulation task source</a>, given <var>realm</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-realm-global\" id=\"ref-for-concept-realm-global①②\">global object</a>, to <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\" id=\"ref-for-reject①⑥\">reject</a> <var>promise</var> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror⑤①\">TypeError</a></code>.</p>"
                    }
                  ]
                },
                {
                  "html": "<p>Abort these steps.</p>"
                }
              ]
            },
            {
              "html": "If <var>currentValue</var> is not undefined:",
              "rationale": "let",
              "steps": [
                {
                  "html": "<p>Let <var>list</var> be a new <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list⑨\">list</a>.</p>"
                },
                {
                  "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-append\" id=\"ref-for-list-append④\">Append</a> <var>currentValue</var> to <var>list</var>.</p>"
                },
                {
                  "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-append\" id=\"ref-for-list-append⑤\">Append</a> <var>value</var> to <var>list</var>.</p>"
                },
                {
                  "html": "<p>Set <var>value</var> to the result of running <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#string-concatenate\" id=\"ref-for-string-concatenate\">concatenate</a> on <var>list</var>.</p>"
                }
              ]
            },
            {
              "html": "<p>Let <var>result</var> be the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-database-store-an-entry-in-the-database\" id=\"ref-for-shared-storage-database-store-an-entry-in-the-database③\">store an entry in the database</a> with <var>queue</var>, <var>databaseMap</var>, <var>environment</var>, <var>key</var>, and <var>value</var>.</p>"
            },
            {
              "html": "If <var>result</var> is false and if <var>globalObject</var> is a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope\" id=\"ref-for-sharedstorageworkletglobalscope②⑥\">SharedStorageWorkletGlobalScope</a></code>:",
              "rationale": "queue",
              "steps": [
                {
                  "html": "<p><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task\" id=\"ref-for-queue-a-global-task①⑨\">Queue a global task</a> on the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source①⑦\">DOM manipulation task source</a>, given <var>realm</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-realm-global\" id=\"ref-for-concept-realm-global①③\">global object</a>, to <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\" id=\"ref-for-reject①⑦\">reject</a> <var>promise</var> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror⑤②\">TypeError</a></code>.</p>"
                },
                {
                  "html": "<p>Abort these steps.</p>"
                }
              ]
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task\" id=\"ref-for-queue-a-global-task②⓪\">Queue a global task</a> on the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source①⑧\">DOM manipulation task source</a>, given <var>realm</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-realm-global\" id=\"ref-for-concept-realm-global①④\">global object</a>, to <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#resolve\" id=\"ref-for-resolve①④\">resolve</a> <var>promise</var> with undefined.</p>"
            }
          ]
        },
        {
          "html": "<p>Return <var>promise</var>.</p>"
        }
      ]
    },
    {
      "name": "SharedStorage/delete(key)",
      "href": "https://wicg.github.io/shared-storage/#dom-sharedstorage-delete",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"SharedStorage\" data-dfn-type=\"method\" data-export=\"\" id=\"dom-sharedstorage-delete\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>delete(<var>key</var>)</code></dfn> method steps are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>promise</var> be a new <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#idl-promise\" id=\"ref-for-idl-promise②③\">promise</a>.</p>"
        },
        {
          "html": "<p>Let <var>globalObject</var> be the <a data-link-type=\"dfn\" href=\"https://tc39.es/ecma262/#current-realm\" id=\"ref-for-current-realm⑦\">current realm</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-realm-global\" id=\"ref-for-concept-realm-global①⑤\">global object</a>.</p>"
        },
        {
          "html": "<p>Let <var>context</var> be null.</p>"
        },
        {
          "html": "If <var>globalObject</var> is a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#window\" id=\"ref-for-window②⑤\">Window</a></code>:",
          "rationale": "set",
          "steps": [
            {
              "html": "<p>Set <var>context</var> to <var>globalObject</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#window-bc\" id=\"ref-for-window-bc⑥\">browsing context</a>.</p>"
            }
          ]
        },
        {
          "html": "Else:",
          "rationale": "set",
          "steps": [
            {
              "html": "<p>Set <var>context</var> to <var>globalObject</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope-outside-settings\" id=\"ref-for-sharedstorageworkletglobalscope-outside-settings②\">outside settings</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-target-browsing-context\" id=\"ref-for-concept-environment-target-browsing-context②\">target browsing context</a>.</p>"
            },
            {
              "html": "<p>If the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope-check-whether-addmodule-is-finished\" id=\"ref-for-sharedstorageworkletglobalscope-check-whether-addmodule-is-finished⑤\">check whether addModule is finished</a> for <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#sharedstorage\" id=\"ref-for-sharedstorage①②\">SharedStorage</a></code>'s associated <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope\" id=\"ref-for-sharedstorageworkletglobalscope②⑦\">SharedStorageWorkletGlobalScope</a></code> is false, return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with③⑧\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror⑤③\">TypeError</a></code>.</p>"
            }
          ]
        },
        {
          "html": "<p>If <var>context</var> is null, return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with③⑨\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror⑤④\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>If <var>context</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-window\" id=\"ref-for-nav-window⑤\">active window</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#concept-document-window\" id=\"ref-for-concept-document-window⑦\">associated document</a> is not <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active\" id=\"ref-for-fully-active⑤\">fully active</a>, return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with④⓪\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror⑤⑤\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>If <var>key</var>’s <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#string-length\" id=\"ref-for-string-length⑤\">length</a> exceeds the <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#key-maximum-length\" id=\"ref-for-key-maximum-length②\">maximum length</a>, return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with④①\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror⑤⑥\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>environment</var> be <var>context</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-window\" id=\"ref-for-nav-window⑥\">active window</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object⑨\">relevant settings object</a>.</p>"
        },
        {
          "html": "<p>Let <var>databaseMap</var> be the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#obtain-a-shared-storage-bottle-map\" id=\"ref-for-obtain-a-shared-storage-bottle-map③\">obtain a shared storage bottle map</a> given <var>environment</var> and <var>environment</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin\" id=\"ref-for-concept-settings-object-origin②②\">origin</a>.</p>"
        },
        {
          "html": "<p>If <var>databaseMap</var> is failure, then return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with④②\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror⑤⑦\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>queue</var> be <var>context</var>’s associated <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-database\" id=\"ref-for-shared-storage-database①⓪\">database</a>'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-database-shared-storage-database-queue\" id=\"ref-for-shared-storage-database-shared-storage-database-queue①⓪\">shared storage database queue</a>.</p>"
        },
        {
          "html": "<p>Let <var>realm</var> be the <a data-link-type=\"dfn\" href=\"https://tc39.es/ecma262/#current-realm\" id=\"ref-for-current-realm⑧\">current realm</a>.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#enqueue-the-following-steps\" id=\"ref-for-enqueue-the-following-steps②\">Enqueue the following steps</a> on <var>queue</var>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>result</var> be the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-database-delete-an-entry-from-the-database\" id=\"ref-for-shared-storage-database-delete-an-entry-from-the-database①\">delete an entry from the database</a> with <var>queue</var>, <var>databaseMap</var>, and <var>key</var>.</p>"
            },
            {
              "html": "If <var>result</var> is false and if <var>globalObject</var> is a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope\" id=\"ref-for-sharedstorageworkletglobalscope②⑧\">SharedStorageWorkletGlobalScope</a></code>:",
              "rationale": "queue",
              "steps": [
                {
                  "html": "<p><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task\" id=\"ref-for-queue-a-global-task②①\">Queue a global task</a> on the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source①⑨\">DOM manipulation task source</a>, given <var>realm</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-realm-global\" id=\"ref-for-concept-realm-global①⑥\">global object</a>, to <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\" id=\"ref-for-reject①⑧\">reject</a> <var>promise</var> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror⑤⑧\">TypeError</a></code>.</p>"
                },
                {
                  "html": "<p>Abort these steps.</p>"
                }
              ]
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task\" id=\"ref-for-queue-a-global-task②②\">Queue a global task</a> on the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source②⓪\">DOM manipulation task source</a>, given <var>realm</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-realm-global\" id=\"ref-for-concept-realm-global①⑦\">global object</a>, to <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#resolve\" id=\"ref-for-resolve①⑤\">resolve</a> <var>promise</var> with undefined.</p>"
            }
          ]
        },
        {
          "html": "<p>Return <var>promise</var>.</p>"
        }
      ]
    },
    {
      "name": "SharedStorage/clear()",
      "href": "https://wicg.github.io/shared-storage/#dom-sharedstorage-clear",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"SharedStorage\" data-dfn-type=\"method\" data-export=\"\" id=\"dom-sharedstorage-clear\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>clear()</code></dfn> method steps are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>promise</var> be a new <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#idl-promise\" id=\"ref-for-idl-promise②④\">promise</a>.</p>"
        },
        {
          "html": "<p>Let <var>globalObject</var> be the <a data-link-type=\"dfn\" href=\"https://tc39.es/ecma262/#current-realm\" id=\"ref-for-current-realm⑨\">current realm</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-realm-global\" id=\"ref-for-concept-realm-global①⑧\">global object</a>.</p>"
        },
        {
          "html": "<p>Let <var>context</var> be null.</p>"
        },
        {
          "html": "If <var>globalObject</var> is a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#window\" id=\"ref-for-window②⑥\">Window</a></code>:",
          "rationale": "set",
          "steps": [
            {
              "html": "<p>Set <var>context</var> to <var>globalObject</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#window-bc\" id=\"ref-for-window-bc⑦\">browsing context</a>.</p>"
            }
          ]
        },
        {
          "html": "Else:",
          "rationale": "set",
          "steps": [
            {
              "html": "<p>Set <var>context</var> to <var>globalObject</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope-outside-settings\" id=\"ref-for-sharedstorageworkletglobalscope-outside-settings③\">outside settings</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-target-browsing-context\" id=\"ref-for-concept-environment-target-browsing-context③\">target browsing context</a>.</p>"
            },
            {
              "html": "<p>If the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope-check-whether-addmodule-is-finished\" id=\"ref-for-sharedstorageworkletglobalscope-check-whether-addmodule-is-finished⑥\">check whether addModule is finished</a> for <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#sharedstorage\" id=\"ref-for-sharedstorage①③\">SharedStorage</a></code>'s associated <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope\" id=\"ref-for-sharedstorageworkletglobalscope②⑨\">SharedStorageWorkletGlobalScope</a></code> is false, return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with④③\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror⑤⑨\">TypeError</a></code>.</p>"
            }
          ]
        },
        {
          "html": "<p>If <var>context</var> is null, return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with④④\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror⑥⓪\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>If <var>context</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-window\" id=\"ref-for-nav-window⑦\">active window</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#concept-document-window\" id=\"ref-for-concept-document-window⑧\">associated document</a> is not <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active\" id=\"ref-for-fully-active⑥\">fully active</a>, return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with④⑤\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror⑥①\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>environment</var> be <var>context</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-window\" id=\"ref-for-nav-window⑧\">active window</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object①⓪\">relevant settings object</a>.</p>"
        },
        {
          "html": "<p>Let <var>databaseMap</var> be the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#obtain-a-shared-storage-bottle-map\" id=\"ref-for-obtain-a-shared-storage-bottle-map④\">obtain a shared storage bottle map</a> given <var>environment</var> and <var>environment</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin\" id=\"ref-for-concept-settings-object-origin②③\">origin</a>.</p>"
        },
        {
          "html": "<p>If <var>databaseMap</var> is failure, then return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with④⑥\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror⑥②\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>queue</var> be <var>context</var>’s associated <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-database\" id=\"ref-for-shared-storage-database①①\">database</a>'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-database-shared-storage-database-queue\" id=\"ref-for-shared-storage-database-shared-storage-database-queue①①\">shared storage database queue</a>.</p>"
        },
        {
          "html": "<p>Let <var>realm</var> be the <a data-link-type=\"dfn\" href=\"https://tc39.es/ecma262/#current-realm\" id=\"ref-for-current-realm①⓪\">current realm</a>.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#enqueue-the-following-steps\" id=\"ref-for-enqueue-the-following-steps③\">Enqueue the following steps</a> on <var>queue</var>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>result</var> be the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-database-clear-all-entries-in-the-database\" id=\"ref-for-shared-storage-database-clear-all-entries-in-the-database①\">clear all entries in the database</a> with <var>queue</var> and <var>databaseMap</var>.</p>"
            },
            {
              "html": "If <var>result</var> is false and if <var>globalObject</var> is a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope\" id=\"ref-for-sharedstorageworkletglobalscope③⓪\">SharedStorageWorkletGlobalScope</a></code>:",
              "rationale": "queue",
              "steps": [
                {
                  "html": "<p><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task\" id=\"ref-for-queue-a-global-task②③\">Queue a global task</a> on the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source②①\">DOM manipulation task source</a>, given <var>realm</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-realm-global\" id=\"ref-for-concept-realm-global①⑨\">global object</a>, to <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\" id=\"ref-for-reject①⑨\">reject</a> <var>promise</var> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror⑥③\">TypeError</a></code>.</p>"
                },
                {
                  "html": "<p>Abort these steps.</p>"
                }
              ]
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task\" id=\"ref-for-queue-a-global-task②④\">Queue a global task</a> on the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source②②\">DOM manipulation task source</a>, given <var>realm</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-realm-global\" id=\"ref-for-concept-realm-global②⓪\">global object</a>, to <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#resolve\" id=\"ref-for-resolve①⑥\">resolve</a> <var>promise</var> with undefined.</p>"
            }
          ]
        },
        {
          "html": "<p>Return <var>promise</var>.</p>"
        }
      ]
    },
    {
      "name": "SharedStorage/get(key)",
      "href": "https://wicg.github.io/shared-storage/#dom-sharedstorage-get",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"SharedStorage\" data-dfn-type=\"method\" data-export=\"\" id=\"dom-sharedstorage-get\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>get(<var>key</var>)</code></dfn> method steps are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>promise</var> be a new <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#idl-promise\" id=\"ref-for-idl-promise②⑤\">promise</a>.</p>"
        },
        {
          "html": "<p>If the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope-check-whether-addmodule-is-finished\" id=\"ref-for-sharedstorageworkletglobalscope-check-whether-addmodule-is-finished⑦\">check whether addModule is finished</a> for <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#sharedstorage\" id=\"ref-for-sharedstorage①④\">SharedStorage</a></code>'s associated <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope\" id=\"ref-for-sharedstorageworkletglobalscope③①\">SharedStorageWorkletGlobalScope</a></code> is false, return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with④⑦\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror⑥④\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>If <var>key</var>’s <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#string-length\" id=\"ref-for-string-length⑥\">length</a> exceeds the <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#key-maximum-length\" id=\"ref-for-key-maximum-length③\">maximum length</a>, return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with④⑧\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror⑥⑤\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>context</var> be <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#sharedstorage\" id=\"ref-for-sharedstorage①⑤\">SharedStorage</a></code>'s <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope\" id=\"ref-for-sharedstorageworkletglobalscope③②\">SharedStorageWorkletGlobalScope</a></code>'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope-outside-settings\" id=\"ref-for-sharedstorageworkletglobalscope-outside-settings④\">outside settings</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-target-browsing-context\" id=\"ref-for-concept-environment-target-browsing-context④\">target browsing context</a>.</p>"
        },
        {
          "html": "<p>If <var>context</var> is null, return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with④⑨\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror⑥⑥\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>If <var>context</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-window\" id=\"ref-for-nav-window⑨\">active window</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#concept-document-window\" id=\"ref-for-concept-document-window⑨\">associated document</a> is not <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active\" id=\"ref-for-fully-active⑦\">fully active</a>, return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with⑤⓪\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror⑥⑦\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>environment</var> be <var>context</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-window\" id=\"ref-for-nav-window①⓪\">active window</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object①①\">relevant settings object</a>.</p>"
        },
        {
          "html": "<p>Let <var>realm</var> be the <a data-link-type=\"dfn\" href=\"https://tc39.es/ecma262/#current-realm\" id=\"ref-for-current-realm①①\">current realm</a>.</p>"
        },
        {
          "html": "<p>Let <var>databaseMap</var> be the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#obtain-a-shared-storage-bottle-map\" id=\"ref-for-obtain-a-shared-storage-bottle-map⑤\">obtain a shared storage bottle map</a> given <var>environment</var> and <var>realm</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-realm-settings-object\" id=\"ref-for-concept-realm-settings-object⑦\">settings object</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin\" id=\"ref-for-concept-settings-object-origin②④\">origin</a>.</p>"
        },
        {
          "html": "<p>If <var>databaseMap</var> is failure, then return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with⑤①\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror⑥⑧\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>queue</var> be <var>context</var>’s associated <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-database\" id=\"ref-for-shared-storage-database①②\">database</a>'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-database-shared-storage-database-queue\" id=\"ref-for-shared-storage-database-shared-storage-database-queue①②\">shared storage database queue</a>.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#enqueue-the-following-steps\" id=\"ref-for-enqueue-the-following-steps④\">Enqueue the following steps</a> on <var>queue</var>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>value</var> be the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-database-retrieve-an-entry-from-the-database\" id=\"ref-for-shared-storage-database-retrieve-an-entry-from-the-database③\">retrieve an entry from the database</a> with <var>queue</var>, <var>databaseMap</var>, <var>environment</var>, and <var>key</var>.</p>"
            },
            {
              "html": "<p>If <var>value</var> is failure, <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task\" id=\"ref-for-queue-a-global-task②⑤\">queue a global task</a> on the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source②③\">DOM manipulation task source</a>, given <var>realm</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-realm-global\" id=\"ref-for-concept-realm-global②①\">global object</a>, to <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\" id=\"ref-for-reject②⓪\">reject</a> <var>promise</var> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror⑥⑨\">TypeError</a></code>.</p>"
            },
            {
              "html": "<p>Otherwise, if <var>value</var> is undefined, <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task\" id=\"ref-for-queue-a-global-task②⑥\">queue a global task</a> on the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source②④\">DOM manipulation task source</a>, given <var>realm</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-realm-global\" id=\"ref-for-concept-realm-global②②\">global object</a>, to <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#resolve\" id=\"ref-for-resolve①⑦\">resolve</a> <var>promise</var> with undefined.</p>"
            },
            {
              "html": "<p>Otherwise, <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task\" id=\"ref-for-queue-a-global-task②⑦\">queue a global task</a> on the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source②⑤\">DOM manipulation task source</a>, given <var>realm</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-realm-global\" id=\"ref-for-concept-realm-global②③\">global object</a>, to <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#resolve\" id=\"ref-for-resolve①⑧\">resolve</a> <var>promise</var> with <var>value</var>.</p>"
            }
          ]
        },
        {
          "html": "<p>Return <var>promise</var>.</p>"
        }
      ]
    },
    {
      "name": "SharedStorage/length()",
      "href": "https://wicg.github.io/shared-storage/#dom-sharedstorage-length",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"SharedStorage\" data-dfn-type=\"method\" data-export=\"\" id=\"dom-sharedstorage-length\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>length()</code></dfn> method steps are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>promise</var> be a new <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#idl-promise\" id=\"ref-for-idl-promise②⑥\">promise</a>.</p>"
        },
        {
          "html": "<p>If the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope-check-whether-addmodule-is-finished\" id=\"ref-for-sharedstorageworkletglobalscope-check-whether-addmodule-is-finished⑧\">check whether addModule is finished</a> for <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#sharedstorage\" id=\"ref-for-sharedstorage①⑥\">SharedStorage</a></code>'s associated <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope\" id=\"ref-for-sharedstorageworkletglobalscope③③\">SharedStorageWorkletGlobalScope</a></code> is false, return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with⑤②\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror⑦⓪\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>context</var> be <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#sharedstorage\" id=\"ref-for-sharedstorage①⑦\">SharedStorage</a></code>'s <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope\" id=\"ref-for-sharedstorageworkletglobalscope③④\">SharedStorageWorkletGlobalScope</a></code>'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope-outside-settings\" id=\"ref-for-sharedstorageworkletglobalscope-outside-settings⑤\">outside settings</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-target-browsing-context\" id=\"ref-for-concept-environment-target-browsing-context⑤\">target browsing context</a>.</p>"
        },
        {
          "html": "<p>If <var>context</var> is null, return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with⑤③\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror⑦①\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>If <var>context</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-window\" id=\"ref-for-nav-window①①\">active window</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#concept-document-window\" id=\"ref-for-concept-document-window①⓪\">associated document</a> is not <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active\" id=\"ref-for-fully-active⑧\">fully active</a>, return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with⑤④\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror⑦②\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>environment</var> be <var>context</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-window\" id=\"ref-for-nav-window①②\">active window</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object①②\">relevant settings object</a>.</p>"
        },
        {
          "html": "<p>Let <var>realm</var> be the <a data-link-type=\"dfn\" href=\"https://tc39.es/ecma262/#current-realm\" id=\"ref-for-current-realm①②\">current realm</a>.</p>"
        },
        {
          "html": "<p>Let <var>databaseMap</var> be the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#obtain-a-shared-storage-bottle-map\" id=\"ref-for-obtain-a-shared-storage-bottle-map⑥\">obtain a shared storage bottle map</a> given <var>environment</var> and <var>realm</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-realm-settings-object\" id=\"ref-for-concept-realm-settings-object⑧\">settings object</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin\" id=\"ref-for-concept-settings-object-origin②⑤\">origin</a>.</p>"
        },
        {
          "html": "<p>If <var>databaseMap</var> is failure, then return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with⑤⑤\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror⑦③\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>queue</var> be <var>context</var>’s associated <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-database\" id=\"ref-for-shared-storage-database①③\">database</a>'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-database-shared-storage-database-queue\" id=\"ref-for-shared-storage-database-shared-storage-database-queue①③\">shared storage database queue</a>.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#enqueue-the-following-steps\" id=\"ref-for-enqueue-the-following-steps⑤\">Enqueue the following steps</a> on <var>queue</var>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>numEntries</var> be the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-database-count-entries-in-the-database\" id=\"ref-for-shared-storage-database-count-entries-in-the-database\">count entries in the database</a> with <var>queue</var> and <var>environment</var>.</p>"
            },
            {
              "html": "<p>If <var>numEntries</var> is failure, <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task\" id=\"ref-for-queue-a-global-task②⑧\">queue a global task</a> on the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source②⑥\">DOM manipulation task source</a>, given <var>realm</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-realm-global\" id=\"ref-for-concept-realm-global②④\">global object</a>, to <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\" id=\"ref-for-reject②①\">reject</a> <var>promise</var> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror⑦④\">TypeError</a></code>.</p>"
            },
            {
              "html": "<p>Otherwise, <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task\" id=\"ref-for-queue-a-global-task②⑨\">queue a global task</a> on the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source②⑦\">DOM manipulation task source</a>, given <var>realm</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-realm-global\" id=\"ref-for-concept-realm-global②⑤\">global object</a>, to <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#resolve\" id=\"ref-for-resolve①⑨\">resolve</a> <var>promise</var> with <var>numEntries</var>.</p>"
            }
          ]
        },
        {
          "html": "<p>Return <var>promise</var>.</p>"
        }
      ]
    },
    {
      "name": "SharedStorage/remainingBudget()",
      "href": "https://wicg.github.io/shared-storage/#dom-sharedstorage-remainingbudget",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"SharedStorage\" data-dfn-type=\"method\" data-export=\"\" id=\"dom-sharedstorage-remainingbudget\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>remainingBudget()</code></dfn> method steps are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>promise</var> be a new <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#idl-promise\" id=\"ref-for-idl-promise②⑦\">promise</a>.</p>"
        },
        {
          "html": "<p>If the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope-check-whether-addmodule-is-finished\" id=\"ref-for-sharedstorageworkletglobalscope-check-whether-addmodule-is-finished⑨\">check whether addModule is finished</a> for <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#sharedstorage\" id=\"ref-for-sharedstorage①⑧\">SharedStorage</a></code>'s associated <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope\" id=\"ref-for-sharedstorageworkletglobalscope③⑤\">SharedStorageWorkletGlobalScope</a></code> is false, return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with⑤⑥\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror⑦⑤\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>context</var> be <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#sharedstorage\" id=\"ref-for-sharedstorage①⑨\">SharedStorage</a></code>'s <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope\" id=\"ref-for-sharedstorageworkletglobalscope③⑥\">SharedStorageWorkletGlobalScope</a></code>'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope-outside-settings\" id=\"ref-for-sharedstorageworkletglobalscope-outside-settings⑥\">outside settings</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-target-browsing-context\" id=\"ref-for-concept-environment-target-browsing-context⑥\">target browsing context</a>.</p>"
        },
        {
          "html": "<p>If <var>context</var> is null, return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with⑤⑦\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror⑦⑥\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>If <var>context</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-window\" id=\"ref-for-nav-window①③\">active window</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#concept-document-window\" id=\"ref-for-concept-document-window①①\">associated document</a> is not <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active\" id=\"ref-for-fully-active⑨\">fully active</a>, return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with⑤⑧\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror⑦⑦\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>environment</var> be <var>context</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-window\" id=\"ref-for-nav-window①④\">active window</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object①③\">relevant settings object</a>.</p>"
        },
        {
          "html": "<p>Let <var>realm</var> be the <a data-link-type=\"dfn\" href=\"https://tc39.es/ecma262/#current-realm\" id=\"ref-for-current-realm①③\">current realm</a>.</p>"
        },
        {
          "html": "<p>Let <var>allowedInOpaqueOriginContext</var> be false.</p>"
        },
        {
          "html": "<p>If the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#determine-whether-shared-storage-is-allowed-by-context\" id=\"ref-for-determine-whether-shared-storage-is-allowed-by-context⑤\">determine whether shared storage is allowed by context</a> given <var>environment</var>, <var>realm</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-realm-settings-object\" id=\"ref-for-concept-realm-settings-object⑨\">settings object</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin\" id=\"ref-for-concept-settings-object-origin②⑥\">origin</a>, and <var>allowedInOpaqueOriginContext</var> is false, return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with⑤⑨\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror⑦⑧\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>If the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#check-if-user-preference-setting-allows-access-to-shared-storage\" id=\"ref-for-check-if-user-preference-setting-allows-access-to-shared-storage⑤\">check if user preference setting allows access to shared storage</a> given <var>environment</var> and <var>realm</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-realm-settings-object\" id=\"ref-for-concept-realm-settings-object①⓪\">settings object</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin\" id=\"ref-for-concept-settings-object-origin②⑦\">origin</a> is false, return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with⑥⓪\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror⑦⑨\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>site</var> be the result of running <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#obtain-a-site\" id=\"ref-for-obtain-a-site③\">obtain a site</a> with <var>realm</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-realm-settings-object\" id=\"ref-for-concept-realm-settings-object①①\">settings object</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin\" id=\"ref-for-concept-settings-object-origin②⑧\">origin</a>.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert②⑤\">Assert</a>: <var>site</var> is not an <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-opaque\" id=\"ref-for-concept-origin-opaque④\">opaque origin</a>.</p>"
        },
        {
          "html": "<p>Let <var>queue</var> be <var>context</var>’s associated <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-database\" id=\"ref-for-shared-storage-database①④\">database</a>'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-database-shared-storage-database-queue\" id=\"ref-for-shared-storage-database-shared-storage-database-queue①④\">shared storage database queue</a>.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#enqueue-the-following-steps\" id=\"ref-for-enqueue-the-following-steps⑥\">Enqueue the following steps</a> on <var>queue</var>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>remainingBudget</var> be the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#determine-remaining-navigation-budget\" id=\"ref-for-determine-remaining-navigation-budget①\">determine remaining navigation budget</a> with <var>site</var>.</p>"
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#resolve\" id=\"ref-for-resolve②⓪\">Resolve</a> <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task\" id=\"ref-for-queue-a-global-task③⓪\">queue a global task</a> on the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source②⑧\">DOM manipulation task source</a>, given <var>realm</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-realm-global\" id=\"ref-for-concept-realm-global②⑥\">global object</a>, to <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#resolve\" id=\"ref-for-resolve②①\">resolve</a> <var>promise</var> with <var>remainingBudget</var>.</p>"
            }
          ]
        },
        {
          "html": "<p>Return <var>promise</var>.</p>"
        }
      ]
    },
    {
      "name": "SharedStorageIterator/asynchronous iterator initialization steps",
      "href": "https://wicg.github.io/shared-storage/#sharedstorageiterator-asynchronous-iterator-initialization-steps",
      "html": "The <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-for=\"SharedStorageIterator\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"sharedstorageiterator-asynchronous-iterator-initialization-steps\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">asynchronous iterator initialization steps</dfn> for a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#sharedstorage\" id=\"ref-for-sharedstorage②②\">SharedStorage</a></code> <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#idl-async-iterable\" id=\"ref-for-idl-async-iterable②\">async iterator</a> <var>iterator</var> are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>promise</var> be a new <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#idl-promise\" id=\"ref-for-idl-promise②⑧\">promise</a>.</p>"
        },
        {
          "html": "<p>If the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope-check-whether-addmodule-is-finished\" id=\"ref-for-sharedstorageworkletglobalscope-check-whether-addmodule-is-finished①⓪\">check whether addModule is finished</a> for <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#sharedstorage\" id=\"ref-for-sharedstorage②③\">SharedStorage</a></code>'s associated <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope\" id=\"ref-for-sharedstorageworkletglobalscope③⑦\">SharedStorageWorkletGlobalScope</a></code> is false, return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with⑥①\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror⑧⓪\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>context</var> be <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#sharedstorage\" id=\"ref-for-sharedstorage②④\">SharedStorage</a></code>'s <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope\" id=\"ref-for-sharedstorageworkletglobalscope③⑧\">SharedStorageWorkletGlobalScope</a></code>'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope-outside-settings\" id=\"ref-for-sharedstorageworkletglobalscope-outside-settings⑦\">outside settings</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-target-browsing-context\" id=\"ref-for-concept-environment-target-browsing-context⑦\">target browsing context</a>.</p>"
        },
        {
          "html": "<p>If <var>context</var> is null, return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with⑥②\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror⑧①\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>If <var>context</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-window\" id=\"ref-for-nav-window①⑤\">active window</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#concept-document-window\" id=\"ref-for-concept-document-window①②\">associated document</a> is not <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active\" id=\"ref-for-fully-active①⓪\">fully active</a>, return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with⑥③\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror⑧②\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>environment</var> be <var>context</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-window\" id=\"ref-for-nav-window①⑥\">active window</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object\" id=\"ref-for-relevant-settings-object①④\">relevant settings object</a>.</p>"
        },
        {
          "html": "<p>Let <var>realm</var> be the <a data-link-type=\"dfn\" href=\"https://tc39.es/ecma262/#current-realm\" id=\"ref-for-current-realm①④\">current realm</a>.</p>"
        },
        {
          "html": "<p>Let <var>databaseMap</var> be the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#obtain-a-shared-storage-bottle-map\" id=\"ref-for-obtain-a-shared-storage-bottle-map⑦\">obtain a shared storage bottle map</a> given <var>environment</var> and <var>realm</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-realm-settings-object\" id=\"ref-for-concept-realm-settings-object①②\">settings object</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin\" id=\"ref-for-concept-settings-object-origin②⑨\">origin</a>.</p>"
        },
        {
          "html": "<p>If <var>databaseMap</var> is failure, then return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with⑥④\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror⑧③\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>queue</var> be <var>context</var>’s associated <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-database\" id=\"ref-for-shared-storage-database①⑤\">database</a>'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-database-shared-storage-database-queue\" id=\"ref-for-shared-storage-database-shared-storage-database-queue①⑤\">shared storage database queue</a>.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#enqueue-the-following-steps\" id=\"ref-for-enqueue-the-following-steps⑦\">Enqueue the following steps</a> on <var>queue</var>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>entries</var> be the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-database-retrieve-all-entries-from-the-database\" id=\"ref-for-shared-storage-database-retrieve-all-entries-from-the-database\">retrieve all entries from the database</a> with <var>queue</var> and <var>environment</var>.</p>"
            },
            {
              "html": "<p>If <var>entries</var> is failure, <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task\" id=\"ref-for-queue-a-global-task③①\">queue a global task</a> on the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source②⑨\">DOM manipulation task source</a>, given <var>realm</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-realm-global\" id=\"ref-for-concept-realm-global②⑦\">global object</a>, to <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#reject\" id=\"ref-for-reject②②\">reject</a> <var>promise</var> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror⑧④\">TypeError</a></code>.</p>"
            },
            {
              "html": "<p>Otherwise, <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task\" id=\"ref-for-queue-a-global-task③②\">queue a global task</a> on the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source③⓪\">DOM manipulation task source</a>, given <var>realm</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-realm-global\" id=\"ref-for-concept-realm-global②⑧\">global object</a>, to <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#resolve\" id=\"ref-for-resolve②②\">resolve</a> <var>promise</var> with <var>entries</var>.</p>"
            }
          ]
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#upon-fulfillment\" id=\"ref-for-upon-fulfillment③\">Upon fulfillment</a> of <var>promise</var>, run the following:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>promiseEntries</var> be the value of <var>promise</var>.</p>"
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-iterate\" id=\"ref-for-map-iterate⑦\">For each</a> <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-database-entry\" id=\"ref-for-shared-storage-database-entry⑥\">entry</a> <var>entry</var> in <var>promiseEntries</var>, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#queue-enqueue\" id=\"ref-for-queue-enqueue①\">enqueue</a> <var>entry</var> in <var>iterator</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageiterator-pending-entries\" id=\"ref-for-sharedstorageiterator-pending-entries\">pending entries</a>.</p>"
            }
          ]
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#upon-rejection\" id=\"ref-for-upon-rejection③\">Upon rejection</a> of <var>promise</var>, set <var>iterator</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageiterator-error\" id=\"ref-for-sharedstorageiterator-error\">error</a> to true.</p>"
        }
      ]
    },
    {
      "name": "SharedStorageIterator/get the next iteration result",
      "href": "https://wicg.github.io/shared-storage/#sharedstorageiterator-get-the-next-iteration-result",
      "html": "To<dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-for=\"SharedStorageIterator\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"sharedstorageiterator-get-the-next-iteration-result\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">get the next iteration result</dfn>, given a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#sharedstorage\" id=\"ref-for-sharedstorage②⑤\">SharedStorage</a></code>'s <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#idl-async-iterable\" id=\"ref-for-idl-async-iterable③\">async iterator</a> <var>iterator</var>, run the following steps:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>promise</var> be a new <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#idl-promise\" id=\"ref-for-idl-promise②⑨\">promise</a>.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#enqueue-the-following-steps\" id=\"ref-for-enqueue-the-following-steps⑧\">Enqueue the following steps</a>:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>iterator</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageiterator-error\" id=\"ref-for-sharedstorageiterator-error①\">error</a> is true, return a <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with⑥⑤\">promise rejected</a> with a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror⑧⑤\">TypeError</a></code>.</p>"
            },
            {
              "html": "If <var>iterator</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageiterator-pending-entries\" id=\"ref-for-sharedstorageiterator-pending-entries①\">pending entries</a> is <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-empty\" id=\"ref-for-list-empty④\">empty</a>:",
              "rationale": "create",
              "steps": [
                {
                  "html": "<p>Create an object <var>doneObject</var>.</p>"
                },
                {
                  "html": "<p><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task\" id=\"ref-for-queue-a-global-task③③\">Queue a global task</a> on the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source③①\">DOM manipulation task source</a>, given <var>realm</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-realm-global\" id=\"ref-for-concept-realm-global②⑨\">global object</a>, to <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#resolve\" id=\"ref-for-resolve②③\">resolve</a> <var>promise</var> with <var>doneObject</var>.</p>"
                },
                {
                  "html": "<p>Abort these steps.</p>"
                }
              ]
            },
            {
              "html": "<p>Otherwise, let <var>entry</var> be the result of <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#queue-dequeue\" id=\"ref-for-queue-dequeue①\">dequeueing</a> from <var>iterator</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#sharedstorageiterator-pending-entries\" id=\"ref-for-sharedstorageiterator-pending-entries②\">pending entries</a>.</p>"
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task\" id=\"ref-for-queue-a-global-task③④\">Queue a global task</a> on the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#dom-manipulation-task-source\" id=\"ref-for-dom-manipulation-task-source③②\">DOM manipulation task source</a>, given <var>realm</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-realm-global\" id=\"ref-for-concept-realm-global③⓪\">global object</a>, to <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#resolve\" id=\"ref-for-resolve②④\">resolve</a> <var>promise</var> with <var>entry</var>.</p>"
            }
          ]
        },
        {
          "html": "<p>Return <var>promise</var>.</p>"
        }
      ]
    },
    {
      "name": "modification-to-update-the-image-data",
      "html": "add the step",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If the element has the <code><a data-link-type=\"element-sub\" href=\"https://wicg.github.io/shared-storage/#element-attrdef-img-sharedstoragewritable\" id=\"ref-for-element-attrdef-img-sharedstoragewritable\">sharedstoragewritable</a></code> attribute present, set <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#request-shared-storage-writable\" id=\"ref-for-request-shared-storage-writable\">shared storage writable</a> to true.</p>"
        }
      ]
    },
    {
      "name": "modification-to-create-navigation-params-by-fetching",
      "html": "add the step",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If <var>navigable</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-container\" id=\"ref-for-nav-container\">container</a> is an <code><a data-link-type=\"element\" href=\"https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-iframe-element\" id=\"ref-for-the-iframe-element①\">iframe</a></code> element, and if it has a <code><a data-link-type=\"element-sub\" href=\"https://wicg.github.io/shared-storage/#element-attrdef-iframe-sharedstoragewritable\" id=\"ref-for-element-attrdef-iframe-sharedstoragewritable①\">sharedstoragewritable</a></code> <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/dom.html#concept-element-attributes\" id=\"ref-for-concept-element-attributes①\">content attribute</a>, then set <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#request-shared-storage-writable\" id=\"ref-for-request-shared-storage-writable①\">shared storage writable</a> to true.</p>"
        }
      ]
    },
    {
      "name": "modification-to-request-constructor",
      "html": "add the step",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If <var>init</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#dom-requestinit-sharedstoragewritable\" id=\"ref-for-dom-requestinit-sharedstoragewritable②\">sharedStorageWritable</a></code>\"] <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists①⑦\">exists</a>, then set <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#request-shared-storage-writable\" id=\"ref-for-request-shared-storage-writable②\">shared storage writable</a> to it.</p>"
        }
      ]
    },
    {
      "name": "modification-to-http-network-or-cache-fetch",
      "html": "add the step",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#append-or-modify-a-sec-shared-storage-writable-request-header\" id=\"ref-for-append-or-modify-a-sec-shared-storage-writable-request-header\">Append or modify a Sec-Shared-Storage-Writable request header</a> for <var>httpRequest</var>.</p>"
        }
      ]
    },
    {
      "name": "modification-to-http-fetch",
      "html": "add the steps",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "If <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-destination\" id=\"ref-for-concept-request-destination③\">destination</a> is \"sharedstorageworklet\":",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>dataOriginValue</var> be the result of <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-header-list-get\" id=\"ref-for-concept-header-list-get\">getting</a> <span>`<code><a data-link-type=\"http-header\" href=\"https://wicg.github.io/shared-storage/#http-headerdef-sec-shared-storage-data-origin\" id=\"ref-for-http-headerdef-sec-shared-storage-data-origin①\">Sec-Shared-Storage-Data-Origin</a></code>`</span> from <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-header-list\" id=\"ref-for-concept-request-header-list②\">header list</a>.</p>"
            },
            {
              "html": "If <var>dataOriginValue</var> is not null, then:",
              "rationale": "let",
              "steps": [
                {
                  "html": "<p>Let <var>dataOriginUrl</var> be the result of running a <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-parser\" id=\"ref-for-concept-url-parser⑥\">URL parser</a> on <var>dataOriginValue</var>.</p>"
                },
                {
                  "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert②⑥\">Assert</a> that <var>dataOriginUrl</var> is not failure.</p>"
                },
                {
                  "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert②⑦\">Assert</a> that <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-origin\" id=\"ref-for-concept-request-origin\">origin</a> is not \"<code>client</code>\".</p>"
                },
                {
                  "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert②⑧\">Assert</a> that <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-origin\" id=\"ref-for-concept-request-origin①\">origin</a> and <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-url\" id=\"ref-for-concept-request-url②\">URL</a>'s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-origin\" id=\"ref-for-concept-url-origin②①\">origin</a> are not <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#same-origin\" id=\"ref-for-same-origin④\">same origin</a>.</p>"
                },
                {
                  "html": "<p>Let <var>allowed</var> be true.</p>"
                },
                {
                  "html": "If <var>dataOriginUrl</var>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-origin\" id=\"ref-for-concept-url-origin②②\">origin</a> and <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-url\" id=\"ref-for-concept-request-url③\">URL</a>'s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-origin\" id=\"ref-for-concept-url-origin②③\">origin</a> are <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#same-origin\" id=\"ref-for-same-origin⑤\">same origin</a>:",
                  "rationale": "let",
                  "steps": [
                    {
                      "html": "<p>Let <var>responseHeaders</var> be <var>internalResponse</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-header-list\" id=\"ref-for-concept-response-header-list①\">header list</a>.</p>"
                    },
                    {
                      "html": "<p>Let <var>allowed</var> be the result of running <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-header-list-get-structured-header\" id=\"ref-for-concept-header-list-get-structured-header\">get a structured field value</a> algorithm given <span>`<code><a data-link-type=\"http-header\" href=\"https://wicg.github.io/shared-storage/#http-headerdef-shared-storage-cross-origin-worklet-allowed\" id=\"ref-for-http-headerdef-shared-storage-cross-origin-worklet-allowed④\">Shared-Storage-Cross-Origin-Worklet-Allowed</a></code>`</span>, \"item\", and <var>responseHeaders</var> as input.</p>"
                    }
                  ]
                },
                {
                  "html": "<p>If <var>allowed</var> is false, then return a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-network-error\" id=\"ref-for-concept-network-error\">network error</a>.</p>"
                }
              ]
            }
          ]
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#handle-a-shared-storage-write-response\" id=\"ref-for-handle-a-shared-storage-write-response\">Handle a Shared-Storage-Write response</a>, given <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response\" id=\"ref-for-concept-response②\">response</a> <var>internalResponse</var> and <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request\" id=\"ref-for-concept-request②\">request</a> <var>request</var> as input.</p>"
        }
      ]
    },
    {
      "name": "determine whether a request can currently use shared storage",
      "href": "https://wicg.github.io/shared-storage/#determine-whether-a-request-can-currently-use-shared-storage",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"determine-whether-a-request-can-currently-use-shared-storage\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">determine whether a request can currently use shared storage</dfn>, given a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request\" id=\"ref-for-concept-request⑧\">request</a> <var>request</var>, perform the following steps:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>window</var> to <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-window\" id=\"ref-for-concept-request-window①\">window</a>.</p>"
        },
        {
          "html": "<p>If <var>window</var> is not an <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object\" id=\"ref-for-environment-settings-object①⑥\">environment settings object</a> whose <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-realm-global\" id=\"ref-for-concept-realm-global③①\">global object</a> is a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#window\" id=\"ref-for-window②⑧\">Window</a></code>, return false.</p>"
        },
        {
          "html": "<p>Let <var>allowedInOpaqueOriginContext</var> be true.</p>"
        },
        {
          "html": "<p>If the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#determine-whether-shared-storage-is-allowed-by-context\" id=\"ref-for-determine-whether-shared-storage-is-allowed-by-context⑥\">determine whether shared storage is allowed by context</a> given <var>window</var>, <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-current-url\" id=\"ref-for-concept-request-current-url①\">current URL</a>'s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-origin\" id=\"ref-for-concept-url-origin②⑥\">origin</a>, and <var>allowedInOpaqueOriginContext</var> is false, return false.</p>"
        },
        {
          "html": "<p>If the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#check-if-user-preference-setting-allows-access-to-shared-storage\" id=\"ref-for-check-if-user-preference-setting-allows-access-to-shared-storage⑥\">check if user preference setting allows access to shared storage</a> given <var>window</var> and <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-current-url\" id=\"ref-for-concept-request-current-url②\">current URL</a>'s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-origin\" id=\"ref-for-concept-url-origin②⑦\">origin</a> is false, return false.</p>"
        }
      ]
    },
    {
      "name": "append or modify a Sec-Shared-Storage-Writable request header",
      "href": "https://wicg.github.io/shared-storage/#append-or-modify-a-sec-shared-storage-writable-request-header",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"append-or-modify-a-sec-shared-storage-writable-request-header\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">append or modify a Sec-Shared-Storage-Writable request header</dfn>, given a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request\" id=\"ref-for-concept-request⑨\">request</a> <var>request</var>, perform the following steps:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#request-shared-storage-writable\" id=\"ref-for-request-shared-storage-writable③\">shared storage writable</a> is not true, then return.</p>"
        },
        {
          "html": "<p>If the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#determine-whether-a-request-can-currently-use-shared-storage\" id=\"ref-for-determine-whether-a-request-can-currently-use-shared-storage②\">determine whether a request can currently use shared storage</a> on <var>request</var> is false, <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-header-list-delete\" id=\"ref-for-concept-header-list-delete\">delete</a> <span>`<code><a data-link-type=\"http-header\" href=\"https://wicg.github.io/shared-storage/#http-headerdef-sec-shared-storage-writable\" id=\"ref-for-http-headerdef-sec-shared-storage-writable③\">Sec-Shared-Storage-Writable</a></code>`</span> from <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-header-list\" id=\"ref-for-concept-request-header-list③\">header list</a>.</p>"
        },
        {
          "html": "<p>Otherwise, <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-header-list-set-structured-header\" id=\"ref-for-concept-header-list-set-structured-header\">set a structured field value</a> (<span>`<code><a data-link-type=\"http-header\" href=\"https://wicg.github.io/shared-storage/#http-headerdef-sec-shared-storage-writable\" id=\"ref-for-http-headerdef-sec-shared-storage-writable④\">Sec-Shared-Storage-Writable</a></code>`</span>, true) in <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-header-list\" id=\"ref-for-concept-request-header-list④\">header list</a>.</p>"
        }
      ]
    },
    {
      "name": "handle a Shared-Storage-Write response",
      "href": "https://wicg.github.io/shared-storage/#handle-a-shared-storage-write-response",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"handle-a-shared-storage-write-response\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">handle a Shared-Storage-Write response</dfn>, given a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response\" id=\"ref-for-concept-response⑨\">response</a> <var>response</var> and a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request\" id=\"ref-for-concept-request①⓪\">request</a> <var>request</var>, perform the following steps:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>sharedStorageWritable</var> the result of running <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-header-list-get-structured-header\" id=\"ref-for-concept-header-list-get-structured-header①\">get a structured field value</a> algorithm given <span>`<code><a data-link-type=\"http-header\" href=\"https://wicg.github.io/shared-storage/#http-headerdef-sec-shared-storage-writable\" id=\"ref-for-http-headerdef-sec-shared-storage-writable⑤\">Sec-Shared-Storage-Writable</a></code>`</span>, \"<code>item</code>\", and <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-header-list\" id=\"ref-for-concept-request-header-list⑤\">header list</a> as input.</p>"
        },
        {
          "html": "<p>If <var>sharedStorageWritable</var> is null, or <var>sharedStorageWritable</var> is not a <a data-link-type=\"dfn\" href=\"https://httpwg.org/specs/rfc8941.html#boolean\" id=\"ref-for-boolean⑧\">Boolean</a>, or the value of <var>sharedStorageWritable</var> is false, return.</p>"
        },
        {
          "html": "<p>Let <var>window</var> to <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-window\" id=\"ref-for-concept-request-window②\">window</a>.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert②⑨\">Assert</a>: <var>window</var> is an <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object\" id=\"ref-for-environment-settings-object①⑦\">environment settings object</a> whose <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-realm-global\" id=\"ref-for-concept-realm-global③②\">global object</a> is a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#window\" id=\"ref-for-window②⑨\">Window</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>sharedStorage</var> be <var>window</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-realm-global\" id=\"ref-for-concept-realm-global③③\">global object</a>'s <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#dom-window-sharedstorage\" id=\"ref-for-dom-window-sharedstorage③\">sharedStorage</a></code>.</p>"
        },
        {
          "html": "<p>If <var>sharedStorage</var> is null, then return.</p>"
        },
        {
          "html": "<p>Let <var>list</var> be <var>response</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-header-list\" id=\"ref-for-concept-response-header-list②\">header list</a>.</p>"
        },
        {
          "html": "<p>Let <var>operationsToParse</var> be the result of running <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-header-list-get-structured-header\" id=\"ref-for-concept-header-list-get-structured-header②\">get a structured field value</a> algorithm given <span>`<code><a data-link-type=\"http-header\" href=\"https://wicg.github.io/shared-storage/#http-headerdef-shared-storage-write\" id=\"ref-for-http-headerdef-shared-storage-write②\">Shared-Storage-Write</a></code>`</span>, \"<code>list</code>\", and <var>list</var> as input.</p>"
        },
        {
          "html": "<p>If <var>operationsToParse</var> is null or <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-empty\" id=\"ref-for-list-empty⑤\">empty</a>, then return.</p>"
        },
        {
          "html": "For each tuple (<var>item</var>, <var>parameters</var>) in <var>operationsToParse</var>, perform the following steps:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>item</var> is an <a data-link-type=\"dfn\" href=\"https://httpwg.org/specs/rfc8941.html#inner-list\" id=\"ref-for-inner-list\">Inner List</a>, continue.</p>"
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert③⓪\">Assert</a>: <var>item</var> is an <a data-link-type=\"dfn\" href=\"https://httpwg.org/specs/rfc8941.html#item\" id=\"ref-for-item\">Bare Item</a>.</p>"
            },
            {
              "html": "<p>Let <var>operationString</var> be the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#get-the-string-value\" id=\"ref-for-get-the-string-value\">get the string value</a> for <var>item</var>.</p>"
            },
            {
              "html": "<p>If <var>operationString</var> is failure, continue.</p>"
            },
            {
              "html": "Switch on <var>operationString</var>:",
              "rationale": ".switch",
              "steps": [
                {
                  "operation": "switch",
                  "steps": [
                    {
                      "case": "If operationString is \"clear\":",
                      "html": "Perform the following steps:",
                      "rationale": "run",
                      "steps": [
                        {
                          "html": "<p>Run <var>sharedStorage</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#dom-sharedstorage-clear\" id=\"ref-for-dom-sharedstorage-clear②\">clear</a></code>().</p>"
                        },
                        {
                          "html": "<p>Continue.</p>"
                        }
                      ]
                    },
                    {
                      "case": "If operationString is \"delete\":",
                      "html": "Perform the following steps:",
                      "rationale": "let",
                      "steps": [
                        {
                          "html": "<p>Let <var>key</var> be the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#obtain-a-string-like-parameter-value\" id=\"ref-for-obtain-a-string-like-parameter-value\">obtain a string-like parameter value</a> with <var>parameters</var> and \"<code>key</code>\".</p>"
                        },
                        {
                          "html": "<p>If <var>key</var> is not null, run <var>sharedStorage</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#dom-sharedstorage-delete\" id=\"ref-for-dom-sharedstorage-delete②\">delete</a></code>(<var>key</var>).</p>"
                        },
                        {
                          "html": "<p>Continue.</p>"
                        }
                      ]
                    },
                    {
                      "case": "If operationString is \"append\":",
                      "html": "Perform the following steps:",
                      "rationale": "let",
                      "steps": [
                        {
                          "html": "<p>Let <var>key</var> be the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#obtain-a-string-like-parameter-value\" id=\"ref-for-obtain-a-string-like-parameter-value①\">obtain a string-like parameter value</a> with <var>parameters</var> and \"<code>key</code>\".</p>"
                        },
                        {
                          "html": "<p>If <var>key</var> is null, continue.</p>"
                        },
                        {
                          "html": "<p>Let <var>value</var> be the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#obtain-a-string-like-parameter-value\" id=\"ref-for-obtain-a-string-like-parameter-value②\">obtain a string-like parameter value</a> with <var>parameters</var> and \"<code>value</code>\".</p>"
                        },
                        {
                          "html": "<p>If <var>value</var> is not null, run <var>sharedStorage</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#dom-sharedstorage-append\" id=\"ref-for-dom-sharedstorage-append②\">append</a></code>(<var>key</var>, <var>value</var>).</p>"
                        },
                        {
                          "html": "<p>Continue.</p>"
                        }
                      ]
                    },
                    {
                      "case": "If operationString is \"set\":",
                      "html": "Perform the following steps:",
                      "rationale": "let",
                      "steps": [
                        {
                          "html": "<p>Let <var>key</var> be the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#obtain-a-string-like-parameter-value\" id=\"ref-for-obtain-a-string-like-parameter-value③\">obtain a string-like parameter value</a> with <var>parameters</var> and \"<code>key</code>\".</p>"
                        },
                        {
                          "html": "<p>If <var>key</var> is null, continue.</p>"
                        },
                        {
                          "html": "<p>Let <var>value</var> be the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#obtain-a-string-like-parameter-value\" id=\"ref-for-obtain-a-string-like-parameter-value④\">obtain a string-like parameter value</a> with <var>parameters</var> and \"<code>value</code>\".</p>"
                        },
                        {
                          "html": "<p>If <var>value</var> is null, continue.</p>"
                        },
                        {
                          "html": "<p>Let <var>options</var> be a new <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#dictdef-sharedstoragesetmethodoptions\" id=\"ref-for-dictdef-sharedstoragesetmethodoptions①\">SharedStorageSetMethodOptions</a></code>.</p>"
                        },
                        {
                          "html": "<p>If the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#obtain-a-boolean-parameter-value\" id=\"ref-for-obtain-a-boolean-parameter-value\">obtain a boolean parameter value</a> with <var>parameters</var> and \"<code>ignore_if_present</code>\" is true, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-set\" id=\"ref-for-map-set⑥\">set</a> <var>options</var>[\"<code>ignoreIfPresent</code>\"] to true.</p>"
                        },
                        {
                          "html": "<p>Run <var>sharedStorage</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#dom-sharedstorage-set\" id=\"ref-for-dom-sharedstorage-set②\">set</a></code>(<var>key</var>, <var>value</var>, <var>options</var>).</p>"
                        },
                        {
                          "html": "<p>Continue.</p>"
                        }
                      ]
                    },
                    {
                      "case": "If operationString is anything else:",
                      "html": "Continue."
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "check if string-like",
      "href": "https://wicg.github.io/shared-storage/#check-if-string-like",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"check-if-string-like\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">check if string-like</dfn> for a <a data-link-type=\"dfn\" href=\"https://httpwg.org/specs/rfc8941.html#item\" id=\"ref-for-item①\">Bare Item</a> <var>item</var>, do the following:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If the <var>item</var> is a <a data-link-type=\"dfn\" href=\"https://httpwg.org/specs/rfc8941.html#string\" id=\"ref-for-string②⑧\">String</a>, <a data-link-type=\"dfn\" href=\"https://httpwg.org/specs/rfc8941.html#token\" id=\"ref-for-token⑥\">Token</a>, or <a data-link-type=\"dfn\" href=\"https://httpwg.org/specs/rfc8941.html#binary\" id=\"ref-for-binary⑨\">Byte Sequence</a>, return true.</p>"
        },
        {
          "html": "<p>Otherwise, return false.</p>"
        }
      ]
    },
    {
      "name": "get the string value",
      "href": "https://wicg.github.io/shared-storage/#get-the-string-value",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"get-the-string-value\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">get the string value</dfn> for a <a data-link-type=\"dfn\" href=\"https://httpwg.org/specs/rfc8941.html#item\" id=\"ref-for-item②\">Bare Item</a> <var>item</var>, do the following:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#check-if-string-like\" id=\"ref-for-check-if-string-like\">check if string-like</a> on <var>item</var> is false, return failure.</p>"
        },
        {
          "html": "Switch on the type of <var>item</var>:",
          "rationale": ".switch",
          "steps": [
            {
              "operation": "switch",
              "steps": [
                {
                  "case": "If item is a Token:",
                  "html": "Perform the following steps:",
                  "rationale": "assert",
                  "steps": [
                    {
                      "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert③①\">Assert</a>: <var>item</var> is an <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#ascii-string\" id=\"ref-for-ascii-string\">ASCII string</a>.</p>"
                    },
                    {
                      "html": "<p>Return <var>item</var>.</p>"
                    }
                  ]
                },
                {
                  "case": "If item is a String:",
                  "html": "Perform the following steps:",
                  "rationale": "assert",
                  "steps": [
                    {
                      "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert③①\">Assert</a>: <var>item</var> is an <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#ascii-string\" id=\"ref-for-ascii-string\">ASCII string</a>.</p>"
                    },
                    {
                      "html": "<p>Return <var>item</var>.</p>"
                    }
                  ]
                },
                {
                  "case": "If item is a Byte Sequence:",
                  "html": "Perform the following steps:",
                  "rationale": "let",
                  "steps": [
                    {
                      "html": "<p>Let <var>fromUTF8</var> be the result of running <a data-link-type=\"dfn\" href=\"https://encoding.spec.whatwg.org/#utf-8-decode\" id=\"ref-for-utf-8-decode①\">UTF-8 decode</a> on <var>item</var>.</p>"
                    },
                    {
                      "html": "<p>If <var>fromUTF8</var> is an error, return null.</p>"
                    },
                    {
                      "html": "<p>Return <var>fromUTF8</var>.</p>"
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "obtain a string-like parameter value",
      "href": "https://wicg.github.io/shared-storage/#obtain-a-string-like-parameter-value",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"obtain-a-string-like-parameter-value\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">obtain a string-like parameter value</dfn>, given a <a data-link-type=\"dfn\" href=\"https://httpwg.org/specs/rfc8941.html#param\" id=\"ref-for-param①⑤\">parameters map</a> <var>parameters</var> and a <a data-link-type=\"dfn\" href=\"https://httpwg.org/specs/rfc8941.html#token\" id=\"ref-for-token⑧\">Token</a> <var>paramKey</var>, perform the following steps:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If <var>parameters</var> does not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists①⑧\">contain</a> <var>paramKey</var>, return null.</p>"
        },
        {
          "html": "<p>If the result of <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#check-if-string-like\" id=\"ref-for-check-if-string-like①\">check if string-like</a> for <var>parameters</var>[<var>paramKey</var>] is false, return null.</p>"
        },
        {
          "html": "<p>Return the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#get-the-string-value\" id=\"ref-for-get-the-string-value①\">get the string value</a> for <var>parameters</var>[<var>paramKey</var>].</p>"
        }
      ]
    },
    {
      "name": "obtain a boolean parameter value",
      "href": "https://wicg.github.io/shared-storage/#obtain-a-boolean-parameter-value",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"obtain-a-boolean-parameter-value\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">obtain a boolean parameter value</dfn>, given a <a data-link-type=\"dfn\" href=\"https://httpwg.org/specs/rfc8941.html#param\" id=\"ref-for-param①⑥\">parameters map</a> <var>parameters</var> and a <a data-link-type=\"dfn\" href=\"https://httpwg.org/specs/rfc8941.html#token\" id=\"ref-for-token⑨\">Token</a> <var>paramKey</var>, perform the following steps:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If <var>parameters</var> does not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists①⑨\">contain</a> <var>paramKey</var>, return null.</p>"
        },
        {
          "html": "<p>If <var>parameters</var>[<var>paramKey</var>] is not a <a data-link-type=\"dfn\" href=\"https://httpwg.org/specs/rfc8941.html#boolean\" id=\"ref-for-boolean⑨\">Boolean</a>, return null.</p>"
        },
        {
          "html": "<p>Return <var>parameters</var>[<var>paramKey</var>].</p>"
        }
      ]
    },
    {
      "name": "monkey-patch-obtain-a-lock-manager",
      "html": "",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "If <a data-link-type=\"dfn\" href=\"https://tc39.es/ecma262/#current-realm\" id=\"ref-for-current-realm①⑤\">current realm</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-realm-global\" id=\"ref-for-concept-realm-global③④\">global object</a> is a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworkletglobalscope\" id=\"ref-for-sharedstorageworkletglobalscope④⓪\">SharedStorageWorkletGlobalScope</a></code>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>workletDataOrigin</var> be <var>environment</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin\" id=\"ref-for-concept-settings-object-origin③⓪\">origin</a>.</p>"
            },
            {
              "html": "<p>Return <a data-link-type=\"dfn\" href=\"https://wicg.github.io/shared-storage/#shared-storage-lock-managers-map\" id=\"ref-for-shared-storage-lock-managers-map②\">shared storage lock managers map</a>[<var>workletDataOrigin</var>].</p>"
            }
          ]
        }
      ]
    }
  ]
}