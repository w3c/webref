{
  "spec": {
    "title": "Attribution Level 1",
    "url": "https://w3c.github.io/ppa/"
  },
  "algorithms": [
    {
      "name": "clear impressions for a conversion site",
      "href": "https://w3c.github.io/ppa/#clear-impressions-for-a-conversion-site",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"clear-impressions-for-a-conversion-site\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">clear impressions for a conversion site</dfn>,\ngiven an <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/#concept-origin\" id=\"ref-for-concept-origin③\">origin</a> <var>origin</var>,\nrun these steps:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If <var>origin</var> is not a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-tuple\" id=\"ref-for-concept-origin-tuple\">tuple origin</a> with a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/#concept-origin-scheme\" id=\"ref-for-concept-origin-scheme\">scheme</a> of <code>https</code>,\nreturn.</p>"
        },
        {
          "html": "<p>Let <var>site</var> be the value returned\nby invoking <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#host-registrable-domain\" id=\"ref-for-host-registrable-domain\">obtain a registrable domain</a>,\npassing the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/#concept-origin-host\" id=\"ref-for-concept-origin-host\">host</a> part of the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-tuple\" id=\"ref-for-concept-origin-tuple①\">origin tuple</a>.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate\">For each</a> <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#impression\" id=\"ref-for-impression④④\">impression</a> <var>impression</var> of\nthe <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#impression-store\" id=\"ref-for-impression-store⑤\">impression store</a>:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>impression</var> has an <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#impression-intermediary-site\" id=\"ref-for-impression-intermediary-site\">Intermediary Site</a> equal to <var>site</var>,\n<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-remove\" id=\"ref-for-list-remove\">remove</a> <var>impression</var> from the <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#impression-store\" id=\"ref-for-impression-store⑥\">impression store</a> and <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue\">continue</a>.</p>"
            },
            {
              "html": "<p>If <var>impression</var> has a <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#impression-conversion-sites\" id=\"ref-for-impression-conversion-sites①\">Conversion Sites</a> <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#sets\" id=\"ref-for-sets⑥\">set</a>\nthat does not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-contain\" id=\"ref-for-list-contain①\">contain</a> the value <var>site</var>, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue①\">continue</a>.</p>"
            },
            {
              "html": "<p>If the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-size\" id=\"ref-for-list-size\">size</a> of <var>impression</var>’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#impression-conversion-sites\" id=\"ref-for-impression-conversion-sites②\">Conversion Sites</a>\nis greater than one,\n<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-remove\" id=\"ref-for-list-remove①\">remove</a> <var>site</var> from <var>impression</var>’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#impression-conversion-sites\" id=\"ref-for-impression-conversion-sites③\">Conversion Sites</a>\nand <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue②\">continue</a>.</p>"
            },
            {
              "html": "<p>Otherwise, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-remove\" id=\"ref-for-list-remove②\">remove</a> <var>impression</var> from the <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#impression-store\" id=\"ref-for-impression-store⑦\">impression store</a>.</p>"
            }
          ]
        }
      ]
    },
    {
      "name": "parse a site",
      "href": "https://w3c.github.io/ppa/#parse-a-site",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"parse-a-site\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">parse a site</dfn>,\nreturning either <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/#site\" id=\"ref-for-site⑨\">site</a> or failure,\ngiven a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#string\" id=\"ref-for-string①\">string</a> <var>input</var>,\nrun these steps:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>host</var> be the value returned by invoking <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-host-parser\" id=\"ref-for-concept-host-parser\">host parser</a>,\npassing <var>input</var>.</p>"
        },
        {
          "html": "<p>If <var>host</var> is failure, return failure.</p>"
        },
        {
          "html": "<p>Let <var>site</var> be the value returned by <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#host-registrable-domain\" id=\"ref-for-host-registrable-domain①\">obtain a registrable domain</a>,\npassing <var>host</var>.</p>"
        },
        {
          "html": "<p>If <var>site</var> is null, return failure.</p>"
        },
        {
          "html": "<p>Return a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/#scheme-and-host\" id=\"ref-for-scheme-and-host①\">scheme-and-host</a> tuple of (\"<code>https</code>\", <var>site</var>).</p>"
        }
      ]
    },
    {
      "name": "deduct privacy budget",
      "href": "https://w3c.github.io/ppa/#deduct-privacy-budget",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"deduct-privacy-budget\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">deduct privacy budget</dfn>\ngiven a <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#privacy-budget-key\" id=\"ref-for-privacy-budget-key①\">privacy budget key</a> <var>key</var>,\n<a href=\"https://webidl.spec.whatwg.org/#idl-double\" id=\"a38011ce0\">double</a> <var>epsilon</var>,\ninteger <var>sensitivity</var>,\nand integer <var>globalSensitivity</var>:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If the <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#privacy-budget-store\" id=\"ref-for-privacy-budget-store④\">privacy budget store</a> does not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists\">contain</a> <var>key</var>, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-set\" id=\"ref-for-map-set\">set</a>\nits value of <var>key</var> to be a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#user-agent\" id=\"ref-for-user-agent⑨\">user agent</a>-defined value,\nplus 1000.</p>"
        },
        {
          "html": "<p>Let <var>currentValue</var> be the result of <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-get\" id=\"ref-for-map-get\">getting the value</a> of <var>key</var>\nin the <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#privacy-budget-store\" id=\"ref-for-privacy-budget-store⑤\">privacy budget store</a>.</p>"
        },
        {
          "html": "<p>Let <var>deductionFp</var> be <var>epsilon</var> * <var>sensitivity</var> / <var>globalSensitivity</var>.</p>"
        },
        {
          "html": "<p>If <var>deductionFp</var> is negative or greater than <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#maximum-epsilon\" id=\"ref-for-maximum-epsilon\">maximum epsilon</a>,\n<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-set\" id=\"ref-for-map-set①\">set</a> the value of <var>key</var> in the <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#privacy-budget-store\" id=\"ref-for-privacy-budget-store⑥\">privacy budget store</a> to 0\nand return false.</p>"
        },
        {
          "html": "<p>Let <var>deduction</var> be <var>deductionFp</var> * 1000000, rounded towards positive Infinity.</p>"
        },
        {
          "html": "<p>If <var>deduction</var> is greater than <var>currentValue</var>,\n<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-set\" id=\"ref-for-map-set②\">set</a> the value of <var>key</var> in the <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#privacy-budget-store\" id=\"ref-for-privacy-budget-store⑦\">privacy budget store</a> to 0\nand return false.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-set\" id=\"ref-for-map-set③\">Set</a> the value of <var>key</var> in the <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#privacy-budget-store\" id=\"ref-for-privacy-budget-store⑧\">privacy budget store</a>\nto <var>currentValue</var> − <var>deduction</var>\nand return true.</p>"
        }
      ]
    },
    {
      "name": "get the current epoch",
      "href": "https://w3c.github.io/ppa/#get-the-current-epoch",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"get-the-current-epoch\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">get the current epoch</dfn>\ngiven a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/#site\" id=\"ref-for-site①⑦\">site</a> <var>site</var>,\nand <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/hr-time-3/#dfn-moment\" id=\"ref-for-dfn-moment⑤\">moment</a> <var>t</var>,\nreturning an <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#epoch-index\" id=\"ref-for-epoch-index⑥\">epoch index</a>:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>period</var> be the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/hr-time-3/#dfn-duration\" id=\"ref-for-dfn-duration②\">duration</a> of one <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#privacy-budget-epoch\" id=\"ref-for-privacy-budget-epoch①②\">epoch</a>.</p>"
        },
        {
          "html": "<p>If the <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#epoch-start-store\" id=\"ref-for-epoch-start-store③\">epoch start store</a> does not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists①\">contain</a> <var>site</var>, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-set\" id=\"ref-for-map-set④\">set</a>\nits value to <var>t</var>, minus a <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/hr-time-3/#dfn-duration\" id=\"ref-for-dfn-duration③\">duration</a>\nthat is randomly selected\nfrom between 0 (inclusive) and <var>period</var> (exclusive).</p>"
        },
        {
          "html": "<p>Let <var>start</var> be the result of <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-get\" id=\"ref-for-map-get①\">getting the value</a> of <var>site</var>\nfrom the <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#epoch-start-store\" id=\"ref-for-epoch-start-store④\">epoch start store</a>.</p>"
        },
        {
          "html": "<p>Let <var>elapsed</var> be (<var>t</var> − <var>start</var>) / <var>period</var>.</p>"
        },
        {
          "html": "<p>Return <var>elapsed</var> as an integer, rounded towards negative Infinity.</p>"
        }
      ]
    },
    {
      "name": "get the starting epoch for attribution",
      "href": "https://w3c.github.io/ppa/#get-the-starting-epoch-for-attribution",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"get-the-starting-epoch-for-attribution\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">get the starting epoch for attribution</dfn>\ngiven <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/#site\" id=\"ref-for-site②④\">site</a> <var>site</var>,\nreturning an <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#epoch-index\" id=\"ref-for-epoch-index⑧\">epoch index</a>:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>startEpoch</var> be a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#user-agent\" id=\"ref-for-user-agent①⑥\">user agent</a>-defined value\nfor the earliest <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#epoch-index\" id=\"ref-for-epoch-index⑨\">epoch index</a>\nthat is supported for attribution.</p>"
        },
        {
          "html": "If the <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#last-browsing-history-clear\" id=\"ref-for-last-browsing-history-clear④\">last browsing history clear</a> is set,\nperform the following steps:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>clearEpoch</var> be the result of <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#get-the-current-epoch\" id=\"ref-for-get-the-current-epoch③\">get the current epoch</a>\nwith <var>site</var> and the value of <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#last-browsing-history-clear\" id=\"ref-for-last-browsing-history-clear⑤\">last browsing history clear</a>.</p>"
            },
            {
              "html": "<p>Set <var>clearEpoch</var> to <var>clearEpoch</var> + 2.</p>"
            },
            {
              "html": "<p>If <var>clearEpoch</var> is greater than <var>startEpoch</var>,\nreturn <var>clearEpoch</var>.</p>"
            }
          ]
        },
        {
          "html": "<p>Return <var>startEpoch</var>.</p>"
        }
      ]
    },
    {
      "name": "Attribution/saveImpression(options)",
      "href": "https://w3c.github.io/ppa/#dom-attribution-saveimpression",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"Attribution\" data-dfn-type=\"method\" data-export=\"\" id=\"dom-attribution-saveimpression\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>saveImpression(<var>options</var>)</code></dfn> method steps are:\n\n\n    \n    <p class=\"advisement\"><a class=\"idl-code\" data-link-type=\"method\" href=\"https://w3c.github.io/ppa/#dom-attribution-saveimpression\" id=\"ref-for-dom-attribution-saveimpression①⑦\">saveImpression()</a>\ndoes not return a status indicating whether the impression was recorded.\nThis minimizes the ability to detect when the Attribution\nAPI is <a href=\"https://w3c.github.io/ppa/#opt-out\">disabled</a>. Similarly, resolution of the returned promise is\nnot predicated on saving <var>impression</var> to the <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#impression-store\" id=\"ref-for-impression-store①③\">impression store</a> in order to\navoid timing <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#side-channels\" id=\"ref-for-side-channels\">side channels</a> related to the number of existing impressions and\nwhether the API is enabled.\n\n</p>",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>realm</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this\">this</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-realm\" id=\"ref-for-concept-relevant-realm\">relevant realm</a>.</p>"
        },
        {
          "html": "<p>If <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this①\">this</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global\" id=\"ref-for-concept-relevant-global\">relevant global object</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#concept-document-window\" id=\"ref-for-concept-document-window\">associated Document</a> is not\n<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/iframe-embed-object.html#allowed-to-use\" id=\"ref-for-allowed-to-use\">allowed to use</a> the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/permissions-policy-1/#policy-controlled-feature\" id=\"ref-for-policy-controlled-feature①\">policy-controlled feature</a> named\n\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#dom-permissionpolicy-save-impression\" id=\"ref-for-dom-permissionpolicy-save-impression\">save-impression</a></code>\", return <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with\">a promise rejected with</a>\na <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#notallowederror\" id=\"ref-for-notallowederror\">\"NotAllowedError\"</a></code> <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException\">DOMException</a></code> in <var>realm</var>.</p>"
        },
        {
          "html": "<p>Let <var>settings</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this②\">this</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/#relevant-settings-object\" id=\"ref-for-relevant-settings-object③\">relevant settings object</a>.</p>"
        },
        {
          "html": "Collect the implicit API inputs from <var>settings</var>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>timestamp</var> be <var>settings</var>’ <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/hr-time-3/#dfn-eso-current-wall-time\" id=\"ref-for-dfn-eso-current-wall-time\">current wall time</a>.</p>"
            },
            {
              "html": "<p>The <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#impression-site\" id=\"ref-for-impression-site⑧\">impression site</a> <var>site</var> is set to the result of\n<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/#obtain-a-site\" id=\"ref-for-obtain-a-site\">obtaining a site</a> from the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/#concept-environment-top-level-origin\" id=\"ref-for-concept-environment-top-level-origin③\">top-level origin</a>.</p>"
            },
            {
              "html": "The <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#intermediary-site\" id=\"ref-for-intermediary-site①③\">intermediary site</a> <var>intermediarySite</var> is set to",
              "rationale": "/^otherwise(\\,| )/i",
              "steps": [
                {
                  "html": "<p>a value of <code>undefined</code> if the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/#concept-origin\" id=\"ref-for-concept-origin④\">origin</a> is <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/#same-site\" id=\"ref-for-same-site②\">same site</a>\n with the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/#concept-environment-top-level-origin\" id=\"ref-for-concept-environment-top-level-origin④\">top-level origin</a>,</p>"
                },
                {
                  "html": "<p>otherwise, the result of\n <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/#obtain-a-site\" id=\"ref-for-obtain-a-site①\">obtaining a site</a>\n from <var>settings</var>’ <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin\" id=\"ref-for-concept-settings-object-origin\">origin</a>.</p>"
                }
              ]
            }
          ]
        },
        {
          "html": "Validate the page-supplied API inputs:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#dom-attributionimpressionoptions-histogramindex\" id=\"ref-for-dom-attributionimpressionoptions-histogramindex②\">histogramIndex</a></code> is\ngreater than or equal to the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#implementation-defined\" id=\"ref-for-implementation-defined①\">implementation-defined</a> <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#maximum-histogram-size\" id=\"ref-for-maximum-histogram-size\">maximum histogram size</a>,\nreturn <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with①\">a promise rejected with</a> a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-rangeerror\" id=\"ref-for-exceptiondef-rangeerror\">RangeError</a></code> in <var>realm</var>.</p>"
            },
            {
              "html": "<p>If <var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#dom-attributionimpressionoptions-lifetimedays\" id=\"ref-for-dom-attributionimpressionoptions-lifetimedays②\">lifetimeDays</a></code> is 0,\nreturn <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with②\">a promise rejected with</a> a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-rangeerror\" id=\"ref-for-exceptiondef-rangeerror①\">RangeError</a></code> in <var>realm</var>.</p>"
            },
            {
              "html": "<p>Clamp <var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#dom-attributionimpressionoptions-lifetimedays\" id=\"ref-for-dom-attributionimpressionoptions-lifetimedays③\">lifetimeDays</a></code> to\nthe <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#user-agent\" id=\"ref-for-user-agent①⑧\">user agent</a>’s upper limit.</p>"
            },
            {
              "html": "<p>If the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-size\" id=\"ref-for-list-size①\">size</a> of\n<var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#dom-attributionimpressionoptions-conversionsites\" id=\"ref-for-dom-attributionimpressionoptions-conversionsites①\">conversionSites</a></code> is\ngreater than an <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#implementation-defined\" id=\"ref-for-implementation-defined②\">implementation-defined</a> maximum value, return\n<a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with③\">a promise rejected with</a> a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-rangeerror\" id=\"ref-for-exceptiondef-rangeerror②\">RangeError</a></code> in <var>realm</var>.</p>"
            },
            {
              "html": "<p>Let <var>conversionSites</var> be the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#sets\" id=\"ref-for-sets⑨\">set</a> that is the result\nof invoking <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#parse-a-site\" id=\"ref-for-parse-a-site\">parse a site</a>\nfor each value in <var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#dom-attributionimpressionoptions-conversionsites\" id=\"ref-for-dom-attributionimpressionoptions-conversionsites②\">conversionSites</a></code>.</p>"
            },
            {
              "html": "<p>If any result in <var>conversionSites</var> is failure, return\n<a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with④\">a promise rejected with</a> a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#syntaxerror\" id=\"ref-for-syntaxerror\">\"SyntaxError\"</a></code> <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException①\">DOMException</a></code> in <var>realm</var>.</p>"
            },
            {
              "html": "<p>If the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-size\" id=\"ref-for-list-size②\">size</a> of\n<var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#dom-attributionimpressionoptions-conversioncallers\" id=\"ref-for-dom-attributionimpressionoptions-conversioncallers①\">conversionCallers</a></code> is\ngreater than an <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#implementation-defined\" id=\"ref-for-implementation-defined③\">implementation-defined</a> maximum value, return\n<a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with⑤\">a promise rejected with</a> a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-rangeerror\" id=\"ref-for-exceptiondef-rangeerror③\">RangeError</a></code> in <var>realm</var>.</p>"
            },
            {
              "html": "<p>Let <var>conversionCallers</var> be the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#sets\" id=\"ref-for-sets①⓪\">set</a> that is the result\nof invoking <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#parse-a-site\" id=\"ref-for-parse-a-site①\">parse a site</a>\nfor each value in <var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#dom-attributionimpressionoptions-conversioncallers\" id=\"ref-for-dom-attributionimpressionoptions-conversioncallers②\">conversionCallers</a></code>.</p>"
            },
            {
              "html": "<p>If any result in <var>conversionCallers</var> is failure, return\n<a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with⑥\">a promise rejected with</a> a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#syntaxerror\" id=\"ref-for-syntaxerror①\">\"SyntaxError\"</a></code> <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException②\">DOMException</a></code> in <var>realm</var>.</p>"
            }
          ]
        },
        {
          "html": "Run the following steps <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel\">in parallel</a>:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>Construct <var>impression</var> as a <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#impression\" id=\"ref-for-impression④⑤\">saved impression</a> comprising:</p>\n        <dl>\n         <dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#impression-match-value\" id=\"ref-for-impression-match-value①\">Match Value</a>\n         </dt><dd data-md=\"\">\n          <p><var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#dom-attributionimpressionoptions-matchvalue\" id=\"ref-for-dom-attributionimpressionoptions-matchvalue③\">matchValue</a></code></p>\n         </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#impression-impression-site\" id=\"ref-for-impression-impression-site①\">Impression Site</a>\n         </dt><dd data-md=\"\">\n          <p><var>site</var></p>\n         </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#impression-intermediary-site\" id=\"ref-for-impression-intermediary-site②\">Intermediary Site</a>\n         </dt><dd data-md=\"\">\n          <p><var>intermediarySite</var></p>\n         </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#impression-conversion-sites\" id=\"ref-for-impression-conversion-sites⑥\">Conversion Sites</a>\n         </dt><dd data-md=\"\">\n          <p><var>conversionSites</var></p>\n         </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#impression-conversion-callers\" id=\"ref-for-impression-conversion-callers①\">Conversion Callers</a>\n         </dt><dd data-md=\"\">\n          <p><var>conversionCallers</var></p>\n         </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#impression-timestamp\" id=\"ref-for-impression-timestamp①\">Timestamp</a>\n         </dt><dd data-md=\"\">\n          <p><var>timestamp</var></p>\n         </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#impression-lifetime\" id=\"ref-for-impression-lifetime①\">Lifetime</a>\n         </dt><dd data-md=\"\">\n          <p><var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#dom-attributionimpressionoptions-lifetimedays\" id=\"ref-for-dom-attributionimpressionoptions-lifetimedays④\">lifetimeDays</a></code>,\n multiplied by a <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/hr-time-3/#dfn-duration\" id=\"ref-for-dfn-duration④\">duration</a> of one day</p>\n         </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#impression-histogram-index\" id=\"ref-for-impression-histogram-index①\">Histogram Index</a>\n         </dt><dd data-md=\"\">\n          <p><var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#dom-attributionimpressionoptions-histogramindex\" id=\"ref-for-dom-attributionimpressionoptions-histogramindex③\">histogramIndex</a></code></p>\n         </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#impression-priority\" id=\"ref-for-impression-priority\">Priority</a>\n         </dt><dd data-md=\"\">\n          <p><var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#dom-attributionimpressionoptions-priority\" id=\"ref-for-dom-attributionimpressionoptions-priority①\">priority</a></code></p>\n        </dd></dl>"
            },
            {
              "html": "<p>If the Attribution API is <a href=\"https://w3c.github.io/ppa/#opt-out\">enabled</a>,\n save <var>impression</var> to the <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#impression-store\" id=\"ref-for-impression-store①②\">impression store</a>.</p>"
            }
          ]
        },
        {
          "html": "<p>Let <var>result</var> be a new <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#dictdef-attributionimpressionresult\" id=\"ref-for-dictdef-attributionimpressionresult①\">AttributionImpressionResult</a></code>.</p>"
        },
        {
          "html": "<p>Return <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-promise-resolved-with\" id=\"ref-for-a-promise-resolved-with\">a promise resolved with</a> <var>result</var> in <var>realm</var>.</p>"
        }
      ]
    },
    {
      "name": "Attribution/measureConversion(options)",
      "href": "https://w3c.github.io/ppa/#dom-attribution-measureconversion",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"Attribution\" data-dfn-type=\"method\" data-export=\"\" id=\"dom-attribution-measureconversion\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>measureConversion(<var>options</var>)</code></dfn> method steps are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>realm</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this③\">this</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-realm\" id=\"ref-for-concept-relevant-realm①\">relevant realm</a>.</p>"
        },
        {
          "html": "<p>If <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this④\">this</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global\" id=\"ref-for-concept-relevant-global①\">relevant global object</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#concept-document-window\" id=\"ref-for-concept-document-window①\">associated Document</a> is not\n<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/iframe-embed-object.html#allowed-to-use\" id=\"ref-for-allowed-to-use①\">allowed to use</a> the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/permissions-policy-1/#policy-controlled-feature\" id=\"ref-for-policy-controlled-feature②\">policy-controlled feature</a> named\n\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#dom-permissionpolicy-measure-conversion\" id=\"ref-for-dom-permissionpolicy-measure-conversion\">measure-conversion</a></code>\", return <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with⑦\">a promise rejected with</a>\na <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#notallowederror\" id=\"ref-for-notallowederror①\">\"NotAllowedError\"</a></code> <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException③\">DOMException</a></code> in <var>realm</var>.</p>"
        },
        {
          "html": "<p>Let <var>settings</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this⑤\">this</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/#relevant-settings-object\" id=\"ref-for-relevant-settings-object④\">relevant settings object</a>.</p>"
        },
        {
          "html": "Collect the implicit API inputs from <var>settings</var>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>now</var> be <var>settings</var>’ <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/hr-time-3/#dfn-eso-current-wall-time\" id=\"ref-for-dfn-eso-current-wall-time①\">current wall time</a>.</p>"
            },
            {
              "html": "<p>Let <var>topLevelSite</var> (the <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#conversion-site\" id=\"ref-for-conversion-site①②\">conversion site</a>) be the result of\n<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/#obtain-a-site\" id=\"ref-for-obtain-a-site②\">obtaining a site</a> from the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/#concept-environment-top-level-origin\" id=\"ref-for-concept-environment-top-level-origin⑤\">top-level origin</a>.</p>"
            },
            {
              "html": "Let <var>intermediarySite</var> be:",
              "rationale": "/^otherwise(\\,| )/i",
              "steps": [
                {
                  "html": "<p>a value of <code>undefined</code> if the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/#concept-origin\" id=\"ref-for-concept-origin⑤\">origin</a> is <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/#same-site\" id=\"ref-for-same-site③\">same site</a>\n with the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/#concept-environment-top-level-origin\" id=\"ref-for-concept-environment-top-level-origin⑥\">top-level origin</a>,</p>"
                },
                {
                  "html": "<p>otherwise, the result of\n <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/#obtain-a-site\" id=\"ref-for-obtain-a-site③\">obtaining a site</a>\n from <var>settings</var>’ <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin\" id=\"ref-for-concept-settings-object-origin①\">origin</a>.</p>"
                }
              ]
            }
          ]
        },
        {
          "html": "<p>Let <var>validatedOptions</var> be the result of\n<a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#validate-attributionconversionoptions\" id=\"ref-for-validate-attributionconversionoptions\">validating</a> <var>options</var>,\nreturning <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with⑧\">a promise rejected with</a> any thrown reason.</p>"
        },
        {
          "html": "<p>Let <var>promise</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-new-promise\" id=\"ref-for-a-new-promise\">a new promise</a> in <var>realm</var>.</p>"
        },
        {
          "html": "Run the following steps <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel①\">in parallel</a>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>report</var> be the result of invoking <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#create-an-all-zero-histogram\" id=\"ref-for-create-an-all-zero-histogram\">create an all-zero histogram</a> with\n <var>validatedOptions</var>’ <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#validated-conversion-options-histogram-size\" id=\"ref-for-validated-conversion-options-histogram-size\">histogram size</a>.</p>"
            },
            {
              "html": "<p>If the Attribution API is <a href=\"https://w3c.github.io/ppa/#opt-out\">enabled</a>, set <var>report</var> to the\n result of <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#do-attribution-and-fill-a-histogram\" id=\"ref-for-do-attribution-and-fill-a-histogram\">do attribution and fill a histogram</a> with <var>validatedOptions</var>,\n <var>topLevelSite</var>, <var>intermediarySite</var>, and <var>now</var>.</p>"
            },
            {
              "html": "<p>Let <var>aggregationService</var> be <var>validatedOptions</var>’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#validated-conversion-options-aggregation-service\" id=\"ref-for-validated-conversion-options-aggregation-service\">aggregation service</a>.</p>"
            },
            {
              "html": "Switch on the value of <var>aggregationService</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#dom-attributionaggregationservice-protocol\" id=\"ref-for-dom-attributionaggregationservice-protocol①\">protocol</a></code>:",
              "rationale": ".switch",
              "steps": [
                {
                  "operation": "switch",
                  "steps": [
                    {
                      "case": "dap-15-histogram",
                      "html": "Perform the following steps:",
                      "rationale": "let",
                      "steps": [
                        {
                          "html": "<p>Let <var>encryptedReport</var> be the result of invoking <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#construct-a-dap-report\" id=\"ref-for-construct-a-dap-report\">construct a DAP report</a>,\ngiven <var>validatedOptions</var>, <var>topLevelSite</var>, <var>now</var>, and <var>report</var>.</p>"
                        }
                      ]
                    },
                    {
                      "case": "tee-00",
                      "html": "<p>Perform the following steps:</p>",
                      "ignored": [
                        "TODO: see #130"
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "html": "<p>Let <var>result</var> be a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#dictdef-attributionconversionresult\" id=\"ref-for-dictdef-attributionconversionresult①\">AttributionConversionResult</a></code> with the following items:</p>\n        <dl>\n         <dt data-md=\"\"><code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#dom-attributionconversionresult-report\" id=\"ref-for-dom-attributionconversionresult-report\">report</a></code>\n         </dt><dd data-md=\"\">\n          <p><var>encryptedReport</var></p>\n        </dd></dl>"
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task\" id=\"ref-for-queue-a-task\">Queue a task</a> on the <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#attribution-task-source\" id=\"ref-for-attribution-task-source\">Attribution task source</a> to\n <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#resolve\" id=\"ref-for-resolve\">resolve</a> <var>promise</var> with <var>result</var>.</p>"
            }
          ]
        },
        {
          "html": "<p>Return <var>promise</var>.</p>"
        }
      ]
    },
    {
      "name": "validate AttributionConversionOptions",
      "href": "https://w3c.github.io/ppa/#validate-attributionconversionoptions",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"validate-attributionconversionoptions\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">validate <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#dictdef-attributionconversionoptions\" id=\"ref-for-dictdef-attributionconversionoptions②\">AttributionConversionOptions</a></code></dfn> <var>options</var>:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If <a class=\"idl-code\" data-link-type=\"attribute\" href=\"https://w3c.github.io/ppa/#dom-attribution-aggregationservices\" id=\"ref-for-dom-attribution-aggregationservices⑤\">aggregationServices</a> does not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists②\">contain</a>\nan <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-entry\" id=\"ref-for-map-entry\">entry</a> with a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-key\" id=\"ref-for-map-key\">key</a> of <var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#dom-attributionconversionoptions-aggregationservice\" id=\"ref-for-dom-attributionconversionoptions-aggregationservice③\">aggregationService</a></code>,\nthrow a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-referenceerror\" id=\"ref-for-exceptiondef-referenceerror\">ReferenceError</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>aggregationService</var> be the result of <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-get\" id=\"ref-for-map-get②\">getting the value</a>\nfrom <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#attributionaggregationservices\" id=\"ref-for-attributionaggregationservices①\">AttributionAggregationServices</a></code>,\ngiven <var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#dom-attributionconversionoptions-aggregationservice\" id=\"ref-for-dom-attributionconversionoptions-aggregationservice④\">aggregationService</a></code>.</p>"
        },
        {
          "html": "<p>If <var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#dom-attributionconversionoptions-epsilon\" id=\"ref-for-dom-attributionconversionoptions-epsilon①\">epsilon</a></code>\nis less than or equal to 0 or is greater than <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#maximum-epsilon\" id=\"ref-for-maximum-epsilon①\">maximum epsilon</a>,\nthrow a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-rangeerror\" id=\"ref-for-exceptiondef-rangeerror④\">RangeError</a></code>.</p>"
        },
        {
          "html": "<p>If <var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#dom-attributionconversionoptions-histogramsize\" id=\"ref-for-dom-attributionconversionoptions-histogramsize①\">histogramSize</a></code>\nis 0 or greater than the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#implementation-defined\" id=\"ref-for-implementation-defined④\">implementation-defined</a> <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"maximum-histogram-size\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">maximum histogram size</dfn>,\nor is greater than the <dfn data-var-ignore=\"\">maximum aggregation-service histogram size</dfn>,\nif any, for <var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#dom-attributionconversionoptions-aggregationservice\" id=\"ref-for-dom-attributionconversionoptions-aggregationservice⑤\">aggregationService</a></code>,\nthrow a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-rangeerror\" id=\"ref-for-exceptiondef-rangeerror⑤\">RangeError</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>credit</var> be «1».</p>"
        },
        {
          "html": "Switch on the value of <var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#dom-attributionconversionoptions-logic\" id=\"ref-for-dom-attributionconversionoptions-logic①\">logic</a></code>:",
          "rationale": ".switch",
          "steps": [
            {
              "operation": "switch",
              "steps": [
                {
                  "case": "\"last-n-touch\"",
                  "html": "Perform the following steps:",
                  "rationale": "if",
                  "steps": [
                    {
                      "html": "<p>If <var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#dom-attributionconversionoptions-value\" id=\"ref-for-dom-attributionconversionoptions-value①\">value</a></code> is 0,\nthrow a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-rangeerror\" id=\"ref-for-exceptiondef-rangeerror⑥\">RangeError</a></code>.</p>"
                    },
                    {
                      "html": "<p>If <var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#dom-attributionconversionoptions-value\" id=\"ref-for-dom-attributionconversionoptions-value②\">value</a></code>\nis greater than <var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#dom-attributionconversionoptions-maxvalue\" id=\"ref-for-dom-attributionconversionoptions-maxvalue①\">maxValue</a></code>,\nthrow a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-rangeerror\" id=\"ref-for-exceptiondef-rangeerror⑦\">RangeError</a></code>.</p>"
                    },
                    {
                      "html": "If <var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#dom-attributionconversionoptions-logicoptions\" id=\"ref-for-dom-attributionconversionoptions-logicoptions\">logicOptions</a></code>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#dom-attributionlogicoptions-credit\" id=\"ref-for-dom-attributionlogicoptions-credit\">credit</a></code> <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists③\">exists</a>:",
                      "rationale": "set",
                      "steps": [
                        {
                          "html": "<p>Set <var>credit</var> to <var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#dom-attributionconversionoptions-logicoptions\" id=\"ref-for-dom-attributionconversionoptions-logicoptions①\">logicOptions</a></code>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#dom-attributionlogicoptions-credit\" id=\"ref-for-dom-attributionlogicoptions-credit①\">credit</a></code>.</p>"
                        },
                        {
                          "html": "<p>If <var>credit</var> is not a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list\">list</a> or <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-is-empty\" id=\"ref-for-list-is-empty\">is empty</a>, throw a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-rangeerror\" id=\"ref-for-exceptiondef-rangeerror⑧\">RangeError</a></code>.</p>"
                        },
                        {
                          "html": "<p>If any of the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-item\" id=\"ref-for-list-item\">items</a> of <var>credit</var> are less than or equal to 0, throw a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-rangeerror\" id=\"ref-for-exceptiondef-rangeerror⑨\">RangeError</a></code>.</p>"
                        },
                        {
                          "html": "<p>If the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-size\" id=\"ref-for-list-size③\">size</a> of <var>credit</var> exceeds an implementation-defined maximum, throw a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-rangeerror\" id=\"ref-for-exceptiondef-rangeerror①⓪\">RangeError</a></code>.</p>"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "html": "<p>Let <var>validatedLogicOptions</var> be a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#dictdef-attributionlogicoptions\" id=\"ref-for-dictdef-attributionlogicoptions②\">AttributionLogicOptions</a></code> with the following fields:</p>\n      <dl>\n       <dt data-md=\"\"><code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#dom-attributionlogicoptions-credit\" id=\"ref-for-dom-attributionlogicoptions-credit②\">credit</a></code>\n       </dt><dd data-md=\"\">\n        <p><var>credit</var></p>\n      </dd></dl>"
        },
        {
          "html": "<p>Let <var>lookback</var> be <var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#dom-attributionconversionoptions-lookbackdays\" id=\"ref-for-dom-attributionconversionoptions-lookbackdays②\">lookbackDays</a></code> <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#day\" id=\"ref-for-day①\">days</a>\nif it <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists④\">exists</a>, the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#implementation-defined\" id=\"ref-for-implementation-defined⑤\">implementation-defined</a> maximum otherwise.</p>"
        },
        {
          "html": "<p>If <var>lookback</var> is 0 <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#day\" id=\"ref-for-day②\">days</a>, throw a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-rangeerror\" id=\"ref-for-exceptiondef-rangeerror①①\">RangeError</a></code>.</p>"
        },
        {
          "html": "<p>If the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-size\" id=\"ref-for-list-size④\">size</a> of\n<var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#dom-attributionconversionoptions-matchvalues\" id=\"ref-for-dom-attributionconversionoptions-matchvalues②\">matchValues</a></code> is\ngreater than an <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#implementation-defined\" id=\"ref-for-implementation-defined⑥\">implementation-defined</a> maximum value, throw a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-rangeerror\" id=\"ref-for-exceptiondef-rangeerror①②\">RangeError</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>matchValues</var> be the result of running <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#set-create\" id=\"ref-for-set-create\">creating a set</a> with\n<var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#dom-attributionconversionoptions-matchvalues\" id=\"ref-for-dom-attributionconversionoptions-matchvalues③\">matchValues</a></code>.</p>"
        },
        {
          "html": "<p>If the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-size\" id=\"ref-for-list-size⑤\">size</a> of\n<var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#dom-attributionconversionoptions-impressionsites\" id=\"ref-for-dom-attributionconversionoptions-impressionsites②\">impressionSites</a></code> is\ngreater than an <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#implementation-defined\" id=\"ref-for-implementation-defined⑦\">implementation-defined</a> maximum value, throw a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-rangeerror\" id=\"ref-for-exceptiondef-rangeerror①③\">RangeError</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>impressionSites</var> be the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#sets\" id=\"ref-for-sets①④\">set</a> that is the result\nof invoking <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#parse-a-site\" id=\"ref-for-parse-a-site②\">parse a site</a>\nfor each value in <var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#dom-attributionconversionoptions-impressionsites\" id=\"ref-for-dom-attributionconversionoptions-impressionsites③\">impressionSites</a></code>.</p>"
        },
        {
          "html": "<p>If any result in <var>impressionSites</var> is failure, throw a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#syntaxerror\" id=\"ref-for-syntaxerror②\">\"SyntaxError\"</a></code> <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException④\">DOMException</a></code>.</p>"
        },
        {
          "html": "<p>If the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-size\" id=\"ref-for-list-size⑥\">size</a> of\n<var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#dom-attributionconversionoptions-impressioncallers\" id=\"ref-for-dom-attributionconversionoptions-impressioncallers②\">impressionCallers</a></code> is\ngreater than an <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#implementation-defined\" id=\"ref-for-implementation-defined⑧\">implementation-defined</a> maximum value, throw a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-rangeerror\" id=\"ref-for-exceptiondef-rangeerror①④\">RangeError</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>impressionCallers</var> be the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#sets\" id=\"ref-for-sets①⑤\">set</a> that is the result\nof invoking <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#parse-a-site\" id=\"ref-for-parse-a-site③\">parse a site</a>\nfor each value in <var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#dom-attributionconversionoptions-impressioncallers\" id=\"ref-for-dom-attributionconversionoptions-impressioncallers③\">impressionCallers</a></code>.</p>"
        },
        {
          "html": "<p>If any result in <var>impressionCallers</var> is failure, throw a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#syntaxerror\" id=\"ref-for-syntaxerror③\">\"SyntaxError\"</a></code> <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException⑤\">DOMException</a></code>.</p>"
        },
        {
          "html": "<p>Return a <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#validated-conversion-options\" id=\"ref-for-validated-conversion-options\">validated conversion options</a> with the following fields:</p>\n      <dl>\n       <dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#validated-conversion-options-aggregation-service\" id=\"ref-for-validated-conversion-options-aggregation-service①\">Aggregation Service</a>\n       </dt><dd data-md=\"\">\n        <p><var>aggregationService</var></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#validated-conversion-options-epsilon\" id=\"ref-for-validated-conversion-options-epsilon\">Epsilon</a>\n       </dt><dd data-md=\"\">\n        <p><var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#dom-attributionconversionoptions-epsilon\" id=\"ref-for-dom-attributionconversionoptions-epsilon②\">epsilon</a></code></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#validated-conversion-options-histogram-size\" id=\"ref-for-validated-conversion-options-histogram-size①\">Histogram Size</a>\n       </dt><dd data-md=\"\">\n        <p><var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#dom-attributionconversionoptions-histogramsize\" id=\"ref-for-dom-attributionconversionoptions-histogramsize②\">histogramSize</a></code></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#validated-conversion-options-lookback\" id=\"ref-for-validated-conversion-options-lookback\">Lookback</a>\n       </dt><dd data-md=\"\">\n        <p><var>lookback</var></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#validated-conversion-options-match-values\" id=\"ref-for-validated-conversion-options-match-values①\">Match Values</a>\n       </dt><dd data-md=\"\">\n        <p><var>matchValues</var></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#validated-conversion-options-impression-sites\" id=\"ref-for-validated-conversion-options-impression-sites①\">Impression Sites</a>\n       </dt><dd data-md=\"\">\n        <p><var>impressionSites</var></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#validated-conversion-options-impression-callers\" id=\"ref-for-validated-conversion-options-impression-callers①\">Impression Callers</a>\n       </dt><dd data-md=\"\">\n        <p><var>impressionCallers</var></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#validated-conversion-options-logic\" id=\"ref-for-validated-conversion-options-logic\">Logic</a>\n       </dt><dd data-md=\"\">\n        <p><var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#dom-attributionconversionoptions-logic\" id=\"ref-for-dom-attributionconversionoptions-logic②\">logic</a></code></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#validated-conversion-options-logic-options\" id=\"ref-for-validated-conversion-options-logic-options\">Logic Options</a>\n       </dt><dd data-md=\"\">\n        <p><var>validatedLogicOptions</var></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#validated-conversion-options-value\" id=\"ref-for-validated-conversion-options-value①\">Value</a>\n       </dt><dd data-md=\"\">\n        <p><var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#dom-attributionconversionoptions-value\" id=\"ref-for-dom-attributionconversionoptions-value③\">value</a></code></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#validated-conversion-options-max-value\" id=\"ref-for-validated-conversion-options-max-value\">Max Value</a>\n       </dt><dd data-md=\"\">\n        <p><var>options</var>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#dom-attributionconversionoptions-maxvalue\" id=\"ref-for-dom-attributionconversionoptions-maxvalue②\">maxValue</a></code></p>\n      </dd></dl>"
        }
      ]
    },
    {
      "name": "do attribution and fill a histogram",
      "href": "https://w3c.github.io/ppa/#do-attribution-and-fill-a-histogram",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"do-attribution-and-fill-a-histogram\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">do attribution and fill a histogram</dfn>, given\n  <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#validated-conversion-options\" id=\"ref-for-validated-conversion-options①\">validated conversion options</a> <var>options</var>,\n  <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/#site\" id=\"ref-for-site②⑦\">site</a> <var>topLevelSite</var>,\n  <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/#site\" id=\"ref-for-site②⑧\">site</a> <var>intermediarySite</var>,\n  and <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/hr-time-3/#dfn-moment\" id=\"ref-for-dfn-moment⑦\">moment</a> <var>now</var>:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>matchedImpressions</var> be an <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-is-empty\" id=\"ref-for-list-is-empty①\">empty</a> <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#sets\" id=\"ref-for-sets①⑥\">set</a>.</p>"
        },
        {
          "html": "<p>Let <var>currentEpoch</var> be the result of <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#get-the-current-epoch\" id=\"ref-for-get-the-current-epoch⑤\">get the current epoch</a>\nwith <var>topLevelSite</var> and <var>now</var>.</p>"
        },
        {
          "html": "<p>Let <var>startEpoch</var> be the result of <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#get-the-starting-epoch-for-attribution\" id=\"ref-for-get-the-starting-epoch-for-attribution\">get the starting epoch for attribution</a>\nwith <var>topLevelSite</var>.</p>"
        },
        {
          "html": "For each <var>epoch</var> from <var>startEpoch</var> to <var>currentEpoch</var>, inclusive:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>impressions</var> be the result of invoking <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#common-matching-logic\" id=\"ref-for-common-matching-logic⑤\">common matching logic</a>\nwith <var>options</var>, <var>topLevelSite</var>, <var>intermediarySite</var>, <var>epoch</var>, and <var>now</var>.</p>"
            },
            {
              "html": "If <var>impressions</var> <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-is-empty\" id=\"ref-for-list-is-empty②\">is not empty</a>:",
              "rationale": "let",
              "steps": [
                {
                  "html": "<p>Let <var>key</var> be a <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#privacy-budget-key\" id=\"ref-for-privacy-budget-key③\">privacy budget key</a> whose items are <var>epoch</var> and <var>topLevelSite</var>.</p>"
                },
                {
                  "html": "<p>Let <var>budgetOk</var> be the result of <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#deduct-privacy-budget\" id=\"ref-for-deduct-privacy-budget①\">deduct privacy budget</a>\nwith <var>key</var>, <var>options</var>’ <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#validated-conversion-options-epsilon\" id=\"ref-for-validated-conversion-options-epsilon①\">epsilon</a>,\n<var>options</var>’ <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#validated-conversion-options-value\" id=\"ref-for-validated-conversion-options-value②\">value</a>,\nand <var>options</var>’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#validated-conversion-options-max-value\" id=\"ref-for-validated-conversion-options-max-value①\">max value</a>.</p>"
                },
                {
                  "html": "<p>If <var>budgetOk</var> is true, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#set-extend\" id=\"ref-for-set-extend\">extend</a> <var>matchedImpressions</var> with <var>impressions</var>.</p>"
                }
              ]
            }
          ]
        },
        {
          "html": "<p>If <var>matchedImpressions</var> <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-is-empty\" id=\"ref-for-list-is-empty③\">is empty</a>, return the result of invoking\n<a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#create-an-all-zero-histogram\" id=\"ref-for-create-an-all-zero-histogram①\">create an all-zero histogram</a> with\n<var>options</var>’ <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#validated-conversion-options-histogram-size\" id=\"ref-for-validated-conversion-options-histogram-size②\">histogram size</a>.</p>"
        },
        {
          "html": "Switch on <var>options</var>’ <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#validated-conversion-options-logic\" id=\"ref-for-validated-conversion-options-logic①\">logic</a>:",
          "rationale": ".switch",
          "steps": [
            {
              "operation": "switch",
              "steps": [
                {
                  "case": "\"last-n-touch\"",
                  "html": "<p>Return the result of <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#fill-a-histogram-with-last-n-touch-attribution\" id=\"ref-for-fill-a-histogram-with-last-n-touch-attribution\">fill a histogram with last-n-touch attribution</a> with <var>matchedImpressions</var>,\n<var>options</var>’ <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#validated-conversion-options-histogram-size\" id=\"ref-for-validated-conversion-options-histogram-size③\">histogram size</a>,\n<var>options</var>’ <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#validated-conversion-options-value\" id=\"ref-for-validated-conversion-options-value③\">value</a>, and\n<var>options</var>’ <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#validated-conversion-options-logic-options\" id=\"ref-for-validated-conversion-options-logic-options①\">logic options</a>.<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#dom-attributionlogicoptions-credit\" id=\"ref-for-dom-attributionlogicoptions-credit③\">credit</a></code>.</p>"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "create an all-zero histogram",
      "href": "https://w3c.github.io/ppa/#create-an-all-zero-histogram",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"create-an-all-zero-histogram\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">create an all-zero histogram</dfn>, given an integer <var>size</var>:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Return a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list①\">list</a> of <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-size\" id=\"ref-for-list-size⑦\">size</a> <var>size</var>, whose <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-item\" id=\"ref-for-list-item①\">items</a> are all 0.</p>"
        }
      ]
    },
    {
      "name": "common matching logic",
      "href": "https://w3c.github.io/ppa/#common-matching-logic",
      "html": "To perform <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"common-matching-logic\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">common matching logic</dfn>, given\n<a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#validated-conversion-options\" id=\"ref-for-validated-conversion-options②\">validated conversion options</a> <var>options</var>,\n<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/#site\" id=\"ref-for-site②⑨\">site</a> <var>topLevelSite</var>,\n<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/#site\" id=\"ref-for-site③⓪\">site</a> <var>intermediarySite</var>,\n<a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#epoch-index\" id=\"ref-for-epoch-index①①\">epoch index</a> <var>epoch</var>, and <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/hr-time-3/#dfn-moment\" id=\"ref-for-dfn-moment⑧\">moment</a> <var>now</var>:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>matching</var> be an <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-is-empty\" id=\"ref-for-list-is-empty④\">empty</a> <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#sets\" id=\"ref-for-sets①⑦\">set</a>.</p>"
        },
        {
          "html": "<p>Let <var>earliestEpoch</var> be the result of calling <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#get-the-current-epoch\" id=\"ref-for-get-the-current-epoch⑥\">get the current epoch</a>,\npassing <var>topLevelSite</var> and (<var>now</var> − <var>options</var>’ <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#validated-conversion-options-lookback\" id=\"ref-for-validated-conversion-options-lookback①\">lookback</a>).</p>"
        },
        {
          "html": "<p>If <var>earliestEpoch</var> is greater than <var>epoch</var>, return <var>matching</var>.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate①\">For each</a> <var>impression</var> in the <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#impression-store\" id=\"ref-for-impression-store①④\">impression store</a>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>impressionEpoch</var> be the result of calling <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#get-the-current-epoch\" id=\"ref-for-get-the-current-epoch⑦\">get the current epoch</a>,\npassing <var>topLevelSite</var> and <var>impression</var>’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#impression-timestamp\" id=\"ref-for-impression-timestamp②\">timestamp</a>.</p>"
            },
            {
              "html": "<p>If <var>impressionEpoch</var> is not equal to <var>epoch</var>, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue③\">continue</a>.</p>"
            },
            {
              "html": "<p>If <var>now</var> is after <var>impression</var>’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#impression-timestamp\" id=\"ref-for-impression-timestamp③\">timestamp</a>\nplus <var>impression</var>’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#impression-lifetime\" id=\"ref-for-impression-lifetime②\">lifetime</a>,\n<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue④\">continue</a>.</p>"
            },
            {
              "html": "<p>If <var>now</var> is after <var>impression</var>’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#impression-timestamp\" id=\"ref-for-impression-timestamp④\">timestamp</a> plus <var>options</var>’ <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#validated-conversion-options-lookback\" id=\"ref-for-validated-conversion-options-lookback②\">lookback</a>,\n<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue⑤\">continue</a>.</p>"
            },
            {
              "html": "<p>If <var>impression</var>’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#impression-conversion-sites\" id=\"ref-for-impression-conversion-sites⑦\">conversion sites</a> <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-is-empty\" id=\"ref-for-list-is-empty⑤\">is not empty</a>\nand <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-contain\" id=\"ref-for-list-contain②\">does not contain</a> <var>topLevelSite</var>,\n<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue⑥\">continue</a>.</p>"
            },
            {
              "html": "<p>If <var>intermediarySite</var> is not <code>undefined</code>, let <var>caller</var> be <var>intermediarySite</var>.\nOtherwise, let <var>caller</var> be <var>topLevelSite</var>.</p>"
            },
            {
              "html": "<p>If <var>impression</var>’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#impression-conversion-callers\" id=\"ref-for-impression-conversion-callers②\">conversion callers</a> <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-is-empty\" id=\"ref-for-list-is-empty⑥\">is not empty</a>\nand <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-contain\" id=\"ref-for-list-contain③\">does not contain</a> <var>caller</var>,\n<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue⑦\">continue</a>.</p>"
            },
            {
              "html": "<p>If <var>options</var>’ <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#validated-conversion-options-match-values\" id=\"ref-for-validated-conversion-options-match-values②\">match values</a> <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-is-empty\" id=\"ref-for-list-is-empty⑦\">is not empty</a>\nand <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-contain\" id=\"ref-for-list-contain④\">does not contain</a> <var>impression</var>’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#impression-match-value\" id=\"ref-for-impression-match-value②\">match value</a>,\n<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue⑧\">continue</a>.</p>"
            },
            {
              "html": "<p>If <var>options</var>’ <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#validated-conversion-options-impression-sites\" id=\"ref-for-validated-conversion-options-impression-sites②\">impression sites</a>\n<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-is-empty\" id=\"ref-for-list-is-empty⑧\">is not empty</a> and\n<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-contain\" id=\"ref-for-list-contain⑤\">does not contain</a> <var>impression</var>’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#impression-impression-site\" id=\"ref-for-impression-impression-site②\">impression site</a>,\n<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue⑨\">continue</a>.</p>"
            },
            {
              "html": "<p>If <var>options</var>’ <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#validated-conversion-options-impression-callers\" id=\"ref-for-validated-conversion-options-impression-callers②\">impression callers</a> <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-is-empty\" id=\"ref-for-list-is-empty⑨\">is not empty</a>\nand <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-contain\" id=\"ref-for-list-contain⑥\">does not contain</a> <var>impression</var>’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#impression-intermediary-site\" id=\"ref-for-impression-intermediary-site③\">intermediary site</a>\nor <var>impression</var>’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#impression-impression-site\" id=\"ref-for-impression-impression-site③\">impression site</a>,\n<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue①⓪\">continue</a>.</p>"
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#set-append\" id=\"ref-for-set-append\">Append</a> <var>impression</var> to <var>matching</var>.</p>"
            }
          ]
        },
        {
          "html": "<p>Return <var>matching</var>.</p>"
        }
      ]
    },
    {
      "name": "fairly allocate credit",
      "href": "https://w3c.github.io/ppa/#fairly-allocate-credit",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"fairly-allocate-credit\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">fairly allocate credit</dfn>, given a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list②\">list</a> of doubles <var>credit</var> and an integer <var>value</var>:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert\">Assert</a>: <var>credit</var> is not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-is-empty\" id=\"ref-for-list-is-empty①⓪\">empty</a>.</p>"
        },
        {
          "html": "<p>Let <var>sumCredit</var> be the sum of <var>credit</var>’s <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-item\" id=\"ref-for-list-item②\">items</a>.</p>"
        },
        {
          "html": "<p>Let <var>roundedCredit</var> be a new <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list③\">list</a>.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate②\">For each</a> <var>item</var> of <var>credit</var>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>normalizedCredit</var> be <var>value</var> * <var>item</var> / <var>sumCredit</var>.</p>"
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-append\" id=\"ref-for-list-append\">Append</a> <var>normalizedCredit</var> to <var>roundedCredit</var>.</p>"
            }
          ]
        },
        {
          "html": "<p>Let <var>idx1</var> be 0.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate③\">For each</a> <var>n</var> of <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-get-the-indices\" id=\"ref-for-list-get-the-indices\">get the indices</a> of <var>roundedCredit</var>, removing the first <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-item\" id=\"ref-for-list-item③\">item</a>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>idx2</var> be <var>n</var>.</p>"
            },
            {
              "html": "<p>Let <var>frac1</var> be <var>roundedCredit</var>[<var>idx1</var>] − floor(<var>roundedCredit</var>[<var>idx1</var>]).</p>"
            },
            {
              "html": "<p>Let <var>frac2</var> be <var>roundedCredit</var>[<var>idx2</var>] − floor(<var>roundedCredit</var>[<var>idx2</var>]).</p>"
            },
            {
              "html": "<p>If <var>frac1</var> and <var>frac2</var> are both equal to zero, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue①①\">continue</a>.</p>"
            },
            {
              "html": "<p>If <var>frac1</var> + <var>frac2</var> is greater than 1, let <var>incr1</var> be 1 − <var>frac1</var> and <var>incr2</var> be 1 − <var>frac2</var>.</p>"
            },
            {
              "html": "<p>Otherwise, let <var>incr1</var> be −<var>frac1</var> and <var>incr2</var> be −<var>frac2</var>.</p>"
            },
            {
              "html": "<p>Let <var>p1</var> be <var>incr2</var> / (<var>incr1</var> + <var>incr2</var>).</p>"
            },
            {
              "html": "<p>Let <var>r</var> be a random double between 0 and 1 (inclusive).</p>"
            },
            {
              "html": "<p>If <var>r</var> is less than <var>p1</var>, let <var>incr</var> be <var>incr1</var> and swap the values of <var>idx1</var> and <var>idx2</var>.</p>"
            },
            {
              "html": "<p>Otherwise, let <var>incr</var> be <var>incr2</var>.</p>"
            },
            {
              "html": "<p>Increment <var>roundedCredit</var>[<var>idx2</var>] by <var>incr</var>.</p>"
            },
            {
              "html": "<p>Decrement <var>roundedCredit</var>[<var>idx1</var>] by <var>incr</var>.</p>"
            }
          ]
        },
        {
          "html": "<p>Let <var>integerCredit</var> be the result of converting <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate④\">every</a> <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-item\" id=\"ref-for-list-item⑤\">item</a> from <var>roundedCredit</var> into an integer by rounding to the nearest integer,\nand rounding halfway cases away from zero.</p>"
        },
        {
          "html": "<p>Return <var>integerCredit</var>.</p>"
        }
      ]
    },
    {
      "name": "fill a histogram with last-n-touch attribution",
      "href": "https://w3c.github.io/ppa/#fill-a-histogram-with-last-n-touch-attribution",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"fill-a-histogram-with-last-n-touch-attribution\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">fill a histogram with last-n-touch attribution</dfn>, given a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#sets\" id=\"ref-for-sets①⑧\">set</a> of\n  <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#impression\" id=\"ref-for-impression④⑥\">impressions</a> <var>matchedImpressions</var>, an integer <var>histogramSize</var>, an integer <var>value</var>, and\n  a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list④\">list</a> of doubles <var>credit</var>:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert①\">Assert</a>: <var>matchedImpressions</var> is <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-is-empty\" id=\"ref-for-list-is-empty①①\">not empty</a>.</p>"
        },
        {
          "html": "<p>Let <var>sortedImpressions</var> be <var>matchedImpressions</var>, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-sort-in-ascending-order\" id=\"ref-for-list-sort-in-ascending-order\">sorted in ascending order</a>\nby <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#impression-priority\" id=\"ref-for-impression-priority①\">priority</a>, then by <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#impression-timestamp\" id=\"ref-for-impression-timestamp⑤\">timestamp</a>.</p>"
        },
        {
          "html": "<p>Let <var>N</var> be the minimum of the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-size\" id=\"ref-for-list-size⑧\">size</a> of <var>credit</var>, and the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-size\" id=\"ref-for-list-size⑨\">size</a> of <var>sortedImpressions</var>.</p>"
        },
        {
          "html": "<p>Let <var>lastNImpressions</var> be the last <var>N</var> entries of <var>sortedImpressions</var>.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-remove\" id=\"ref-for-list-remove③\">Remove</a> all but the last <var>N</var> entries of <var>credit</var>.</p>"
        },
        {
          "html": "<p>Let <var>normalizedCredit</var> be the result of <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#fairly-allocate-credit\" id=\"ref-for-fairly-allocate-credit\">fairly allocating credit</a> with <var>credit</var> and <var>value</var>.</p>"
        },
        {
          "html": "<p>Let <var>histogram</var> be the result of invoking <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#create-an-all-zero-histogram\" id=\"ref-for-create-an-all-zero-histogram②\">create an all-zero histogram</a>\nwith <var>histogramSize</var>.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate⑤\">For each</a> <var>i</var> of <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-get-the-indices\" id=\"ref-for-list-get-the-indices①\">the indices</a> of <var>lastNImpressions</var>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>impression</var> be <var>lastNImpressions</var>[<var>i</var>].</p>"
            },
            {
              "html": "<p>Let <var>value</var> be <var>normalizedCredit</var>[<var>i</var>].</p>"
            },
            {
              "html": "<p>Let <var>index</var> be <var>impression</var>’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#impression-histogram-index\" id=\"ref-for-impression-histogram-index②\">histogram index</a>.</p>"
            },
            {
              "html": "<p>If <var>index</var> is less than <var>histogram</var>’s <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-size\" id=\"ref-for-list-size①⓪\">size</a>, increment <var>histogram</var>[<var>index</var>] by <var>value</var>.</p>"
            }
          ]
        },
        {
          "html": "<p>Return <var>histogram</var>.</p>"
        }
      ]
    },
    {
      "name": "parse a Save-Impression header",
      "href": "https://w3c.github.io/ppa/#parse-a-save-impression-header",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"parse-a-save-impression-header\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">parse a <code>Save-Impression</code> header</dfn> given a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#header-value\" id=\"ref-for-header-value\">header value</a>\n<var>input</var>, run these steps:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>dict</var> be the result of <a data-link-type=\"dfn\" href=\"https://httpwg.org/specs/rfc9651#text-parse\" id=\"ref-for-text-parse\">parsing structured fields</a>\nwith <var>input_bytes</var> set to <var>input</var> and\n<var>field_type</var> set to \"<code>dictionary</code>\".</p>"
        },
        {
          "html": "<p>If parsing failed, return an error.</p>"
        },
        {
          "html": "<p>If <var>dict</var>[\"<code><a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#save-impression-histogram-index\" id=\"ref-for-save-impression-histogram-index\">histogram-index</a></code>\"] does not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists⑤\">exist</a> or\nis not an <a data-link-type=\"dfn\" href=\"https://httpwg.org/specs/rfc9651#integer\" id=\"ref-for-integer④\">integer</a> or is less than 0, return an error.</p>"
        },
        {
          "html": "<p>Let <var>histogramIndex</var> be <var>dict</var>[\"<code><a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#save-impression-histogram-index\" id=\"ref-for-save-impression-histogram-index①\">histogram-index</a></code>\"].</p>"
        },
        {
          "html": "<p>Let <var>conversionSites</var> be <var>dict</var>[\"<code><a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#save-impression-conversion-sites\" id=\"ref-for-save-impression-conversion-sites\">conversion-sites</a></code>\"]\n<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-with-default\" id=\"ref-for-map-with-default\">with default</a> an empty <a data-link-type=\"dfn\" href=\"https://httpwg.org/specs/rfc9651#inner-list\" id=\"ref-for-inner-list②\">inner list</a>.</p>"
        },
        {
          "html": "<p>Let <var>conversionCallers</var> be <var>dict</var>[\"<code><a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#save-impression-conversion-callers\" id=\"ref-for-save-impression-conversion-callers\">conversion-callers</a></code>\"]\n<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-with-default\" id=\"ref-for-map-with-default①\">with default</a> an empty <a data-link-type=\"dfn\" href=\"https://httpwg.org/specs/rfc9651#inner-list\" id=\"ref-for-inner-list③\">inner list</a>.</p>"
        },
        {
          "html": "<p>If any of <var>conversionSites</var>’ <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-item\" id=\"ref-for-list-item⑥\">items</a> is not a <a data-link-type=\"dfn\" href=\"https://httpwg.org/specs/rfc9651#string\" id=\"ref-for-string④\">string</a>, return an error.</p>"
        },
        {
          "html": "<p>Let <var>matchValue</var> be <var>dict</var>[\"<code><a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#save-impression-match-value\" id=\"ref-for-save-impression-match-value\">match-value</a></code>\"] <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-with-default\" id=\"ref-for-map-with-default②\">with default</a> 0.</p>"
        },
        {
          "html": "<p>If <var>matchValue</var> is not an <a data-link-type=\"dfn\" href=\"https://httpwg.org/specs/rfc9651#integer\" id=\"ref-for-integer⑤\">integer</a> or is less than 0, return an error.</p>"
        },
        {
          "html": "<p>Let <var>lifetimeDays</var> be <var>dict</var>[\"<code><a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#save-impression-lifetime-days\" id=\"ref-for-save-impression-lifetime-days\">lifetime-days</a></code>\"] <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-with-default\" id=\"ref-for-map-with-default③\">with default</a> 30.</p>"
        },
        {
          "html": "<p>If <var>lifetimeDays</var> is not an <a data-link-type=\"dfn\" href=\"https://httpwg.org/specs/rfc9651#integer\" id=\"ref-for-integer⑥\">integer</a> or is less than or equal to 0, return an error.</p>"
        },
        {
          "html": "<p>Let <var>priority</var> be <var>dict</var>[\"<code><a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#save-impression-priority\" id=\"ref-for-save-impression-priority\">priority</a></code>\"] <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-with-default\" id=\"ref-for-map-with-default④\">with default</a> 0.</p>"
        },
        {
          "html": "<p>If <var>priority</var> is not an <a data-link-type=\"dfn\" href=\"https://httpwg.org/specs/rfc9651#integer\" id=\"ref-for-integer⑦\">integer</a>, return an error.</p>"
        },
        {
          "html": "<p>Return a new <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#dictdef-attributionimpressionoptions\" id=\"ref-for-dictdef-attributionimpressionoptions②\">AttributionImpressionOptions</a></code> with the following items:</p>\n      <dl>\n       <dt data-md=\"\"><code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#dom-attributionimpressionoptions-histogramindex\" id=\"ref-for-dom-attributionimpressionoptions-histogramindex⑤\">histogramIndex</a></code>\n       </dt><dd data-md=\"\">\n        <p><var>histogramIndex</var></p>\n       </dd><dt data-md=\"\"><code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#dom-attributionimpressionoptions-matchvalue\" id=\"ref-for-dom-attributionimpressionoptions-matchvalue⑤\">matchValue</a></code>\n       </dt><dd data-md=\"\">\n        <p><var>matchValue</var></p>\n       </dd><dt data-md=\"\"><code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#dom-attributionimpressionoptions-conversionsites\" id=\"ref-for-dom-attributionimpressionoptions-conversionsites④\">conversionSites</a></code>\n       </dt><dd data-md=\"\">\n        <p><var>conversionSites</var></p>\n       </dd><dt data-md=\"\"><code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#dom-attributionimpressionoptions-conversioncallers\" id=\"ref-for-dom-attributionimpressionoptions-conversioncallers④\">conversionCallers</a></code>\n       </dt><dd data-md=\"\">\n        <p><var>conversionCallers</var></p>\n       </dd><dt data-md=\"\"><code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#dom-attributionimpressionoptions-lifetimedays\" id=\"ref-for-dom-attributionimpressionoptions-lifetimedays⑥\">lifetimeDays</a></code>\n       </dt><dd data-md=\"\">\n        <p><var>lifetimeDays</var></p>\n       </dd><dt data-md=\"\"><code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/ppa/#dom-attributionimpressionoptions-priority\" id=\"ref-for-dom-attributionimpressionoptions-priority③\">priority</a></code>\n       </dt><dd data-md=\"\">\n        <p><var>priority</var></p>\n      </dd></dl>"
        }
      ]
    },
    {
      "name": "construct a DAP report",
      "href": "https://w3c.github.io/ppa/#construct-a-dap-report",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"construct-a-dap-report\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">construct a DAP report</dfn>,\nproducing a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#byte-sequence\" id=\"ref-for-byte-sequence\">byte sequence</a> <var>report</var>,\ngiven <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#validated-conversion-options\" id=\"ref-for-validated-conversion-options③\">validated conversion options</a> <var>options</var>,\n<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/#site\" id=\"ref-for-site③①\">site</a> <var>topLevelSite</var>,\n<a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/hr-time-3/#dfn-moment\" id=\"ref-for-dfn-moment⑨\">moment</a> <var>now</var>,\nand a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list⑤\">list</a> of <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/css-values-4/#integer\" id=\"ref-for-integer⑧\">integers</a> <var>histogram</var>:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>field</var> be Field128,\nas defined in <a href=\"https://datatracker.ietf.org/doc/html/draft-irtf-cfrg-vdaf-15#section-6.1.3\">Section 6.1.3</a>\nof <a data-link-type=\"biblio\" href=\"https://w3c.github.io/ppa/#biblio-vdaf\" title=\"Verifiable Distributed Aggregation Functions\">[VDAF]</a>.</p>"
        },
        {
          "html": "<p>Let <var>length</var> be the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-size\" id=\"ref-for-list-size①①\">size</a> of <var>histogram</var>.</p>"
        },
        {
          "html": "<p>Let <var>bits</var> be the base-2 logarithm\nof <var>options</var>.<a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#validated-conversion-options-max-value\" id=\"ref-for-validated-conversion-options-max-value②\">max value</a>,\nrounded toward positive Infinity.</p>"
        },
        {
          "html": "<p>Let <var>chunkLength</var> be the square root of (<var>bits</var> + 1) * <var>length</var>,\nrounded to the nearest integer.</p>"
        },
        {
          "html": "<p>Let <var>vdaf</var> be a new PrioL1BoundSum VDAF <a data-link-type=\"biblio\" href=\"https://w3c.github.io/ppa/#biblio-prio-l1\" title=\"A Prio Instantiation for Vector Sums with an L1 Norm Bound on Contributions\">[PRIO-L1]</a> instance,\npassing <var>field</var>, <var>length</var>, <var>bits</var>, and <var>chunkLength</var>.</p>"
        },
        {
          "html": "<p>Let <var>taskID</var> be the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#byte-sequence\" id=\"ref-for-byte-sequence①\">byte sequence</a>\nfrom the hex string <code>b13e8440f1cdb4da51eed3967e0a2652d27f5005bc35f751daf188b4b746708b</code>\n<a data-link-type=\"biblio\" href=\"https://w3c.github.io/ppa/#biblio-dap-ext\" title=\"Distributed Aggregation Protocol (DAP) Report Binding Extensions\">[DAP-EXT]</a>.</p>"
        },
        {
          "html": "<p>Let <var>ctx</var> be the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#byte-sequence\" id=\"ref-for-byte-sequence②\">byte sequence</a> formed by concatenating\nthe <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#isomorphic-encode\" id=\"ref-for-isomorphic-encode\">encoded</a> string <code>dap-15</code>\nand <var>taskID</var>,\nas defined in <a href=\"https://datatracker.ietf.org/doc/html/draft-ietf-ppm-dap-15#section-4.5.2\">Section 4.5.2</a>\nof <a data-link-type=\"biblio\" href=\"https://w3c.github.io/ppa/#biblio-dap\" title=\"Distributed Aggregation Protocol for Privacy Preserving Measurement\">[DAP]</a>.</p>"
        },
        {
          "html": "<p>Let <var>reportID</var> be 16 bytes sampled from a cryptographically-secure random source <a data-link-type=\"biblio\" href=\"https://w3c.github.io/ppa/#biblio-rfc4086\" title=\"Randomness Requirements for Security\">[RFC4086]</a>.</p>"
        },
        {
          "html": "<p>Let <var>rand</var> be 128 bytes sampled from a cryptographically-secure random source <a data-link-type=\"biblio\" href=\"https://w3c.github.io/ppa/#biblio-rfc4086\" title=\"Randomness Requirements for Security\">[RFC4086]</a>.</p>"
        },
        {
          "html": "<p>Let <var>publicShare</var>, <var>inputShares</var> be the result of invoking <var>vdaf</var>.<a href=\"https://datatracker.ietf.org/doc/html/draft-irtf-cfrg-vdaf#section-4.1\"><code>shard()</code></a>,\nas defined in <a href=\"https://datatracker.ietf.org/doc/html/draft-irtf-cfrg-vdaf-15#section-4.1\">Section 4.1</a>\nof <a data-link-type=\"biblio\" href=\"https://w3c.github.io/ppa/#biblio-vdaf\" title=\"Verifiable Distributed Aggregation Functions\">[VDAF]</a>,\nwith <var>ctx</var>, <var>histogram</var>, <var>reportID</var> (as the VDAF \"nonce\" parameter), and <var>rand</var>.</p>"
        },
        {
          "html": "<p>Let <var>time</var> be <var>now</var> as a <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/hr-time-3/#dfn-duration\" id=\"ref-for-dfn-duration⑥\">duration</a> since the <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/hr-time-3/#dfn-unix-epoch\" id=\"ref-for-dfn-unix-epoch\">Unix epoch</a>,\ndivided by a <a data-link-type=\"dfn\" href=\"https://www.w3.org/TR/hr-time-3/#dfn-duration\" id=\"ref-for-dfn-duration⑦\">duration</a> of 5 seconds.</p>"
        },
        {
          "html": "The extension codepoint for <a href=\"https://datatracker.ietf.org/doc/html/draft-thomson-ppm-dap-dp-ext-02#name-privacy-budget-consumption\">privacy budget</a>,\nmapped to the value of <var>encodedEpsilon</var>, derived as follows:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>scaledEpsilon</var> be the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#32-bit-unsigned-integer\" id=\"ref-for-32-bit-unsigned-integer⑥\">32-bit unsigned integer</a>\nthat is <var>options</var>.<a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#validated-conversion-options-epsilon\" id=\"ref-for-validated-conversion-options-epsilon②\">epsilon</a>,\nmultiplied by 1,000,000, then rounded toward positive Infinity.</p>"
            },
            {
              "html": "<p>Let <var>encodedEpsilon</var> be the result of invoking\n<a href=\"https://tc39.es/ecma262/multipage/structured-data.html#sec-numerictorawbytes\"><code>NumericToRawBytes</code></a>\nwith <a href=\"https://tc39.es/ecma262/multipage/indexed-collections.html#table-the-typedarray-constructors\">UINT32</a>, <var>scaledEpsilon</var>, and <code>false</code> (for <code>isLittleEndian</code>).</p>"
            }
          ]
        },
        {
          "html": "<p>Let <var>reportMetadata</var> be encoded DAP <a href=\"https://datatracker.ietf.org/doc/html/draft-ietf-ppm-dap-15#section-4.5.2\"><code>ReportMetadata</code></a>\ngenerated from <var>reportID</var>, <var>time</var>, and <var>extensions</var>.</p>"
        },
        {
          "html": "<p>Let <var>encryptedInputShares</var> be an <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-is-empty\" id=\"ref-for-list-is-empty①③\">empty</a> <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list⑥\">list</a>.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate⑥\">For each</a> <var>share</var> of <var>inputShares</var>,\nfollow the method for encrypting shares\ndescribed in <a href=\"https://datatracker.ietf.org/doc/html/draft-ietf-ppm-dap-15#section-4.5.2\">Section 4.5.2</a>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>pkR</var> be the public key of the corresponding role from\nthe <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#aggregation-service\" id=\"ref-for-aggregation-service①⓪\">aggregation service</a> <a href=\"https://datatracker.ietf.org/doc/html/draft-ietf-ppm-dap-15#section-4.5.1\">HPKE configuration</a>\nobtained for the <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#aggregation-service\" id=\"ref-for-aggregation-service①①\">aggregation service</a>\nindicated by <var>options</var>.<a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#validated-conversion-options-aggregation-service\" id=\"ref-for-validated-conversion-options-aggregation-service②\">Aggregation Service</a>.</p>"
            },
            {
              "html": "<p>Let <var>serverRole</var> be 2 for the first item (the Leader)\nand 3 for the second (the Helper role).</p>"
            },
            {
              "html": "<p>Let <var>info</var> be the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#byte-sequence\" id=\"ref-for-byte-sequence⑤\">byte sequence</a> formed by concatenating:\nthe <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#isomorphic-encode\" id=\"ref-for-isomorphic-encode②\">encoded</a> value of the string <code>dap-15 input share</code>,\na byte with the value 0x01, and <var>serverRole</var>.</p>"
            },
            {
              "html": "<p>Let <var>inputShareAAD</var> be constructed from\n<var>taskID</var>, <var>reportMetadata</var>, and <var>publicShare</var>,\nfollowing the structure for <a href=\"https://datatracker.ietf.org/doc/html/draft-ietf-ppm-dap-15#section-4.5.2\"><code>InputShareAad</code></a>.</p>"
            },
            {
              "html": "<p>Let <var>hpke</var> be an HPKE <a data-link-type=\"biblio\" href=\"https://w3c.github.io/ppa/#biblio-rfc9180\" title=\"Hybrid Public Key Encryption\">[RFC9180]</a> configuration\nthat is based on the same <a href=\"https://datatracker.ietf.org/doc/html/draft-ietf-ppm-dap-15#section-4.5.1\">HPKE configuration</a>.</p>"
            },
            {
              "html": "<p>Let <var>encryptedShare</var> be the result of invoking <var>hpke</var>.<a href=\"https://hpkewg.github.io/hpke/draft-ietf-hpke-hpke.html#section-6.1\"><code>Seal&lt;mode_base&gt;()</code></a>,\npassing <var>pkR</var>, <var>info</var>, <var>inputShareAAD</var>, and <var>share</var>.</p>"
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-append\" id=\"ref-for-list-append①\">Append</a> <var>encryptedShare</var> to <var>encryptedInputShares</var>.</p>"
            }
          ]
        },
        {
          "html": "<p>Let <var>report</var> be an encoded DAP <a href=\"https://datatracker.ietf.org/doc/html/draft-ietf-ppm-dap-15#section-4.5.2\"><code>Report</code></a>\ngenerated from <var>reportMetadata</var>, <var>publicShare</var>, <var>encryptedInputShares</var>\n(the two values being the leader and helper encrypted input shares respectively),\nand <a data-link-type=\"dfn\" href=\"https://w3c.github.io/ppa/#aggregation-service\" id=\"ref-for-aggregation-service①②\">aggregation service</a> <a href=\"https://datatracker.ietf.org/doc/html/draft-ietf-ppm-dap-15#section-4.5.1\">HPKE configuration</a>\nobtained from the DAP aggregators.</p>"
        },
        {
          "html": "<p>Return <var>report</var>.</p>"
        }
      ]
    }
  ]
}