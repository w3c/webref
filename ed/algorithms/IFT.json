{
  "spec": {
    "title": "Incremental Font Transfer",
    "url": "https://w3c.github.io/IFT/Overview.html"
  },
  "algorithms": [
    {
      "html": "It is expected that the most common way to produce an incremental font will be to convert an existing font to use the incremental\nencoding defined in this specification. At a high level converting an existing font to be incremental will look like this:",
      "rationale": "choose",
      "steps": [
        {
          "html": "<p>Choose the content of the initial <a href=\"https://w3c.github.io/IFT/Overview.html#font-subset-dfn\">subset</a>, this will be included in the initial font file the client loads\nand usually consists of any data from the original font that is expected to always be needed.</p>"
        },
        {
          "html": "<p>Choose the patch type or types. Different patch types have different qualities, so different use cases can call for different\npatch types, or in some cases a mix of two types.</p>"
        },
        {
          "html": "<p>Choose a segmentation of the font. Individual segments will be added to the base subset by the client using patches. Choosing an\nappropriate segmentation is one of the most important parts of producing an efficient encoding.</p>"
        },
        {
          "html": "<p>Based on these choices, generate a set of patches, where each patch adds the data for a particular segment relative to either\nthe initial font file or a previous patch.</p>"
        },
        {
          "html": "<p>Generate the initial font file including the initial subset and a <a href=\"https://w3c.github.io/IFT/Overview.html#font-format-extensions\">patch mapping</a>. This mapping\nlists all of the available patch files, the url they reside at, and information on what data the patch will add to the font.</p>"
        }
      ]
    },
    {
      "html": "The algorithm:",
      "rationale": "set",
      "steps": [
        {
          "html": "<p>Set <var>extended font subset</var> to <var>font subset</var>.</p>"
        },
        {
          "html": "<p>Load the 'IFT ' and 'IFTX' (if present) mapping <a href=\"https://learn.microsoft.com/en-us/typography/opentype/spec/otff#table-directory\">tables</a> from <var>extended font subset</var>. Both\ntables are formatted as a <a href=\"https://w3c.github.io/IFT/Overview.html#patch-map-table\">§ 5.3 Patch Map Table</a>. Check that they are valid according to the requirements in <a href=\"https://w3c.github.io/IFT/Overview.html#patch-map-table\">§ 5.3 Patch Map Table</a>. If\neither table is not valid, invoke <a data-link-type=\"abstract-op\" href=\"https://w3c.github.io/IFT/Overview.html#abstract-opdef-handle-errors\" id=\"ref-for-abstract-opdef-handle-errors\">Handle errors</a>. If <var>extended font subset</var> does not have an 'IFT ' table, then it is\nnot an <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#incremental-font\" id=\"ref-for-incremental-font⑥\">incremental font</a> and cannot be extended, return <var>extended font subset</var>.</p>"
        },
        {
          "html": "<p>If the compatibility ID in 'IFT ' is equal to the compatibility ID in 'IFTX' this is an error, invoke <a data-link-type=\"abstract-op\" href=\"https://w3c.github.io/IFT/Overview.html#abstract-opdef-handle-errors\" id=\"ref-for-abstract-opdef-handle-errors①\">Handle errors</a>.</p>"
        },
        {
          "html": "<p>For each of <a href=\"https://learn.microsoft.com/en-us/typography/opentype/spec/otff#table-directory\">tables</a> 'IFT ' and 'IFTX' (if present): convert the table into a list of entries by\ninvoking <a data-link-type=\"abstract-op\" href=\"https://w3c.github.io/IFT/Overview.html#abstract-opdef-interpret-format-1-patch-map\" id=\"ref-for-abstract-opdef-interpret-format-1-patch-map\">Interpret Format 1 Patch Map</a> or <a data-link-type=\"abstract-op\" href=\"https://w3c.github.io/IFT/Overview.html#abstract-opdef-interpret-format-2-patch-map\" id=\"ref-for-abstract-opdef-interpret-format-2-patch-map\">Interpret Format 2 Patch Map</a>. Concatenate the returned entry lists into a single list, <var>entry list</var>.</p>"
        },
        {
          "html": "<p>For each <var>entry</var> in <var>entry list</var> invoke <a data-link-type=\"abstract-op\" href=\"https://w3c.github.io/IFT/Overview.html#abstract-opdef-check-entry-intersection\" id=\"ref-for-abstract-opdef-check-entry-intersection\">Check entry intersection</a> with <var>entry</var> and <var>target subset definition</var> as inputs, if it returns false remove <var>entry</var> from <var>entry list</var>. Additionally remove\nany entries in <var>entry list</var> which have a patch URL string which was loaded and applied previously during the execution of this algorithm.</p>"
        },
        {
          "html": "<p>If <var>entry list</var> is empty, then the extension operation is finished, return <var>extended font subset</var>.</p>"
        },
        {
          "html": "<p>Group the entries from <var>entry list</var> into 3 lists based on the invalidation mode of the <a href=\"https://w3c.github.io/IFT/Overview.html#font-patch-formats-summary\">patch format</a> of each entry: <var>full invalidation entry list</var>, <var>partial invalidation entry list</var>, and <var>no invalidation entry list</var>.</p>"
        },
        {
          "html": "<p>Pick one <var>entry</var> with the following procedure:</p>\n     <ul>\n      <li data-md=\"\">\n       <p>If <var>full invalidation entry list</var> is not empty, then select exactly one of the contained entries. Follow the criteria in <a href=\"https://w3c.github.io/IFT/Overview.html#invalidating-patch-selection\">§ 4.4 Selecting Invalidating Patches</a> to select the single entry.</p>\n      </li><li data-md=\"\">\n       <p>Otherwise if <var>partial invalidation entry list</var> is not empty then, select exactly one of the contained entries.\nFollow the criteria in <a href=\"https://w3c.github.io/IFT/Overview.html#invalidating-patch-selection\">§ 4.4 Selecting Invalidating Patches</a> to select the single entry.</p>\n      </li><li data-md=\"\">\n       <p>Otherwise select the entry in <var>no invalidation entry list</var> which is listed first in the <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#patch-map\" id=\"ref-for-patch-map②\">patch map</a>. For <a href=\"https://w3c.github.io/IFT/Overview.html#patch-map-format-1\">§ 5.3.1 Patch Map Table: Format 1</a> this is the entry with the lowest entry index. For <a href=\"https://w3c.github.io/IFT/Overview.html#patch-map-format-2\">§ 5.3.2 Patch Map Table: Format 2</a> this is the entry that appears first in the <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#mapping-entries-entries\" id=\"ref-for-mapping-entries-entries\">entries</a> array. If entries from both the IFT and\nIFTX tables are candidates then all entries in IFT are considered to come before those in IFTX.</p>\n     </li></ul>"
        },
        {
          "html": "<p>Start a load of <var>patch file</var> (if not already previously started) by invoking <a data-link-type=\"abstract-op\" href=\"https://w3c.github.io/IFT/Overview.html#abstract-opdef-load-patch-file\" id=\"ref-for-abstract-opdef-load-patch-file\">Load patch file</a> with the <var>initial font URL</var> as the initial font URL and the first patch URL string in <var>entry</var> as the patch URL string. If there are any other URL strings in <var>entry</var>, then initiate loads for those using the same procedure. These may be used during future iterations of this algorithm.\nAdditionally the client may optionally start loads using the same procedure for any entries in <var>entry list</var> which will not be <a href=\"https://w3c.github.io/IFT/Overview.html#font-patch-invalidations\">invalidated</a> by <var>entry</var>. The total number of patches that a client can load and apply during a single execution\nof this algorithm is limited to:</p>\n     <ul>\n      <li data-md=\"\">\n       <p>At most 100 patches which are <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#partial-invalidation\" id=\"ref-for-partial-invalidation\">Partial Invalidation</a> or <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#full-invalidation\" id=\"ref-for-full-invalidation\">Full Invalidation</a>.</p>\n      </li><li data-md=\"\">\n       <p>At most 2000 patches of any type.</p>\n     </li></ul>\n     <p>Can be loaded and applied during a single invocation of this algorithm. If either count has been exceeded this is an error invoke <a data-link-type=\"abstract-op\" href=\"https://w3c.github.io/IFT/Overview.html#abstract-opdef-handle-errors\" id=\"ref-for-abstract-opdef-handle-errors②\">Handle errors</a>.</p>"
        },
        {
          "html": "<p>Once the load for <var>patch file</var> is finished, apply it using the appropriate application algorithm (matching the patches format in <var>entry</var>) from <a href=\"https://w3c.github.io/IFT/Overview.html#font-patch-formats\">§ 6 Font Patch Formats</a> to apply the <var>patch file</var> using the patch URL string and the compatibility id from <var>entry</var> to <var>extended font subset</var>. If the load for <var>patch file</var> resulted in an error, handle it according\n to <a data-link-type=\"abstract-op\" href=\"https://w3c.github.io/IFT/Overview.html#abstract-opdef-handle-errors\" id=\"ref-for-abstract-opdef-handle-errors③\">Handle errors</a>.</p>"
        },
        {
          "html": "<p>Go to step 2.</p>"
        }
      ]
    },
    {
      "html": "The algorithm:",
      "rationale": "for",
      "steps": [
        {
          "html": "<p>For each set in <var>subset definition</var> (code points, feature tags,\n design space) check if the set intersects the corresponding set from <var>mapping entry</var>’s subset definition. A set\n intersects when:</p>\n     <table>\n      <tbody>\n       <tr>\n        <th>\n        </th><th>subset definition set is empty\n        </th><th>subset definition set is not empty\n       </th></tr><tr>\n        <th>mapping entry set is empty\n        </th><td>true\n        </td><td>true\n       </td></tr><tr>\n        <th>mapping entry set is not empty\n        </th><td>false\n        </td><td>true if the two sets intersect\n     </td></tr></tbody></table>\n     <p>When checking design space sets for intersection, they intersect if there is at least one pair of intersecting segments\n (tags are equal and the ranges intersect).</p>"
        },
        {
          "html": "<p>If one or more sets checked in step 1 did not intersect, then return false for <var>intersects</var>.</p>"
        },
        {
          "html": "<p>If there are no child entries in <var>mapping entry</var>, then return true for <var>intersects</var>.</p>"
        },
        {
          "html": "<p>Invoke <a data-link-type=\"abstract-op\" href=\"https://w3c.github.io/IFT/Overview.html#abstract-opdef-check-entry-intersection\" id=\"ref-for-abstract-opdef-check-entry-intersection①\">Check entry intersection</a> for each child entry referenced in <var>mapping entry</var> with <var>subset definition</var> as an input. If child entry match mode is conjunctive, then return true for <var>intersects</var> only if all invocations return true.\nOtherwise return true only if at least one invocation returns true.</p>"
        }
      ]
    },
    {
      "html": "The algorithm:",
      "rationale": "parse",
      "steps": [
        {
          "html": "<p>Parse <var>patch URL string</var> into a <a href=\"https://url.spec.whatwg.org/#concept-url\">URL Record</a> using <a href=\"https://url.spec.whatwg.org/#url-parsing\">URL Standard § url-parsing</a>. <var>initial font URL</var> is the <a href=\"https://url.spec.whatwg.org/#concept-base-url\">base URL</a> and encoding is UTF-8. Store the result\n in <var>target URL</var>. If URL parsing failed, then return an error.</p>"
        },
        {
          "html": "<p>Retrieve the contents of <var>target URL</var> using the fetching capabilities of the implementing user agent. For web browsers, <a data-link-type=\"biblio\" href=\"https://w3c.github.io/IFT/Overview.html#biblio-fetch\" title=\"Fetch Standard\">[FETCH]</a> should be used. When using <a data-link-type=\"biblio\" href=\"https://w3c.github.io/IFT/Overview.html#biblio-fetch\" title=\"Fetch Standard\">[FETCH]</a> the request is configured as follows:</p>\n     <ul>\n      <li data-md=\"\">\n       <p>Set <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-method\" id=\"ref-for-concept-request-method\">method</a> to GET.</p>\n      </li><li data-md=\"\">\n       <p>Set <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-url\" id=\"ref-for-concept-request-url\">url</a> to <var>target URL</var>.</p>\n      </li><li data-md=\"\">\n       <p>Set <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-client\" id=\"ref-for-concept-request-client\">client</a> to the client from the request object used to fetch <var>initial font URL</var>.</p>\n      </li><li data-md=\"\">\n       <p>Set <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#request-initiator-type\" id=\"ref-for-request-initiator-type\">initiator type</a> to \"font\".</p>\n      </li><li data-md=\"\">\n       <p>Set <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-destination\" id=\"ref-for-concept-request-destination\">destination</a> to \"font\".</p>\n      </li><li data-md=\"\">\n       <p>Set <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-referrer\" id=\"ref-for-concept-request-referrer\">referrer</a> to <var>initial font URL</var>.</p>\n      </li><li data-md=\"\">\n       <p>Set <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-mode\" id=\"ref-for-concept-request-mode\">mode</a> to \"cors\".</p>\n     </li></ul>\n     <p><a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-fetch\" id=\"ref-for-concept-fetch\">Fetch</a> the <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request\" id=\"ref-for-concept-request\">request</a> where <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#process-response-end-of-body\" id=\"ref-for-process-response-end-of-body\">processResponseConsumeBody</a> is step 3 of this algorithm.</p>\n     <p>For non <a data-link-type=\"biblio\" href=\"https://w3c.github.io/IFT/Overview.html#biblio-fetch\" title=\"Fetch Standard\">[FETCH]</a> implementations, make a request for <var>target URL</var> using the fetching capabilities that are available.\nCopy the <a data-link-type=\"biblio\" href=\"https://w3c.github.io/IFT/Overview.html#biblio-fetch\" title=\"Fetch Standard\">[FETCH]</a> based settings specified above where equivalent concepts exist. Proceed to step 3 with the results of that\nfetch.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#process-response-end-of-body\" id=\"ref-for-process-response-end-of-body①\">processResponseConsumeBody</a> is passed the response and null, failure, or a byte sequence. If a byte sequence is received,\nthen return the bytes as <var>patch file</var>. If null is received, then return an empty byte array as <var>patch file</var>.\nOtherwise return an error.</p>"
        }
      ]
    },
    {
      "html": "The following selection criteria minimizes round trips and must be used by the client when selecting a single partial or full invalidation patch in step 8\nof <a data-link-type=\"abstract-op\" href=\"https://w3c.github.io/IFT/Overview.html#abstract-opdef-extend-an-incremental-font-subset\" id=\"ref-for-abstract-opdef-extend-an-incremental-font-subset②\">Extend an Incremental Font Subset</a>:",
      "rationale": "if",
      "steps": [
        {
          "html": "<p>If one or more candidate entries have previously had their associated patch file loaded by step 9 of <a data-link-type=\"abstract-op\" href=\"https://w3c.github.io/IFT/Overview.html#abstract-opdef-extend-an-incremental-font-subset\" id=\"ref-for-abstract-opdef-extend-an-incremental-font-subset③\">Extend an Incremental Font Subset</a>,\nthen in the following steps only consider candidate entries whose patch file is already loaded or is currently being loaded. Otherwise consider all\ncandidate entries.</p>"
        },
        {
          "html": "<p>For each candidate entry: compute a total subset definition by unioning that entry’s subset definition and the subset definition of all child entries\n reachable via the graph of referenced child entries.</p>"
        },
        {
          "html": "<p>For each candidate entry: compute the set intersection between the total subset definition and the target subset definition.</p>"
        },
        {
          "html": "<p>Find an entry whose intersection from step 2 is not a strict subset of any other intersection.</p>"
        },
        {
          "html": "<p>Locate any additional entries that are in the same <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#patch-map\" id=\"ref-for-patch-map③\">patch map</a> and have the same intersection as the entry found in step 3. From the this set of\n entries (including the step 3 pick) the final selection is the entry which is listed first in the <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#patch-map\" id=\"ref-for-patch-map④\">patch map</a>. For <a href=\"https://w3c.github.io/IFT/Overview.html#patch-map-format-1\">§ 5.3.1 Patch Map Table: Format 1</a> this is the\n entry with the lowest entry index. For <a href=\"https://w3c.github.io/IFT/Overview.html#patch-map-format-2\">§ 5.3.2 Patch Map Table: Format 2</a> this is the entry that appears first in the <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#mapping-entries-entries\" id=\"ref-for-mapping-entries-entries①\">entries</a> array.</p>"
        }
      ]
    },
    {
      "html": "The algorithm:",
      "rationale": "invoke",
      "steps": [
        {
          "html": "<p>Invoke <a data-link-type=\"abstract-op\" href=\"https://w3c.github.io/IFT/Overview.html#abstract-opdef-extend-an-incremental-font-subset\" id=\"ref-for-abstract-opdef-extend-an-incremental-font-subset⑧\">Extend an Incremental Font Subset</a> with <var>font subset</var>. The input target subset definition is a special one which\nis considered to intersect all entries in the <a data-link-type=\"abstract-op\" href=\"https://w3c.github.io/IFT/Overview.html#abstract-opdef-check-entry-intersection\" id=\"ref-for-abstract-opdef-check-entry-intersection②\">Check entry intersection</a> step. Return the resulting font subset as\nthe <var>expanded font</var>.</p>"
        }
      ]
    },
    {
      "html": "For <a data-link-type=\"biblio\" href=\"https://w3c.github.io/IFT/Overview.html#biblio-woff2\" title=\"WOFF File Format 2.0\">[WOFF2]</a> special care must be taken. If an incremental font will be encoded by WOFF2 for transfer:",
      "rationale": "if",
      "steps": [
        {
          "html": "<p>If the WOFF2 encoding will include a transformed glyf and loca table (<a href=\"https://www.w3.org/TR/WOFF2/#glyf_table_format\"><cite>WOFF 2.0</cite> § 5.1 Transformed glyf table format</a>) then, the incremental\n font should not contain <a href=\"https://w3c.github.io/IFT/Overview.html#table-keyed\">§ 6.2 Table Keyed</a> patches which modify either the glyf or loca table. The WOFF2 format does not\n guarantee the specific bytes that result from decoding a transformed glyf and loca table. <a href=\"https://w3c.github.io/IFT/Overview.html#glyph-keyed\">§ 6.3 Glyph Keyed</a> patches may be used\n in conjunction with a transformed glyf and loca table.</p>"
        },
        {
          "html": "<p>The 'IFT ' and 'IFTX' tables can be processed and brotli encoded by a WOFF2 encoder following the standard process defined in <a href=\"https://www.w3.org/TR/WOFF2/#table_format\"><cite>WOFF 2.0</cite> § 5 Compressed data format</a>.</p>"
        }
      ]
    },
    {
      "html": "The algorithm:",
      "rationale": "check",
      "steps": [
        {
          "html": "<p>Check that the <var>patch map</var> data is: complete and not truncated, has <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#format-1-patch-map-format\" id=\"ref-for-format-1-patch-map-format\">format</a> equal to 1, and is valid\n according to the requirements in <a href=\"https://w3c.github.io/IFT/Overview.html#patch-map-format-1\">§ 5.3.1 Patch Map Table: Format 1</a> (requirements are marked with a \"must\"). If it is not return an error.</p>"
        },
        {
          "html": "<p>For each unique <var>entry index</var> in <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#glyph-map-entryindex\" id=\"ref-for-glyph-map-entryindex\">entryIndex</a>:</p>\n     <ul>\n      <li data-md=\"\">\n       <p>If <var>entry index</var> is 0 then, this is a special entry used to mark glyphs which are already in the initial font. Skip this\nindex and do not build an entry for it.</p>\n      </li><li data-md=\"\">\n       <p>If the <var>entry index</var> is larger than <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#format-1-patch-map-maxglyphmapentryindex\" id=\"ref-for-format-1-patch-map-maxglyphmapentryindex\">maxGlyphMapEntryIndex</a> this entry is invalid, skip this <var>entry index</var>.</p>\n      </li><li data-md=\"\">\n       <p>If the bit for <var>entry index</var> in <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#format-1-patch-map-appliedentriesbitmap\" id=\"ref-for-format-1-patch-map-appliedentriesbitmap\">appliedEntriesBitMap</a> is set to 1, skip this <var>entry index</var>.</p>\n      </li><li data-md=\"\">\n       <p>Collect the set of glyph indices that map to the <var>entry index</var>.</p>\n      </li><li data-md=\"\">\n       <p>Convert the set of glyph indices to a set of Unicode code points using the code point to glyph mapping in the <a href=\"https://learn.microsoft.com/en-us/typography/opentype/spec/cmap#\">cmap</a> table of <var>font subset</var>. Ignore any glyph indices that are not mapped by <a href=\"https://learn.microsoft.com/en-us/typography/opentype/spec/cmap#\">cmap</a>.\nMultiple code points may map to the same glyph id. All code points associated with a glyph should be included.</p>\n      </li><li data-md=\"\">\n       <p>Convert <var>entry index</var> into a URL string by applying <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#format-1-patch-map-uritemplate\" id=\"ref-for-format-1-patch-map-uritemplate\">uriTemplate</a> following <a href=\"https://w3c.github.io/IFT/Overview.html#uri-templates\">§ 5.3.3 URI Templates</a>. If\nthe template expansion results in an error (see: <a href=\"https://www.rfc-editor.org/rfc/rfc6570#section-3\">URI Template § section-3</a>) then, return an error.</p>\n      </li><li data-md=\"\">\n       <p>If the Unicode code point set is empty then, skip this <var>entry index</var>.</p>\n      </li><li data-md=\"\">\n       <p>Add an <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#patch-map-entries\" id=\"ref-for-patch-map-entries⑤\">entry</a> to <var>entry list</var> with a subset definition which contains only the Unicode code point\nset and maps to the generated URL string, the patch format specified by <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#format-1-patch-map-patchformat\" id=\"ref-for-format-1-patch-map-patchformat\">patchFormat</a>, and <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#format-1-patch-map-compatibilityid\" id=\"ref-for-format-1-patch-map-compatibilityid\">compatibilityId</a>.</p>\n     </li></ul>"
        },
        {
          "html": "<p>If <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#format-1-patch-map-featuremapoffset\" id=\"ref-for-format-1-patch-map-featuremapoffset\">featureMapOffset</a> is not null then, for each <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#featurerecord\" id=\"ref-for-featurerecord①\">FeatureRecord</a> and associated <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#entrymaprecord\" id=\"ref-for-entrymaprecord②\">EntryMapRecord</a> in <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#feature-map-featurerecords\" id=\"ref-for-feature-map-featurerecords②\">featureRecords</a> and <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#feature-map-entrymaprecords\" id=\"ref-for-feature-map-entrymaprecords\">entryMapRecords</a>:</p>\n     <ul>\n      <li data-md=\"\">\n       <p>Any <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#featurerecord\" id=\"ref-for-featurerecord②\">FeatureRecord’s</a> whose <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#featurerecord-featuretag\" id=\"ref-for-featurerecord-featuretag①\">featureTag</a> is less than or equal to a <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#featurerecord-featuretag\" id=\"ref-for-featurerecord-featuretag②\">featureTag</a> of any <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#featurerecord\" id=\"ref-for-featurerecord③\">FeatureRecord</a> which occurred earlier in the list are invalid. All associated <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#entrymaprecord\" id=\"ref-for-entrymaprecord③\">EntryMapRecord’s</a> are\nskipped. For ordering, tag values are interpreted as a 4 byte big endian unsigned integer and ordered by the integer value.</p>\n      </li><li data-md=\"\">\n       <p>Compute <var>mapped entry index</var>, the first <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#entrymaprecord\" id=\"ref-for-entrymaprecord④\">EntryMapRecord</a> associated with a <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#featurerecord\" id=\"ref-for-featurerecord④\">FeatureRecord</a> is <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#featurerecord-firstnewentryindex\" id=\"ref-for-featurerecord-firstnewentryindex\">FeatureRecord::firstNewEntryIndex</a>, the second <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#featurerecord-firstnewentryindex\" id=\"ref-for-featurerecord-firstnewentryindex①\">FeatureRecord::firstNewEntryIndex</a> + 1, and so on. The last will be <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#featurerecord-firstnewentryindex\" id=\"ref-for-featurerecord-firstnewentryindex②\">FeatureRecord::firstNewEntryIndex</a> + <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#featurerecord-entrymapcount\" id=\"ref-for-featurerecord-entrymapcount①\">entryMapCount</a> - 1.</p>\n      </li><li data-md=\"\">\n       <p>If the computed <var>mapped entry index</var> is less than or equal to <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#format-1-patch-map-maxglyphmapentryindex\" id=\"ref-for-format-1-patch-map-maxglyphmapentryindex①\">maxGlyphMapEntryIndex</a> or larger than <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#format-1-patch-map-maxentryindex\" id=\"ref-for-format-1-patch-map-maxentryindex⑤\">maxEntryIndex</a> this <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#entrymaprecord\" id=\"ref-for-entrymaprecord⑤\">EntryMapRecord</a> is invalid, skip it.</p>\n      </li><li data-md=\"\">\n       <p>If <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#entrymaprecord-firstentryindex\" id=\"ref-for-entrymaprecord-firstentryindex\">EntryMapRecord::firstEntryIndex</a> is greater than <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#entrymaprecord-lastentryindex\" id=\"ref-for-entrymaprecord-lastentryindex\">EntryMapRecord::lastEntryIndex</a> this <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#entrymaprecord\" id=\"ref-for-entrymaprecord⑥\">EntryMapRecord</a> is invalid, skip it.</p>\n      </li><li data-md=\"\">\n       <p>Convert <var>mapped entry index</var> into a URL string by applying <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#format-1-patch-map-uritemplate\" id=\"ref-for-format-1-patch-map-uritemplate①\">uriTemplate</a> following <a href=\"https://w3c.github.io/IFT/Overview.html#uri-templates\">§ 5.3.3 URI Templates</a>.\nIf the template expansion results in an error (see: <a href=\"https://www.rfc-editor.org/rfc/rfc6570#section-3\">URI Template § section-3</a>) then, return an error.</p>\n      </li><li data-md=\"\">\n       <p>If the bit for <var>mapped entry index</var> in <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#format-1-patch-map-appliedentriesbitmap\" id=\"ref-for-format-1-patch-map-appliedentriesbitmap①\">appliedEntriesBitMap</a> is set to 1, skip this entry.</p>\n      </li><li data-md=\"\">\n       <p>Construct a set of Unicode code points. For each <var>entry index</var> between <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#entrymaprecord-firstentryindex\" id=\"ref-for-entrymaprecord-firstentryindex①\">EntryMapRecord::firstEntryIndex</a> (inclusive) and <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#entrymaprecord-lastentryindex\" id=\"ref-for-entrymaprecord-lastentryindex①\">EntryMapRecord::lastEntryIndex</a> (inclusive):</p>\n       <ul>\n        <li data-md=\"\">\n         <p>If <var>entry index</var> is greater than <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#format-1-patch-map-maxglyphmapentryindex\" id=\"ref-for-format-1-patch-map-maxglyphmapentryindex②\">maxGlyphMapEntryIndex</a> then, this <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#entrymaprecord\" id=\"ref-for-entrymaprecord⑦\">EntryMapRecord</a> is invalid\nskip it.</p>\n        </li><li data-md=\"\">\n         <p>Add the set of Unicode code points associated with <var>entry index</var> that was computed in step 2 to the set. If the <var>entry index</var> was skipped because it was 0 or <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#format-1-patch-map-appliedentriesbitmap\" id=\"ref-for-format-1-patch-map-appliedentriesbitmap②\">appliedEntriesBitMap</a> compute the set of\nassociated code points as if it wasn’t skipped.</p>\n       </li></ul>\n      </li><li data-md=\"\">\n       <p>If the constructed set of Unicode code points is empty then, this <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#entrymaprecord\" id=\"ref-for-entrymaprecord⑧\">EntryMapRecord</a> is invalid skip it.</p>\n      </li><li data-md=\"\">\n       <p>Add an <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#patch-map-entries\" id=\"ref-for-patch-map-entries⑥\">entry</a> to <var>entry list</var> which  maps to the generated URL string, the patch format\nspecified by <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#format-1-patch-map-patchformat\" id=\"ref-for-format-1-patch-map-patchformat①\">patchFormat</a>, and <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#format-1-patch-map-compatibilityid\" id=\"ref-for-format-1-patch-map-compatibilityid①\">compatibilityId</a>; or if there is an existing <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#patch-map-entries\" id=\"ref-for-patch-map-entries⑦\">entry</a> in <var>entry list</var> which has the same patch URL string as the generated URL string then\ninstead modify the existing entry. Add the constructed set of Unicode code points and <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#featurerecord-featuretag\" id=\"ref-for-featurerecord-featuretag③\">featureTag</a> to the new or\nexisting entry’s subset definition.</p>\n     </li></ul>"
        },
        {
          "html": "<p>Return <var>entry list</var>.</p>"
        }
      ]
    },
    {
      "html": "The algorithm:",
      "rationale": "check",
      "steps": [
        {
          "html": "<p>Check that the <var>patch map</var> has <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#format-1-patch-map-format\" id=\"ref-for-format-1-patch-map-format①\">format</a> equal to 1 and is valid according to the requirements in <a href=\"https://w3c.github.io/IFT/Overview.html#patch-map-format-1\">§ 5.3.1 Patch Map Table: Format 1</a>. If it is not return an error.</p>"
        },
        {
          "html": "<p>For each unique <var>entry index</var> in <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#glyph-map-entryindex\" id=\"ref-for-glyph-map-entryindex①\">entryIndex</a> of <var>patch map</var>:</p>\n     <ul>\n      <li data-md=\"\">\n       <p>If the bit for <var>entry index</var> in <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#format-1-patch-map-appliedentriesbitmap\" id=\"ref-for-format-1-patch-map-appliedentriesbitmap③\">appliedEntriesBitMap</a> is set to 1, skip this <var>entry index</var>.</p>\n      </li><li data-md=\"\">\n       <p>Convert <var>entry index</var> into a URL string by applying <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#format-1-patch-map-uritemplate\" id=\"ref-for-format-1-patch-map-uritemplate②\">uriTemplate</a> following <a href=\"https://w3c.github.io/IFT/Overview.html#uri-templates\">§ 5.3.3 URI Templates</a>.\nIf the template expansion results in an error (see: <a href=\"https://www.rfc-editor.org/rfc/rfc6570#section-3\">URI Template § section-3</a>) then, return an error.</p>\n      </li><li data-md=\"\">\n       <p>If the generated URL string is equal to <var>patch URL string</var> then set the bit for <var>entry index</var> in <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#format-1-patch-map-appliedentriesbitmap\" id=\"ref-for-format-1-patch-map-appliedentriesbitmap④\">appliedEntriesBitMap</a> to 1.</p>\n     </li></ul>"
        }
      ]
    },
    {
      "html": "The algorithm:",
      "rationale": "check",
      "steps": [
        {
          "html": "<p>Check that the <var>patch map</var> has <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#format-2-patch-map-format\" id=\"ref-for-format-2-patch-map-format\">format</a> equal to 2 and is valid according to the requirements in <a href=\"https://w3c.github.io/IFT/Overview.html#patch-map-format-2\">§ 5.3.2 Patch Map Table: Format 2</a> (requirements are marked with a \"must\"). If it is not return an error.</p>"
        },
        {
          "html": "<p>If the <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#format-2-patch-map-entryidstringdata\" id=\"ref-for-format-2-patch-map-entryidstringdata⑤\">entryIdStringData</a> offset is 0 then initialize <var>last entry id</var> to 0. Otherwise initialize\n it to an empty byte string. Set <var>current byte</var> to 0, and <var>current id string byte</var> to 0.</p>"
        },
        {
          "html": "<p>Initialize <var>entry list</var> and <var>prior entry list</var> to empty lists.</p>"
        },
        {
          "html": "<p>Invoke <a data-link-type=\"abstract-op\" href=\"https://w3c.github.io/IFT/Overview.html#abstract-opdef-interpret-format-2-patch-map-entry\" id=\"ref-for-abstract-opdef-interpret-format-2-patch-map-entry①\">Interpret Format 2 Patch Map Entry</a>, <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#format-2-patch-map-entrycount\" id=\"ref-for-format-2-patch-map-entrycount①\">entryCount</a> times. For each invocation:</p>\n     <ul>\n      <li data-md=\"\">\n       <p>pass in <var>prior entry list</var>, the bytes from <var>patch map</var> starting from <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#format-2-patch-map-entries\" id=\"ref-for-format-2-patch-map-entries\">entries</a>[<var>current byte</var>] to\n the end of <var>patch map</var>,\n the bytes from <var>patch map</var> starting from <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#format-2-patch-map-entryidstringdata\" id=\"ref-for-format-2-patch-map-entryidstringdata⑥\">entryIdStringData</a>[<var>current id string byte</var>]\n to the end of <var>patch map</var> if <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#format-2-patch-map-entryidstringdata\" id=\"ref-for-format-2-patch-map-entryidstringdata⑦\">entryIdStringData</a> is non zero, <var>last entry id</var>, <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#format-2-patch-map-defaultpatchformat\" id=\"ref-for-format-2-patch-map-defaultpatchformat①\">defaultPatchFormat</a>, and <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#format-2-patch-map-uritemplate\" id=\"ref-for-format-2-patch-map-uritemplate\">uriTemplate</a>.</p>\n      </li><li data-md=\"\">\n       <p>Set <var>last entry id</var> to the returned entry id.</p>\n      </li><li data-md=\"\">\n       <p>Add the returned consumed byte count to <var>current byte</var>.</p>\n      </li><li data-md=\"\">\n       <p>Add the returned consumed id string byte count to <var>current id string byte</var>.</p>\n      </li><li data-md=\"\">\n       <p>Add the returned entry to <var>prior entry list</var>.</p>\n      </li><li data-md=\"\">\n       <p>If the returned value of ignored is false, then set the compatibility ID of the returned entry to <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#format-2-patch-map-compatibilityid\" id=\"ref-for-format-2-patch-map-compatibilityid\">compatibilityId</a> and add the  entry to <var>entry list</var>.</p>\n     </li></ul>"
        },
        {
          "html": "<p>Return <var>entry list</var>.</p>"
        }
      ]
    },
    {
      "html": "The algorithm:",
      "rationale": "for",
      "steps": [
        {
          "html": "<p>For the all steps whenever data is loaded from <var>entry bytes</var> increment <var>consumed bytes</var> with the\n number of bytes read.</p>"
        },
        {
          "html": "<p>Set <var>entry id</var> = <var>last entry id</var>, <var>consumed id string bytes</var> = 0.</p>"
        },
        {
          "html": "<p>Set the patch format of <var>entry</var> to <var>default patch format</var>.</p>"
        },
        {
          "html": "<p>Add a single <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#font-subset-definition\" id=\"ref-for-font-subset-definition⑨\">font subset definition</a> to <var>entry</var> with all sets initialized to be empty.</p>"
        },
        {
          "html": "<p>Read <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#mapping-entry-formatflags\" id=\"ref-for-mapping-entry-formatflags①⓪\">formatFlags</a> from <var>entry bytes</var>.</p>"
        },
        {
          "html": "<p>If <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#mapping-entry-formatflags\" id=\"ref-for-mapping-entry-formatflags①①\">formatFlags</a> bit 0 is set, then the feature tag and design space lists are present:</p>\n     <ul>\n      <li data-md=\"\">\n       <p>Read the feature tag list specified by <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#mapping-entry-featurecount\" id=\"ref-for-mapping-entry-featurecount\">featureCount</a> and <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#mapping-entry-featuretags\" id=\"ref-for-mapping-entry-featuretags\">featureTags</a> from <var>entry bytes</var> and add the loaded tags to the first <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#font-subset-definition\" id=\"ref-for-font-subset-definition①⓪\">font subset definition</a> in <var>entry</var>.</p>\n      </li><li data-md=\"\">\n       <p>Read the design space segment list specified by <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#mapping-entry-designspacecount\" id=\"ref-for-mapping-entry-designspacecount\">designSpaceCount</a> and <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#mapping-entry-designspacesegments\" id=\"ref-for-mapping-entry-designspacesegments\">designSpaceSegments</a> from <var>entry bytes</var> and add the design space segments to the first <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#font-subset-definition\" id=\"ref-for-font-subset-definition①①\">font subset definition</a> in <var>entry</var>. Each\nsegment defines an interval from <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#design-space-segment-start\" id=\"ref-for-design-space-segment-start\">start</a> to <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#design-space-segment-end\" id=\"ref-for-design-space-segment-end\">end</a> inclusive for the axis identified\nby <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#design-space-segment-tag\" id=\"ref-for-design-space-segment-tag\">tag</a>. If any segment has a <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#design-space-segment-start\" id=\"ref-for-design-space-segment-start①\">start</a> which is greater than <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#design-space-segment-end\" id=\"ref-for-design-space-segment-end①\">end</a> then, this encoding is invalid return an error.</p>\n     </li></ul>"
        },
        {
          "html": "<p>If <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#mapping-entry-formatflags\" id=\"ref-for-mapping-entry-formatflags①②\">formatFlags</a> bit 1 is set, then the copy indices list is present:</p>\n     <ul>\n      <li data-md=\"\">\n       <p>If the most significant bit of <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#mapping-entry-childentrymatchmodeandcount\" id=\"ref-for-mapping-entry-childentrymatchmodeandcount\">childEntryMatchModeAndCount</a> is set then set <var>entry</var>’s match mode to conjunctive,\n otherwise to disjunctive.</p>\n      </li><li data-md=\"\">\n       <p>Read the child entry indices list specified by <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#mapping-entry-childentrymatchmodeandcount\" id=\"ref-for-mapping-entry-childentrymatchmodeandcount①\">childEntryMatchModeAndCount</a> and <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#mapping-entry-childentryindices\" id=\"ref-for-mapping-entry-childentryindices\">childEntryIndices</a> from <var>entry bytes</var>.</p>\n      </li><li data-md=\"\">\n       <p>The child entry indices refer to previously loaded entries. 0 is the first <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#mapping-entry\" id=\"ref-for-mapping-entry③\">Mapping Entry</a> in <var>prior entry list</var>, 1 the second\n and so on. For each value in <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#mapping-entry-childentryindices\" id=\"ref-for-mapping-entry-childentryindices①\">childEntryIndices</a> locate the entry in <var>prior entry list</var> with a matching index.\n Add a reference to that entry into <var>entry</var>. If a <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#mapping-entry-childentryindices\" id=\"ref-for-mapping-entry-childentryindices②\">childEntryIndices</a> is greater than or equal to the length\n of <var>prior entry list</var> then, this encoding is invalid return an error.</p>\n     </li></ul>"
        },
        {
          "html": "<p>If <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#mapping-entry-formatflags\" id=\"ref-for-mapping-entry-formatflags①③\">formatFlags</a> bit 2 is set, then id deltas or id string lengths are present:</p>\n     <ul>\n      <li data-md=\"\">\n       <p>If <var>id string bytes</var> is not present, then:</p>\n       <ul>\n        <li data-md=\"\">\n         <p>Read the next <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#mapping-entry-entryiddelta\" id=\"ref-for-mapping-entry-entryiddelta①\">entryIdDelta</a> value.</p>\n        </li><li data-md=\"\">\n         <p>Set <var>entry id</var> to <code><var>entry id</var> + 1 + floor(delta value / 2)</code>.\n If <var>entry id</var> is negative or greater than 4,294,967,295 then, this encoding is invalid return an error.</p>\n        </li><li data-md=\"\">\n         <p>Convert <var>entry id</var> into a URL string by applying <var>uri template</var> following <a href=\"https://w3c.github.io/IFT/Overview.html#uri-templates\">§ 5.3.3 URI Templates</a>.\n If the template expansion results in an error (see: <a href=\"https://www.rfc-editor.org/rfc/rfc6570#section-3\">URI Template § section-3</a>) then, return an error.</p>\n        </li><li data-md=\"\">\n         <p>Add the generated patch URL string to <var>entry</var>.</p>\n        </li><li data-md=\"\">\n         <p>If the least significant bit of the read delta value is set, then repeat step 8.</p>\n       </li></ul>\n      </li><li data-md=\"\">\n       <p>Otherwise if <var>id string bytes</var> is present, then:</p>\n       <ul>\n        <li data-md=\"\">\n         <p>Read the next <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#mapping-entry-entryidstringlength\" id=\"ref-for-mapping-entry-entryidstringlength\">entryIdStringLength</a> value.</p>\n        </li><li data-md=\"\">\n         <p>Interpret the least significant 23 bits as an unsigned integer and read that many bytes from <var>id string bytes</var>.\n Set <var>entry id</var> to the result. Increment <var>consumed id string bytes</var> by the number of bytes read.</p>\n        </li><li data-md=\"\">\n         <p>Convert <var>entry id</var> into a URL string by applying <var>uri template</var> following <a href=\"https://w3c.github.io/IFT/Overview.html#uri-templates\">§ 5.3.3 URI Templates</a>.\n If the template expansion results in an error (see: <a href=\"https://www.rfc-editor.org/rfc/rfc6570#section-3\">URI Template § section-3</a>) then, return an error.</p>\n        </li><li data-md=\"\">\n         <p>Add the generated patch URL string to <var>entry</var>.</p>\n        </li><li data-md=\"\">\n         <p>If the most significant bit of the read length value is set, then repeat step 8.</p>\n       </li></ul>\n     </li></ul>"
        },
        {
          "html": "<p>If <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#mapping-entry-formatflags\" id=\"ref-for-mapping-entry-formatflags①④\">formatFlags</a> bit 2 is not set:</p>\n     <ul>\n      <li data-md=\"\">\n       <p>If <var>id string bytes</var> is not present, then:</p>\n       <ul>\n        <li data-md=\"\">\n         <p>Set <var>entry id</var> to <var>entry id</var> + 1.</p>\n        </li><li data-md=\"\">\n         <p>Convert <var>entry id</var> into a URL string by applying <var>uri template</var> following <a href=\"https://w3c.github.io/IFT/Overview.html#uri-templates\">§ 5.3.3 URI Templates</a>.\n If the template expansion results in an error (see: <a href=\"https://www.rfc-editor.org/rfc/rfc6570#section-3\">URI Template § section-3</a>) then, return an error.</p>\n        </li><li data-md=\"\">\n         <p>Add the generated patch URL string to <var>entry</var>.</p>\n       </li></ul>\n      </li><li data-md=\"\">\n       <p>Otherwise if <var>id string bytes</var> is present, then:</p>\n       <ul>\n        <li data-md=\"\">\n         <p>Convert <var>entry id</var> into a URL string by applying <var>uri template</var> following <a href=\"https://w3c.github.io/IFT/Overview.html#uri-templates\">§ 5.3.3 URI Templates</a>.\n If the template expansion results in an error (see: <a href=\"https://www.rfc-editor.org/rfc/rfc6570#section-3\">URI Template § section-3</a>) then, return an error.</p>\n        </li><li data-md=\"\">\n         <p>Add the generated patch URL string to <var>entry</var>.</p>\n       </li></ul>\n     </li></ul>"
        },
        {
          "html": "<p>If <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#mapping-entry-formatflags\" id=\"ref-for-mapping-entry-formatflags①⑤\">formatFlags</a> bit 3 is set, then a patch format is present. Read the format specified by <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#mapping-entry-patchformat\" id=\"ref-for-mapping-entry-patchformat\">patchFormat</a> from <var>entry bytes</var> and set the patch format of <var>entry</var> to the read value.\n If <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#mapping-entry-patchformat\" id=\"ref-for-mapping-entry-patchformat①\">patchFormat</a> is not one of the values in <a href=\"https://w3c.github.io/IFT/Overview.html#font-patch-formats-summary\">§ 6.1 Formats Summary</a> then, this encoding is invalid\n return an error.</p>"
        },
        {
          "html": "<p>If one or both of <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#mapping-entry-formatflags\" id=\"ref-for-mapping-entry-formatflags①⑥\">formatFlags</a> bit 4 and bit 5 are set, then a code point list is present:</p>\n     <ul>\n      <li data-md=\"\">\n       <p>If <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#mapping-entry-formatflags\" id=\"ref-for-mapping-entry-formatflags①⑦\">formatFlags</a> bit 4 is 0 and bit 5 is 1, then read the 2 byte (uint16) <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#mapping-entry-bias\" id=\"ref-for-mapping-entry-bias\">bias</a> value\nfrom <var>entry bytes</var>.</p>\n      </li><li data-md=\"\">\n       <p>If <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#mapping-entry-formatflags\" id=\"ref-for-mapping-entry-formatflags①⑧\">formatFlags</a> bit 4 is 1 and bit 5 is 1, then read the 3 byte (uint24) <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#mapping-entry-bias\" id=\"ref-for-mapping-entry-bias①\">bias</a> value\nfrom <var>entry bytes</var>.</p>\n      </li><li data-md=\"\">\n       <p>Otherwise the bias is 0.</p>\n      </li><li data-md=\"\">\n       <p>Read the sparse bit set <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#mapping-entry-codepoints\" id=\"ref-for-mapping-entry-codepoints\">codePoints</a> from <var>entry bytes</var> with bias following <a href=\"https://w3c.github.io/IFT/Overview.html#sparse-bit-set-decoding\">§ 5.3.2.3 Sparse Bit Set</a>.\nAdd the resulting code point set to the first <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#font-subset-definition\" id=\"ref-for-font-subset-definition①②\">font subset definition</a> in <var>entry</var>. If the sparse bit set decoding\nfailed then, this encoding is invalid return an error.</p>\n     </li></ul>"
        },
        {
          "html": "<p>If <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#mapping-entry-formatflags\" id=\"ref-for-mapping-entry-formatflags①⑨\">formatFlags</a> bit 6 is set, then set <var>ignored</var> to true. Otherwise <var>ignored</var> is false.</p>"
        },
        {
          "html": "<p>Return <var>entry id</var>, <var>entry</var>, <var>consumed bytes</var>, <var>consumed id string bytes</var>, and <var>ignored</var>.</p>"
        }
      ]
    },
    {
      "html": "The algorithm, using a FIFO (first in first out) queue <var>Q</var>:",
      "rationale": "remove",
      "steps": [
        {
          "html": "<p>Remove the first byte from <var>treeData</var>. This is the header byte. Determine <var>H</var> the tree height and <var>B</var> the\n branch factor following <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#sparse-bit-set\" id=\"ref-for-sparse-bit-set①\">Sparse Bit Set</a>.</p>"
        },
        {
          "html": "<p>If <var>H</var> is greater than the \"Maximum Height\" in the <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#branch-factor-encoding\" id=\"ref-for-branch-factor-encoding①\">Branch Factor Encoding</a> table in the row for <var>B</var> then,\n the encoding is invalid, return an error.</p>"
        },
        {
          "html": "<p>If <var>H</var> is equal to 0, then this is an empty set and no further bytes of <var>treeData</var> are consumed. Return an empty set.</p>"
        },
        {
          "html": "<p>Insert the tuple (0, 1) into <var>Q</var>.</p>"
        },
        {
          "html": "<p>Initialize <var>S</var> to an empty set.</p>"
        },
        {
          "html": "<p><var>treeData</var> is interpreted as a string of bits where the least significant bit of <var>treeData</var>[0] is the first bit in\n the string, the most significant bit of <var>treeData</var>[0] is the 8th bit, and so on.</p>"
        },
        {
          "html": "<p>If in the following steps a value is added to <var>S</var> which is larger than the maximum unicode code point value (0x10FFFF) then,\n ignore the value and do not add it to <var>S</var>.</p>"
        },
        {
          "html": "<p>If <var>Q</var> is empty return <var>S</var>.</p>"
        },
        {
          "html": "<p>Extract the next tuple <var>t</var> from <var>Q</var>. The first value of\n in <var>t</var> is <var>start</var> and the second value is <var>depth</var>.</p>"
        },
        {
          "html": "<p>Remove the next <var>B</var> bits from the <var>treeData</var> bit string. The first removed bit is <i>v<sub>1</sub></i>,\n the second is <i>v<sub>2</sub></i>, and so on until the last removed bit which is <i>v<sub>B</sub></i>. If prior to removal there\n were less than <var>B</var> bits left in <var>treeData</var>, then <var>treeData</var> is malformed, return an error.</p>"
        },
        {
          "html": "<p>If all bits <i>v<sub>1</sub></i> through <i>v<sub>B</sub></i> are 0, then insert all integers in the interval\n[<var>start</var> + <var>bias</var>, <var>start</var> + <var>bias</var> + <var>B</var><sup><var>H</var> - <var>depth</var> + 1</sup>)\ninto <var>S</var>. Go to step 5.</p>"
        },
        {
          "html": "<p>For each <i>v<sub>i</sub></i> which is equal to 1 in <i>v<sub>1</sub></i> through <i>v<sub>B</sub></i>:\n If <var>depth</var> is equal to <var>H</var> add\n integer <var>start</var> + <var>bias</var> + <i>i</i> - 1 to <var>S</var>. Otherwise, insert the tuple\n (<var>start</var> + (i - 1) * <var>B</var><sup><var>H</var> - <var>depth</var></sup>, <var>depth</var> + 1)\n into <var>Q</var>.</p>"
        },
        {
          "html": "<p>Go to step 8.</p>"
        }
      ]
    },
    {
      "html": "The algorithm:",
      "rationale": "initialize",
      "steps": [
        {
          "html": "<p>Initialize <var>extended font subset</var> to be an empty font with no tables.</p>"
        },
        {
          "html": "<p>Check that the <var>patch</var> is valid according to the requirements in <a href=\"https://w3c.github.io/IFT/Overview.html#table-keyed\">§ 6.2 Table Keyed</a> (requirements are marked with a\n\"must\") and all <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#tablepatch\" id=\"ref-for-tablepatch②\">TablePatch</a>’s are contained within <var>patch</var>. Otherwise, return an error</p>"
        },
        {
          "html": "<p>Check that the <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#table-keyed-patch-compatibilityid\" id=\"ref-for-table-keyed-patch-compatibilityid\">compatibilityId</a> field in <var>patch</var> is equal to <var>compatibility id</var>.\nIf there is no match, or <var>base font subset</var> does not have either an 'IFT ' or 'IFTX' table, then patch application\nhas failed, return an error.</p>"
        },
        {
          "html": "<p>In the following steps, adding a table to <var>extended font subset</var> consists of adding the table’s data to the font and\ninserting a new entry into the <a href=\"https://learn.microsoft.com/en-us/typography/opentype/spec/otff#table-directory\">table directory</a> according to the requirements of the open\ntype specification. That entry includes a checksum for the table data. When an existing table is copied unmodified, the client\ncan re-use the checksum from the entry in the source font. Otherwise a new checksum will need to be computed.</p>"
        },
        {
          "html": "<p>For each entry in <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#table-keyed-patch-patches\" id=\"ref-for-table-keyed-patch-patches①\">patches</a>, with index <var>i</var>:</p>\n     <ul>\n      <li data-md=\"\">\n       <p>Find the <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#tablepatch\" id=\"ref-for-tablepatch③\">TablePatch</a> associated with index <var>i</var>. The object starts at the offset <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#table-keyed-patch-patches\" id=\"ref-for-table-keyed-patch-patches②\">patches[i]</a> (inclusive) and ends at the offset <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#table-keyed-patch-patches\" id=\"ref-for-table-keyed-patch-patches③\">patches[i+1]</a> (exclusive). Both offsets are relative to the start of\nthe <var>patch</var>.</p>\n      </li><li data-md=\"\">\n       <p>If an entry in <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#table-keyed-patch-patches\" id=\"ref-for-table-keyed-patch-patches④\">patches</a> was previously applied that has the same <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#tablepatch-tag\" id=\"ref-for-tablepatch-tag\">tag</a> as\nthis entry, then ignore this entry and continue the iteration to the next one. Entries are processed in same order as they\nare listed in the <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#table-keyed-patch-patches\" id=\"ref-for-table-keyed-patch-patches⑤\">patches</a> array.</p>\n      </li><li data-md=\"\">\n       <p>If bit 1 of <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#tablepatch-flags\" id=\"ref-for-tablepatch-flags\">flags</a> is set, then do not copy or add a <a href=\"https://learn.microsoft.com/en-us/typography/opentype/spec/otff#table-directory\">table</a> to <var>extended font subset</var> identified by <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#tablepatch-tag\" id=\"ref-for-tablepatch-tag①\">tag</a>. Continue to the next entry.</p>\n      </li><li data-md=\"\">\n       <p>If bit 0 (least significant bit) of <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#tablepatch-flags\" id=\"ref-for-tablepatch-flags①\">flags</a> is set, then decode <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#tablepatch-brotlistream\" id=\"ref-for-tablepatch-brotlistream①\">brotliStream</a> following <a href=\"https://www.rfc-editor.org/rfc/rfc7932#section-10\">Brotli Compressed Data Format § section-10</a>. No shared dictionary is used. If the decoded data is larger than <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#tablepatch-maxuncompressedlength\" id=\"ref-for-tablepatch-maxuncompressedlength\">maxUncompressedLength</a> return an error. If there is any data in <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#tablepatch-brotlistream\" id=\"ref-for-tablepatch-brotlistream②\">brotliStream</a> which was not used by the decoding process return an error.\nAdd a <a href=\"https://learn.microsoft.com/en-us/typography/opentype/spec/otff#table-directory\">table</a> to <var>extended font subset</var> identified by <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#tablepatch-tag\" id=\"ref-for-tablepatch-tag②\">tag</a> with it’s contents set to the decoded <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#tablepatch-brotlistream\" id=\"ref-for-tablepatch-brotlistream③\">brotliStream</a>. Continue to the next entry.</p>\n      </li><li data-md=\"\">\n       <p>Otherwise, decode <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#tablepatch-brotlistream\" id=\"ref-for-tablepatch-brotlistream④\">brotliStream</a> following <a href=\"https://www.rfc-editor.org/rfc/rfc7932#section-10\">Brotli Compressed Data Format § section-10</a> and using the <a href=\"https://learn.microsoft.com/en-us/typography/opentype/spec/otff#table-directory\">table</a> identified by <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#tablepatch-tag\" id=\"ref-for-tablepatch-tag③\">tag</a> in <var>base font subset</var> as a <a href=\"https://datatracker.ietf.org/doc/html/draft-vandevenne-shared-brotli-format-15#section-3.2\">shared LZ77 dictionary</a>. If no such table exists return an error. If the decoded data is\nlarger than <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#tablepatch-maxuncompressedlength\" id=\"ref-for-tablepatch-maxuncompressedlength①\">maxUncompressedLength</a> return an error. If there is any data in <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#tablepatch-brotlistream\" id=\"ref-for-tablepatch-brotlistream⑤\">brotliStream</a> which was\nnot used by the decoding process return an error. Add a <a href=\"https://learn.microsoft.com/en-us/typography/opentype/spec/otff#table-directory\">table</a> to <var>extended font subset</var> identified by <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#tablepatch-tag\" id=\"ref-for-tablepatch-tag④\">tag</a> with it’s contents set to the decoded <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#tablepatch-brotlistream\" id=\"ref-for-tablepatch-brotlistream⑥\">brotliStream</a>.</p>\n     </li></ul>"
        },
        {
          "html": "<p>For each <a href=\"https://learn.microsoft.com/en-us/typography/opentype/spec/otff#table-directory\">table</a> in <var>base font subset</var> which has a tag that was not found in any of\nthe entries processed in step 5, add a copy of that table to <var>extended font subset</var>.</p>"
        }
      ]
    },
    {
      "html": "The algorithm:",
      "rationale": "check",
      "steps": [
        {
          "html": "<p>Check that the <var>patch</var> is valid according to the requirements in <a href=\"https://w3c.github.io/IFT/Overview.html#glyph-keyed\">§ 6.3 Glyph Keyed</a> (requirements are marked with a\n\"must\"). Otherwise, return an error</p>"
        },
        {
          "html": "<p>Check that the <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#glyph-keyed-patch-compatibilityid\" id=\"ref-for-glyph-keyed-patch-compatibilityid\">compatibilityId</a> field in <var>patch</var> is equal to <var>compatibility id</var>.\nIf there is no match, or <var>base font subset</var> does not have either an 'IFT ' or 'IFTX' table, then patch application has\nfailed, return an error.</p>"
        },
        {
          "html": "<p>Decode the brotli encoded data in <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#glyph-keyed-patch-brotlistream\" id=\"ref-for-glyph-keyed-patch-brotlistream①\">brotliStream</a> following <a href=\"https://www.rfc-editor.org/rfc/rfc7932#section-10\">Brotli Compressed Data Format § section-10</a>. The\ndecoded data is a <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#glyphpatches\" id=\"ref-for-glyphpatches②\">GlyphPatches</a> table. If the decoded data is larger than <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#glyph-keyed-patch-maxuncompressedlength\" id=\"ref-for-glyph-keyed-patch-maxuncompressedlength\">maxUncompressedLength</a> return an\nerror</p>"
        },
        {
          "html": "<p>For each <a href=\"https://learn.microsoft.com/en-us/typography/opentype/spec/otff#table-directory\">font table</a> listed in <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#glyphpatches-tables\" id=\"ref-for-glyphpatches-tables②\">tables</a>, with index <code>i</code>:</p>\n     <ul>\n      <li data-md=\"\">\n       <p>Using the corresponding table in <var>base font subset</var>, synthesize\na new table where the data for each glyph is replaced with the data corresponding to that glyph index\nfrom <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#glyphpatches-glyphdata\" id=\"ref-for-glyphpatches-glyphdata\">glyphData</a> if present, otherwise copied from the corresponding table in <var>base font subset</var> for\nthat glyph index.</p>\n      </li><li data-md=\"\">\n       <p>The patch glyph data for a glyph index is located by finding <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#glyphpatches-glyphids\" id=\"ref-for-glyphpatches-glyphids①\">glyphIds[j]</a> equal to the glyph index. The\noffset to the associated glyph data is <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#glyphpatches-glyphdataoffsets\" id=\"ref-for-glyphpatches-glyphdataoffsets①\">glyphDataOffsets[i * glyphCount + j]</a>. The length\nof the associated glyph data is <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#glyphpatches-glyphdataoffsets\" id=\"ref-for-glyphpatches-glyphdataoffsets②\">glyphDataOffsets[i * glyphCount + j + 1]</a> minus <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#glyphpatches-glyphdataoffsets\" id=\"ref-for-glyphpatches-glyphdataoffsets③\">glyphDataOffsets[i * glyphCount + j]</a>.</p>\n      </li><li data-md=\"\">\n       <p>The specific process for synthesizing the new table, depends on the specified format of the <a href=\"https://learn.microsoft.com/en-us/typography/opentype/spec/otff#table-directory\">table</a>. Any non-glyph associated data should be copied from the table in <var>base font subset</var>. Tables of the type <a href=\"https://learn.microsoft.com/en-us/typography/opentype/spec/glyf#\">glyf</a>, <a href=\"https://learn.microsoft.com/en-us/typography/opentype/spec/gvar#\">gvar</a>, <a href=\"https://learn.microsoft.com/en-us/typography/opentype/spec/cff#\">CFF</a>, or <a href=\"https://learn.microsoft.com/en-us/typography/opentype/spec/cff2#\">CFF2</a> are supported. Entries for tables\nof any other types must be ignored. When updating <a href=\"https://learn.microsoft.com/en-us/typography/opentype/spec/glyf#\">glyf</a> the <a href=\"https://learn.microsoft.com/en-us/typography/opentype/spec/loca#\">loca</a> table must be updated as\nwell. No other tables in the font can be modified as a result of this step. Notably this means that a patch cannot add glyphs\nwith indices beyond the numGlyphs specified in <a href=\"https://learn.microsoft.com/en-us/typography/opentype/spec/maxp#\">maxp</a>.</p>\n       <p><a href=\"https://learn.microsoft.com/en-us/typography/opentype/spec/cff#\">CFF</a>, <a href=\"https://learn.microsoft.com/en-us/typography/opentype/spec/cff2#\">CFF2</a>, and <a href=\"https://learn.microsoft.com/en-us/typography/opentype/spec/gvar#\">gvar</a> have variable sized offsets to per glyph data. If\nnecessary when synthesizing a new table the offset sizes can be increased as needed. For <a href=\"https://learn.microsoft.com/en-us/typography/opentype/spec/glyf#\">glyf</a>/<a href=\"https://learn.microsoft.com/en-us/typography/opentype/spec/loca#\">loca</a> offset sizes cannot be changed because the offset size is specified in the <a href=\"https://learn.microsoft.com/en-us/typography/opentype/spec/head#\">head</a> table. If during synthesis an offset\nis generated which exceeds the maximum possible offset value (after increasing offset size if possible), then patch application has\nfailed. Return an error.</p>\n      </li><li data-md=\"\">\n       <p>If <var>base font subset</var> does not have a matching table, return an error.</p>\n      </li><li data-md=\"\">\n       <p>Insert the synthesized table into <var>extended font subset</var>.</p>\n     </li></ul>"
        },
        {
          "html": "<p>Locate the <a href=\"https://w3c.github.io/IFT/Overview.html#patch-map-table\">§ 5.3 Patch Map Table</a> which has the same <a data-link-type=\"dfn\" href=\"https://w3c.github.io/IFT/Overview.html#glyph-keyed-patch-compatibilityid\" id=\"ref-for-glyph-keyed-patch-compatibilityid①\">compatibilityId</a> as <var>compatibility id</var>. If it is a\nformat 1 patch map then, invoke <a data-link-type=\"abstract-op\" href=\"https://w3c.github.io/IFT/Overview.html#abstract-opdef-remove-entries-from-format-1-patch-map\" id=\"ref-for-abstract-opdef-remove-entries-from-format-1-patch-map\">Remove Entries from Format 1 Patch Map</a> with the patch map table and <var>patch URL string</var> as an\ninput. Otherwise if it is a format 2 patch map then, invoke <a data-link-type=\"abstract-op\" href=\"https://w3c.github.io/IFT/Overview.html#abstract-opdef-remove-entries-from-format-2-patch-map\" id=\"ref-for-abstract-opdef-remove-entries-from-format-2-patch-map\">Remove Entries from Format 2 Patch Map</a> with the patch map table and <var>patch URL string</var> as an input. Copy the modified patch map table into <var>extended font subset</var>.</p>"
        },
        {
          "html": "<p>For each <a href=\"https://learn.microsoft.com/en-us/typography/opentype/spec/otff#table-directory\">table</a> in <var>base font subset</var> which has a tag that was not found in any of\nthe entries processed in step 4 or 5, add a copy of that table to <var>extended font subset</var>.</p>"
        },
        {
          "html": "<p>If the contents of any <a href=\"https://learn.microsoft.com/en-us/typography/opentype/spec/otff#table-directory\">font table</a> was modified during the previous steps then,\nfor each modified table: update the checksums in the <a href=\"https://learn.microsoft.com/en-us/typography/opentype/spec/otff#table-directory\">fonts table directory</a> to match the table’s\nnew contents.</p>"
        }
      ]
    },
    {
      "html": "For fonts that are in-between, or in cases where fine-grained segmentation of glyph data is desired but segmentation of data\nin other tables is still needed, it can be desirable to mix the <a href=\"https://w3c.github.io/IFT/Overview.html#table-keyed\">§ 6.2 Table Keyed</a> and <a href=\"https://w3c.github.io/IFT/Overview.html#glyph-keyed\">§ 6.3 Glyph Keyed</a> patch types in this\nway:",
      "rationale": "use",
      "steps": [
        {
          "html": "<p>Keep all table keyed patch entries in one mapping table and all glyph keyed entries in the other mapping table.</p>"
        },
        {
          "html": "<p>Use table keyed patches to update all tables except for the tables touched by the glyph keyed patches (outline,\nvariation deltas, and the glyph keyed patch mapping table). These patches should use a small number of large segments to keep\nthe patch count reasonable.</p>"
        },
        {
          "html": "<p>Because glyph keyed patches reference the specific glyph IDs that are updated, the table keyed patches must not change\nthe glyph to glyph ID assignments used in the original font; otherwise, the glyph IDs listed in the glyph keyed patches may\nbecome incorrect. In font subsetters this is often available as an option called \"retain glyph IDs\".</p>"
        },
        {
          "html": "<p>Lastly, use glyph keyed patches to update the remaining tables, here much smaller fine-grained segments can be utilized without\nrequiring too many patches.</p>"
        }
      ]
    },
    {
      "html": "Using <a href=\"https://w3c.github.io/IFT/Overview.html#table-keyed\">§ 6.2 Table Keyed</a> patches along side a large number of segments can result in a very large number of patches needed, which can have two\nnegative effects. First, the storage space needed for all of the pre-generated patches could be undesirably large. Second, more \npatches will generally mean lower CDN cache performance, because a higher number of patches represents a higher number of paths\nfrom a given subset to a given subset, with different paths being taken by different users depending on the content they access.\nThere are some techniques which can be used to reduce the total number of pre-generated patches:",
      "rationale": "use",
      "steps": [
        {
          "html": "<p>Use a maximum depth for the patch graph, once this limit is reached the font is patched to add all remaining parts of the full\noriginal font. This will cause the whole remaining font to be loaded after a certain number of segments have been added. Limiting\nthe depth of the graph will reduced the combinatorial explosion of patches at the lower depths.</p>"
        },
        {
          "html": "<p>Alternatively, at lower depths the encoder could begin combining multiple segments into single patches to reduce the fan out at each\nlevel.</p>"
        }
      ]
    },
    {
      "html": "One security concern is that IFT fonts could potentially generate a large number of network requests for patches. This could cause\nproblems on the client or the service hosting the patches. The IFT specification contains a couple of mitigations to limit excessive\nnumber of requests:",
      "rationale": "load",
      "steps": [
        {
          "html": "<p><a href=\"https://w3c.github.io/IFT/Overview.html#extending-font-subset\">§ 4 Extending a Font Subset</a>: disallows re-requesting the same URL multiple times and has limits on the total number of requests\n that can be issued during the extension process.</p>"
        },
        {
          "html": "<p><a data-link-type=\"abstract-op\" href=\"https://w3c.github.io/IFT/Overview.html#abstract-opdef-load-patch-file\" id=\"ref-for-abstract-opdef-load-patch-file②\">Load patch file</a>: specifies the use of <a data-link-type=\"biblio\" href=\"https://w3c.github.io/IFT/Overview.html#biblio-fetch\" title=\"Fetch Standard\">[FETCH]</a> in implementing web browsers and matches the CORS settings for the initial\n font load. As a result cross-origin requests for patch files are disallowed unless the hosting service opts in via the appropriate\n access control headers.</p>"
        }
      ]
    }
  ]
}