{
  "spec": {
    "title": "Device Bound Session Credentials",
    "url": "https://w3c.github.io/webappsec-dbsc/"
  },
  "algorithms": [
    {
      "name": "algorithms/identify a session",
      "href": "https://w3c.github.io/webappsec-dbsc/#algorithms-identify-a-session",
      "html": "This algorithm describes how to <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-for=\"algorithms\" data-dfn-type=\"dfn\" data-export=\"\" id=\"algorithms-identify-a-session\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">identify a session</dfn> out of all the\n  sessions that exist on a user agent. The <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#device-bound-session-session-identifier\" id=\"ref-for-device-bound-session-session-identifier①\">session identifier</a> is unique within a <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#host-registrable-domain\" id=\"ref-for-host-registrable-domain⑤\">registrable domain</a>. \n    <p>Given a <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url\" id=\"ref-for-concept-url②\">URL</a> (<var>url</var>) and <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#device-bound-session-session-identifier\" id=\"ref-for-device-bound-session-session-identifier②\">session identifier</a> (<var>session identifier</var>), this algorithm returns a <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#device-bound-session\" id=\"ref-for-device-bound-session①\">device bound session</a> or\n  null if no such session exists.</p>",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>domain</var> be the <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#host-registrable-domain\" id=\"ref-for-host-registrable-domain⑥\">registrable domain</a> of <var>url</var>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-host\" id=\"ref-for-concept-url-host\">host</a>.</p>"
        },
        {
          "html": "<p>If the user agent’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#session-store\" id=\"ref-for-session-store\">session store</a> does not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists\">contain</a> <var>domain</var>,\n return null.</p>"
        },
        {
          "html": "<p>Let <var>domain sessions</var> be the user agent’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#session-store\" id=\"ref-for-session-store①\">session store</a>[<var>domain</var>] as a <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#sessions-by-id-map\" id=\"ref-for-sessions-by-id-map①\">sessions by id map</a>.</p>"
        },
        {
          "html": "<p>Return <var>domain sessions</var>[<var>session identifier</var>] <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-with-default\" id=\"ref-for-map-with-default\">with default</a> null.</p>"
        }
      ]
    },
    {
      "name": "algorithms/determine if a URL is in scope",
      "href": "https://w3c.github.io/webappsec-dbsc/#algorithms-determine-if-a-url-is-in-scope",
      "html": "This algorithm describes how to <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-for=\"algorithms\" data-dfn-type=\"dfn\" data-export=\"\" data-lt=\"determine if a URL is in scope\" id=\"algorithms-determine-if-a-url-is-in-scope\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">determine if a\n  URL is in scope</dfn> of a device bound session. Given a <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url\" id=\"ref-for-concept-url③\">URL</a> (<var>URL</var>) and <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#device-bound-session\" id=\"ref-for-device-bound-session②\">device bound session</a> (<var>session</var>), returns \"include\" if <var>URL</var> is in scope,\n  and \"exclude\" otherwise.",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>scope</var> be <var>session</var>’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#device-bound-session-session-scope\" id=\"ref-for-device-bound-session-session-scope\">session scope</a>.</p>"
        },
        {
          "html": "<p>If <var>scope</var>’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#session-scope-include-site\" id=\"ref-for-session-scope-include-site\">include site</a> is true, return \"exclude\" if <var>URL</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin\" id=\"ref-for-concept-origin①\">origin</a> is not <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#same-site\" id=\"ref-for-same-site\">same site</a> with <var>scope</var>’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#session-scope-origin\" id=\"ref-for-session-scope-origin\">origin</a>.</p>"
        },
        {
          "html": "<p>If <var>scope</var>’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#session-scope-include-site\" id=\"ref-for-session-scope-include-site①\">include site</a> is false, return \"exclude\" if <var>URL</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin\" id=\"ref-for-concept-origin②\">origin</a> is not <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#same-origin\" id=\"ref-for-same-origin\">same origin</a> with <var>scope</var>’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#session-scope-origin\" id=\"ref-for-session-scope-origin①\">origin</a>.</p>"
        },
        {
          "html": "<p>If <var>URL</var> matches <var>session</var>’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#device-bound-session-refresh-url\" id=\"ref-for-device-bound-session-refresh-url\">refresh URL</a>, return \"exclude\".</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate\">For each</a> <var>scope specification</var> in <var>scope</var>’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#session-scope-scope-specifications\" id=\"ref-for-session-scope-scope-specifications\">scope specifications</a>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>host pattern</var> be <var>scope specification</var>’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#scope-specification-host\" id=\"ref-for-scope-specification-host\">host</a>, and <var>path pattern</var> be <var>scope\n specification</var>’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#scope-specification-path\" id=\"ref-for-scope-specification-path\">path</a>.</p>"
            },
            {
              "html": "<p>If running <a href=\"https://w3c.github.io/webappsec-dbsc/#algo-host-pattern-matches\">§ 8.4 Identify if a host matches a pattern</a> on <var>URL</var>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-host\" id=\"ref-for-concept-url-host①\">host</a> and <var>host pattern</var> returns false, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue\">continue</a>.</p>"
            },
            {
              "html": "<p>If any of the following hold, return <var>scope specification</var>’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#scope-specification-type\" id=\"ref-for-scope-specification-type\">type</a>:</p>",
              "ignored": [
                "URL’s path is exactly path pattern. path pattern ends in '/' and URL’s path starts with path pattern. URL’s path starts with path pattern followed by a '/'."
              ]
            }
          ]
        },
        {
          "html": "<p>Return \"include\".</p>"
        }
      ]
    },
    {
      "name": "algorithms/determine if a request is allowed to trigger refresh",
      "href": "https://w3c.github.io/webappsec-dbsc/#algorithms-determine-if-a-request-is-allowed-to-trigger-refresh",
      "html": "This algorithm describes how to <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-for=\"algorithms\" data-dfn-type=\"dfn\" data-export=\"\" data-lt=\"determine if a request is allowed to trigger refresh\" id=\"algorithms-determine-if-a-request-is-allowed-to-trigger-refresh\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">determine if\n  a request is allowed to trigger refresh</dfn> for a device bound\n  session. Given a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request\" id=\"ref-for-concept-request\">request</a> (<var>request</var>) and <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#device-bound-session\" id=\"ref-for-device-bound-session③\">device bound session</a> (<var>session</var>), returns \"allowed\" if <var>request</var> can trigger a refresh, and\n  \"disallowed\" otherwise.",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If <var>session</var>’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#device-bound-session-session-scope\" id=\"ref-for-device-bound-session-session-scope①\">session scope</a>’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#session-scope-include-site\" id=\"ref-for-session-scope-include-site②\">include site</a> is true, and <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-origin\" id=\"ref-for-concept-request-origin\">origin</a> is <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#same-site\" id=\"ref-for-same-site①\">same site</a> with <var>session</var>’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#device-bound-session-session-scope\" id=\"ref-for-device-bound-session-session-scope②\">session scope</a> <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#session-scope-origin\" id=\"ref-for-session-scope-origin②\">origin</a>, return \"allowed\".</p>"
        },
        {
          "html": "<p>If <var>session</var>’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#device-bound-session-session-scope\" id=\"ref-for-device-bound-session-session-scope③\">session scope</a>’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#session-scope-include-site\" id=\"ref-for-session-scope-include-site③\">include site</a> is false, and <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-origin\" id=\"ref-for-concept-request-origin①\">origin</a> is <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#same-origin\" id=\"ref-for-same-origin①\">same origin</a> with <var>session</var>’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#device-bound-session-session-scope\" id=\"ref-for-device-bound-session-session-scope④\">session scope</a> <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#session-scope-origin\" id=\"ref-for-session-scope-origin③\">origin</a>, return \"allowed\".</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate①\">For each</a> <var>initiator pattern</var> in <var>session</var>’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#device-bound-session-allowed-refresh-initiators\" id=\"ref-for-device-bound-session-allowed-refresh-initiators\">allowed refresh initiators</a>:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If running <a href=\"https://w3c.github.io/webappsec-dbsc/#algo-host-pattern-matches\">§ 8.4 Identify if a host matches a pattern</a> on <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-origin\" id=\"ref-for-concept-request-origin②\">origin</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-host\" id=\"ref-for-concept-origin-host\">host</a> and <var>initiator pattern</var> returns true, return \"allowed\".</p>"
            }
          ]
        },
        {
          "html": "<p>Return \"disallowed\".</p>"
        }
      ]
    },
    {
      "name": "algorithms/determine if a host matches a pattern",
      "href": "https://w3c.github.io/webappsec-dbsc/#algorithms-determine-if-a-host-matches-a-pattern",
      "html": "This algorithm describes how to <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-for=\"algorithms\" data-dfn-type=\"dfn\" data-export=\"\" data-lt=\"determine if a host matches a pattern\" id=\"algorithms-determine-if-a-host-matches-a-pattern\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">determine if\n  a host matches a pattern</dfn>. It takes as input a <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-host\" id=\"ref-for-concept-url-host②\">host</a> (<var>host</var>) and\n  a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#string\" id=\"ref-for-string⑨\">string</a> (<var>pattern</var>). It returns true if <var>pattern</var> covers <var>host</var>.",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If <var>pattern</var> equals '*', return true.</p>"
        },
        {
          "html": "If <var>pattern</var> starts with '*':",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>pattern</var> does not start with '*.', return false.</p>"
            },
            {
              "html": "<p>Return true if <var>host</var> ends with all but the first character\n of <var>pattern</var>.</p>"
            }
          ]
        },
        {
          "html": "<p>Return true if <var>host</var> is equal to <var>pattern</var>.</p>"
        }
      ]
    },
    {
      "name": "algorithms/identify a session needing refresh",
      "href": "https://w3c.github.io/webappsec-dbsc/#algorithms-identify-a-session-needing-refresh",
      "html": "Given a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request\" id=\"ref-for-concept-request①\">request</a> (<var>request</var>), this algorithm describes how to <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-for=\"algorithms\" data-dfn-type=\"dfn\" data-export=\"\" id=\"algorithms-identify-a-session-needing-refresh\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">identify a session needing refresh</dfn>. If any such\n  session exists, it should block <var>request</var> from proceeding.",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>domain</var> be the <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#host-registrable-domain\" id=\"ref-for-host-registrable-domain⑦\">registrable domain</a> of <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-url\" id=\"ref-for-concept-request-url\">url</a>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-host\" id=\"ref-for-concept-url-host③\">host</a>.</p>"
        },
        {
          "html": "<p>If the user agent’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#session-store\" id=\"ref-for-session-store②\">session store</a> does not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists①\">contain</a> <var>domain</var>,\n return null.</p>"
        },
        {
          "html": "<p>Let <var>domain sessions</var> be the user agent’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#session-store\" id=\"ref-for-session-store③\">session store</a>[<var>domain</var>] as a <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#sessions-by-id-map\" id=\"ref-for-sessions-by-id-map②\">sessions by id map</a>.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate②\">For each</a> <var>session</var> of <var>domain sessions</var>:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>session</var>’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#device-bound-session-expiration-timestamp\" id=\"ref-for-device-bound-session-expiration-timestamp\">expiration timestamp</a> is before the present, remove <var>session</var> from <var>domain sessions</var> and <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue①\">continue</a>.</p>"
            },
            {
              "html": "<p>Let <var>id</var> be <var>session</var>’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#device-bound-session-session-identifier\" id=\"ref-for-device-bound-session-session-identifier③\">session identifier</a>.</p>"
            },
            {
              "html": "<p>If the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#tuple\" id=\"ref-for-tuple\">tuple</a> (<var>domain</var>, <var>id</var>) is in <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#request-deferred-device-bound-session-ids\" id=\"ref-for-request-deferred-device-bound-session-ids\">deferred device bound session ids</a>, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue②\">continue</a>.</p>"
            },
            {
              "html": "<p>Run the steps in <a href=\"https://w3c.github.io/webappsec-dbsc/#algo-url-in-scope\">§ 8.2 Identify if a URL is in scope of a session</a> on <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-url\" id=\"ref-for-concept-request-url①\">URL</a> and <var>session</var>. If the result is not \"include\", <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue③\">continue</a>.</p>"
            },
            {
              "html": "<p>Run the steps in <a href=\"https://w3c.github.io/webappsec-dbsc/#algo-request-allows-refresh\">§ 8.3 Identify if a request is allowed to refresh</a> on <var>request</var> and <var>session</var>. If the result is not \"allowed\", <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue④\">continue</a>.</p>"
            },
            {
              "html": "<p>Run the steps in <a href=\"https://w3c.github.io/webappsec-dbsc/#algo-identify-if-missing-session-credential\">§ 8.6 Identify if missing session credential</a> on <var>request</var> and <var>session</var>’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#device-bound-session-session-credentials\" id=\"ref-for-device-bound-session-session-credentials\">session credentials</a>.\nIf the result is false, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue⑤\">continue</a>.</p>"
            },
            {
              "html": "<p>Add (<var>domain</var>, <var>id</var>) to <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#request-deferred-device-bound-session-ids\" id=\"ref-for-request-deferred-device-bound-session-ids①\">deferred device bound session ids</a>.</p>"
            },
            {
              "html": "<p>Set <var>session</var>’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#device-bound-session-expiration-timestamp\" id=\"ref-for-device-bound-session-expiration-timestamp①\">expiration timestamp</a> set to a future timestamp. The\n exact choice of expiration timestamp is left up to the user agent. It is\n recommended to align with the maximum cookie lifetime.</p>"
            },
            {
              "html": "<p>Return <var>session</var>.</p>"
            }
          ]
        },
        {
          "html": "<p>Return null.</p>"
        }
      ]
    },
    {
      "name": "algorithms/identify if a request is missing a session credential",
      "href": "https://w3c.github.io/webappsec-dbsc/#algorithms-identify-if-a-request-is-missing-a-session-credential",
      "html": "This algorithm describes how to <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-for=\"algorithms\" data-dfn-type=\"dfn\" data-export=\"\" data-lt=\"identify if a request is missing a session credential\" id=\"algorithms-identify-if-a-request-is-missing-a-session-credential\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">identify if a\n  request is missing a session credential</dfn>. Given a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request\" id=\"ref-for-concept-request②\">request</a> (<var>request</var>)\n  and a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list③\">list</a> of <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#session-credential\" id=\"ref-for-session-credential①\">session credentials</a> (<var>credentials</var>), returns a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#boolean\" id=\"ref-for-boolean①\">boolean</a> indicating whether any <var>credential</var> in <var>credentials</var> is missing on <var>request</var>.",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate③\">For each</a> <var>credential</var> in <var>credentials</var>:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If a cookie with <var>credential</var>’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#session-credential-attributes\" id=\"ref-for-session-credential-attributes\">attributes</a> would\n not be attached to <var>request</var> (see <a href=\"https://httpwg.org/specs/rfc6265.html#cookie\">section 5.4</a> of <a data-link-type=\"biblio\" href=\"https://w3c.github.io/webappsec-dbsc/#biblio-cookies\" title=\"HTTP State Management Mechanism\">[COOKIES]</a>), <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue⑥\">continue</a>.</p>"
            },
            {
              "html": "<p>If <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-header-list\" id=\"ref-for-concept-request-header-list\">header list</a> contains a <var>cookie</var> that\n satisfies all of the following conditions, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue⑦\">continue</a>:</p>",
              "ignored": [
                "cookie’s name matches credential’s name. All of the following attributes of cookie match those in credential’s attributes: Domain, Path, Secure, HttpOnly, SameSite."
              ]
            },
            {
              "html": "<p>Return true.</p>"
            }
          ]
        },
        {
          "html": "<p>Return false.</p>"
        }
      ]
    },
    {
      "name": "algorithms/process a challenge",
      "href": "https://w3c.github.io/webappsec-dbsc/#algorithms-process-a-challenge",
      "html": "This algorithm describes how to <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-for=\"algorithms\" data-dfn-type=\"dfn\" data-export=\"\" id=\"algorithms-process-a-challenge\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">process a challenge</dfn> received in an HTTP\n  header. \n    <p>Given a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response\" id=\"ref-for-concept-response\">response</a> (<var>response</var>), this algorithm updates the <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#device-bound-session-cached-challenge\" id=\"ref-for-device-bound-session-cached-challenge\">cached challenge</a> for a <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#device-bound-session\" id=\"ref-for-device-bound-session④\">device bound session</a>.</p>",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>header name</var> be \"<code>Secure-Session-Challenge</code>\".</p>"
        },
        {
          "html": "<p>Let <var>challenge list</var> be the result of executing <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-header-list-get-structured-header\" id=\"ref-for-concept-header-list-get-structured-header\">get a structured\nfield value</a> given <var>header name</var> and \"list\" from <var>response</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-header-list\" id=\"ref-for-concept-response-header-list\">header list</a>.</p>"
        },
        {
          "html": "<p>If <var>challenge list</var> is null, return.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate④\">For each</a> (<var>challenge</var>, <var>params</var>) of <var>challenge list</var>:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If the type of <var>challenge</var> is not an <a data-link-type=\"dfn\" href=\"https://datatracker.ietf.org/doc/html/rfc9651#string\" id=\"ref-for-string①⓪\">sf-string</a>, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue⑧\">continue</a>.</p>"
            },
            {
              "html": "<p>Let <var>session id</var> be null.</p>"
            },
            {
              "html": "<p>If <var>params</var>[\"id\"] exists and is an <a data-link-type=\"dfn\" href=\"https://datatracker.ietf.org/doc/html/rfc9651#string\" id=\"ref-for-string①①\">sf-string</a>, set <var>session id</var> to <var>params</var>[\"id\"].</p>"
            },
            {
              "html": "<p>If <var>session id</var> is null, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue⑨\">continue</a>.</p>"
            },
            {
              "html": "<p>Let <var>session</var> be the result of running <a href=\"https://w3c.github.io/webappsec-dbsc/#algo-identify-session\">§ 8.1 Identify session</a> given <var>response</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-url\" id=\"ref-for-concept-response-url\">URL</a> and <var>session id</var>.</p>"
            },
            {
              "html": "<p>If <var>session</var> is null, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue①⓪\">continue</a>.</p>"
            },
            {
              "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate⑤\">For each</a> <var>credential</var> in <var>session</var>’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#device-bound-session-session-credentials\" id=\"ref-for-device-bound-session-session-credentials①\">session credentials</a>:",
              "rationale": "if",
              "steps": [
                {
                  "html": "<p>If a cookie with <var>credential</var>’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#session-credential-attributes\" id=\"ref-for-session-credential-attributes②\">attributes</a> could\n  not be set by <var>response</var> (see <a href=\"https://httpwg.org/specs/rfc6265.html#storage-model\">section 5.3</a> of <a data-link-type=\"biblio\" href=\"https://w3c.github.io/webappsec-dbsc/#biblio-cookies\" title=\"HTTP State Management Mechanism\">[COOKIES]</a>), <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue①①\">continue</a>.</p>"
                },
                {
                  "html": "<p>Store <var>challenge</var> as <var>session</var>’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#device-bound-session-cached-challenge\" id=\"ref-for-device-bound-session-cached-challenge①\">cached challenge</a> to be used next\n time a <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#dbsc-proof\" id=\"ref-for-dbsc-proof\">DBSC proof</a> is to be sent from this <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#device-bound-session\" id=\"ref-for-device-bound-session⑤\">device bound session</a>.</p>"
                },
                {
                  "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-break\" id=\"ref-for-iteration-break\">Break</a>.</p>"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "algorithms/send a request",
      "href": "https://w3c.github.io/webappsec-dbsc/#algorithms-send-a-request",
      "html": "This algorithm describes how to <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-for=\"algorithms\" data-dfn-type=\"dfn\" data-export=\"\" data-lt=\"send a request\" id=\"algorithms-send-a-request\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">send\n  a request</dfn> for a device bound session registration or refresh. It\n  takes as input a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request\" id=\"ref-for-concept-request③\">request</a> (<var>originating request</var>), <var>key pair</var>, <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url\" id=\"ref-for-concept-url④\">URL</a> (<var>destination</var>),\n  and optional <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#string\" id=\"ref-for-string①②\">strings</a> <var>session id</var>, <var>challenge</var>, and <var>authorization</var>. \n    <p>User agents will perform these steps whenever a bound credential is missing,\n  but MAY do this at any time. Sending a request proactively before the bound\n  credential expires can minimize the latency costs of DBSC.</p>",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>The user agent MAY skip this request in order to prevent denial of service for\n the user or site. For example, this might happen if this session is\n requesting excessive TPM operations (harming the user) or the refresh\n endpoint has recently been unreachable (denial of service risk for the\n site). If the user agent chooses to do this, it should perform the steps of <a href=\"https://w3c.github.io/webappsec-dbsc/#algo-add-debug-header\">§ 8.12 Add debug header</a> with <var>originating request</var>, an appropriate token (see\n options in <a href=\"https://w3c.github.io/webappsec-dbsc/#header-secure-session-skipped\">§ 9.5 `Secure-Session-Skipped` HTTP header field</a>), and <var>session id</var> to indicate this to the site.</p>"
        },
        {
          "html": "Let <var>terminate the session</var> be an algorithm with the following steps:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>session id</var> is null, return.</p>"
            },
            {
              "html": "<p>Remove the session with domain <var>destination</var>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-host\" id=\"ref-for-concept-url-host④\">host</a>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#host-registrable-domain\" id=\"ref-for-host-registrable-domain⑧\">registrable domain</a> and identifier <var>session id</var> from the\n user agent’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#session-store\" id=\"ref-for-session-store④\">session store</a>, if such a session if found.</p>"
            }
          ]
        },
        {
          "html": "<p>If <var>originating request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-url\" id=\"ref-for-concept-request-url②\">URL</a>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin\" id=\"ref-for-concept-origin③\">origin</a> is not <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#same-site\" id=\"ref-for-same-site②\">same site</a> with <var>destination</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin\" id=\"ref-for-concept-origin④\">origin</a>, return.</p>"
        },
        {
          "html": "<p>Let <var>signed challenge</var> be null. If <var>challenge</var> is non-null, create\n a <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#dbsc-proof\" id=\"ref-for-dbsc-proof①\">DBSC proof</a>, sign it with <var>key pair</var>, and store the result\n in <var>signed challenge</var>.</p>"
        },
        {
          "html": "<p>Create a <var>request</var> for use in <a href=\"https://fetch.spec.whatwg.org/#http-fetch\">HTTP fetch</a>.</p>"
        },
        {
          "html": "<p>Set <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-method\" id=\"ref-for-concept-request-method\">method</a> to \"POST\".</p>"
        },
        {
          "html": "<p>Set <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-url\" id=\"ref-for-concept-request-url③\">URL</a> to <var>destination</var>.</p>"
        },
        {
          "html": "<p>Set <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-redirect-mode\" id=\"ref-for-concept-request-redirect-mode\">redirect mode</a> to \"follow\".</p>"
        },
        {
          "html": "<p>If <var>signed challenge</var> is non-null, <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-header-list-append\" id=\"ref-for-concept-header-list-append\">append</a> the header\n (\"Secure-Session-Response\", <var>signed challenge</var>) to <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-header-list\" id=\"ref-for-concept-request-header-list①\">header list</a>.</p>"
        },
        {
          "html": "<p>If <var>authorization</var> is non-null, <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-header-list-append\" id=\"ref-for-concept-header-list-append①\">append</a> the header\n (\"Authorization\", <var>authorization</var>) to <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-header-list\" id=\"ref-for-concept-request-header-list②\">header list</a>.</p>"
        },
        {
          "html": "<p>Set <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-initiator\" id=\"ref-for-concept-request-initiator\">initiator</a> to <var>originating request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-initiator\" id=\"ref-for-concept-request-initiator①\">initiator</a>.</p>"
        },
        {
          "html": "<p>Set <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-origin\" id=\"ref-for-concept-request-origin③\">origin</a> to <var>originating request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-origin\" id=\"ref-for-concept-request-origin④\">origin</a>.</p>"
        },
        {
          "html": "<p>Let <var>response</var> be the result of running <a href=\"https://fetch.spec.whatwg.org/#http-fetch\">HTTP fetch</a> for <var>request</var>.</p>"
        },
        {
          "html": "<p>If <var>response</var> is a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-network-error\" id=\"ref-for-concept-network-error\">network error</a>, or <var>response</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-status\" id=\"ref-for-concept-response-status\">status</a> is 407 or 429, return.</p>"
        },
        {
          "html": "<p>If <var>response</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-status\" id=\"ref-for-concept-response-status①\">status</a> is at least 300 and below 400, then\n return.</p>"
        },
        {
          "html": "If <var>response</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-status\" id=\"ref-for-concept-response-status②\">status</a> is 403:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>session id</var> is null, return.</p>"
            },
            {
              "html": "<p>Let <var>session</var> be the result of running the steps of <a href=\"https://w3c.github.io/webappsec-dbsc/#algo-identify-session\">§ 8.1 Identify session</a> on <var>destination</var> and <var>session id</var>.</p>"
            },
            {
              "html": "<p>If <var>session</var> is null, return.</p>"
            },
            {
              "html": "<p>Otherwise, restart this algorithm with the original inputs, except\n replacing <var>challenge</var> with <var>session</var>’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#device-bound-session-cached-challenge\" id=\"ref-for-device-bound-session-cached-challenge②\">cached challenge</a>.</p>"
            }
          ]
        },
        {
          "html": "<p>If <var>response</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-status\" id=\"ref-for-concept-response-status③\">status</a> is at least 400 and below 500,\n then <var>terminate the session</var> and return.</p>"
        },
        {
          "html": "<p>If <var>response</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-status\" id=\"ref-for-concept-response-status④\">status</a> is at least 500, then\n return. User agents may choose to trigger a backoff mechanism on\n subsequent refresh requests on this session, to limit the harm of a\n temporary outage on the refresh endpoint.</p>"
        },
        {
          "html": "<p>If <var>session id</var> is non-null, and <var>response</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-body\" id=\"ref-for-concept-response-body\">body</a> is\n empty, return.</p>"
        },
        {
          "html": "<p>Call <a href=\"https://w3c.github.io/webappsec-dbsc/#algo-create-session\">§ 8.9 Create session</a> on <var>response</var>, <var>destination</var>, <var>session id</var>, and <var>key pair</var>.</p>"
        }
      ]
    },
    {
      "name": "create a session",
      "href": "https://w3c.github.io/webappsec-dbsc/#create-session",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-export=\"\" id=\"create-session\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">create a session</dfn> due to the <var>response</var> (a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response\" id=\"ref-for-concept-response①\">response</a>) to a registration request to <var>destination</var> (a <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url\" id=\"ref-for-concept-url⑤\">URL</a>) for <var>session id</var> (a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#string\" id=\"ref-for-string①③\">string</a>) with a <var>key pair</var>, perform the following steps:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "Let <var>terminate the session</var> be an algorithm with the following steps:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>session id</var> is null, return.</p>"
            },
            {
              "html": "<p>Remove the session with domain <var>destination</var>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-host\" id=\"ref-for-concept-url-host⑤\">host</a>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#host-registrable-domain\" id=\"ref-for-host-registrable-domain⑨\">registrable domain</a> and identifier <var>session id</var> from the\n user agent’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#session-store\" id=\"ref-for-session-store⑤\">session store</a>, if such a session if found.</p>"
            }
          ]
        },
        {
          "html": "<p>Parse <var>response</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-body\" id=\"ref-for-concept-response-body①\">body</a> according to <a href=\"https://w3c.github.io/webappsec-dbsc/#format-session-instructions\">§ 9.6 JSON Session Instruction Format</a>. If parsing fails, <var>terminate the\n session</var> and return.</p>"
        },
        {
          "html": "<p>If the <var>response</var> JSON contains the key \"continue\" and its value is false, <var>terminate the session</var> and return.</p>"
        },
        {
          "html": "<p>Let <var>session identifier</var> be the value of key \"session_identifier\".</p>"
        },
        {
          "html": "Perform the following validations. If any fail, <var>terminate the session</var> and return.",
          "rationale": "if",
          "steps": [
            {
              "html": "<p><var>session identifier</var> must be non-empty.</p>"
            },
            {
              "html": "<p>If <var>session id</var> is non-null, it must match <var>session identifier</var>.</p>"
            },
            {
              "html": "<p>The value of the key \"refresh_url\" must be non-empty.</p>"
            },
            {
              "html": "<p>Let <var>origin</var> be an <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin\" id=\"ref-for-concept-origin⑤\">origin</a> constructed from the value of the key\n \"scope.origin\", if present, or the origin of <var>destination</var> if\n not.</p>"
            },
            {
              "html": "<p><var>origin</var> must be a valid non-opaque origin.</p>"
            },
            {
              "html": "<p><var>origin</var> must be <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#same-site\" id=\"ref-for-same-site③\">same site</a> with <var>destination</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin\" id=\"ref-for-concept-origin⑥\">origin</a>.</p>"
            },
            {
              "html": "<p>Let <var>refresh URL</var> be the result of resolving <var>destination</var> with the value\n of the key \"refresh_url\".</p>"
            },
            {
              "html": "<p><var>refresh URL</var> must have scheme HTTPS or be localhost.</p>"
            },
            {
              "html": "<p><var>refresh URL</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin\" id=\"ref-for-concept-origin⑦\">origin</a> must be <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#same-site\" id=\"ref-for-same-site④\">same site</a> with <var>destination</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin\" id=\"ref-for-concept-origin⑧\">origin</a>.</p>"
            },
            {
              "html": "<p>All of the <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#json-session-credentials\" id=\"ref-for-json-session-credentials①\">JSON session credentials</a> must not have the attribute \"Partitioned\".</p>"
            }
          ]
        },
        {
          "html": "<p>Let <var>destination domain</var> be the <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#host-registrable-domain\" id=\"ref-for-host-registrable-domain①⓪\">registrable domain</a> of <var>destination</var>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-host\" id=\"ref-for-concept-url-host⑥\">host</a>.</p>"
        },
        {
          "html": "If the value of the key \"scope.include_site\" in <var>response</var> is true,\n perform the following validations. If any fail, <var>terminate the\n session</var> and return.",
          "rationale": "if",
          "steps": [
            {
              "html": "<p><var>origin</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-domain\" id=\"ref-for-concept-origin-domain\">domain</a> must be equal to <var>destination domain</var>.</p>"
            },
            {
              "html": "<p>If <var>destination domain</var> is equal to the <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-host\" id=\"ref-for-concept-url-host⑦\">host</a> of <var>destination</var>, skip all remaining validations within this step.</p>"
            },
            {
              "html": "<p>Otherwise, let <var>well known URL</var> be a copy of <var>destination</var>, with the <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-host\" id=\"ref-for-concept-url-host⑧\">host</a> replaced with <var>destination domain</var>, and the <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-path\" id=\"ref-for-concept-url-path③\">path</a> replaced with \"/.well-known/device-bound-sessions\".</p>"
            },
            {
              "html": "<p>Let <var>well known response</var> be the result of fetching <var>well known URL</var>.</p>"
            },
            {
              "html": "<p><var>well known response</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-status\" id=\"ref-for-concept-response-status⑤\">status</a> must be 200.</p>"
            },
            {
              "html": "<p><var>well known response</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-body\" id=\"ref-for-concept-response-body②\">body</a> must be a JSON-encoded\n dictionary.</p>"
            },
            {
              "html": "<p><var>well known response</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-body\" id=\"ref-for-concept-response-body③\">body</a> must include the key \"registering_origins\".</p>"
            },
            {
              "html": "<p>The value of the key \"registering_origins\" must include the origin of <var>destination</var>.</p>"
            }
          ]
        },
        {
          "html": "<p>Let <var>session</var> be a new session with:</p>",
          "ignored": [
            "session identifier set to session identifier. refresh URL set to refresh URL. session scope a new scope with origin origin, include site the value of the key \"scope.include_site\", and scope specifications the value of the key \"scope.scope_specification\". session credentials the value of the key \"credentials\". session key pair set to key pair. allowed refresh initiators the value of the key \"allowed_refresh_initiators\". expiration timestamp set to a future timestamp. The exact choice of expiration timestamp is left up to the user agent. It is recommended to align with the maximum cookie lifetime."
          ]
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate⑥\">For each</a> <var>credential</var> in <var>session</var>’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#device-bound-session-session-credentials\" id=\"ref-for-device-bound-session-session-credentials③\">session credentials</a>:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If a cookie with <var>credential</var>’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#session-credential-attributes\" id=\"ref-for-session-credential-attributes③\">attributes</a> could\n not be set by <var>response</var> (see <a href=\"https://httpwg.org/specs/rfc6265.html#cookie\">section 5.3</a> of <a data-link-type=\"biblio\" href=\"https://w3c.github.io/webappsec-dbsc/#biblio-cookies\" title=\"HTTP State Management Mechanism\">[COOKIES]</a>), <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue①②\">continue</a>.</p>"
            },
            {
              "html": "<p>Call <var>terminate the session</var> to remove the existing session.</p>"
            },
            {
              "html": "<p>Set the user agent’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#session-store\" id=\"ref-for-session-store⑥\">session store</a>[<var>destination\n domain</var>][<var>session identifier</var>] to <var>session</var>.</p>"
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-break\" id=\"ref-for-iteration-break①\">Break</a>.</p>"
            }
          ]
        }
      ]
    },
    {
      "name": "process a session registration",
      "href": "https://w3c.github.io/webappsec-dbsc/#process-session-registration",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-export=\"\" data-lt=\"process a session registration\" id=\"process-session-registration\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">process a session\nregistration</dfn> due to the <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response\" id=\"ref-for-concept-response②\">response</a> (<var>response</var>) to a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request\" id=\"ref-for-concept-request④\">request</a> (<var>request</var>), do the following steps:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>header name</var> be \"<code>Secure-Session-Registration</code>\".</p>"
        },
        {
          "html": "<p>Let <var>registration list</var> be the result of executing <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-header-list-get-structured-header\" id=\"ref-for-concept-header-list-get-structured-header①\">get a structured\nfield value</a> given <var>header name</var> and \"list\" from <var>response</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response-header-list\" id=\"ref-for-concept-response-header-list①\">header list</a>.</p>"
        },
        {
          "html": "<p>If <var>registration list</var> is null, return.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate⑦\">For each</a> <var>registration entry</var>, <var>params</var> → <var>registration list</var>:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>registration entry</var> is not an <a data-link-type=\"dfn\" href=\"https://datatracker.ietf.org/doc/html/rfc9651#inner-list\" id=\"ref-for-inner-list\">sf-inner-list</a>, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue①③\">continue</a>.</p>"
            },
            {
              "html": "<p>If <var>params</var>[\"path\"] does not exist, or is not of type <a data-link-type=\"dfn\" href=\"https://datatracker.ietf.org/doc/html/rfc9651#string\" id=\"ref-for-string①④\">sf-string</a>, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue①④\">continue</a>.</p>"
            },
            {
              "html": "<p>Let <var>path</var> be <var>params</var>[\"path\"].</p>"
            },
            {
              "html": "<p>Let <var>challenge</var> be null, and let <var>authorization</var> be null.</p>"
            },
            {
              "html": "<p>If <var>params</var>[\"challenge\"] exists and is of type <a data-link-type=\"dfn\" href=\"https://datatracker.ietf.org/doc/html/rfc9651#string\" id=\"ref-for-string①⑤\">sf-string</a>,\nset <var>challenge</var> to <var>params</var>[\"challenge\"].</p>"
            },
            {
              "html": "<p>If <var>params</var>[\"authorization\"] exists and is a string, set <var>authorization</var> to <var>params</var>[\"authorization\"].</p>"
            },
            {
              "html": "<p>Let <var>endpoint</var> be the result of resolving <var>path</var> relative to <var>response</var>’s URL.</p>"
            },
            {
              "html": "<p>Let <var>key pair</var> be the result of running <a href=\"https://w3c.github.io/webappsec-dbsc/#algo-create-session-key-pair\">§ 8.11 Create session key pair</a> on <var>registration entry</var>, <var>params</var>, and <var>endpoint</var>.</p>"
            },
            {
              "html": "<p>If <var>key pair</var> is null, return.</p>"
            },
            {
              "html": "<p>Call <a href=\"https://w3c.github.io/webappsec-dbsc/#algo-session-request\">§ 8.8 Send request</a> with <var>request</var>, <var>key pair</var>, <var>endpoint</var>,\n session identifier as null, <var>challenge</var>, and <var>authorization</var>.</p>"
            }
          ]
        }
      ]
    },
    {
      "name": "create a session key pair",
      "href": "https://w3c.github.io/webappsec-dbsc/#create-session-key-pair",
      "html": "This algorithm describes how to <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-export=\"\" data-lt=\"create a session key pair\" id=\"create-session-key-pair\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">create\na session key pair</dfn>, including key sharing between a Relying Party and\nSession Provider. It takes as inputs the <var>registration entry</var> and <var>params</var> of a\n`<code><a data-link-type=\"http-header\" href=\"https://w3c.github.io/webappsec-dbsc/#secure-session-registration-header\" id=\"ref-for-secure-session-registration-header④\">Secure-Session-Registration</a></code>` header and the <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url\" id=\"ref-for-concept-url⑥\">URL</a> (<var>registration URL</var>) of\nthe registration endpoint. It returns a key pair for use in the session or null\nif no key is possible.",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>algorithm list</var> be an empty <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list④\">list</a>.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate⑧\">For each</a> <var>algorithm</var> → <var>registration entry</var>:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>algorithm</var> is not an <a data-link-type=\"dfn\" href=\"https://datatracker.ietf.org/doc/html/rfc9651#token\" id=\"ref-for-token\">sf-token</a>, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue①⑤\">continue</a>.</p>"
            },
            {
              "html": "<p>If <var>algorithm</var> represents a crypto algorithm supported in\n `<code><a data-link-type=\"http-header\" href=\"https://w3c.github.io/webappsec-dbsc/#secure-session-registration-header\" id=\"ref-for-secure-session-registration-header⑤\">Secure-Session-Registration</a></code>` and is supported on this client,\n add <var>algorithm</var> to <var>algorithm list</var>.</p>"
            }
          ]
        },
        {
          "html": "<p>If <var>algorithm list</var> is empty, return null.</p>"
        },
        {
          "html": "If any of <var>params</var>[\"provider_key\"], <var>params</var>[\"provider_id\"], or <var>params</var>[\"provider_url\"] exists:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If any of the three keys is missing, return null.</p>"
            },
            {
              "html": "<p>Let <var>permission</var> be the result of performing <a data-link-type=\"dfn\" href=\"https://w3c.github.io/permissions/#dfn-request-permission-to-use\" id=\"ref-for-dfn-request-permission-to-use\">request permission to use</a> for \"device-bound-session-key-sharing\".</p>"
            },
            {
              "html": "<p>If <var>permission</var> is <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://w3c.github.io/permissions/#dom-permissionstate-denied\" id=\"ref-for-dom-permissionstate-denied\">\"denied\"</a></code>, return null.</p>"
            },
            {
              "html": "<p>Let <var>provider URL</var> be a <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url\" id=\"ref-for-concept-url⑦\">URL</a> constructed from <var>params</var>[\"provider_url\"].</p>"
            },
            {
              "html": "<p>Let <var>provider origin</var> be the <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-origin\" id=\"ref-for-concept-url-origin\">origin</a> of <var>provider URL</var>.</p>"
            },
            {
              "html": "<p>If <var>provider origin</var> is opaque, return null.</p>"
            },
            {
              "html": "<p>Let <var>provider domain</var> be the <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#host-registrable-domain\" id=\"ref-for-host-registrable-domain①①\">registrable domain</a> of <var>provider URL</var>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-host\" id=\"ref-for-concept-url-host⑨\">host</a>.</p>"
            },
            {
              "html": "<p>Let <var>provider identifier</var> be <var>params</var>[\"provider_id\"].</p>"
            },
            {
              "html": "<p>Let <var>provider session</var> be the session in the user agent’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#session-store\" id=\"ref-for-session-store⑦\">session store</a>[<var>provider domain</var>][<var>provider identifier</var>].</p>"
            },
            {
              "html": "<p>If <var>provider session</var> is null, return null.</p>"
            },
            {
              "html": "<p>If <var>provider session</var>’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#device-bound-session-session-scope\" id=\"ref-for-device-bound-session-session-scope⑥\">session scope</a> <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#session-scope-origin\" id=\"ref-for-session-scope-origin⑤\">origin</a> is not <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#same-origin\" id=\"ref-for-same-origin②\">same origin</a> with <var>provider\n origin</var>, return null.</p>"
            },
            {
              "html": "<p>If <var>provider session</var>’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#device-bound-session-session-key-pair\" id=\"ref-for-device-bound-session-session-key-pair①\">session key pair</a> does not match <var>params</var>[\"provider_key\"], return null.</p>"
            },
            {
              "html": "<p>Let <var>provider well known URL</var> be a copy of <var>provider URL</var>, with the <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-path\" id=\"ref-for-concept-url-path④\">path</a> replaced with \"/.well-known/device-bound-sessions\".</p>"
            },
            {
              "html": "<p>Let <var>provider well known response</var> be the result of fetching <var>provider\n well known URL</var>. If any of the following hold, return null:</p>",
              "ignored": [
                "provider well known response’s status is not 200. provider well known response’s body is not a JSON-encoded dictionary. provider well known response’s body contains the key \"provider_origin\". provider well known response’s body does not include the key \"relying_origins\". The value of the key \"relying_origins\" does not include the origin of registration URL."
              ]
            },
            {
              "html": "<p>User agents SHOULD place an upper limit on the number of <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#registrable-origin-label\" id=\"ref-for-registrable-origin-label①\">registrable origin labels</a> in \"relying_origins\" to prevent\n abuse.</p>"
            },
            {
              "html": "<p>Let <var>relying well known URL</var> be a copy of <var>registration URL</var>, with the <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-path\" id=\"ref-for-concept-url-path⑤\">path</a> replaced with \"/.well-known/device-bound-sessions\".</p>"
            },
            {
              "html": "<p>Let <var>relying well known response</var> be the result of fetching <var>relying well\n known URL</var>. If any of the following hold, return null:</p>",
              "ignored": [
                "relying well known response’s status is not 200. relying well known response’s body is not a JSON-encoded dictionary. relying well known response’s body contains the key \"relying_origins\". relying well known response’s body does not include the key \"provider_origin\". The value of the key \"provider_origin\" is not the origin of provider URL."
              ]
            },
            {
              "html": "<p>Return <var>provider session</var>’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#device-bound-session-session-key-pair\" id=\"ref-for-device-bound-session-session-key-pair②\">session key pair</a>.</p>"
            }
          ]
        },
        {
          "html": "<p>Return a new key pair created for <var>algorithm list</var>.</p>"
        }
      ]
    },
    {
      "name": "add the debug header",
      "href": "https://w3c.github.io/webappsec-dbsc/#add-debug-header",
      "html": "In order for sites to understand when the user agent chooses not to\napply a session, user agents should <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-export=\"\" id=\"add-debug-header\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">add the debug header</dfn> to a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request\" id=\"ref-for-concept-request⑤\">request</a> (<var>request</var>) with an <a data-link-type=\"dfn\" href=\"https://datatracker.ietf.org/doc/html/rfc9651#token\" id=\"ref-for-token①\">sf-token</a> (<var>token</var>) and <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#string\" id=\"ref-for-string①⑥\">string</a> (<var>session id</var>).",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>value</var> be an <a data-link-type=\"dfn\" href=\"https://datatracker.ietf.org/doc/html/rfc9651#token\" id=\"ref-for-token②\">sf-token</a> with value <var>token</var>.</p>"
        },
        {
          "html": "<p>Set the <a data-link-type=\"dfn\" href=\"https://datatracker.ietf.org/doc/html/rfc9651#name-parameters\" id=\"ref-for-name-parameters\">sf-parameter</a> \"session_identifier\" on <var>value</var> to <var>session id</var>.</p>"
        },
        {
          "html": "<p>Let <var>skipped header value</var> be the result of running the steps of <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-header-list-get-structured-header\" id=\"ref-for-concept-header-list-get-structured-header②\">get a structured field value</a> with <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#header-name\" id=\"ref-for-header-name\">header name</a> \"Secure-Session-Skipped\", type \"list\", and <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-header-list\" id=\"ref-for-concept-request-header-list③\">header list</a>.</p>"
        },
        {
          "html": "<p>If <var>skipped header value</var> is null, set it to an empty <a data-link-type=\"dfn\" href=\"https://datatracker.ietf.org/doc/html/rfc9651#list\" id=\"ref-for-list⑤\">sf-list</a>.</p>"
        },
        {
          "html": "<p>Append <var>value</var> to <var>skipped header value</var>.</p>"
        },
        {
          "html": "<p>Run the steps of <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-header-list-set-structured-header\" id=\"ref-for-concept-header-list-set-structured-header\">set a structured field value</a> given\n(\"Secure-Session-Skipped\", <var>skipped header value</var>) on <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-header-list\" id=\"ref-for-concept-request-header-list④\">header list</a>.</p>"
        }
      ]
    },
    {
      "html": "After computing cookies in step 8.21, run <a href=\"https://w3c.github.io/webappsec-dbsc/#algo-identify-session-needing-refresh\">§ 8.5 Identify session needing refresh</a>. If the resulting <var>session</var> is non-null:",
      "rationale": "run",
      "steps": [
        {
          "html": "<p>Run <a href=\"https://w3c.github.io/webappsec-dbsc/#algo-session-request\">§ 8.8 Send request</a> with the returned <var>session</var>’s <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#device-bound-session-session-key-pair\" id=\"ref-for-device-bound-session-session-key-pair③\">session key pair</a>, <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#device-bound-session-refresh-url\" id=\"ref-for-device-bound-session-refresh-url②\">refresh URL</a>, <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#device-bound-session-session-identifier\" id=\"ref-for-device-bound-session-session-identifier⑨\">session identifier</a>, <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-dbsc/#device-bound-session-cached-challenge\" id=\"ref-for-device-bound-session-cached-challenge③\">cached challenge</a>, and an empty authorization.</p>"
        },
        {
          "html": "<p>Restart <a href=\"https://fetch.spec.whatwg.org/#http-network-or-cache-fetch\">HTTP-network-or-cache\nfetch</a> with the original inputs.</p>"
        }
      ]
    },
    {
      "html": "This specification also requires two new calls to process the new\nheaders. After step 14 in the current <a href=\"https://fetch.spec.whatwg.org/#http-network-fetch\">HTTP-network \nfetch</a>, execute the following step:",
      "rationale": "run",
      "steps": [
        {
          "html": "<p>Run <a href=\"https://w3c.github.io/webappsec-dbsc/#algo-process-session-registration\">§ 8.10 Process session registration</a> and <a href=\"https://w3c.github.io/webappsec-dbsc/#algo-process-challenge\">§ 8.7 Cache challenge</a>.</p>"
        }
      ]
    }
  ]
}