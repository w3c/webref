{
  "spec": {
    "title": "Private Aggregation API",
    "url": "https://patcg-individual-drafts.github.io/private-aggregation-api/"
  },
  "algorithms": [
    {
      "name": "PrivateAggregation/contributeToHistogram(PAHistogramContribution contribution)",
      "href": "https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-privateaggregation-contributetohistogram",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"PrivateAggregation\" data-dfn-type=\"method\" data-export=\"\" data-lt=\"contributeToHistogram(contribution)\" id=\"dom-privateaggregation-contributetohistogram\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code> contributeToHistogram(PAHistogramContribution contribution)</code></dfn> method steps\nare:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If <var>contribution</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-pahistogramcontribution-bucket\" id=\"ref-for-dom-pahistogramcontribution-bucket\">bucket</a></code>\"] is not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-contain\" id=\"ref-for-list-contain\"> contained</a> in <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#the-exclusive-range\" id=\"ref-for-the-exclusive-range\">the range</a> 0 to 2<sup>128</sup>,\nexclusive, <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-throw\" id=\"ref-for-dfn-throw\">throw</a> a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-rangeerror\" id=\"ref-for-exceptiondef-rangeerror\">RangeError</a></code>.</p>"
        },
        {
          "html": "<p>If <var>contribution</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-pahistogramcontribution-value\" id=\"ref-for-dom-pahistogramcontribution-value\">value</a></code>\"] is negative, <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-throw\" id=\"ref-for-dfn-throw①\">throw</a> a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-rangeerror\" id=\"ref-for-exceptiondef-rangeerror①\">RangeError</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>scopingDetails</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this\">this</a>'s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#privateaggregation-scoping-details\" id=\"ref-for-privateaggregation-scoping-details\">scoping details</a>.</p>"
        },
        {
          "html": "<p>Let <var>batchingScope</var> be the result of running <var>scopingDetails</var>’ <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#scoping-details-get-batching-scope-steps\" id=\"ref-for-scoping-details-get-batching-scope-steps\">get batching scope steps</a>.</p>"
        },
        {
          "html": "<p>Let <var>filteringIdMaxBytes</var> be the <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#default-filtering-id-max-bytes\" id=\"ref-for-default-filtering-id-max-bytes\">default filtering ID max bytes</a>.</p>"
        },
        {
          "html": "If <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#pre-specified-report-parameters-map\" id=\"ref-for-pre-specified-report-parameters-map\">pre-specified report parameters map</a>[<var>batchingScope</var>] <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists\">exists</a>:",
          "rationale": "set",
          "steps": [
            {
              "html": "<p>Set <var>filteringIdMaxBytes</var> to <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#pre-specified-report-parameters-map\" id=\"ref-for-pre-specified-report-parameters-map①\">pre-specified report parameters\nmap</a>[<var>batchingScope</var>]'s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#pre-specified-report-parameters-filtering-id-max-bytes\" id=\"ref-for-pre-specified-report-parameters-filtering-id-max-bytes\">filtering ID\nmax bytes</a>.</p>"
            }
          ]
        },
        {
          "html": "<p>If <var>contribution</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-pahistogramcontribution-filteringid\" id=\"ref-for-dom-pahistogramcontribution-filteringid\">filteringId</a></code>\"] is not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-contain\" id=\"ref-for-list-contain①\"> contained</a> in <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#the-exclusive-range\" id=\"ref-for-the-exclusive-range①\">the range</a> 0 to\n256<sup><var>filteringIdMaxBytes</var></sup>, exclusive, <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-throw\" id=\"ref-for-dfn-throw②\">throw</a> a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-rangeerror\" id=\"ref-for-exceptiondef-rangeerror②\">RangeError</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>entry</var> be a new <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#contribution-cache-entry\" id=\"ref-for-contribution-cache-entry\">contribution cache entry</a> with the items:</p>\n      <dl>\n       <dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#contribution-cache-entry-contribution\" id=\"ref-for-contribution-cache-entry-contribution\">contribution</a>\n       </dt><dd data-md=\"\">\n        <p><var>contribution</var></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#contribution-cache-entry-batching-scope\" id=\"ref-for-contribution-cache-entry-batching-scope\">batching scope</a>\n       </dt><dd data-md=\"\">\n        <p><var>batchingScope</var></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#contribution-cache-entry-debug-scope\" id=\"ref-for-contribution-cache-entry-debug-scope\">debug scope</a>\n       </dt><dd data-md=\"\">\n        <p>The result of running <var>scopingDetails</var>’ <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#scoping-details-get-debug-scope-steps\" id=\"ref-for-scoping-details-get-debug-scope-steps\">get debug scope\nsteps</a>.</p>\n      </dd></dl>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#append-an-entry-to-the-contribution-cache\" id=\"ref-for-append-an-entry-to-the-contribution-cache\">Append</a> <var>entry</var> to the <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#contribution-cache\" id=\"ref-for-contribution-cache\">contribution cache</a>.</p>"
        }
      ]
    },
    {
      "name": "PrivateAggregation/enableDebugMode(optional PADebugModeOptions options)",
      "href": "https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-privateaggregation-enabledebugmode",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"PrivateAggregation\" data-dfn-type=\"method\" data-export=\"\" data-lt=\"enableDebugMode(options)|enableDebugMode()\" id=\"dom-privateaggregation-enabledebugmode\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code> enableDebugMode(optional PADebugModeOptions options)</code></dfn> method steps are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>scopingDetails</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this①\">this</a>'s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#privateaggregation-scoping-details\" id=\"ref-for-privateaggregation-scoping-details①\">scoping details</a>.</p>"
        },
        {
          "html": "<p>Let <var>debugScope</var> be the result of running <var>scopingDetails</var>’ <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#scoping-details-get-debug-scope-steps\" id=\"ref-for-scoping-details-get-debug-scope-steps①\">get debug scope steps</a>.</p>"
        },
        {
          "html": "<p>If <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#debug-scope-map\" id=\"ref-for-debug-scope-map\">debug scope map</a>[<var>debugScope</var>] <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists①\">exists</a>, <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-throw\" id=\"ref-for-dfn-throw③\">throw</a> a\n\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#dataerror\" id=\"ref-for-dataerror\">DataError</a></code>\" <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException\">DOMException</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>debugKey</var> be null.</p>"
        },
        {
          "html": "If <var>options</var> was given:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>options</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-padebugmodeoptions-debugkey\" id=\"ref-for-dom-padebugmodeoptions-debugkey①\">debugKey</a></code>\"] is not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-contain\" id=\"ref-for-list-contain②\">contained</a> in <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#the-exclusive-range\" id=\"ref-for-the-exclusive-range②\">the range</a> 0 to 2<sup>64</sup>, exclusive, <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-throw\" id=\"ref-for-dfn-throw④\">throw</a> a \"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#dataerror\" id=\"ref-for-dataerror①\">DataError</a></code>\" <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException①\">DOMException</a></code>.</p>"
            },
            {
              "html": "<p>Set <var>debugKey</var> to <var>options</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-padebugmodeoptions-debugkey\" id=\"ref-for-dom-padebugmodeoptions-debugkey②\">debugKey</a></code>\"].</p>"
            }
          ]
        },
        {
          "html": "<p>Let <var>debugDetails</var> be a new <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#debug-details\" id=\"ref-for-debug-details\">debug details</a> with the items:</p>\n      <dl>\n       <dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#debug-details-enabled\" id=\"ref-for-debug-details-enabled\">enabled</a>\n       </dt><dd data-md=\"\">\n        <p>true</p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#debug-details-key\" id=\"ref-for-debug-details-key\">key</a>\n       </dt><dd data-md=\"\">\n        <p><var>debugKey</var></p>\n      </dd></dl>"
        },
        {
          "html": "<p>Optionally, set <var>debugDetails</var> to a new <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#debug-details\" id=\"ref-for-debug-details①\">debug details</a>.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-set\" id=\"ref-for-map-set\">Set</a> <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#debug-scope-map\" id=\"ref-for-debug-scope-map①\">debug scope map</a>[<var>debugScope</var>] to <var>debugDetails</var>.</p>"
        }
      ]
    },
    {
      "name": "get the privateAggregation",
      "href": "https://patcg-individual-drafts.github.io/private-aggregation-api/#get-the-privateaggregation",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-export=\"\" id=\"get-the-privateaggregation\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">get the privateAggregation</dfn> given a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#privateaggregation\" id=\"ref-for-privateaggregation⑤\">PrivateAggregation</a></code> <var>this</var>:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>scopingDetails</var> be <var>this</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#privateaggregation-scoping-details\" id=\"ref-for-privateaggregation-scoping-details④\">scoping details</a>.</p>"
        },
        {
          "html": "<p>If <var>scopingDetails</var> is null, <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-throw\" id=\"ref-for-dfn-throw⑤\">throw</a> a \"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#notallowederror\" id=\"ref-for-notallowederror\">NotAllowedError</a></code>\" <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException②\">DOMException</a></code>.</p>"
        },
        {
          "html": "<p>If <var>this</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#privateaggregation-allowed-to-use\" id=\"ref-for-privateaggregation-allowed-to-use②\">allowed to use</a> is false, <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-throw\" id=\"ref-for-dfn-throw⑥\"> throw</a> an \"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#invalidaccesserror\" id=\"ref-for-invalidaccesserror②\">InvalidAccessError</a></code>\" <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException③\">DOMException</a></code>.</p>"
        },
        {
          "html": "<p>Return <var>this</var>.</p>"
        }
      ]
    },
    {
      "name": "append an entry to the contribution cache",
      "href": "https://patcg-individual-drafts.github.io/private-aggregation-api/#append-an-entry-to-the-contribution-cache",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-export=\"\" id=\"append-an-entry-to-the-contribution-cache\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">append an entry to the contribution cache</dfn> given a <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#contribution-cache-entry\" id=\"ref-for-contribution-cache-entry③\">contribution cache entry</a> <var>entry</var>:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-append\" id=\"ref-for-list-append\">Append</a> <var>entry</var> to the <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#contribution-cache\" id=\"ref-for-contribution-cache③\">contribution cache</a>.</p>"
        }
      ]
    },
    {
      "name": "get a debug details",
      "href": "https://patcg-individual-drafts.github.io/private-aggregation-api/#get-a-debug-details",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-export=\"\" id=\"get-a-debug-details\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">get a debug details</dfn> given a <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#debug-scope\" id=\"ref-for-debug-scope⑥\">debug scope</a> <var>debugScope</var>, perform the following steps. They return a <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#debug-details\" id=\"ref-for-debug-details⑥\">debug details</a>.",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#debug-scope-map\" id=\"ref-for-debug-scope-map③\">debug scope map</a>[<var>debugScope</var>] <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists②\">exists</a>, return <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#debug-scope-map\" id=\"ref-for-debug-scope-map④\">debug scope map</a>[<var>debugScope</var>].</p>"
        },
        {
          "html": "<p>Otherwise, return a new <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#debug-details\" id=\"ref-for-debug-details⑦\">debug details</a>.</p>"
        }
      ]
    },
    {
      "name": "mark a debug scope complete",
      "href": "https://patcg-individual-drafts.github.io/private-aggregation-api/#mark-a-debug-scope-complete",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-export=\"\" id=\"mark-a-debug-scope-complete\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">mark a debug scope complete</dfn> given a <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#debug-scope\" id=\"ref-for-debug-scope⑦\">debug\nscope</a> <var>debugScope</var> and an optional <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#debug-details\" id=\"ref-for-debug-details⑧\">debug details</a> or null <var>debugDetailsOverride</var> (default null):",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>debugDetails</var> be <var>debugDetailsOverride</var>.</p>"
        },
        {
          "html": "If <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#debug-scope-map\" id=\"ref-for-debug-scope-map⑤\">debug scope map</a>[<var>debugScope</var>] <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists③\">exists</a>:",
          "rationale": "assert",
          "steps": [
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert①\">Assert</a>: <var>debugDetailsOverride</var> is null.</p>"
            },
            {
              "html": "<p>Set <var>debugDetails</var> to <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#debug-scope-map\" id=\"ref-for-debug-scope-map⑥\">debug scope map</a>[<var>debugScope</var>].</p>"
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-remove\" id=\"ref-for-map-remove\">Remove</a> <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#debug-scope-map\" id=\"ref-for-debug-scope-map⑦\">debug scope map</a>[<var>debugScope</var>].</p>"
            },
            {
              "html": "<p>If <var>debugDetails</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#debug-details-key\" id=\"ref-for-debug-details-key①\">key</a> is not null, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert②\">assert</a>: <var>debugDetails</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#debug-details-enabled\" id=\"ref-for-debug-details-enabled②\">enabled</a> is true.</p>"
            }
          ]
        },
        {
          "html": "<p>If <var>debugDetails</var> is null, set <var>debugDetails</var> to a new <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#debug-details\" id=\"ref-for-debug-details⑨\">debug details</a>.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate\">For each</a> <var>entry</var> of the <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#contribution-cache\" id=\"ref-for-contribution-cache④\">contribution cache</a>:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>entry</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#contribution-cache-entry-debug-scope\" id=\"ref-for-contribution-cache-entry-debug-scope②\">debug scope</a> is <var>debugScope</var>,\nset <var>entry</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#contribution-cache-entry-debug-details\" id=\"ref-for-contribution-cache-entry-debug-details\">debug details</a> to <var>debugDetails</var>.</p>"
            }
          ]
        }
      ]
    },
    {
      "name": "determine if a report should be sent deterministically",
      "href": "https://patcg-individual-drafts.github.io/private-aggregation-api/#determine-if-a-report-should-be-sent-deterministically",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"determine-if-a-report-should-be-sent-deterministically\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">determine if a report should be sent deterministically</dfn> given a <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#pre-specified-report-parameters\" id=\"ref-for-pre-specified-report-parameters①\">pre-specified report parameters</a> <var>preSpecifiedParams</var>, perform the following\nsteps. They return a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#boolean\" id=\"ref-for-boolean③\">boolean</a>:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If <var>preSpecifiedParams</var>’ <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#pre-specified-report-parameters-context-id\" id=\"ref-for-pre-specified-report-parameters-context-id\">context ID</a> is\nnot null, return true.</p>"
        },
        {
          "html": "<p>If <var>preSpecifiedParams</var>’ <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#pre-specified-report-parameters-filtering-id-max-bytes\" id=\"ref-for-pre-specified-report-parameters-filtering-id-max-bytes①\">filtering ID max\nbytes</a> is not the <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#default-filtering-id-max-bytes\" id=\"ref-for-default-filtering-id-max-bytes②\">default filtering ID max bytes</a>, return true.</p>"
        },
        {
          "html": "<p>Return false.</p>"
        }
      ]
    },
    {
      "name": "process contributions for a batching scope",
      "href": "https://patcg-individual-drafts.github.io/private-aggregation-api/#process-contributions-for-a-batching-scope",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-export=\"\" id=\"process-contributions-for-a-batching-scope\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">process contributions for a batching scope</dfn> given\na <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#batching-scope\" id=\"ref-for-batching-scope⑤\">batching scope</a> <var>batchingScope</var>, an <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin\" id=\"ref-for-concept-origin④\">origin</a> <var>reportingOrigin</var>, a <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#context-type\" id=\"ref-for-context-type②\">context type</a> <var>contextType</var> and a <a data-link-type=\"dfn\" href=\"https://w3c.github.io/hr-time/#dfn-moment\" id=\"ref-for-dfn-moment②\">moment</a> or null <var>timeout</var>:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>batchEntries</var> be a new <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list③\">list</a>.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate①\">For each</a> <var>entry</var> of the <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#contribution-cache\" id=\"ref-for-contribution-cache⑤\">contribution cache</a>:",
          "rationale": "if",
          "steps": [
            {
              "html": "If <var>entry</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#contribution-cache-entry-batching-scope\" id=\"ref-for-contribution-cache-entry-batching-scope②\">batching scope</a> is <var>batchingScope</var>:",
              "rationale": "assert",
              "steps": [
                {
                  "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert③\">Assert</a>: <var>entry</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#contribution-cache-entry-debug-details\" id=\"ref-for-contribution-cache-entry-debug-details①\">debug details</a> is\nnot null.</p>"
                },
                {
                  "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-append\" id=\"ref-for-list-append①\">Append</a> <var>entry</var> to <var>batchEntries</var>.</p>"
                }
              ]
            }
          ]
        },
        {
          "html": "<p>Let <var>aggregationCoordinator</var> be the <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#default-aggregation-coordinator\" id=\"ref-for-default-aggregation-coordinator\">default aggregation coordinator</a>.</p>"
        },
        {
          "html": "If <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregation-coordinator-map\" id=\"ref-for-aggregation-coordinator-map\">aggregation coordinator map</a>[<var>batchingScope</var>] <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists④\">exists</a>:",
          "rationale": "set",
          "steps": [
            {
              "html": "<p>Set <var>aggregationCoordinator</var> to <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregation-coordinator-map\" id=\"ref-for-aggregation-coordinator-map①\">aggregation coordinator\nmap</a>[<var>batchingScope</var>].</p>"
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-remove\" id=\"ref-for-map-remove①\">Remove</a> <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregation-coordinator-map\" id=\"ref-for-aggregation-coordinator-map②\">aggregation coordinator map</a>[<var>batchingScope</var>].</p>"
            }
          ]
        },
        {
          "html": "<p>Let <var>preSpecifiedParams</var> be a new <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#pre-specified-report-parameters\" id=\"ref-for-pre-specified-report-parameters②\">pre-specified report parameters</a>.</p>"
        },
        {
          "html": "If <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#pre-specified-report-parameters-map\" id=\"ref-for-pre-specified-report-parameters-map③\">pre-specified report parameters map</a>[<var>batchingScope</var>] <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists⑤\">exists</a>:",
          "rationale": "set",
          "steps": [
            {
              "html": "<p>Set <var>preSpecifiedParams</var> to <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#pre-specified-report-parameters-map\" id=\"ref-for-pre-specified-report-parameters-map④\">pre-specified report parameters\nmap</a>[<var>batchingScope</var>].</p>"
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-remove\" id=\"ref-for-map-remove②\">Remove</a> <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#pre-specified-report-parameters-map\" id=\"ref-for-pre-specified-report-parameters-map⑤\">pre-specified report parameters map</a>[<var>batchingScope</var>].</p>"
            }
          ]
        },
        {
          "html": "<p>Let <var>isDeterministicReport</var> be the result of <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#determine-if-a-report-should-be-sent-deterministically\" id=\"ref-for-determine-if-a-report-should-be-sent-deterministically\">determining if a report should\nbe sent deterministically</a> given <var>preSpecifiedParams</var>.</p>"
        },
        {
          "html": "<p>If <var>isDeterministicReport</var> is false, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert④\">assert</a>: <var>timeout</var> is null.</p>"
        },
        {
          "html": "<p>If <var>batchEntries</var> <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-is-empty\" id=\"ref-for-list-is-empty\">is empty</a> and <var>isDeterministicReport</var> is false,\nreturn.</p>"
        },
        {
          "html": "<p>Let <var>batchedContributions</var> be a new <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#ordered-map\" id=\"ref-for-ordered-map③\">ordered map</a>.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate②\">For each</a> <var>entry</var> of <var>batchEntries</var>:",
          "rationale": "remove",
          "steps": [
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-remove\" id=\"ref-for-list-remove\">Remove</a> <var>entry</var> from the <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#contribution-cache\" id=\"ref-for-contribution-cache⑥\">contribution cache</a>.</p>"
            },
            {
              "html": "<p>Let <var>debugDetails</var> be <var>entry</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#contribution-cache-entry-debug-details\" id=\"ref-for-contribution-cache-entry-debug-details②\">debug\ndetails</a>.</p>"
            },
            {
              "html": "If <var>batchedContributions</var>[<var>debugDetails</var>] does not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists⑥\">exist</a>:",
              "rationale": "set",
              "steps": [
                {
                  "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-set\" id=\"ref-for-map-set①\">Set</a> <var>batchedContributions</var>[<var>debugDetails</var>] to a new <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list④\">list</a>.</p>"
                }
              ]
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-append\" id=\"ref-for-list-append②\">Append</a> <var>entry</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#contribution-cache-entry-contribution\" id=\"ref-for-contribution-cache-entry-contribution①\">contribution</a> to <var>batchedContributions</var>[<var>debugDetails</var>].</p>"
            }
          ]
        },
        {
          "html": "If <var>batchedContributions</var> <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-is-empty\" id=\"ref-for-map-is-empty\">is empty</a>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>debugDetails</var> be a new <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#debug-details\" id=\"ref-for-debug-details①⓪\">debug details</a>.</p>"
            },
            {
              "html": "<p>Set <var>batchedContributions</var>[<var>debugDetails</var>] to a new <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list⑤\">list</a>.</p>"
            }
          ]
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-iterate\" id=\"ref-for-map-iterate\">For each</a> <var>debugDetails</var> → <var>contributions</var> of <var>batchedContributions</var>:",
          "rationale": "perform",
          "steps": [
            {
              "html": "<p>Perform the <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#report-creation-and-scheduling-steps\" id=\"ref-for-report-creation-and-scheduling-steps\">report creation and scheduling steps</a> with <var>reportingOrigin</var>, <var>contextType</var>, <var>contributions</var>, <var>debugDetails</var>, <var>aggregationCoordinator</var>, <var>preSpecifiedParams</var> and <var>timeout</var>.</p>"
            }
          ]
        }
      ]
    },
    {
      "name": "determine if an origin is an aggregation coordinator",
      "href": "https://patcg-individual-drafts.github.io/private-aggregation-api/#determine-if-an-origin-is-an-aggregation-coordinator",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-export=\"\" id=\"determine-if-an-origin-is-an-aggregation-coordinator\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">determine if an origin is an aggregation coordinator</dfn> given\nan <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin\" id=\"ref-for-concept-origin⑤\">origin</a> <var>origin</var>, perform the following steps. They return a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#boolean\" id=\"ref-for-boolean④\">boolean</a>.",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Return whether <var>origin</var> is an <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregation-coordinator\" id=\"ref-for-aggregation-coordinator④\">aggregation coordinator</a>.</p>"
        }
      ]
    },
    {
      "name": "set the aggregation coordinator for a batching scope",
      "href": "https://patcg-individual-drafts.github.io/private-aggregation-api/#set-the-aggregation-coordinator-for-a-batching-scope",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-export=\"\" id=\"set-the-aggregation-coordinator-for-a-batching-scope\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">set the aggregation coordinator for a batching scope</dfn> given\nan <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin\" id=\"ref-for-concept-origin⑥\">origin</a> <var>origin</var> and a <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#batching-scope\" id=\"ref-for-batching-scope⑥\">batching scope</a> <var>batchingScope</var>:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert⑤\">Assert</a>: <var>origin</var> is an <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregation-coordinator\" id=\"ref-for-aggregation-coordinator⑤\">aggregation coordinator</a>.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-set\" id=\"ref-for-map-set②\">Set</a> <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregation-coordinator-map\" id=\"ref-for-aggregation-coordinator-map③\">aggregation coordinator map</a>[<var>batchingScope</var>] to <var>origin</var>.</p>"
        }
      ]
    },
    {
      "name": "set the pre-specified report parameters for a batching scope",
      "href": "https://patcg-individual-drafts.github.io/private-aggregation-api/#set-the-pre-specified-report-parameters-for-a-batching-scope",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-export=\"\" data-lt=\"set the pre-specified report parameters for a batching scope\" id=\"set-the-pre-specified-report-parameters-for-a-batching-scope\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">set the pre-specified report parameters for a batching\nscope</dfn> given a <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#pre-specified-report-parameters\" id=\"ref-for-pre-specified-report-parameters③\">pre-specified report parameters</a> <var>params</var> and a <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#batching-scope\" id=\"ref-for-batching-scope⑦\">batching scope</a> <var>batchingScope</var>:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>contextId</var> be <var>params</var>’ <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#pre-specified-report-parameters-context-id\" id=\"ref-for-pre-specified-report-parameters-context-id①\">context ID</a>.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert⑥\">Assert</a>: <var>contextId</var> is null or <var>contextId</var>’s <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#string-length\" id=\"ref-for-string-length\">length</a> is not\nlarger than 64.</p>"
        },
        {
          "html": "<p>Let <var>filteringIdMaxBytes</var> be <var>params</var>’ <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#pre-specified-report-parameters-filtering-id-max-bytes\" id=\"ref-for-pre-specified-report-parameters-filtering-id-max-bytes②\"> filtering ID max bytes</a>.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert⑦\">Assert</a>: <var>filteringIdMaxBytes</var> is <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-contain\" id=\"ref-for-list-contain④\">contained</a> in the <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#valid-filtering-id-max-bytes-range\" id=\"ref-for-valid-filtering-id-max-bytes-range\">valid\nfiltering ID max bytes range</a></p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-set\" id=\"ref-for-map-set③\">Set</a> <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#pre-specified-report-parameters-map\" id=\"ref-for-pre-specified-report-parameters-map⑥\">pre-specified report parameters map</a>[<var>batchingScope</var>] to <var>params</var>.</p>"
        }
      ]
    },
    {
      "name": "report creation and scheduling steps",
      "href": "https://patcg-individual-drafts.github.io/private-aggregation-api/#report-creation-and-scheduling-steps",
      "html": "To perform the <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"report-creation-and-scheduling-steps\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">report creation and scheduling steps</dfn> with an <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin\" id=\"ref-for-concept-origin⑦\">origin</a> <var>reportingOrigin</var>, a <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#context-type\" id=\"ref-for-context-type③\">context type</a> <var>api</var>, a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list⑥\">list</a> of <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dictdef-pahistogramcontribution\" id=\"ref-for-dictdef-pahistogramcontribution⑥\">PAHistogramContribution</a></code>s <var>contributions</var>, a <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#debug-details\" id=\"ref-for-debug-details①②\">debug details</a> <var>debugDetails</var>, an <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregation-coordinator\" id=\"ref-for-aggregation-coordinator⑥\">aggregation coordinator</a> <var>aggregationCoordinator</var>, a <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#pre-specified-report-parameters\" id=\"ref-for-pre-specified-report-parameters④\">pre-specified report parameters</a> <var>preSpecifiedParams</var> and a <a data-link-type=\"dfn\" href=\"https://w3c.github.io/hr-time/#dfn-moment\" id=\"ref-for-dfn-moment③\">moment</a> or\nnull <var>timeout</var>:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert⑧\">Assert</a>: <var>reportingOrigin</var> is a <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-secure-contexts/#potentially-trustworthy-origin\" id=\"ref-for-potentially-trustworthy-origin①\">potentially trustworthy origin</a>.</p>"
        },
        {
          "html": "<p>Optionally, return.</p>"
        },
        {
          "html": "<p>Let <var>mergedContributions</var> be a new <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list⑦\">list</a>.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate③\">For each</a> <var>contribution</var> of <var>contributions</var>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>hasProcessedContribution</var> be false.</p>"
            },
            {
              "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate④\">For each</a> <var>mergedContribution</var> of <var>mergedContributions</var>:",
              "rationale": "if",
              "steps": [
                {
                  "html": "If <var>contribution</var> and <var>mergedContribution</var> have both the same <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-pahistogramcontribution-bucket\" id=\"ref-for-dom-pahistogramcontribution-bucket①\">bucket</a></code> and the same <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-pahistogramcontribution-filteringid\" id=\"ref-for-dom-pahistogramcontribution-filteringid①\">filteringId</a></code>:",
                  "rationale": "add",
                  "steps": [
                    {
                      "html": "<p>Add <var>contribution</var>’s <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-pahistogramcontribution-value\" id=\"ref-for-dom-pahistogramcontribution-value①\">value</a></code> to <var>mergedContribution</var>’s <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-pahistogramcontribution-value\" id=\"ref-for-dom-pahistogramcontribution-value②\">value</a></code>.</p>"
                    },
                    {
                      "html": "<p>Set <var>hasProcessedContribution</var> to true.</p>"
                    },
                    {
                      "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-break\" id=\"ref-for-iteration-break\">Break</a>.</p>"
                    }
                  ]
                }
              ]
            },
            {
              "html": "<p>If <var>hasProcessedContribution</var> is false, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-append\" id=\"ref-for-list-append③\">append</a> <var>contribution</var> to <var>mergedContributions</var>.</p>"
            }
          ]
        },
        {
          "html": "<p>Let <var>truncatedContributions</var> be a new <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list⑧\">list</a>.</p>"
        },
        {
          "html": "If <var>mergedContributions</var> has a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-size\" id=\"ref-for-list-size\">size</a> greater than <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#maximum-report-contributions\" id=\"ref-for-maximum-report-contributions\">maximum report\ncontributions</a>:",
          "rationale": "for",
          "steps": [
            {
              "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate⑤\">For each</a> <var>n</var> of <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#the-exclusive-range\" id=\"ref-for-the-exclusive-range③\">the range</a> 0 to <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#maximum-report-contributions\" id=\"ref-for-maximum-report-contributions①\">maximum\nreport contributions</a>, exclusive:",
              "rationale": "append",
              "steps": [
                {
                  "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#set-append\" id=\"ref-for-set-append\">Append</a> <var>mergedContributions</var>[<var>n</var>] to <var>truncatedContributions</var>.</p>"
                }
              ]
            }
          ]
        },
        {
          "html": "<p>Otherwise, set <var>truncatedContributions</var> to <var>mergedContributions</var>.</p>"
        },
        {
          "html": "<p>Let <var>contributionSum</var> be 0.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate⑥\">For each</a> <var>contribution</var> of <var>truncatedContributions</var>:",
          "rationale": "assert",
          "steps": [
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert⑨\">Assert</a>: <var>contribution</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-pahistogramcontribution-value\" id=\"ref-for-dom-pahistogramcontribution-value③\">value</a></code>\"] is\nnon-negative.</p>"
            },
            {
              "html": "<p>Add <var>contribution</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-pahistogramcontribution-value\" id=\"ref-for-dom-pahistogramcontribution-value④\">value</a></code>\"] to <var>contributionSum</var>.</p>"
            }
          ]
        },
        {
          "html": "<p>Let <var>currentWallTime</var> be the <a data-link-type=\"dfn\" href=\"https://w3c.github.io/hr-time/#dfn-current-wall-time\" id=\"ref-for-dfn-current-wall-time\">current wall time</a>.</p>"
        },
        {
          "html": "<p>Let <var>sufficientBudget</var> be the result of <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#consume-budget-if-permitted\" id=\"ref-for-consume-budget-if-permitted①\">consuming budget if permitted</a> given <var>contributionSum</var>, <var>reportingOrigin</var>, <var>api</var> and <var>currentWallTime</var>.</p>"
        },
        {
          "html": "If <var>sufficientBudget</var> is false:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>isDeterministicReport</var> be the result of <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#determine-if-a-report-should-be-sent-deterministically\" id=\"ref-for-determine-if-a-report-should-be-sent-deterministically①\">determining if a report\nshould be sent deterministically</a> given <var>preSpecifiedParams</var>.</p>"
            },
            {
              "html": "<p>If <var>isDeterministicReport</var> is false, return.</p>"
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-empty\" id=\"ref-for-list-empty\">Empty</a> <var>truncatedContributions</var>.</p>"
            }
          ]
        },
        {
          "html": "<p>Let <var>report</var> be the result of <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#obtain-an-aggregatable-report\" id=\"ref-for-obtain-an-aggregatable-report\">obtaining an aggregatable report</a> given <var>reportingOrigin</var>, <var>api</var>, <var>truncatedContributions</var>, <var>debugDetails</var>, <var>aggregationCoordinator</var>, <var>preSpecifiedParams</var>, <var>timeout</var> and <var>currentWallTime</var>.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#set-append\" id=\"ref-for-set-append①\">Append</a> <var>report</var> to the user agent’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregatable-report-cache\" id=\"ref-for-aggregatable-report-cache①\">aggregatable report cache</a>.</p>"
        }
      ]
    },
    {
      "name": "obtain an aggregatable report",
      "href": "https://patcg-individual-drafts.github.io/private-aggregation-api/#obtain-an-aggregatable-report",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"obtain-an-aggregatable-report\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">obtain an aggregatable report</dfn> given an <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin\" id=\"ref-for-concept-origin⑨\">origin</a> <var>reportingOrigin</var>, a <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#context-type\" id=\"ref-for-context-type⑤\">context type</a> <var>api</var>, a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list⑨\">list</a> of <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dictdef-pahistogramcontribution\" id=\"ref-for-dictdef-pahistogramcontribution⑦\">PAHistogramContribution</a></code>s <var>contributions</var>, a <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#debug-details\" id=\"ref-for-debug-details①③\">debug details</a> <var>debugDetails</var>, an <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregation-coordinator\" id=\"ref-for-aggregation-coordinator⑦\">aggregation coordinator</a> <var>aggregationCoordinator</var>, a <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#pre-specified-report-parameters\" id=\"ref-for-pre-specified-report-parameters⑤\">pre-specified report parameters</a> <var>preSpecifiedParams</var>, a [=moment] or null <var>timeout</var> and a <a data-link-type=\"dfn\" href=\"https://w3c.github.io/hr-time/#dfn-moment\" id=\"ref-for-dfn-moment⑤\">moment</a> <var>currentTime</var>,\nperform the following steps. They return an <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregatable-report\" id=\"ref-for-aggregatable-report⑤\">aggregatable report</a>.",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert①⓪\">Assert</a>: <var>reportingOrigin</var> is a <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-secure-contexts/#potentially-trustworthy-origin\" id=\"ref-for-potentially-trustworthy-origin②\">potentially trustworthy origin</a>.</p>"
        },
        {
          "html": "<p>Let <var>reportTime</var> be the result of running <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#obtain-a-report-delivery-time\" id=\"ref-for-obtain-a-report-delivery-time\">obtain a report delivery time</a> given <var>currentTime</var> and <var>timeout</var>.</p>"
        },
        {
          "html": "<p>Let <var>report</var> be a new <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregatable-report\" id=\"ref-for-aggregatable-report⑥\">aggregatable report</a> with the items:</p>\n      <dl>\n       <dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregatable-report-reporting-origin\" id=\"ref-for-aggregatable-report-reporting-origin\">reporting origin</a>\n       </dt><dd data-md=\"\">\n        <p><var>reportingOrigin</var></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregatable-report-original-report-time\" id=\"ref-for-aggregatable-report-original-report-time\">original report time</a>\n       </dt><dd data-md=\"\">\n        <p><var>reportTime</var></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregatable-report-report-time\" id=\"ref-for-aggregatable-report-report-time\">report time</a>\n       </dt><dd data-md=\"\">\n        <p><var>reportTime</var></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregatable-report-contributions\" id=\"ref-for-aggregatable-report-contributions\">contributions</a>\n       </dt><dd data-md=\"\">\n        <p><var>contributions</var></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregatable-report-api\" id=\"ref-for-aggregatable-report-api\">api</a>\n       </dt><dd data-md=\"\">\n        <p><var>api</var></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregatable-report-report-id\" id=\"ref-for-aggregatable-report-report-id\">report ID</a>\n       </dt><dd data-md=\"\">\n        <p>The result of <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webcrypto/#dfn-generate-a-random-uuid\" id=\"ref-for-dfn-generate-a-random-uuid\">generating a random UUID</a>.</p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregatable-report-debug-details\" id=\"ref-for-aggregatable-report-debug-details①\">debug details</a>\n       </dt><dd data-md=\"\">\n        <p><var>debugDetails</var></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregatable-report-aggregation-coordinator\" id=\"ref-for-aggregatable-report-aggregation-coordinator\">aggregation coordinator</a>\n       </dt><dd data-md=\"\">\n        <p><var>aggregationCoordinator</var></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregatable-report-context-id\" id=\"ref-for-aggregatable-report-context-id\">context ID</a>\n       </dt><dd data-md=\"\">\n        <p><var>preSpecifiedParams</var>’ <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#pre-specified-report-parameters-context-id\" id=\"ref-for-pre-specified-report-parameters-context-id②\">context ID</a></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregatable-report-filtering-id-max-bytes\" id=\"ref-for-aggregatable-report-filtering-id-max-bytes\">filtering ID max bytes</a>\n       </dt><dd data-md=\"\">\n        <p><var>preSpecifiedParams</var>’ <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#pre-specified-report-parameters-filtering-id-max-bytes\" id=\"ref-for-pre-specified-report-parameters-filtering-id-max-bytes③\">filtering ID max\nbytes</a></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregatable-report-queued\" id=\"ref-for-aggregatable-report-queued\">queued</a>\n       </dt><dd data-md=\"\">\n        <p>false</p>\n      </dd></dl>"
        },
        {
          "html": "<p>Return <var>report</var>.</p>"
        }
      ]
    },
    {
      "name": "obtain a report delivery time",
      "href": "https://patcg-individual-drafts.github.io/private-aggregation-api/#obtain-a-report-delivery-time",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"obtain-a-report-delivery-time\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">obtain a report delivery time</dfn> given a <a data-link-type=\"dfn\" href=\"https://w3c.github.io/hr-time/#dfn-moment\" id=\"ref-for-dfn-moment⑥\">moment</a> <var>currentTime</var> and a <a data-link-type=\"dfn\" href=\"https://w3c.github.io/hr-time/#dfn-moment\" id=\"ref-for-dfn-moment⑦\">moment</a> or null <var>timeout</var>, perform the following steps.\nThey return a <a data-link-type=\"dfn\" href=\"https://w3c.github.io/hr-time/#dfn-moment\" id=\"ref-for-dfn-moment⑧\">moment</a>.",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "If <var>timeout</var> is not null:",
          "rationale": "return",
          "steps": [
            {
              "html": "<p>Return <var>timeout</var>.</p>"
            }
          ]
        },
        {
          "html": "<p>If <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#automation-local-testing-mode-enabled\" id=\"ref-for-automation-local-testing-mode-enabled\">automation local testing mode enabled</a> is true, return <var>currentTime</var>.</p>"
        },
        {
          "html": "<p>Let <var>r</var> be a random double between 0 (inclusive) and 1 (exclusive) with\nuniform probability.</p>"
        },
        {
          "html": "<p>Return <var>currentTime</var> + <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#minimum-report-delay\" id=\"ref-for-minimum-report-delay①\">minimum report delay</a> + <var>r</var> * <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#randomized-report-delay\" id=\"ref-for-randomized-report-delay\">randomized report\ndelay</a>.</p>"
        }
      ]
    },
    {
      "name": "attempt to queue reports for sending",
      "href": "https://patcg-individual-drafts.github.io/private-aggregation-api/#attempt-to-queue-reports-for-sending",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"attempt-to-queue-reports-for-sending\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">attempt to queue reports for sending</dfn> given a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list①⓪\">list</a> of <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregatable-report\" id=\"ref-for-aggregatable-report⑦\">aggregatable reports</a> <var>reports</var>:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate⑦\">For each</a> <var>report</var> of <var>reports</var>, run these steps <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel\">in\nparallel</a>:",
          "rationale": "run",
          "steps": [
            {
              "html": "Run these steps, but <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#abort-when\" id=\"ref-for-abort-when\">abort when</a> the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#user-agent\" id=\"ref-for-user-agent⑦\">user agent</a> shuts down:",
              "rationale": "if",
              "steps": [
                {
                  "html": "<p>If <var>report</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregatable-report-queued\" id=\"ref-for-aggregatable-report-queued①\">queued</a> value is true, return.</p>"
                },
                {
                  "html": "<p>Set <var>report</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregatable-report-queued\" id=\"ref-for-aggregatable-report-queued②\">queued</a> value to true.</p>"
                },
                {
                  "html": "<p>Let <var>currentWallTime</var> be the <a data-link-type=\"dfn\" href=\"https://w3c.github.io/hr-time/#dfn-current-wall-time\" id=\"ref-for-dfn-current-wall-time①\">current wall time</a>.</p>"
                },
                {
                  "html": "<p>If <var>report</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregatable-report-report-time\" id=\"ref-for-aggregatable-report-report-time①\">report time</a> is before <var>currentWallTime</var>, set <var>report</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregatable-report-report-time\" id=\"ref-for-aggregatable-report-report-time②\">report\ntime</a> to <var>currentWallTime</var> plus an <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#implementation-defined\" id=\"ref-for-implementation-defined③\">implementation-defined</a> random non-negative <a data-link-type=\"dfn\" href=\"https://w3c.github.io/hr-time/#dfn-duration\" id=\"ref-for-dfn-duration②\">duration</a>.</p>"
                },
                {
                  "html": "<p>Wait until the <a data-link-type=\"dfn\" href=\"https://w3c.github.io/hr-time/#dfn-current-wall-time\" id=\"ref-for-dfn-current-wall-time②\">current wall time</a> is equal to or after <var>report</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregatable-report-report-time\" id=\"ref-for-aggregatable-report-report-time③\">report time</a>.</p>"
                },
                {
                  "html": "<p>Optionally, wait a further <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#implementation-defined\" id=\"ref-for-implementation-defined④\">implementation-defined</a> non-negative <a data-link-type=\"dfn\" href=\"https://w3c.github.io/hr-time/#dfn-duration\" id=\"ref-for-dfn-duration③\">duration</a>.</p>"
                },
                {
                  "html": "<p>Run <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#attempt-to-deliver-a-report\" id=\"ref-for-attempt-to-deliver-a-report\">attempt to deliver a report</a> with <var>report</var>.</p>"
                }
              ]
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#if-aborted\" id=\"ref-for-if-aborted\">If aborted</a>, set <var>report</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregatable-report-queued\" id=\"ref-for-aggregatable-report-queued③\">queued</a> value to\nfalse.</p>"
            }
          ]
        }
      ]
    },
    {
      "name": "attempt to deliver a report",
      "href": "https://patcg-individual-drafts.github.io/private-aggregation-api/#attempt-to-deliver-a-report",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"attempt-to-deliver-a-report\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">attempt to deliver a report</dfn> given an <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregatable-report\" id=\"ref-for-aggregatable-report⑧\">aggregatable report</a> <var>report</var>:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>url</var> be the result of <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#obtain-a-reporting-endpoint\" id=\"ref-for-obtain-a-reporting-endpoint\">obtaining a reporting endpoint</a> given <var>report</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregatable-report-reporting-origin\" id=\"ref-for-aggregatable-report-reporting-origin①\">reporting origin</a> and <var>report</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregatable-report-api\" id=\"ref-for-aggregatable-report-api①\">api</a>.</p>"
        },
        {
          "html": "<p>Let <var>data</var> be the result of <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#serialize-an-aggregatable-report\" id=\"ref-for-serialize-an-aggregatable-report\">serializing an aggregatable report</a> given <var>report</var>.</p>"
        },
        {
          "html": "<p>If <var>data</var> is an error, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-remove\" id=\"ref-for-list-remove①\">remove</a> <var>report</var> from the <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregatable-report-cache\" id=\"ref-for-aggregatable-report-cache③\">aggregatable\nreport cache</a>.</p>"
        },
        {
          "html": "<p>Let <var>request</var> be the result of <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#create-a-report-request\" id=\"ref-for-create-a-report-request\">creating a report request</a> given <var>url</var> and <var>data</var>.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-task\" id=\"ref-for-queue-a-task①\">Queue a task</a> to <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-fetch\" id=\"ref-for-concept-fetch\">fetch</a> <var>request</var> with <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#process-response\" id=\"ref-for-process-response\">processResponse</a> being\nthe following steps:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>shouldRetry</var> be an <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#implementation-defined\" id=\"ref-for-implementation-defined⑤\">implementation-defined</a> <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#boolean\" id=\"ref-for-boolean⑥\">boolean</a>. The value\nshould be false if no error occurred.</p>"
            },
            {
              "html": "If <var>shouldRetry</var> is true:",
              "rationale": "set",
              "steps": [
                {
                  "html": "<p>Set <var>report</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregatable-report-report-time\" id=\"ref-for-aggregatable-report-report-time④\">report time</a> to the <a data-link-type=\"dfn\" href=\"https://w3c.github.io/hr-time/#dfn-current-wall-time\" id=\"ref-for-dfn-current-wall-time③\">current\nwall time</a> plus an <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#implementation-defined\" id=\"ref-for-implementation-defined⑥\">implementation-defined</a> non-negative <a data-link-type=\"dfn\" href=\"https://w3c.github.io/hr-time/#dfn-duration\" id=\"ref-for-dfn-duration④\">duration</a>.</p>"
                },
                {
                  "html": "<p>Set <var>report</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregatable-report-queued\" id=\"ref-for-aggregatable-report-queued④\">queued</a> value to false.</p>"
                }
              ]
            },
            {
              "html": "<p>Otherwise, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-remove\" id=\"ref-for-list-remove②\">remove</a> <var>report</var> from the <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregatable-report-cache\" id=\"ref-for-aggregatable-report-cache④\">aggregatable report\ncache</a>.</p>"
            }
          ]
        }
      ]
    },
    {
      "name": "obtain a reporting endpoint",
      "href": "https://patcg-individual-drafts.github.io/private-aggregation-api/#obtain-a-reporting-endpoint",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"obtain-a-reporting-endpoint\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">obtain a reporting endpoint</dfn> given an <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin\" id=\"ref-for-concept-origin①⓪\">origin</a> <var>reportingOrigin</var> and <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#context-type\" id=\"ref-for-context-type⑥\">context type</a> <var>api</var>, perform the following steps. They return a <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url\" id=\"ref-for-concept-url\">URL</a>.",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert①①\">Assert</a>: <var>reportingOrigin</var> is a <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-secure-contexts/#potentially-trustworthy-origin\" id=\"ref-for-potentially-trustworthy-origin③\">potentially trustworthy origin</a>.</p>"
        },
        {
          "html": "<p>Let <var>path</var> be the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#string-concatenate\" id=\"ref-for-string-concatenate\">concatenation</a> of\n«\"<code><a data-link-type=\"biblio\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#biblio-rfc8615\" title=\"Well-Known Uniform Resource Identifiers (URIs)\">.well-known</a>/private-aggregation/report-</code>\", <var>api</var>».</p>"
        },
        {
          "html": "<p>Let <var>base</var> be the result on running the <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-parser\" id=\"ref-for-concept-url-parser\">URL parser</a> on the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#ascii-serialisation-of-an-origin\" id=\"ref-for-ascii-serialisation-of-an-origin\">serialization</a> of <var>reportingOrigin</var>.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert①②\">Assert</a>: <var>base</var> is not failure.</p>"
        },
        {
          "html": "<p>Let <var>result</var> be the result of running the <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-parser\" id=\"ref-for-concept-url-parser①\">URL parser</a> on <var>path</var> with <var>base</var>.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert①③\">Assert</a>: <var>result</var> is not failure.</p>"
        },
        {
          "html": "<p>Return <var>result</var>.</p>"
        }
      ]
    },
    {
      "name": "create a report request",
      "href": "https://patcg-individual-drafts.github.io/private-aggregation-api/#create-a-report-request",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"create-a-report-request\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">create a report request</dfn> given a <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url\" id=\"ref-for-concept-url①\">URL</a> <var>url</var> and a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#byte-sequence\" id=\"ref-for-byte-sequence\">byte\nsequence</a> <var>body</var>:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>request</var> be a new <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request\" id=\"ref-for-concept-request\">request</a> with the following properties:</p>\n      <dl>\n       <dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-method\" id=\"ref-for-concept-request-method\">method</a>\n       </dt><dd data-md=\"\">\n        <p>\"<code>POST</code>\"</p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-url\" id=\"ref-for-concept-request-url\">URL</a>\n       </dt><dd data-md=\"\">\n        <p><var>url</var></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-header-list\" id=\"ref-for-concept-request-header-list\">header list</a>\n       </dt><dd data-md=\"\">\n        <p>«(\"<code>Content-Type</code>\", \"<code>application/json</code>\")»</p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#unsafe-request-flag\" id=\"ref-for-unsafe-request-flag\">unsafe-request flag</a>\n       </dt><dd data-md=\"\">\n        <p>set</p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-body\" id=\"ref-for-concept-request-body\">body</a>\n       </dt><dd data-md=\"\">\n        <p><var>body</var></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-client\" id=\"ref-for-concept-request-client\">client</a>\n       </dt><dd data-md=\"\">\n        <p><code>null</code></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-window\" id=\"ref-for-concept-request-window\">window</a>\n       </dt><dd data-md=\"\">\n        <p>\"<code>no-window</code>\"</p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#request-service-workers-mode\" id=\"ref-for-request-service-workers-mode\">service-workers mode</a>\n       </dt><dd data-md=\"\">\n        <p>\"<code>none</code>\"</p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-initiator\" id=\"ref-for-concept-request-initiator\">initiator</a>\n       </dt><dd data-md=\"\">\n        <p>\"\"</p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-referrer\" id=\"ref-for-concept-request-referrer\">referrer</a>\n       </dt><dd data-md=\"\">\n        <p>\"<code>no-referrer</code>\"</p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-mode\" id=\"ref-for-concept-request-mode\">mode</a>\n       </dt><dd data-md=\"\">\n        <p>\"<code>cors</code>\"</p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-credentials-mode\" id=\"ref-for-concept-request-credentials-mode\">credentials mode</a>\n       </dt><dd data-md=\"\">\n        <p>\"<code>omit</code>\"</p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-cache-mode\" id=\"ref-for-concept-request-cache-mode\">cache mode</a>\n       </dt><dd data-md=\"\">\n        <p>\"<code>no-store</code>\"</p>\n      </dd></dl>"
        },
        {
          "html": "<p>Return <var>request</var>.</p>"
        }
      ]
    },
    {
      "name": "serialize an aggregatable report",
      "href": "https://patcg-individual-drafts.github.io/private-aggregation-api/#serialize-an-aggregatable-report",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"serialize-an-aggregatable-report\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">serialize an aggregatable report</dfn> given an <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregatable-report\" id=\"ref-for-aggregatable-report⑨\">aggregatable report</a> <var>report</var>, perform the following steps. They return a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#byte-sequence\" id=\"ref-for-byte-sequence①\">byte sequence</a> or an\nerror.",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>aggregationServicePayloads</var> be the result of <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#obtain-the-aggregation-service-payloads\" id=\"ref-for-obtain-the-aggregation-service-payloads\">obtaining the aggregation\nservice payloads</a> given <var>report</var>.</p>"
        },
        {
          "html": "<p>If <var>aggregationServicePayloads</var> is an error, return <var>aggregationServicePayloads</var>.</p>"
        },
        {
          "html": "<p>Let <var>data</var> be an <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#ordered-map\" id=\"ref-for-ordered-map④\">ordered map</a> of the following key/value pairs:</p>\n      <dl>\n       <dt data-md=\"\">\"<code>aggregation_coordinator_origin</code>\"\n       </dt><dd data-md=\"\">\n        <p><var>report</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregatable-report-aggregation-coordinator\" id=\"ref-for-aggregatable-report-aggregation-coordinator①\">aggregation coordinator</a>, <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#ascii-serialisation-of-an-origin\" id=\"ref-for-ascii-serialisation-of-an-origin①\">serialized</a>.</p>\n       </dd><dt data-md=\"\">\"<code>aggregation_service_payloads</code>\"\n       </dt><dd data-md=\"\">\n        <p><var>aggregationServicePayloads</var></p>\n       </dd><dt data-md=\"\">\"<code>shared_info</code>\"\n       </dt><dd data-md=\"\">\n        <p>The result of <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#obtain-a-reports-shared-info\" id=\"ref-for-obtain-a-reports-shared-info\">obtaining a report’s shared info</a> given <var>report</var>.</p>\n      </dd></dl>"
        },
        {
          "html": "<p>Let <var>debugKey</var> be <var>report</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregatable-report-debug-details\" id=\"ref-for-aggregatable-report-debug-details②\">debug details</a>'s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#debug-details-key\" id=\"ref-for-debug-details-key②\">key</a>.</p>"
        },
        {
          "html": "<p>If <var>debugKey</var> is not null, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-set\" id=\"ref-for-map-set④\">set</a> <var>data</var>[\"<code>debug_key</code>\"] to <var>debugKey</var>.</p>"
        },
        {
          "html": "<p>Let <var>contextId</var> be <var>report</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregatable-report-context-id\" id=\"ref-for-aggregatable-report-context-id①\">context ID</a>.</p>"
        },
        {
          "html": "<p>If <var>contextId</var> is not null, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-set\" id=\"ref-for-map-set⑤\">set</a> <var>data</var>[\"<code>context_id</code>\"] to <var>contextId</var>.</p>"
        },
        {
          "html": "<p>Return the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#byte-sequence\" id=\"ref-for-byte-sequence②\">byte sequence</a> resulting from executing <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#serialize-an-infra-value-to-json-bytes\" id=\"ref-for-serialize-an-infra-value-to-json-bytes\">serialize an infra\nvalue to JSON bytes</a> on <var>data</var>.</p>"
        }
      ]
    },
    {
      "name": "obtain the aggregation service payloads",
      "href": "https://patcg-individual-drafts.github.io/private-aggregation-api/#obtain-the-aggregation-service-payloads",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"obtain-the-aggregation-service-payloads\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">obtain the aggregation service payloads</dfn> given an <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregatable-report\" id=\"ref-for-aggregatable-report①⓪\">aggregatable\nreport</a> <var>report</var>, perform the following steps. They return a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list①①\">list</a> of <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#ordered-map\" id=\"ref-for-ordered-map⑤\">maps</a> or an error.",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>publicKeyTuple</var> be the result of <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#obtain-the-public-key-for-encryption\" id=\"ref-for-obtain-the-public-key-for-encryption\">obtaining the public key for\nencryption</a> given <var>report</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregatable-report-aggregation-coordinator\" id=\"ref-for-aggregatable-report-aggregation-coordinator②\">aggregation\ncoordinator</a>.</p>"
        },
        {
          "html": "<p>If <var>publicKeyTuple</var> is an error, return <var>publicKeyTuple</var>.</p>"
        },
        {
          "html": "<p>Let (<var>pkR</var>, <var>keyId</var>) be <var>publicKeyTuple</var>.</p>"
        },
        {
          "html": "<p>Let <var>plaintextPayload</var> be the result of <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#obtain-the-plaintext-payload\" id=\"ref-for-obtain-the-plaintext-payload\">obtaining the plaintext payload</a> given <var>report</var>.</p>"
        },
        {
          "html": "<p>Let <var>sharedInfo</var> be the result of <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#obtain-a-reports-shared-info\" id=\"ref-for-obtain-a-reports-shared-info①\">obtaining a report’s shared info</a> given <var>report</var>.</p>"
        },
        {
          "html": "<p>Let <var>encryptedPayload</var> be the result of <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#encrypt-the-payload\" id=\"ref-for-encrypt-the-payload\">encrypting the payload</a> given <var>plaintextPayload</var>, <var>pkR</var> and <var>sharedInfo</var>.</p>"
        },
        {
          "html": "<p>If <var>encryptedPayload</var> is an error, return <var>encryptedPayload</var>.</p>"
        },
        {
          "html": "<p>Let <var>aggregationServicePayloads</var> be a new <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list①②\">list</a>.</p>"
        },
        {
          "html": "<p>Let <var>aggregationServicePayload</var> be an <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#ordered-map\" id=\"ref-for-ordered-map⑥\">ordered map</a> of the following\nkey/value pairs:</p>\n      <dl>\n       <dt data-md=\"\">\"<code>key_id</code>\"\n       </dt><dd data-md=\"\">\n        <p><var>keyId</var></p>\n       </dd><dt data-md=\"\">\"<code>payload</code>\"\n       </dt><dd data-md=\"\">\n        <p><var>encryptedPayload</var>, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#forgiving-base64-encode\" id=\"ref-for-forgiving-base64-encode\">base64 encoded</a></p>\n      </dd></dl>"
        },
        {
          "html": "If <var>report</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregatable-report-debug-details\" id=\"ref-for-aggregatable-report-debug-details③\">debug details</a>'s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#debug-details-enabled\" id=\"ref-for-debug-details-enabled③\"> enabled</a> field is true:",
          "rationale": "set",
          "steps": [
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-set\" id=\"ref-for-map-set⑥\">Set</a> <var>aggregationServicePayload</var>[<code>debug_cleartext_payload</code>] to <var>plaintextPayload</var>, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#forgiving-base64-encode\" id=\"ref-for-forgiving-base64-encode①\">base64 encoded</a>.</p>"
            }
          ]
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-append\" id=\"ref-for-list-append④\">Append</a> <var>aggregationServicePayload</var> to <var>aggregationServicePayloads</var>.</p>"
        },
        {
          "html": "<p>Return <var>aggregationServicePayloads</var>.</p>"
        }
      ]
    },
    {
      "name": "obtain the public key for encryption",
      "href": "https://patcg-individual-drafts.github.io/private-aggregation-api/#obtain-the-public-key-for-encryption",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"obtain-the-public-key-for-encryption\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">obtain the public key for encryption</dfn> given an <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregation-coordinator\" id=\"ref-for-aggregation-coordinator⑧\">aggregation\ncoordinator</a> <var>aggregationCoordinator</var>, perform the following steps. They return\na <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#tuple\" id=\"ref-for-tuple\">tuple</a> consisting of a public key and a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#string\" id=\"ref-for-string⑤\">string</a>, or an error.",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>url</var> be a new <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url\" id=\"ref-for-concept-url②\">URL record</a>.</p>"
        },
        {
          "html": "<p>Set <var>url</var>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-scheme\" id=\"ref-for-concept-url-scheme\">scheme</a> to <var>aggregationCoordinator</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-scheme\" id=\"ref-for-concept-origin-scheme\">scheme</a>.</p>"
        },
        {
          "html": "<p>Set <var>url</var>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-host\" id=\"ref-for-concept-url-host\">host</a> to <var>aggregationCoordinator</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-host\" id=\"ref-for-concept-origin-host\">host</a>.</p>"
        },
        {
          "html": "<p>Set <var>url</var>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-port\" id=\"ref-for-concept-url-port\">port</a> to <var>aggregationCoordinator</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-port\" id=\"ref-for-concept-origin-port\">port</a>.</p>"
        },
        {
          "html": "<p>Set <var>url</var>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-path\" id=\"ref-for-concept-url-path\">path</a> to «\"<code>.well-known</code>\", \"<code>aggregation-service</code>\",\n\"<code>v1</code>\", \"<code>public-keys</code>\"».</p>"
        },
        {
          "html": "<p>Return an <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#implementation-defined\" id=\"ref-for-implementation-defined⑦\">implementation-defined</a> <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#tuple\" id=\"ref-for-tuple①\">tuple</a> consisting of a public key\nfrom <var>url</var> and a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#string\" id=\"ref-for-string⑥\">string</a> that should uniquely identify the public key or,\nin the event that the user agent failed to obtain the public key from <var>url</var>,\nan error. This step may be asynchronous.</p>"
        }
      ]
    },
    {
      "name": "obtain the plaintext payload",
      "href": "https://patcg-individual-drafts.github.io/private-aggregation-api/#obtain-the-plaintext-payload",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"obtain-the-plaintext-payload\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">obtain the plaintext payload</dfn> given an <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregatable-report\" id=\"ref-for-aggregatable-report①①\">aggregatable report</a> <var>report</var>, perform the following steps. They return a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#byte-sequence\" id=\"ref-for-byte-sequence③\">byte sequence</a>.",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>payloadData</var> be a new <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list①③\">list</a>.</p>"
        },
        {
          "html": "<p>Let <var>contributions</var> be <var>report</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregatable-report-contributions\" id=\"ref-for-aggregatable-report-contributions①\">contributions</a>.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert①④\">Assert</a>: <var>contributions</var>’ <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-size\" id=\"ref-for-list-size①\">size</a> is not greater than <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#maximum-report-contributions\" id=\"ref-for-maximum-report-contributions②\">maximum\nreport contributions</a>.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-while\" id=\"ref-for-iteration-while\">While</a> <var>contributions</var>’ <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-size\" id=\"ref-for-list-size②\">size</a> is less than <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#maximum-report-contributions\" id=\"ref-for-maximum-report-contributions③\">maximum\nreport contributions</a>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>nullContribution</var> be a new <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dictdef-pahistogramcontribution\" id=\"ref-for-dictdef-pahistogramcontribution⑧\">PAHistogramContribution</a></code> with the\nitems:</p>\n        <dl>\n         <dt data-md=\"\"><code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-pahistogramcontribution-bucket\" id=\"ref-for-dom-pahistogramcontribution-bucket②\">bucket</a></code>\n         </dt><dd data-md=\"\">\n          <p>0</p>\n         </dd><dt data-md=\"\"><code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-pahistogramcontribution-value\" id=\"ref-for-dom-pahistogramcontribution-value⑤\">value</a></code>\n         </dt><dd data-md=\"\">\n          <p>0</p>\n         </dd><dt data-md=\"\"><code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-pahistogramcontribution-filteringid\" id=\"ref-for-dom-pahistogramcontribution-filteringid②\">filteringId</a></code>\n         </dt><dd data-md=\"\">\n          <p>0</p>\n        </dd></dl>"
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-append\" id=\"ref-for-list-append⑤\">Append</a> <var>nullContribution</var> to <var>contributions</var>.</p>"
            }
          ]
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate⑧\">For each</a> <var>contribution</var> of <var>report</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregatable-report-contributions\" id=\"ref-for-aggregatable-report-contributions②\"> contributions</a>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>filteringIdMaxBytes</var> be <var>report</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregatable-report-filtering-id-max-bytes\" id=\"ref-for-aggregatable-report-filtering-id-max-bytes①\">filtering\nid max bytes</a>.</p>"
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert①⑤\">Assert</a>: <var>contribution</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-pahistogramcontribution-filteringid\" id=\"ref-for-dom-pahistogramcontribution-filteringid③\">filteringId</a></code>\"]\nis <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-contain\" id=\"ref-for-list-contain⑤\">contained</a> in <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#the-exclusive-range\" id=\"ref-for-the-exclusive-range④\">the range</a> 0 to\n256<sup><var>filteringIdMaxBytes</var></sup>, exclusive.</p>"
            },
            {
              "html": "<p>Let <var>contributionData</var> be an <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#ordered-map\" id=\"ref-for-ordered-map⑦\">ordered map</a> of the following key/value\npairs:</p>\n        <dl>\n         <dt data-md=\"\">\"<code>bucket</code>\"\n         </dt><dd data-md=\"\">\n          <p>The result of <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#encode-an-integer-for-the-payload\" id=\"ref-for-encode-an-integer-for-the-payload\">encoding an integer for the payload</a> given <var>contribution</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-pahistogramcontribution-bucket\" id=\"ref-for-dom-pahistogramcontribution-bucket③\">bucket</a></code>\"] and 16.</p>\n         </dd><dt data-md=\"\">\"<code>value</code>\"\n         </dt><dd data-md=\"\">\n          <p>The result of <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#encode-an-integer-for-the-payload\" id=\"ref-for-encode-an-integer-for-the-payload①\">encoding an integer for the payload</a> given <var>contribution</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-pahistogramcontribution-value\" id=\"ref-for-dom-pahistogramcontribution-value⑥\">value</a></code>\"] and 4.</p>\n         </dd><dt data-md=\"\">\"<code>id</code>\"\n         </dt><dd data-md=\"\">\n          <p>The result of <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#encode-an-integer-for-the-payload\" id=\"ref-for-encode-an-integer-for-the-payload②\">encoding an integer for the payload</a> given <var>contribution</var>[=\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-pahistogramcontribution-filteringid\" id=\"ref-for-dom-pahistogramcontribution-filteringid④\">filteringId</a></code>\"] and <var>filteringIdMaxBytes</var>.</p>\n        </dd></dl>"
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-append\" id=\"ref-for-list-append⑥\">Append</a> <var>contributionData</var> to <var>payloadData</var>.</p>"
            }
          ]
        },
        {
          "html": "<p>Let <var>payload</var> be an <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#ordered-map\" id=\"ref-for-ordered-map⑧\">ordered map</a> of the following key/value pairs:</p>\n      <dl>\n       <dt data-md=\"\">\"<code>data</code>\"\n       </dt><dd data-md=\"\">\n        <p><var>payloadData</var></p>\n       </dd><dt data-md=\"\">\"<code>operation</code>\"\n       </dt><dd data-md=\"\">\n        <p>\"<code>histogram</code>\"</p>\n      </dd></dl>"
        },
        {
          "html": "<p>Return the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#byte-sequence\" id=\"ref-for-byte-sequence④\">byte sequence</a> resulting from <a data-link-type=\"biblio\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#biblio-rfc8949\" title=\"Concise Binary Object Representation (CBOR)\">CBOR encoding</a> <var>payload</var>.</p>"
        }
      ]
    },
    {
      "name": "encrypt the payload",
      "href": "https://patcg-individual-drafts.github.io/private-aggregation-api/#encrypt-the-payload",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"encrypt-the-payload\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">encrypt the payload</dfn> given a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#byte-sequence\" id=\"ref-for-byte-sequence⑤\">byte sequence</a> <var>plaintextPayload</var>,\npublic key <var>pkR</var> and a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#string\" id=\"ref-for-string⑦\">string</a> <var>sharedInfo</var>, perform the following steps.\nThey return a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#byte-sequence\" id=\"ref-for-byte-sequence⑥\">byte sequence</a> or an error.",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>info</var> be the result of <a data-link-type=\"dfn\" href=\"https://encoding.spec.whatwg.org/#utf-8-encode\" id=\"ref-for-utf-8-encode\">UTF-8 encoding</a> the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#string-concatenate\" id=\"ref-for-string-concatenate①\">concatenation</a> of « \"<code>aggregation_service</code>\", <var>sharedInfo</var> ».</p>"
        },
        {
          "html": "<p>Let (<var>kem_id</var>, <var>kdf_id</var>, <var>aead_id</var>) be (0x0020, 0x0001, 0x0003).</p>"
        },
        {
          "html": "<p>Let <var>hpkeContext</var> be the result of setting up an <a data-link-type=\"biblio\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#biblio-rfc9180\" title=\"Hybrid Public Key Encryption\">HPKE</a> <a href=\"https://www.rfc-editor.org/rfc/rfc9180#name-encryption-to-a-public-key\">sender’s context</a> with <var>pkR</var>, <var>info</var>, <var>kem_id</var>, <var>kdf_id</var> and <var>aead_id</var>.</p>"
        },
        {
          "html": "<p>Let <var>aad</var> be `` (an empty <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#byte-sequence\" id=\"ref-for-byte-sequence⑦\">byte sequence</a>).</p>"
        },
        {
          "html": "<p>Let <var>encryptedPayload</var> be the result of <a href=\"https://www.rfc-editor.org/rfc/rfc9180#name-encryption-and-decryption\">encrypting</a> <var>plaintextPayload</var> with <var>hpkeContext</var> and <var>aad</var>.</p>"
        }
      ]
    },
    {
      "name": "obtain a report’s shared info",
      "href": "https://patcg-individual-drafts.github.io/private-aggregation-api/#obtain-a-reports-shared-info",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"obtain-a-reports-shared-info\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">obtain a report’s shared info</dfn> given an <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregatable-report\" id=\"ref-for-aggregatable-report①②\">aggregatable report</a> <var>report</var>, perform the following steps. They return a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#string\" id=\"ref-for-string⑧\">string</a>.",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>scheduledReportTime</var> be the <a data-link-type=\"dfn\" href=\"https://w3c.github.io/hr-time/#dfn-duration-from\" id=\"ref-for-dfn-duration-from\">duration from</a> the <a data-link-type=\"dfn\" href=\"https://w3c.github.io/hr-time/#dfn-unix-epoch\" id=\"ref-for-dfn-unix-epoch\">UNIX epoch</a> to <var>report</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregatable-report-original-report-time\" id=\"ref-for-aggregatable-report-original-report-time①\">original report time</a>.</p>"
        },
        {
          "html": "<p>Let <var>sharedInfo</var> be an <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#ordered-map\" id=\"ref-for-ordered-map⑨\">ordered map</a> of the following key/value pairs:</p>\n      <dl>\n       <dt data-md=\"\">\"<code>api</code>\"\n       </dt><dd data-md=\"\">\n        <p><var>report</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregatable-report-api\" id=\"ref-for-aggregatable-report-api②\">api</a></p>\n       </dd><dt data-md=\"\">\"<code>report_id</code>\"\n       </dt><dd data-md=\"\">\n        <p><var>report</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregatable-report-report-id\" id=\"ref-for-aggregatable-report-report-id①\">report ID</a></p>\n       </dd><dt data-md=\"\">\"<code>reporting_origin</code>\"\n       </dt><dd data-md=\"\">\n        <p>The <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#ascii-serialisation-of-an-origin\" id=\"ref-for-ascii-serialisation-of-an-origin②\">serialization</a> of <var>report</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregatable-report-reporting-origin\" id=\"ref-for-aggregatable-report-reporting-origin②\">reporting origin</a></p>\n       </dd><dt data-md=\"\">\"<code>scheduled_report_time</code>\"\n       </dt><dd data-md=\"\">\n        <p>The number of seconds in <var>scheduledReportTime</var>, rounded down to the\nnearest number of whole seconds and <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#serialize-an-integer\" id=\"ref-for-serialize-an-integer\">serialized</a></p>\n       </dd><dt data-md=\"\">\"<code>version</code>\"\n       </dt><dd data-md=\"\">\n        <p>\"<code>1.0</code>\"</p>\n      </dd></dl>"
        },
        {
          "html": "<p>Return the result of <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#serialize-an-infra-value-to-a-json-string\" id=\"ref-for-serialize-an-infra-value-to-a-json-string\">serializing an infra value to a json string</a> given <var>sharedInfo</var>.</p>"
        }
      ]
    },
    {
      "name": "remote end steps",
      "href": "https://patcg-individual-drafts.github.io/private-aggregation-api/#remote-end-steps",
      "html": "The <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-export=\"\" id=\"remote-end-steps\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">remote end steps</dfn> are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If <var>parameters</var> is not a JSON-formatted <a href=\"https://tc39.es/ecma262/multipage/overview.html#sec-objects\">Object</a>,\nreturn a <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webdriver/#dfn-error\" id=\"ref-for-dfn-error\">WebDriver error</a> with <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webdriver/#dfn-error-code\" id=\"ref-for-dfn-error-code\">error code</a> <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webdriver/#dfn-invalid-argument\" id=\"ref-for-dfn-invalid-argument\">invalid argument</a>.</p>"
        },
        {
          "html": "<p>Let <var>enabled</var> be the result of <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webdriver/#dfn-getting-properties\" id=\"ref-for-dfn-getting-properties\">getting a property</a> named <code>\"enabled\"</code> from <var>parameters</var>.</p>"
        },
        {
          "html": "<p>If <var>enabled</var> is <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-undefined\" id=\"ref-for-idl-undefined②\">undefined</a></code> or is not a boolean, return a <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webdriver/#dfn-error\" id=\"ref-for-dfn-error①\">WebDriver\nerror</a> with <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webdriver/#dfn-error-code\" id=\"ref-for-dfn-error-code①\">error code</a> <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webdriver/#dfn-invalid-argument\" id=\"ref-for-dfn-invalid-argument①\">invalid argument</a>.</p>"
        },
        {
          "html": "<p>Set <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#automation-local-testing-mode-enabled\" id=\"ref-for-automation-local-testing-mode-enabled①\">automation local testing mode enabled</a> to <var>enabled</var>.</p>"
        },
        {
          "html": "<p>Return <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webdriver/#dfn-success\" id=\"ref-for-dfn-success\">success</a> with data <code>null</code>.</p>"
        }
      ]
    },
    {
      "name": "obtain the aggregation coordinator",
      "href": "https://patcg-individual-drafts.github.io/private-aggregation-api/#obtain-the-aggregation-coordinator",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"obtain-the-aggregation-coordinator\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">obtain the aggregation coordinator</dfn> given a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#dictdef-sharedstoragerunoperationmethodoptions\" id=\"ref-for-dictdef-sharedstoragerunoperationmethodoptions①\">SharedStorageRunOperationMethodOptions</a></code> <var>options</var>, perform the following\nsteps. They return an <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregation-coordinator\" id=\"ref-for-aggregation-coordinator⑨\">aggregation coordinator</a>, null or a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException④\">DOMException</a></code>:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If <var>options</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-sharedstoragerunoperationmethodoptions-privateaggregationconfig\" id=\"ref-for-dom-sharedstoragerunoperationmethodoptions-privateaggregationconfig\">privateAggregationConfig</a></code>\"]\ndoes not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists⑦\">exist</a>, return null.</p>"
        },
        {
          "html": "<p>If <var>options</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-sharedstoragerunoperationmethodoptions-privateaggregationconfig\" id=\"ref-for-dom-sharedstoragerunoperationmethodoptions-privateaggregationconfig①\">privateAggregationConfig</a></code>\"][\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-sharedstorageprivateaggregationconfig-aggregationcoordinatororigin\" id=\"ref-for-dom-sharedstorageprivateaggregationconfig-aggregationcoordinatororigin\">aggregationCoordinatorOrigin</a></code>\"]\ndoes not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists⑧\">exist</a>, return null.</p>"
        },
        {
          "html": "<p>Let <var>url</var> be the result of running the <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-parser\" id=\"ref-for-concept-url-parser②\">URL parser</a> on <var>options</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-sharedstoragerunoperationmethodoptions-privateaggregationconfig\" id=\"ref-for-dom-sharedstoragerunoperationmethodoptions-privateaggregationconfig②\">privateAggregationConfig</a></code>\"][\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-sharedstorageprivateaggregationconfig-aggregationcoordinatororigin\" id=\"ref-for-dom-sharedstorageprivateaggregationconfig-aggregationcoordinatororigin①\">aggregationCoordinatorOrigin</a></code>\"].</p>"
        },
        {
          "html": "<p>If <var>url</var> is failure or null, return a new <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException⑤\">DOMException</a></code> with name\n\"<code>SyntaxError</code>\".</p>"
        },
        {
          "html": "<p>Let <var>origin</var> be <var>url</var>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-origin\" id=\"ref-for-concept-url-origin\">origin</a>.</p>"
        },
        {
          "html": "<p>If the result of <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#determine-if-an-origin-is-an-aggregation-coordinator\" id=\"ref-for-determine-if-an-origin-is-an-aggregation-coordinator\">determining if an origin is an aggregation coordinator</a> given <var>origin</var> is false, return a new <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException⑥\">DOMException</a></code> with name\n\"<code>DataError</code>\".</p>"
        },
        {
          "html": "<p>Return <var>origin</var>.</p>"
        }
      ]
    },
    {
      "name": "obtain the pre-specified report parameters",
      "href": "https://patcg-individual-drafts.github.io/private-aggregation-api/#obtain-the-pre-specified-report-parameters",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"obtain-the-pre-specified-report-parameters\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">obtain the pre-specified report parameters</dfn> given a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#dictdef-sharedstoragerunoperationmethodoptions\" id=\"ref-for-dictdef-sharedstoragerunoperationmethodoptions②\">SharedStorageRunOperationMethodOptions</a></code> <var>options</var>, perform the following\nsteps. They return a <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#pre-specified-report-parameters\" id=\"ref-for-pre-specified-report-parameters⑥\">pre-specified report parameters</a>, null, or a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException⑦\">DOMException</a></code>:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If <var>options</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-sharedstoragerunoperationmethodoptions-privateaggregationconfig\" id=\"ref-for-dom-sharedstoragerunoperationmethodoptions-privateaggregationconfig③\">privateAggregationConfig</a></code>\"]\ndoes not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists⑨\">exist</a>, return null.</p>"
        },
        {
          "html": "<p>Let <var>privateAggregationConfig</var> be <var>options</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-sharedstoragerunoperationmethodoptions-privateaggregationconfig\" id=\"ref-for-dom-sharedstoragerunoperationmethodoptions-privateaggregationconfig④\">privateAggregationConfig</a></code>\"].</p>"
        },
        {
          "html": "<p>Let <var>contextId</var> be null.</p>"
        },
        {
          "html": "<p>If <var>privateAggregationConfig</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-sharedstorageprivateaggregationconfig-contextid\" id=\"ref-for-dom-sharedstorageprivateaggregationconfig-contextid\">contextId</a></code>\"] <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists①⓪\">exists</a>, set <var>contextId</var> to <var>privateAggregationConfig</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-sharedstorageprivateaggregationconfig-contextid\" id=\"ref-for-dom-sharedstorageprivateaggregationconfig-contextid①\">contextId</a></code>\"].</p>"
        },
        {
          "html": "<p>If <var>contextId</var>’s <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#string-length\" id=\"ref-for-string-length①\">length</a> is greater than 64, return a new <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException⑧\">DOMException</a></code> with name \"<code>DataError</code>\".</p>"
        },
        {
          "html": "<p>Let <var>filteringIdMaxBytes</var> be the <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#default-filtering-id-max-bytes\" id=\"ref-for-default-filtering-id-max-bytes③\">default filtering ID max bytes</a>.</p>"
        },
        {
          "html": "<p>If <var>privateAggregationConfig</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-sharedstorageprivateaggregationconfig-filteringidmaxbytes\" id=\"ref-for-dom-sharedstorageprivateaggregationconfig-filteringidmaxbytes\">filteringIdMaxBytes</a></code>\"] <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists①①\">exists</a>, set <var>filteringIdMaxBytes</var> to <var>privateAggregationConfig</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-sharedstorageprivateaggregationconfig-filteringidmaxbytes\" id=\"ref-for-dom-sharedstorageprivateaggregationconfig-filteringidmaxbytes①\">filteringIdMaxBytes</a></code>\"].</p>"
        },
        {
          "html": "<p>If <var>filteringIdMaxBytes</var> is not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-contain\" id=\"ref-for-list-contain⑥\">contained</a> in the <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#valid-filtering-id-max-bytes-range\" id=\"ref-for-valid-filtering-id-max-bytes-range①\">valid filtering ID\nmax bytes range</a>, return a new <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException⑨\">DOMException</a></code> with name \"<code>DataError</code>\".</p>"
        },
        {
          "html": "<p>Return a new <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#pre-specified-report-parameters\" id=\"ref-for-pre-specified-report-parameters⑦\">pre-specified report parameters</a> with the items:</p>\n      <dl>\n       <dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#pre-specified-report-parameters-context-id\" id=\"ref-for-pre-specified-report-parameters-context-id③\">context ID</a>\n       </dt><dd data-md=\"\">\n        <p><var>contextId</var></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#pre-specified-report-parameters-filtering-id-max-bytes\" id=\"ref-for-pre-specified-report-parameters-filtering-id-max-bytes④\">filtering ID max bytes</a>\n       </dt><dd data-md=\"\">\n        <p><var>filteringIdMaxBytes</var></p>\n      </dd></dl>"
        }
      ]
    },
    {
      "name": "shared-storage-run-monkey-patch-1",
      "html": "",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>preSpecifiedParams</var> be the result of <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#obtain-the-pre-specified-report-parameters\" id=\"ref-for-obtain-the-pre-specified-report-parameters\">obtaining the pre-specified\nreport parameters</a> given <var>options</var>.</p>"
        },
        {
          "html": "<p>If <var>preSpecifiedParams</var> is a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException①⓪\">DOMException</a></code>, return <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with\">a promise rejected\nwith</a> <var>preSpecifiedParams</var>.</p>"
        },
        {
          "html": "<p>Let <var>aggregationCoordinator</var> be the result of <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#obtain-the-aggregation-coordinator\" id=\"ref-for-obtain-the-aggregation-coordinator\">obtaining the aggregation\ncoordinator</a> given <var>options</var>.</p>"
        },
        {
          "html": "<p>If <var>aggregationCoordinator</var> is a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException①①\">DOMException</a></code>, return <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with①\">a promise\nrejected with</a> <var>aggregationCoordinator</var>.</p>"
        }
      ]
    },
    {
      "name": "shared-storage-run-monkey-patch-2",
      "html": "",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>batchingScope</var> be a new <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#batching-scope\" id=\"ref-for-batching-scope⑧\">batching scope</a>.</p>"
        },
        {
          "html": "<p>Let <var>debugScope</var> be a new <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#debug-scope\" id=\"ref-for-debug-scope⑧\">debug scope</a>.</p>"
        },
        {
          "html": "<p>Let <var>privateAggregationTimeout</var> be null.</p>"
        },
        {
          "html": "<p>Let <var>isDeterministicReport</var> be false.</p>"
        },
        {
          "html": "If <var>preSpecifiedParams</var> is not null:",
          "rationale": "set",
          "steps": [
            {
              "html": "<p>Set <var>isDeterministicReport</var> to the result of <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#determine-if-a-report-should-be-sent-deterministically\" id=\"ref-for-determine-if-a-report-should-be-sent-deterministically②\">determining if a report\nshould be sent deterministically</a> given <var>preSpecifiedParams</var>.</p>"
            },
            {
              "html": "If <var>isDeterministicReport</var>:",
              "rationale": "set",
              "steps": [
                {
                  "html": "<p>Set <var>privateAggregationTimeout</var> to the <a data-link-type=\"dfn\" href=\"https://w3c.github.io/hr-time/#dfn-current-wall-time\" id=\"ref-for-dfn-current-wall-time④\">current wall time</a> plus the <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#deterministic-operation-timeout-duration\" id=\"ref-for-deterministic-operation-timeout-duration\">deterministic operation timeout duration</a>.</p>"
                }
              ]
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#set-the-pre-specified-report-parameters-for-a-batching-scope\" id=\"ref-for-set-the-pre-specified-report-parameters-for-a-batching-scope\">Set the pre-specified report parameters for a batching scope</a> given <var>preSpecifiedParams</var> and <var>batchingScope</var>.</p>"
            }
          ]
        },
        {
          "html": "<p>If <var>aggregationCoordinator</var> is not null, <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#set-the-aggregation-coordinator-for-a-batching-scope\" id=\"ref-for-set-the-aggregation-coordinator-for-a-batching-scope\">set the aggregation coordinator\nfor a batching scope</a> given <var>aggregationCoordinator</var> and <var>batchingScope</var>.</p>"
        }
      ]
    },
    {
      "name": "shared-storage-run-monkey-patch-3",
      "html": "",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>hasRunPrivateAggregationCompletionTask</var> be false.</p>"
        },
        {
          "html": "Let <var>privateAggregationCompletionTask</var> be an algorithm to perform the\nfollowing steps:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>hasRunPrivateAggregationCompletionTask</var>, return.</p>"
            },
            {
              "html": "<p>Set <var>hasRunPrivateAggregationCompletionTask</var> to true.</p>"
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#mark-a-debug-scope-complete\" id=\"ref-for-mark-a-debug-scope-complete③\">Mark a debug scope complete</a> given <var>debugScope</var>.</p>"
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#process-contributions-for-a-batching-scope\" id=\"ref-for-process-contributions-for-a-batching-scope③\">Process contributions for a batching scope</a> given <var>batchingScope</var>, <var>outsideSettings</var>’ <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin\" id=\"ref-for-concept-settings-object-origin①\">origin</a>, \"<code>shared-storage</code>\"\nand <var>privateAggregationTimeout</var>.</p>"
            }
          ]
        },
        {
          "html": "If <var>isDeterministicReport</var>&gt;, run the following steps <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel①\">in\nparallel</a>:",
          "rationale": "wait",
          "steps": [
            {
              "html": "<p>Wait until <var>privateAggregationTimeout</var>.</p>"
            },
            {
              "html": "<p>Run <var>privateAggregationCompletionTask</var>.</p>"
            }
          ]
        }
      ]
    },
    {
      "name": "shared-storage-run-monkey-patch-4",
      "html": "",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "When the above <a data-link-type=\"dfn\" href=\"https://tc39.es/ecma262/#sec-call\" id=\"ref-for-sec-call\">call</a> returns, perform the following steps:",
          "rationale": "run",
          "steps": [
            {
              "html": "<p>Run <var>privateAggregationCompletionTask</var>.</p>"
            }
          ]
        }
      ]
    },
    {
      "name": "shared-storage-selecturl-monkey-patch-1",
      "html": "",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>preSpecifiedParams</var> be the result of <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#obtain-the-pre-specified-report-parameters\" id=\"ref-for-obtain-the-pre-specified-report-parameters①\">obtaining the pre-specified\nreport parameters</a> given <var>options</var>.</p>"
        },
        {
          "html": "<p>If <var>preSpecifiedParams</var> is a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException①②\">DOMException</a></code>, return <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with②\">a promise rejected\nwith</a> <var>preSpecifiedParams</var>.</p>"
        },
        {
          "html": "<p>Let <var>aggregationCoordinator</var> be the result of <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#obtain-the-aggregation-coordinator\" id=\"ref-for-obtain-the-aggregation-coordinator①\">obtaining the aggregation\ncoordinator</a> given <var>options</var>.</p>"
        },
        {
          "html": "<p>If <var>aggregationCoordinator</var> is a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException①③\">DOMException</a></code>, return <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#a-promise-rejected-with\" id=\"ref-for-a-promise-rejected-with③\">a promise\nrejected with</a> <var>aggregationCoordinator</var>.</p>"
        }
      ]
    },
    {
      "name": "shared-storage-selecturl-monkey-patch-2",
      "html": "",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>batchingScope</var> be a new <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#batching-scope\" id=\"ref-for-batching-scope⑨\">batching scope</a>.</p>"
        },
        {
          "html": "<p>Let <var>debugScope</var> be a new <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#debug-scope\" id=\"ref-for-debug-scope⑨\">debug scope</a>.</p>"
        },
        {
          "html": "<p>Let <var>privateAggregationTimeout</var> be null.</p>"
        },
        {
          "html": "<p>Let <var>hasRunPrivateAggregationCompletionTask</var> be false.</p>"
        },
        {
          "html": "Let <var>privateAggregationCompletionTask</var> be an algorithm to perform the\nfollowing steps:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>hasRunPrivateAggregationCompletionTask</var>, return.</p>"
            },
            {
              "html": "<p>Set <var>hasRunPrivateAggregationCompletionTask</var> to true.</p>"
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#mark-a-debug-scope-complete\" id=\"ref-for-mark-a-debug-scope-complete④\">Mark a debug scope complete</a> given <var>debugScope</var>.</p>"
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#process-contributions-for-a-batching-scope\" id=\"ref-for-process-contributions-for-a-batching-scope④\">Process contributions for a batching scope</a> given <var>batchingScope</var>, <var>outsideSettings</var>’ <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin\" id=\"ref-for-concept-settings-object-origin②\">origin</a>, \"<code>shared-storage</code>\"\nand <var>privateAggregationTimeout</var>.</p>"
            }
          ]
        },
        {
          "html": "<p>If <var>aggregationCoordinator</var> is not null, <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#set-the-aggregation-coordinator-for-a-batching-scope\" id=\"ref-for-set-the-aggregation-coordinator-for-a-batching-scope①\">set the aggregation coordinator\nfor a batching scope</a> given <var>aggregationCoordinator</var> and <var>batchingScope</var>.</p>"
        },
        {
          "html": "If <var>preSpecifiedParams</var> is not null:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>isDeterministicReport</var> be the result of <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#determine-if-a-report-should-be-sent-deterministically\" id=\"ref-for-determine-if-a-report-should-be-sent-deterministically③\">determining if a report\nshould be sent deterministically</a> given <var>preSpecifiedParams</var>.</p>"
            },
            {
              "html": "If <var>isDeterministicReport</var>:",
              "rationale": "set",
              "steps": [
                {
                  "html": "<p>Set <var>privateAggregationTimeout</var> to the <a data-link-type=\"dfn\" href=\"https://w3c.github.io/hr-time/#dfn-current-wall-time\" id=\"ref-for-dfn-current-wall-time⑤\">current wall time</a> plus the <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#deterministic-operation-timeout-duration\" id=\"ref-for-deterministic-operation-timeout-duration①\">deterministic operation timeout duration</a>.</p>"
                }
              ]
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#set-the-pre-specified-report-parameters-for-a-batching-scope\" id=\"ref-for-set-the-pre-specified-report-parameters-for-a-batching-scope①\">Set the pre-specified report parameters for a batching scope</a> given <var>preSpecifiedParams</var> and <var>batchingScope</var>.</p>"
            },
            {
              "html": "If <var>isDeterministicReport</var>, run the following steps <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel\" id=\"ref-for-in-parallel②\">in parallel</a>:",
              "rationale": "wait",
              "steps": [
                {
                  "html": "<p>Wait until <var>privateAggregationTimeout</var>.</p>"
                },
                {
                  "html": "<p>Run <var>privateAggregationCompletionTask</var>.</p>"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "shared-storage-selecturl-monkey-patch-3",
      "html": "",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Run <var>privateAggregationCompletionTask</var>.</p>"
        }
      ]
    },
    {
      "name": "shared-storage-addmodule-monkey-patch",
      "html": "",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "If <var>this</var> is a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/shared-storage/#sharedstorageworklet\" id=\"ref-for-sharedstorageworklet\">SharedStorageWorklet</a></code>, <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#upon-fulfillment\" id=\"ref-for-upon-fulfillment\">upon fulfillment</a> of <var>promise</var> or <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#upon-rejection\" id=\"ref-for-upon-rejection\">upon rejection</a> of <var>promise</var>, run the following steps:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>globalScopes</var> be <var>this</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/worklets.html#concept-worklet-global-scopes\" id=\"ref-for-concept-worklet-global-scopes\">global scopes</a>.</p>"
            },
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert①⑥\">Assert</a>: <var>globalScopes</var>’ <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-size\" id=\"ref-for-list-size③\">size</a> equals 1.</p>"
            },
            {
              "html": "<p>Let <var>privateAggregationObj</var> be <var>globalScopes</var>[0]'s <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-sharedstorageworkletglobalscope-privateaggregation\" id=\"ref-for-dom-sharedstorageworkletglobalscope-privateaggregation①\">privateAggregation</a></code>.</p>"
            },
            {
              "html": "<p>Set <var>privateAggregationObj</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#privateaggregation-allowed-to-use\" id=\"ref-for-privateaggregation-allowed-to-use③\">allowed to use</a> to\nthe result of determining whether <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this④\">this</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global\" id=\"ref-for-concept-relevant-global\">relevant global\nobject</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#concept-document-window\" id=\"ref-for-concept-document-window\">associated document</a> is <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/iframe-embed-object.html#allowed-to-use\" id=\"ref-for-allowed-to-use①\">allowed to use</a> the\n\"<code><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#private-aggregation\" id=\"ref-for-private-aggregation①\">private-aggregation</a></code>\" <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature\" id=\"ref-for-policy-controlled-feature③\">policy-controlled feature</a>.</p>"
            },
            {
              "html": "<p>Set <var>privateAggregationObj</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#privateaggregation-scoping-details\" id=\"ref-for-privateaggregation-scoping-details⑤\">scoping details</a> to a\n    new <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#scoping-details\" id=\"ref-for-scoping-details①\">scoping details</a> with the items:</p>\n        <dl>\n         <dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#scoping-details-get-batching-scope-steps\" id=\"ref-for-scoping-details-get-batching-scope-steps②\">get batching scope steps</a>\n         </dt><dd data-md=\"\">\n          <p>An algorithm that returns the <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#batching-scope\" id=\"ref-for-batching-scope①⓪\">batching scope</a> that is scheduled to\nbe passed to <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#process-contributions-for-a-batching-scope\" id=\"ref-for-process-contributions-for-a-batching-scope⑤\">process contributions for a batching scope</a> when the\ncall currently executing in <var>scope</var> returns.</p>\n         </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#scoping-details-get-debug-scope-steps\" id=\"ref-for-scoping-details-get-debug-scope-steps③\">get debug scope steps</a>\n         </dt><dd data-md=\"\">\n          <p>An algorithm that returns the <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#debug-scope\" id=\"ref-for-debug-scope①⓪\">debug scope</a> that is scheduled to be\npassed to <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#mark-a-debug-scope-complete\" id=\"ref-for-mark-a-debug-scope-complete⑤\">mark a debug scope complete</a> when the call currently\nexecuting in <var>scope</var> returns.</p>\n        </dd></dl>"
            }
          ]
        }
      ]
    },
    {
      "name": "PrivateAggregation/contributeToHistogramOnEvent(DOMString event, PAExtendedHistogramContribution contribution)",
      "href": "https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-privateaggregation-contributetohistogramonevent",
      "html": "The <dfn class=\"dfn-paneled idl-code has-dfn-panel\" data-dfn-for=\"PrivateAggregation\" data-dfn-type=\"method\" data-export=\"\" data-lt=\"contributeToHistogramOnEvent(event, contribution)\" id=\"dom-privateaggregation-contributetohistogramonevent\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\"><code>contributeToHistogramOnEvent(DOMString\nevent, PAExtendedHistogramContribution contribution)</code></dfn> method steps are:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>scopingDetails</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this⑥\">this</a>'s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#privateaggregation-scoping-details\" id=\"ref-for-privateaggregation-scoping-details⑥\">scoping details</a>.</p>"
        },
        {
          "html": "<p>If <var>event</var> <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#string-starts-with\" id=\"ref-for-string-starts-with\">starts with</a> \"<code>reserved.</code>\" and « \"<code>reserved.always</code>\",\n\"<code>reserved.loss</code>\", \"<code>reserved.win</code>\" » does not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-contain\" id=\"ref-for-list-contain⑦\">contain</a> <var>event</var>,\nreturn.</p>"
        },
        {
          "html": "<p>Let <var>bucket</var> be <var>contribution</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-paextendedhistogramcontribution-bucket\" id=\"ref-for-dom-paextendedhistogramcontribution-bucket\">bucket</a></code>\"].</p>"
        },
        {
          "html": "If <var>bucket</var> is a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dictdef-pasignalvalue\" id=\"ref-for-dictdef-pasignalvalue②\">PASignalValue</a></code>:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>bucket</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-pasignalvalue-basevalue\" id=\"ref-for-dom-pasignalvalue-basevalue\">baseValue</a></code>\"] is not a valid <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#signal-base-value\" id=\"ref-for-signal-base-value\">signal base\nvalue</a>, <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-throw\" id=\"ref-for-dfn-throw⑦\">throw</a> a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror\">TypeError</a></code>.</p>"
            },
            {
              "html": "<p>If <var>bucket</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-pasignalvalue-offset\" id=\"ref-for-dom-pasignalvalue-offset\">offset</a></code>\"] is not a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-bigint\" id=\"ref-for-idl-bigint⑨\">bigint</a></code>, <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-throw\" id=\"ref-for-dfn-throw⑧\"> throw</a> a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror①\">TypeError</a></code>.</p>"
            }
          ]
        },
        {
          "html": "<p>Otherwise, if <var>contribution</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-paextendedhistogramcontribution-bucket\" id=\"ref-for-dom-paextendedhistogramcontribution-bucket①\">bucket</a></code>\"] is\nnot <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-contain\" id=\"ref-for-list-contain⑧\">contained</a> in <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#the-exclusive-range\" id=\"ref-for-the-exclusive-range⑤\">the range</a> 0 to\n2<sup>128</sup>, exclusive, <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-throw\" id=\"ref-for-dfn-throw⑨\">throw</a> a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror②\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>value</var> be <var>contribution</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-paextendedhistogramcontribution-value\" id=\"ref-for-dom-paextendedhistogramcontribution-value\">value</a></code>\"].</p>"
        },
        {
          "html": "If <var>value</var> is a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dictdef-pasignalvalue\" id=\"ref-for-dictdef-pasignalvalue③\">PASignalValue</a></code>:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>value</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-pasignalvalue-basevalue\" id=\"ref-for-dom-pasignalvalue-basevalue①\">baseValue</a></code>\"] is not a valid <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#signal-base-value\" id=\"ref-for-signal-base-value①\">signal base\nvalue</a>, <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-throw\" id=\"ref-for-dfn-throw①⓪\">throw</a> a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror③\">TypeError</a></code>.</p>"
            },
            {
              "html": "<p>If <var>value</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-pasignalvalue-offset\" id=\"ref-for-dom-pasignalvalue-offset①\">offset</a></code>\"] is a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-bigint\" id=\"ref-for-idl-bigint①⓪\">bigint</a></code>, <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-throw\" id=\"ref-for-dfn-throw①①\"> throw</a> a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror④\">TypeError</a></code>.</p>"
            }
          ]
        },
        {
          "html": "<p>Otherwise, if <var>contribution</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-paextendedhistogramcontribution-value\" id=\"ref-for-dom-paextendedhistogramcontribution-value①\">value</a></code>\"] is\nnegative, <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-throw\" id=\"ref-for-dfn-throw①②\">throw</a> a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror⑤\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>If <var>contribution</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-paextendedhistogramcontribution-filteringid\" id=\"ref-for-dom-paextendedhistogramcontribution-filteringid\">filteringId</a></code>\"] is\nnot <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-contain\" id=\"ref-for-list-contain⑨\">contained</a> in <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#the-exclusive-range\" id=\"ref-for-the-exclusive-range⑥\">the range</a> 0 to\n256<sup><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#default-filtering-id-max-bytes\" id=\"ref-for-default-filtering-id-max-bytes④\">default filtering ID max bytes</a></sup>, exclusive, <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-throw\" id=\"ref-for-dfn-throw①③\"> throw</a> a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror⑥\">TypeError</a></code>.</p>"
        },
        {
          "html": "<p>Let <var>batchingScope</var> be null.</p>"
        },
        {
          "html": "<p>If <var>event</var> <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#string-starts-with\" id=\"ref-for-string-starts-with①\">starts with</a> \"<code>reserved.</code>\", set <var>batchingScope</var> to the\nresult of running <var>scopingDetails</var>’ <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#scoping-details-get-batching-scope-steps\" id=\"ref-for-scoping-details-get-batching-scope-steps③\">get batching scope\nsteps</a>.</p>"
        },
        {
          "html": "<p>Let <var>entry</var> be a new <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#on-event-contribution-cache-entry\" id=\"ref-for-on-event-contribution-cache-entry\">on event contribution cache entry</a> with the items:</p>\n      <dl>\n       <dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#on-event-contribution-cache-entry-contribution\" id=\"ref-for-on-event-contribution-cache-entry-contribution\">contribution</a>\n       </dt><dd data-md=\"\">\n        <p><var>contribution</var></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#on-event-contribution-cache-entry-batching-scope\" id=\"ref-for-on-event-contribution-cache-entry-batching-scope\">batching scope</a>\n       </dt><dd data-md=\"\">\n        <p><var>batchingScope</var></p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#on-event-contribution-cache-entry-debug-scope\" id=\"ref-for-on-event-contribution-cache-entry-debug-scope\">debug scope</a>\n       </dt><dd data-md=\"\">\n        <p>The result of running <var>scopingDetails</var>’ <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#scoping-details-get-debug-scope-steps\" id=\"ref-for-scoping-details-get-debug-scope-steps④\">get debug scope\nsteps</a>.</p>\n       </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#on-event-contribution-cache-entry-worklet-function\" id=\"ref-for-on-event-contribution-cache-entry-worklet-function\">worklet function</a>\n       </dt><dd data-md=\"\">\n        <p>The <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#worklet-function\" id=\"ref-for-worklet-function\">worklet function</a> that is currently being executed.</p>\n      </dd></dl>"
        },
        {
          "html": "<p>Let <var>global</var> be <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this⑦\">this</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global\" id=\"ref-for-concept-relevant-global①\">relevant global object</a>.</p>"
        },
        {
          "html": "<p>Let <var>auctionConfig</var> be <var>global</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#interestgroupscriptrunnerglobalscope-auction-config\" id=\"ref-for-interestgroupscriptrunnerglobalscope-auction-config\">auction config</a>.</p>"
        },
        {
          "html": "<p>Let <var>ig</var> be the result of <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#maybe-obtain-an-interest-group\" id=\"ref-for-maybe-obtain-an-interest-group\">maybe obtaining an\ninterest group</a> given <var>global</var>.</p>"
        },
        {
          "html": "<p>Let <var>cacheMap</var> be <var>auctionConfig</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#auction-config-per-bid-or-seller-on-event-contribution-cache\" id=\"ref-for-auction-config-per-bid-or-seller-on-event-contribution-cache\">per-bid or seller on\nevent contribution cache</a>.</p>"
        },
        {
          "html": "<p>If <var>cacheMap</var>[<var>ig</var>] does not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists①③\">exist</a>, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-set\" id=\"ref-for-map-set⑦\">set</a> <var>cacheMap</var>[<var>ig</var>] to\na new <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#on-event-contribution-cache\" id=\"ref-for-on-event-contribution-cache\">on event contribution cache</a>.</p>"
        },
        {
          "html": "<p>Let <var>onEventContributionCache</var> be <var>cacheMap</var>[<var>ig</var>].</p>"
        },
        {
          "html": "<p>If <var>onEventContributionCache</var>[<var>event</var>] does not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists①④\">exist</a>, set <var>onEventContributionCache</var>[<var>event</var>] to a new <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list①④\">list</a>.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-append\" id=\"ref-for-list-append⑦\">Append</a> <var>entry</var> to <var>onEventContributionCache</var>[<var>event</var>].</p>"
        }
      ]
    },
    {
      "name": "protected-audience-joinadig-monkey-patch",
      "html": "",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "If <var>group</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-auctionadinterestgroup-privateaggregationconfig\" id=\"ref-for-dom-auctionadinterestgroup-privateaggregationconfig\">privateAggregationConfig</a></code>\"] <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists①⑤\">exists</a>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>aggregationCoordinator</var> be the result of <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#obtain-the-private-aggregation-coordinator\" id=\"ref-for-obtain-the-private-aggregation-coordinator\">obtaining the Private\nAggregation coordinator</a> given <var>group</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-auctionadinterestgroup-privateaggregationconfig\" id=\"ref-for-dom-auctionadinterestgroup-privateaggregationconfig①\">privateAggregationConfig</a></code>\"].</p>"
            },
            {
              "html": "<p>If <var>aggregationCoordinator</var> is a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException①④\">DOMException</a></code>, then <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-throw\" id=\"ref-for-dfn-throw①④\">throw</a> <var>aggregationCoordinator</var>.</p>"
            },
            {
              "html": "<p>Set <var>interestGroup</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#interest-group-private-aggregation-coordinator\" id=\"ref-for-interest-group-private-aggregation-coordinator\">Private\nAggregation coordinator</a> to <var>aggregationCoordinator</var>.</p>"
            }
          ]
        }
      ]
    },
    {
      "name": "protected-audience-runadauction-monkey-patch",
      "html": "",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Set <var>auctionConfig</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#auction-config-permissions-policy-state\" id=\"ref-for-auction-config-permissions-policy-state\">permissions policy\nstate</a> to a new <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#permissions-policy-state\" id=\"ref-for-permissions-policy-state①\">permissions policy state</a> with the items:</p>\n      <dl>\n       <dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#permissions-policy-state-private-aggregation-enabled\" id=\"ref-for-permissions-policy-state-private-aggregation-enabled\">private aggregation enabled</a>\n       </dt><dd data-md=\"\">\n        <p>The result of determining whether <var>global</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/nav-history-apis.html#concept-document-window\" id=\"ref-for-concept-document-window①\">associated\nDocument</a> is <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/iframe-embed-object.html#allowed-to-use\" id=\"ref-for-allowed-to-use②\">allowed to use</a> the\n\"<code><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#private-aggregation\" id=\"ref-for-private-aggregation②\">private-aggregation</a></code>\" <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature\" id=\"ref-for-policy-controlled-feature④\">policy-controlled feature</a>.</p>\n      </dd></dl>"
        }
      ]
    },
    {
      "name": "protected-audience-validate-config-monkey-patch",
      "html": "",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "If <var>config</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-auctionadconfig-auctionreportbuyerkeys\" id=\"ref-for-dom-auctionadconfig-auctionreportbuyerkeys\">auctionReportBuyerKeys</a></code>\"] <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists①⑥\">exists</a>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>interestGroupBuyers</var> be <var>auctionConfig</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/turtledove/#auction-config-interest-group-buyers\" id=\"ref-for-auction-config-interest-group-buyers\">interest group buyers</a>.</p>"
            },
            {
              "html": "<p>If <var>interestGroupBuyers</var> is null, set <var>interestGroupBuyers</var> to a new <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list\" id=\"ref-for-list①⑥\">list</a>.</p>"
            },
            {
              "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate⑨\">For each</a> <var>index</var> of <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#the-exclusive-range\" id=\"ref-for-the-exclusive-range⑦\">the range</a> 0 to <var>config</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-auctionadconfig-auctionreportbuyerkeys\" id=\"ref-for-dom-auctionadconfig-auctionreportbuyerkeys①\">auctionReportBuyerKeys</a></code>\"]'s <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-size\" id=\"ref-for-list-size④\">size</a>,\nexclusive:",
              "rationale": "let",
              "steps": [
                {
                  "html": "<p>Let <var>key</var> be <var>config</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-auctionadconfig-auctionreportbuyerkeys\" id=\"ref-for-dom-auctionadconfig-auctionreportbuyerkeys②\">auctionReportBuyerKeys</a></code>\"][<var>index</var>].</p>"
                },
                {
                  "html": "<p>If <var>key</var> is not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-contain\" id=\"ref-for-list-contain①⓪\">contained</a> in <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#the-exclusive-range\" id=\"ref-for-the-exclusive-range⑧\">the\nrange</a> 0 to 2<sup>128</sup>, exclusive, <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-throw\" id=\"ref-for-dfn-throw①⑤\">throw</a> a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror⑦\">TypeError</a></code>.</p>"
                },
                {
                  "html": "<p>If <var>index</var> is equal to or greater than <var>interestGroupBuyers</var>’ <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-size\" id=\"ref-for-list-size⑤\"> size</a>, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue\">continue</a>.</p>"
                },
                {
                  "html": "<p>Let <var>origin</var> be <var>interestGroupBuyers</var>[<var>index</var>].</p>"
                },
                {
                  "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-set\" id=\"ref-for-map-set⑧\">Set</a> <var>auctionConfig</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#auction-config-auction-report-buyer-keys\" id=\"ref-for-auction-config-auction-report-buyer-keys\">auction report buyer\nkeys</a>[<var>origin</var>] to <var>key</var>.</p>"
                }
              ]
            }
          ]
        },
        {
          "html": "If <var>config</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-auctionadconfig-auctionreportbuyers\" id=\"ref-for-dom-auctionadconfig-auctionreportbuyers\">auctionReportBuyers</a></code>\"] <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists①⑦\">exists</a>:",
          "rationale": "for",
          "steps": [
            {
              "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-iterate\" id=\"ref-for-map-iterate①\">For each</a> <var>reportType</var> → <var>reportBuyerConfig</var> of <var>config</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-auctionadconfig-auctionreportbuyers\" id=\"ref-for-dom-auctionadconfig-auctionreportbuyers①\">auctionReportBuyers</a></code>\"]:",
              "rationale": "if",
              "steps": [
                {
                  "html": "<p>If « \"<code>interestGroupCount</code>\", \"<code>bidCount</code>\",\n\"<code>totalGenerateBidLatency</code>\", \"<code>totalSignalsFetchLatency</code>\" » does not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-contain\" id=\"ref-for-list-contain①①\">contain</a> <var>reportType</var>, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue②\">continue</a>.</p>"
                },
                {
                  "html": "<p>If <var>reportBuyerConfig</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-auctionreportbuyersconfig-bucket\" id=\"ref-for-dom-auctionreportbuyersconfig-bucket\">bucket</a></code>\"] is not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-contain\" id=\"ref-for-list-contain①②\">contained</a> in <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#the-exclusive-range\" id=\"ref-for-the-exclusive-range⑨\">the range</a> 0 to\n2<sup>128</sup>, exclusive, <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-throw\" id=\"ref-for-dfn-throw①⑥\">throw</a> a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror⑧\">TypeError</a></code>.</p>"
                },
                {
                  "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-set\" id=\"ref-for-map-set⑨\">Set</a> <var>auctionConfig</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#auction-config-auction-report-buyers\" id=\"ref-for-auction-config-auction-report-buyers\">auction report\nbuyers</a>[<var>reportType</var>] to <var>reportBuyerConfig</var>.</p>"
                }
              ]
            }
          ]
        },
        {
          "html": "<p>Set <var>auctionConfig</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#auction-config-auction-report-buyer-debug-details\" id=\"ref-for-auction-config-auction-report-buyer-debug-details\">auction report buyer debug details</a> to a new <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#debug-details\" id=\"ref-for-debug-details①⑥\">debug details</a>.</p>"
        },
        {
          "html": "If <var>config</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-auctionadconfig-auctionreportbuyerdebugmodeconfig\" id=\"ref-for-dom-auctionadconfig-auctionreportbuyerdebugmodeconfig\">auctionReportBuyerDebugModeConfig</a></code>\"] <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists①⑧\">exists</a>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>debugModeConfig</var> be <var>config</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-auctionadconfig-auctionreportbuyerdebugmodeconfig\" id=\"ref-for-dom-auctionadconfig-auctionreportbuyerdebugmodeconfig①\">auctionReportBuyerDebugModeConfig</a></code>\"].</p>"
            },
            {
              "html": "<p>Let <var>enabled</var> be <var>debugModeConfig</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-auctionreportbuyerdebugmodeconfig-enabled\" id=\"ref-for-dom-auctionreportbuyerdebugmodeconfig-enabled\">enabled</a></code>\"].</p>"
            },
            {
              "html": "<p>Let <var>debugKey</var> be <var>debugModeConfig</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-auctionreportbuyerdebugmodeconfig-debugkey\" id=\"ref-for-dom-auctionreportbuyerdebugmodeconfig-debugkey\">debugKey</a></code>\"].</p>"
            },
            {
              "html": "If <var>debugKey</var> is not null:",
              "rationale": "if",
              "steps": [
                {
                  "html": "<p>If <var>debugKey</var> is not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-contain\" id=\"ref-for-list-contain①③\">contained</a> in <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#the-exclusive-range\" id=\"ref-for-the-exclusive-range①⓪\">the\nrange</a> 0 to 2<sup>64</sup>, exclusive, <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-throw\" id=\"ref-for-dfn-throw①⑦\">throw</a> a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror⑨\">TypeError</a></code>.</p>"
                },
                {
                  "html": "<p>If <var>enabled</var> is false, <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#dfn-throw\" id=\"ref-for-dfn-throw①⑧\">throw</a> a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#exceptiondef-typeerror\" id=\"ref-for-exceptiondef-typeerror①⓪\">TypeError</a></code>.</p>"
                }
              ]
            },
            {
              "html": "<p>Set <var>auctionConfig</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#auction-config-auction-report-buyer-debug-details\" id=\"ref-for-auction-config-auction-report-buyer-debug-details①\">auction report buyer debug\ndetails</a> to a new <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#debug-details\" id=\"ref-for-debug-details①⑦\">debug details</a> with the items:</p>\n        <dl>\n         <dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#debug-details-enabled\" id=\"ref-for-debug-details-enabled④\">enabled</a>\n         </dt><dd data-md=\"\">\n          <p><var>enabled</var></p>\n         </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#debug-details-key\" id=\"ref-for-debug-details-key③\">key</a>\n         </dt><dd data-md=\"\">\n          <p><var>debugKey</var></p>\n        </dd></dl>"
            }
          ]
        },
        {
          "html": "If <var>config</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-auctionadconfig-privateaggregationconfig\" id=\"ref-for-dom-auctionadconfig-privateaggregationconfig\">privateAggregationConfig</a></code>\"] <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists①⑨\">exists</a>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>aggregationCoordinator</var> be the result of <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#obtain-the-private-aggregation-coordinator\" id=\"ref-for-obtain-the-private-aggregation-coordinator①\">obtaining the Private\nAggregation coordinator</a> given <var>config</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-auctionadconfig-privateaggregationconfig\" id=\"ref-for-dom-auctionadconfig-privateaggregationconfig①\">privateAggregationConfig</a></code>\"].</p>"
            },
            {
              "html": "<p>If <var>aggregationCoordinator</var> is a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException①⑤\">DOMException</a></code>, return failure.</p>"
            },
            {
              "html": "<p>Set <var>auctionConfig</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#auction-config-seller-private-aggregation-coordinator\" id=\"ref-for-auction-config-seller-private-aggregation-coordinator\">seller Private\nAggregation coordinator</a> to <var>aggregationCoordinator</var>.</p>"
            }
          ]
        }
      ]
    },
    {
      "name": "protected-audience-generate-and-score-bids-monkey-patch",
      "html": "",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#process-the-private-aggregation-contributions-for-an-auction\" id=\"ref-for-process-the-private-aggregation-contributions-for-an-auction\">Process the Private Aggregation contributions for an auction</a> given <var>auctionConfig</var> and <var>leadingBidInfo</var>.</p>"
        }
      ]
    },
    {
      "name": "protected-audience-evaluate-a-script-monkey-patch",
      "html": "",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Set <var>global</var>’s <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-interestgroupscriptrunnerglobalscope-privateaggregation\" id=\"ref-for-dom-interestgroupscriptrunnerglobalscope-privateaggregation①\">privateAggregation</a></code>'s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#privateaggregation-allowed-to-use\" id=\"ref-for-privateaggregation-allowed-to-use④\">allowed to use</a> to <var>auctionConfig</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#auction-config-permissions-policy-state\" id=\"ref-for-auction-config-permissions-policy-state①\"> permissions policy state</a>'s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#permissions-policy-state-private-aggregation-enabled\" id=\"ref-for-permissions-policy-state-private-aggregation-enabled①\">private aggregation\nenabled</a>.</p>"
        },
        {
          "html": "<p>Let <var>debugScope</var> be a new <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#debug-scope\" id=\"ref-for-debug-scope①②\">debug scope</a>.</p>"
        },
        {
          "html": "An algorithm that performs the following steps:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>origin</var> be <var>realm</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-realm-settings-object\" id=\"ref-for-concept-realm-settings-object\">settings object</a>'s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin\" id=\"ref-for-concept-settings-object-origin③\">origin</a>.</p>"
            },
            {
              "html": "<p>Let <var>ig</var> be the result of <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#maybe-obtain-an-interest-group\" id=\"ref-for-maybe-obtain-an-interest-group①\">maybe\nobtaining an interest group</a> given <var>realm</var>’s <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#concept-realm-global\" id=\"ref-for-concept-realm-global\">global\nobject</a>.</p>"
            },
            {
              "html": "<p>Let <var>aggregationCoordinator</var> be null.</p>"
            },
            {
              "html": "<p>If <var>ig</var> is not null, set <var>aggregationCoordinator</var> to <var>ig</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#interest-group-private-aggregation-coordinator\" id=\"ref-for-interest-group-private-aggregation-coordinator①\">Private Aggregation coordinator</a>.</p>"
            },
            {
              "html": "<p>Otherwise, set <var>aggregationCoordinator</var> to <var>auctionConfig</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#auction-config-seller-private-aggregation-coordinator\" id=\"ref-for-auction-config-seller-private-aggregation-coordinator①\">seller Private Aggregation coordinator</a>.</p>"
            },
            {
              "html": "<p>If <var>aggregationCoordinator</var> is null, set <var>aggregationCoordinator</var> to\nthe <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#default-aggregation-coordinator\" id=\"ref-for-default-aggregation-coordinator②\">default aggregation coordinator</a>.</p>"
            },
            {
              "html": "<p>Return the result of running <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#get-or-create-a-batching-scope\" id=\"ref-for-get-or-create-a-batching-scope\">get or create a batching scope</a> given <var>origin</var>, <var>aggregationCoordinator</var> and <var>auctionConfig</var>.</p>"
            }
          ]
        }
      ]
    },
    {
      "name": "protected-audience-evaluate-a-script-monkey-patch-2",
      "html": "",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>debugDetails</var> be the result of <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#get-a-debug-details\" id=\"ref-for-get-a-debug-details\">get a debug details</a> given <var>debugScope</var>.</p>"
        },
        {
          "html": "<p>Let <var>ig</var> be the result of <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#maybe-obtain-an-interest-group\" id=\"ref-for-maybe-obtain-an-interest-group②\">maybe obtaining an\ninterest group</a> given <var>global</var>.</p>"
        },
        {
          "html": "<p>Let <var>onEventContributionCache</var> be <var>auctionConfig</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#auction-config-per-bid-or-seller-on-event-contribution-cache\" id=\"ref-for-auction-config-per-bid-or-seller-on-event-contribution-cache①\">per-bid or seller on event contribution cache</a>[<var>ig</var>].</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-iterate\" id=\"ref-for-map-iterate②\">For each</a> <var>event</var> → <var>entries</var> of <var>onEventContributionCache</var>:",
          "rationale": "for",
          "steps": [
            {
              "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate①⓪\">For each</a> <var>onEventEntry</var> of <var>entries</var>:",
              "rationale": "if",
              "steps": [
                {
                  "html": "<p>If <var>onEventEntry</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#on-event-contribution-cache-entry-debug-scope\" id=\"ref-for-on-event-contribution-cache-entry-debug-scope①\">debug scope</a> is <var>debugScope</var>, set <var>onEventEntry</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#on-event-contribution-cache-entry-debug-details\" id=\"ref-for-on-event-contribution-cache-entry-debug-details\">debug details</a> to <var>debugDetails</var>.</p>"
                }
              ]
            }
          ]
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#mark-a-debug-scope-complete\" id=\"ref-for-mark-a-debug-scope-complete⑥\">Mark a debug scope complete</a> given <var>debugScope</var>.</p>"
        }
      ]
    },
    {
      "name": "protected-audience-evaluate-a-bidding-script-monkey-patch",
      "html": "",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Set <var>global</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#interestgroupscriptrunnerglobalscope-auction-config\" id=\"ref-for-interestgroupscriptrunnerglobalscope-auction-config①\">auction\nconfig</a> to <var>auctionConfig</var>.</p>"
        }
      ]
    },
    {
      "name": "protected-audience-evaluate-a-scoring-script-monkey-patch",
      "html": "",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Set <var>global</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#interestgroupscriptrunnerglobalscope-auction-config\" id=\"ref-for-interestgroupscriptrunnerglobalscope-auction-config②\">auction\nconfig</a> to <var>auctionConfig</var>.</p>"
        }
      ]
    },
    {
      "name": "protected-audience-evaluate-a-reporting-script-monkey-patch",
      "html": "",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Set <var>global</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#interestgroupscriptrunnerglobalscope-auction-config\" id=\"ref-for-interestgroupscriptrunnerglobalscope-auction-config③\">auction config</a> to <var>auctionConfig</var>.</p>"
        },
        {
          "html": "<p>Set <var>global</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#interestgroupreportingscriptrunnerglobalscope-interest-group\" id=\"ref-for-interestgroupreportingscriptrunnerglobalscope-interest-group\">interest\ngroup</a> to <var>ig</var>.</p>"
        }
      ]
    },
    {
      "name": "protected-audience-estimated-size-monkey-patch",
      "html": "",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>The <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#string-length\" id=\"ref-for-string-length②\">length</a> of the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#ascii-serialisation-of-an-origin\" id=\"ref-for-ascii-serialisation-of-an-origin③\">serialization</a> of <var>ig</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#interest-group-private-aggregation-coordinator\" id=\"ref-for-interest-group-private-aggregation-coordinator②\">Private Aggregation coordinator</a> if\nthe field is not null.</p>"
        }
      ]
    },
    {
      "name": "protected-audience-update-interest-groups-monkey-patch",
      "html": "",
      "rationale": ".switch",
      "steps": [
        {
          "operation": "switch",
          "steps": [
            {
              "case": "\"privateAggregationConfig\"",
              "html": "",
              "rationale": "if",
              "steps": [
                {
                  "html": "<p>If <var>value</var> is not a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#ordered-map\" id=\"ref-for-ordered-map①⑤\">map</a> whose <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-getting-the-keys\" id=\"ref-for-map-getting-the-keys\">keys</a> are <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#string\" id=\"ref-for-string①①\">strings</a>, jump to\nthe step labeled Abort update.</p>"
                },
                {
                  "html": "If <var>value</var>[\"<code>aggregationCoordinatorOrigin</code>\"] <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists②⓪\">exists</a>:",
                  "rationale": "if",
                  "steps": [
                    {
                      "html": "<p>If <var>value</var>[\"<code>aggregationCoordinatorOrigin</code>\"] is not a <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#string\" id=\"ref-for-string①②\">string</a>,\njump to the step labeled Abort update.</p>"
                    },
                    {
                      "html": "<p>Let <var>aggregationCoordinator</var> be the result of <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#obtain-the-private-aggregation-coordinator-from-a-string\" id=\"ref-for-obtain-the-private-aggregation-coordinator-from-a-string\">obtaining the Private\nAggregation coordinator</a> given <var>value</var>[\"<code>aggregationCoordinatorOrigin</code>\"].</p>"
                    },
                    {
                      "html": "<p>If <var>aggregationCoordinator</var> is a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException①⑥\">DOMException</a></code>, jump to the step\nlabeled Abort update.</p>"
                    },
                    {
                      "html": "<p>Otherwise, set <var>ig</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#interest-group-private-aggregation-coordinator\" id=\"ref-for-interest-group-private-aggregation-coordinator③\">Private\nAggregation coordinator</a> to <var>aggregationCoordinator</var>.</p>"
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "process the Private Aggregation contributions for an auction",
      "href": "https://patcg-individual-drafts.github.io/private-aggregation-api/#process-the-private-aggregation-contributions-for-an-auction",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"process-the-private-aggregation-contributions-for-an-auction\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">process the Private Aggregation contributions for an auction</dfn> given\nan <a data-link-type=\"dfn\" href=\"https://wicg.github.io/turtledove/#auction-config\" id=\"ref-for-auction-config⑥\">auction config</a> <var>auctionConfig</var> and a <a data-link-type=\"dfn\" href=\"https://wicg.github.io/turtledove/#leading-bid-info\" id=\"ref-for-leading-bid-info\">leading bid info</a> <var>leadingBidInfo</var>:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>winnerOrigin</var> be null.</p>"
        },
        {
          "html": "<p>If <var>leadingBidInfo</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/turtledove/#leading-bid-info-leading-bid\" id=\"ref-for-leading-bid-info-leading-bid①\">leading\nbid</a> is not null, set <var>winnerOrigin</var> to <var>leadingBidInfo</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/turtledove/#leading-bid-info-leading-bid\" id=\"ref-for-leading-bid-info-leading-bid②\">leading bid</a>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/turtledove/#generated-bid-interest-group\" id=\"ref-for-generated-bid-interest-group①\">interest group</a>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/turtledove/#interest-group-owner\" id=\"ref-for-interest-group-owner\">owner</a>.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-iterate\" id=\"ref-for-map-iterate③\">For each</a> <var>ig</var> → <var>onEventContributionCache</var> of <var>auctionConfig</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#auction-config-per-bid-or-seller-on-event-contribution-cache\" id=\"ref-for-auction-config-per-bid-or-seller-on-event-contribution-cache②\">per-bid or seller on event contribution\ncache</a>:",
          "rationale": "let",
          "steps": [
            {
              "html": "<p>Let <var>origin</var> be null.</p>"
            },
            {
              "html": "<p>If <var>ig</var> is null, set <var>origin</var> to <var>auctionConfig</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/turtledove/#auction-config-seller\" id=\"ref-for-auction-config-seller\">seller</a>.</p>"
            },
            {
              "html": "<p>Otherwise, set <var>origin</var> to <var>ig</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/turtledove/#interest-group-owner\" id=\"ref-for-interest-group-owner①\">owner</a>.</p>"
            },
            {
              "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-iterate\" id=\"ref-for-map-iterate④\">For each</a> <var>event</var> → <var>entries</var> of <var>onEventContributionCache</var>:",
              "rationale": "if",
              "steps": [
                {
                  "html": "If <var>event</var> is \"<code>reserved.win</code>\" or does not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#string-starts-with\" id=\"ref-for-string-starts-with②\">start with</a> \"<code>reserved.</code>\":",
                  "rationale": "if",
                  "steps": [
                    {
                      "html": "<p>If <var>origin</var> is not <var>winnerOrigin</var>, return.</p>"
                    }
                  ]
                },
                {
                  "html": "<p>If <var>event</var> is \"<code>reserved.loss</code>\" and <var>origin</var> is <var>winnerOrigin</var>,\nreturn.</p>"
                },
                {
                  "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#list-iterate\" id=\"ref-for-list-iterate①①\">For each</a> <var>onEventEntry</var> of <var>entries</var>:",
                  "rationale": "let",
                  "steps": [
                    {
                      "html": "<p>Let <var>filledInContribution</var> be the result of <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#fill-in-the-contribution\" id=\"ref-for-fill-in-the-contribution\">filling in the\ncontribution</a> given <var>onEventEntry</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#on-event-contribution-cache-entry-contribution\" id=\"ref-for-on-event-contribution-cache-entry-contribution①\">contribution</a> and <var>leadingBidInfo</var>.</p>"
                    },
                    {
                      "html": "If <var>event</var> does not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#string-starts-with\" id=\"ref-for-string-starts-with③\">start with</a> \"<code>reserved.</code>\":",
                      "rationale": "store",
                      "steps": [
                        {
                          "html": "<p>Store <var>event</var>, <var>filledInContribution</var>, <var>onEventEntry</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#on-event-contribution-cache-entry-debug-details\" id=\"ref-for-on-event-contribution-cache-entry-debug-details①\">debug details</a> in the <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/fenced-frame/#fencedframeconfig\" id=\"ref-for-fencedframeconfig\">FencedFrameConfig</a></code> as appropriate.</p>"
                        },
                        {
                          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue③\">Continue</a>.</p>"
                        }
                      ]
                    },
                    {
                      "html": "<p>Let <var>entry</var> be a new <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#contribution-cache-entry\" id=\"ref-for-contribution-cache-entry④\">contribution cache entry</a> with the items:</p>\n            <dl>\n             <dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#contribution-cache-entry-contribution\" id=\"ref-for-contribution-cache-entry-contribution②\">contribution</a>\n             </dt><dd data-md=\"\">\n              <p><var>filledInContribution</var></p>\n             </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#contribution-cache-entry-batching-scope\" id=\"ref-for-contribution-cache-entry-batching-scope③\">batching scope</a>\n             </dt><dd data-md=\"\">\n              <p><var>onEventEntry</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#on-event-contribution-cache-entry-batching-scope\" id=\"ref-for-on-event-contribution-cache-entry-batching-scope①\">batching\nscope</a></p>\n             </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#contribution-cache-entry-debug-scope\" id=\"ref-for-contribution-cache-entry-debug-scope③\">debug scope</a>\n             </dt><dd data-md=\"\">\n              <p><var>onEventEntry</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#on-event-contribution-cache-entry-debug-scope\" id=\"ref-for-on-event-contribution-cache-entry-debug-scope②\">debug\nscope</a></p>\n             </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#contribution-cache-entry-debug-details\" id=\"ref-for-contribution-cache-entry-debug-details③\">debug details</a>\n             </dt><dd data-md=\"\">\n              <p><var>onEventEntry</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#on-event-contribution-cache-entry-debug-details\" id=\"ref-for-on-event-contribution-cache-entry-debug-details②\">debug\ndetails</a></p>\n            </dd></dl>"
                    },
                    {
                      "html": "<p><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#append-an-entry-to-the-contribution-cache\" id=\"ref-for-append-an-entry-to-the-contribution-cache①\">Append</a> <var>entry</var> to\nthe <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#contribution-cache\" id=\"ref-for-contribution-cache⑦\">contribution cache</a>.</p>"
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "html": "<p>Let <var>sellerBatchingScope</var> be the result of <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#get-or-create-a-batching-scope\" id=\"ref-for-get-or-create-a-batching-scope①\">getting or creating a batching scope</a> given <var>auctionConfig</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/turtledove/#auction-config-seller\" id=\"ref-for-auction-config-seller①\">seller</a>, <var>auctionConfig</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#auction-config-seller-private-aggregation-coordinator\" id=\"ref-for-auction-config-seller-private-aggregation-coordinator②\">seller Private Aggregation coordinator</a>, and <var>auctionConfig</var>.</p>"
        },
        {
          "html": "<p>Let <var>auctionReportBuyersDebugScope</var> be a new <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#debug-scope\" id=\"ref-for-debug-scope①③\">debug scope</a>.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-iterate\" id=\"ref-for-map-iterate⑤\">For each</a> <var>reportType</var> → <var>reportBuyerConfig</var> of <var>auctionConfig</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#auction-config-auction-report-buyers\" id=\"ref-for-auction-config-auction-report-buyers①\">auction report buyers</a>:",
          "rationale": "for",
          "steps": [
            {
              "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-iterate\" id=\"ref-for-map-iterate⑥\">For each</a> <var>buyerOrigin</var> → <var>buyerOffset</var> of <var>auctionConfig</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#auction-config-auction-report-buyer-keys\" id=\"ref-for-auction-config-auction-report-buyer-keys①\">auction report buyer keys</a>:",
              "rationale": "let",
              "steps": [
                {
                  "html": "<p>Let <var>bucket</var> be the sum of <var>buyerOffset</var> and <var>reportBuyerConfig</var>’s <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-auctionreportbuyersconfig-bucket\" id=\"ref-for-dom-auctionreportbuyersconfig-bucket①\">bucket</a></code>.</p>"
                },
                {
                  "html": "Let <var>value</var> be the result (a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-double\" id=\"ref-for-idl-double②\">double</a></code>) of switching on <var>reportType</var>:",
                  "rationale": ".switch",
                  "steps": [
                    {
                      "operation": "switch",
                      "steps": [
                        {
                          "case": "\"interestGroupCount\"",
                          "html": "<p>The number of interest groups in the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#user-agent\" id=\"ref-for-user-agent⑨\">user agent</a>'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/turtledove/#interest-group-set\" id=\"ref-for-interest-group-set\">interest group set</a> whose <a data-link-type=\"dfn\" href=\"https://wicg.github.io/turtledove/#interest-group-owner\" id=\"ref-for-interest-group-owner②\">owner</a> is <var>buyerOrigin</var>.</p>"
                        },
                        {
                          "case": "\"bidCount\"",
                          "html": "<p>The number of valid bids generated by interest groups whose <a data-link-type=\"dfn\" href=\"https://wicg.github.io/turtledove/#interest-group-owner\" id=\"ref-for-interest-group-owner③\">owner</a> is <var>buyerOrigin</var>.</p>"
                        },
                        {
                          "case": "\"totalGenerateBidLatency\"",
                          "html": "<p>The sum of execution time in milliseconds for all <code>generateBid()</code> calls in the auction for interest groups whose <a data-link-type=\"dfn\" href=\"https://wicg.github.io/turtledove/#interest-group-owner\" id=\"ref-for-interest-group-owner④\">owner</a> is <var>buyerOrigin</var>.</p>"
                        },
                        {
                          "case": "\"totalSignalsFetchLatency\"",
                          "html": "<p>The total time spent fetching trusted buyer signals in\nmilliseconds, or 0 if the interest group didn’t fetch any\ntrusted signals.</p>"
                        },
                        {
                          "case": "None of the above values",
                          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert①⑦\">Assert</a>: false</p>"
                        }
                      ]
                    }
                  ]
                },
                {
                  "html": "<p>Set <var>value</var> to the result of multiplying <var>reportBuyerConfig</var>’s <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-auctionreportbuyersconfig-scale\" id=\"ref-for-dom-auctionreportbuyersconfig-scale\">scale</a></code> with <var>value</var>.</p>"
                },
                {
                  "html": "<p>Set <var>value</var> to the maximum of 0.0 and <var>value</var>.</p>"
                },
                {
                  "html": "<p>Set <var>value</var> to the result of converting <var>value</var> to an integer by\ntruncating its fractional part.</p>"
                },
                {
                  "html": "<p>Set <var>value</var> to the minimum of <var>value</var> and 2<sup>31</sup>−1.</p>"
                },
                {
                  "html": "<p>Let <var>contribution</var> be a new <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dictdef-pahistogramcontribution\" id=\"ref-for-dictdef-pahistogramcontribution⑨\">PAHistogramContribution</a></code> with the\nitems:</p>\n          <dl>\n           <dt data-md=\"\"><code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-pahistogramcontribution-bucket\" id=\"ref-for-dom-pahistogramcontribution-bucket④\">bucket</a></code>\n           </dt><dd data-md=\"\">\n            <p><var>bucket</var></p>\n           </dd><dt data-md=\"\"><code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-pahistogramcontribution-value\" id=\"ref-for-dom-pahistogramcontribution-value⑦\">value</a></code>\n           </dt><dd data-md=\"\">\n            <p><var>value</var></p>\n           </dd><dt data-md=\"\"><code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-pahistogramcontribution-filteringid\" id=\"ref-for-dom-pahistogramcontribution-filteringid⑤\">filteringId</a></code>\n           </dt><dd data-md=\"\">\n            <p>0</p>\n          </dd></dl>"
                },
                {
                  "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-iterate\" id=\"ref-for-map-iterate⑦\">For each</a> <var>ig</var> of the <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#user-agent\" id=\"ref-for-user-agent①⓪\">user agent</a>'s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/turtledove/#interest-group-set\" id=\"ref-for-interest-group-set①\"> interest group set</a> whose <a data-link-type=\"dfn\" href=\"https://wicg.github.io/turtledove/#interest-group-owner\" id=\"ref-for-interest-group-owner⑤\">owner</a> is <var>buyerOrigin</var>:",
                  "rationale": "if",
                  "steps": [
                    {
                      "html": "<p>If seller capabilities don’t allow this reporting, <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#iteration-continue\" id=\"ref-for-iteration-continue④\"> continue</a>.</p>"
                    },
                    {
                      "html": "<p>Let <var>entry</var> be a new <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#contribution-cache-entry\" id=\"ref-for-contribution-cache-entry⑤\">contribution cache entry</a> with the items:</p>\n            <dl>\n             <dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#contribution-cache-entry-contribution\" id=\"ref-for-contribution-cache-entry-contribution③\">contribution</a>\n             </dt><dd data-md=\"\">\n              <p><var>contribution</var></p>\n             </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#contribution-cache-entry-batching-scope\" id=\"ref-for-contribution-cache-entry-batching-scope④\">batching scope</a>\n             </dt><dd data-md=\"\">\n              <p><var>sellerBatchingScope</var></p>\n             </dd><dt data-md=\"\"><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#contribution-cache-entry-debug-scope\" id=\"ref-for-contribution-cache-entry-debug-scope④\">debug scope</a>\n             </dt><dd data-md=\"\">\n              <p><var>auctionReportBuyersDebugScope</var></p>\n            </dd></dl>"
                    },
                    {
                      "html": "<p><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#append-an-entry-to-the-contribution-cache\" id=\"ref-for-append-an-entry-to-the-contribution-cache②\">Append</a> <var>entry</var> to\nthe <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#contribution-cache\" id=\"ref-for-contribution-cache⑧\">contribution cache</a>.</p>"
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#mark-a-debug-scope-complete\" id=\"ref-for-mark-a-debug-scope-complete⑦\">Mark a debug scope complete</a> given <var>auctionReportBuyersDebugScope</var> and <var>auctionConfig</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#auction-config-auction-report-buyer-debug-details\" id=\"ref-for-auction-config-auction-report-buyer-debug-details②\">auction report buyer debug details</a>.</p>"
        },
        {
          "html": "<a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-iterate\" id=\"ref-for-map-iterate⑧\">For each</a> (<var>origin</var>, <var>aggregationCoordinator</var>) → <var>batchingScope</var> of <var>auctionConfig</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#auction-config-batching-scope-map\" id=\"ref-for-auction-config-batching-scope-map\">batching scope map</a>:",
          "rationale": "process",
          "steps": [
            {
              "html": "<p><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#process-contributions-for-a-batching-scope\" id=\"ref-for-process-contributions-for-a-batching-scope⑥\">Process contributions for a batching scope</a> given <var>batchingScope</var>, <var>origin</var>, \"<code>protected-audience</code>\" and null.</p>"
            }
          ]
        }
      ]
    },
    {
      "name": "get or create a batching scope",
      "href": "https://patcg-individual-drafts.github.io/private-aggregation-api/#get-or-create-a-batching-scope",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"get-or-create-a-batching-scope\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">get or create a batching scope</dfn> given an <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin\" id=\"ref-for-concept-origin①③\">origin</a> <var>origin</var>, an <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregation-coordinator\" id=\"ref-for-aggregation-coordinator①③\">aggregation coordinator</a> <var>aggregationCoordinator</var> and an <a data-link-type=\"dfn\" href=\"https://wicg.github.io/turtledove/#auction-config\" id=\"ref-for-auction-config⑦\">auction config</a> <var>auctionConfig</var>, perform the following\nsteps. They return a <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#batching-scope\" id=\"ref-for-batching-scope①⑥\">batching scope</a>.",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>batchingScopeMap</var> be <var>auctionConfig</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#auction-config-batching-scope-map\" id=\"ref-for-auction-config-batching-scope-map①\">batching scope\nmap</a>.</p>"
        },
        {
          "html": "<p>Let <var>tuple</var> be (<var>origin</var>, <var>aggregationCoordinator</var>).</p>"
        },
        {
          "html": "If <var>batchingScopeMap</var>[<var>tuple</var>] does not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists②①\">exist</a>:",
          "rationale": "set",
          "steps": [
            {
              "html": "<p>Set <var>batchingScopeMap</var>[<var>tuple</var>] to a new <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#batching-scope\" id=\"ref-for-batching-scope①⑦\">batching scope</a>.</p>"
            },
            {
              "html": "<p>If <var>aggregationCoordinator</var> is not null, <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#set-the-aggregation-coordinator-for-a-batching-scope\" id=\"ref-for-set-the-aggregation-coordinator-for-a-batching-scope②\">set the aggregation\ncoordinator for a batching scope</a> given <var>aggregationCoordinator</var> and <var>batchingScopeMap</var>[<var>tuple</var>].</p>"
            }
          ]
        },
        {
          "html": "<p>Return <var>batchingScopeMap</var>[<var>tuple</var>].</p>"
        }
      ]
    },
    {
      "name": "fill in the contribution",
      "href": "https://patcg-individual-drafts.github.io/private-aggregation-api/#fill-in-the-contribution",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"fill-in-the-contribution\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">fill in the contribution</dfn> given a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dictdef-paextendedhistogramcontribution\" id=\"ref-for-dictdef-paextendedhistogramcontribution②\">PAExtendedHistogramContribution</a></code> <var>contribution</var> and a <a data-link-type=\"dfn\" href=\"https://wicg.github.io/turtledove/#leading-bid-info\" id=\"ref-for-leading-bid-info①\">leading bid info</a> <var>leadingBidInfo</var>, perform the\nfollowing steps. They return a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dictdef-pahistogramcontribution\" id=\"ref-for-dictdef-pahistogramcontribution①⓪\">PAHistogramContribution</a></code>.",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>bucket</var> be <var>contribution</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-paextendedhistogramcontribution-bucket\" id=\"ref-for-dom-paextendedhistogramcontribution-bucket②\">bucket</a></code>\"].</p>"
        },
        {
          "html": "<p>If <var>bucket</var> is a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dictdef-pasignalvalue\" id=\"ref-for-dictdef-pasignalvalue④\">PASignalValue</a></code>, set <var>bucket</var> to the result of <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#fill-in-the-signal-value\" id=\"ref-for-fill-in-the-signal-value\">filling\nin the signal value</a> given <var>bucket</var>, 2<sup>128</sup>−1 and <var>leadingBidInfo</var>.</p>"
        },
        {
          "html": "<p>Let <var>value</var> be <var>contribution</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-paextendedhistogramcontribution-value\" id=\"ref-for-dom-paextendedhistogramcontribution-value②\">value</a></code>\"].</p>"
        },
        {
          "html": "<p>If <var>value</var> is a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dictdef-pasignalvalue\" id=\"ref-for-dictdef-pasignalvalue⑤\">PASignalValue</a></code>, set <var>value</var> to the result of <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#fill-in-the-signal-value\" id=\"ref-for-fill-in-the-signal-value①\">filling in\nthe signal value</a> given <var>value</var>, 2<sup>31</sup>−1 and <var>leadingBidInfo</var>.</p>"
        },
        {
          "html": "<p>Let <var>filledInContribution</var> be a new <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dictdef-pahistogramcontribution\" id=\"ref-for-dictdef-pahistogramcontribution①①\">PAHistogramContribution</a></code> with the\nitems:</p>\n      <dl>\n       <dt data-md=\"\"><code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-pahistogramcontribution-bucket\" id=\"ref-for-dom-pahistogramcontribution-bucket⑤\">bucket</a></code>\n       </dt><dd data-md=\"\">\n        <p><var>bucket</var></p>\n       </dd><dt data-md=\"\"><code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-pahistogramcontribution-value\" id=\"ref-for-dom-pahistogramcontribution-value⑧\">value</a></code>\n       </dt><dd data-md=\"\">\n        <p><var>value</var></p>\n       </dd><dt data-md=\"\"><code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-pahistogramcontribution-filteringid\" id=\"ref-for-dom-pahistogramcontribution-filteringid⑥\">filteringId</a></code>\n       </dt><dd data-md=\"\">\n        <p><var>contribution</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-paextendedhistogramcontribution-filteringid\" id=\"ref-for-dom-paextendedhistogramcontribution-filteringid①\">filteringId</a></code>\"]</p>\n      </dd></dl>"
        },
        {
          "html": "<p>Return <var>filledInContribution</var>.</p>"
        }
      ]
    },
    {
      "name": "fill in the signal value",
      "href": "https://patcg-individual-drafts.github.io/private-aggregation-api/#fill-in-the-signal-value",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"fill-in-the-signal-value\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">fill in the signal value</dfn> given a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dictdef-pasignalvalue\" id=\"ref-for-dictdef-pasignalvalue⑥\">PASignalValue</a></code> <var>value</var>, an\ninteger <var>maxAllowed</var> and a <a data-link-type=\"dfn\" href=\"https://wicg.github.io/turtledove/#leading-bid-info\" id=\"ref-for-leading-bid-info②\">leading bid info</a> <var>leadingBidInfo</var>, perform the following steps. They return an integer.",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert①⑧\">Assert</a>: <var>value</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-pasignalvalue-basevalue\" id=\"ref-for-dom-pasignalvalue-basevalue②\">baseValue</a></code>\"] is a valid <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#signal-base-value\" id=\"ref-for-signal-base-value②\">signal base\nvalue</a>.</p>"
        },
        {
          "html": "<p>Let <var>returnValue</var> be the result of <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#determine-a-signals-numeric-value\" id=\"ref-for-determine-a-signals-numeric-value①\">determining a signal’s numeric value</a> given <var>value</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-pasignalvalue-basevalue\" id=\"ref-for-dom-pasignalvalue-basevalue③\">baseValue</a></code>\"] and <var>leadingBidInfo</var>.</p>"
        },
        {
          "html": "<p>If <var>value</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-pasignalvalue-scale\" id=\"ref-for-dom-pasignalvalue-scale\">scale</a></code>\"] <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists②②\">exists</a>, set <var>returnValue</var> to\nthe result of multiplying <var>value</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-pasignalvalue-scale\" id=\"ref-for-dom-pasignalvalue-scale①\">scale</a></code>\"] with <var>returnValue</var>.</p>"
        },
        {
          "html": "<p>Set <var>returnValue</var> to the result of converting <var>returnValue</var> to an integer by\ntruncating its fractional part.</p>"
        },
        {
          "html": "<p>If <var>value</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-pasignalvalue-offset\" id=\"ref-for-dom-pasignalvalue-offset②\">offset</a></code>\"] <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists②③\">exists</a>, set <var>returnValue</var> to\nthe result of adding <var>returnValue</var> to <var>value</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-pasignalvalue-offset\" id=\"ref-for-dom-pasignalvalue-offset③\">offset</a></code>\"].</p>"
        },
        {
          "html": "<p>Clamp <var>returnValue</var> to <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#the-range\" id=\"ref-for-the-range①\">the range</a> 0 to <var>maxAllowed</var>,\ninclusive, and return the result.</p>"
        }
      ]
    },
    {
      "name": "determine a signal’s numeric value",
      "href": "https://patcg-individual-drafts.github.io/private-aggregation-api/#determine-a-signals-numeric-value",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"determine-a-signals-numeric-value\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">determine a signal’s numeric value</dfn> given a <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#signal-base-value\" id=\"ref-for-signal-base-value③\">signal base value</a> <var>signalBaseValue</var> and a <a data-link-type=\"dfn\" href=\"https://wicg.github.io/turtledove/#leading-bid-info\" id=\"ref-for-leading-bid-info③\">leading bid info</a> <var>leadingBidInfo</var>, perform the following steps. They return a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-double\" id=\"ref-for-idl-double③\">double</a></code>.",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "If <var>signalBaseValue</var> is \"<code><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#signal-base-value-winning-bid\" id=\"ref-for-signal-base-value-winning-bid\">winning-bid</a></code>\":",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>leadingBidInfo</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/turtledove/#leading-bid-info-leading-bid\" id=\"ref-for-leading-bid-info-leading-bid③\">leading\nbid</a> is null, return 0.</p>"
            },
            {
              "html": "<p>Otherwise, return <var>leadingBidInfo</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/turtledove/#leading-bid-info-leading-bid\" id=\"ref-for-leading-bid-info-leading-bid④\">leading bid</a>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/turtledove/#generated-bid-bid\" id=\"ref-for-generated-bid-bid\">bid</a>.</p>"
            }
          ]
        },
        {
          "html": "If <var>signalBaseValue</var> is\n\"<code><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#signal-base-value-highest-scoring-other-bid\" id=\"ref-for-signal-base-value-highest-scoring-other-bid\">highest-scoring-other-bid</a></code>\":",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>leadingBidInfo</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/turtledove/#leading-bid-info-highest-scoring-other-bid\" id=\"ref-for-leading-bid-info-highest-scoring-other-bid\">highest\nscoring other bid</a> is null, return 0.</p>"
            },
            {
              "html": "<p>Otherwise, return <var>leadingBidInfo</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/turtledove/#leading-bid-info-highest-scoring-other-bid\" id=\"ref-for-leading-bid-info-highest-scoring-other-bid①\">highest scoring other\nbid</a>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/turtledove/#generated-bid-bid\" id=\"ref-for-generated-bid-bid①\">bid</a>.</p>"
            }
          ]
        },
        {
          "html": "If <var>signalBaseValue</var> is \"<code><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#signal-base-value-script-run-time\" id=\"ref-for-signal-base-value-script-run-time\">script-run-time</a></code>\":",
          "rationale": "return",
          "steps": [
            {
              "html": "<p>Return the number of milliseconds of CPU time that the calling function\n(e.g. <code>generateBid()</code>) took to run.</p>"
            }
          ]
        },
        {
          "html": "If <var>signalBaseValue</var> is\n\"<code><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#signal-base-value-signals-fetch-time\" id=\"ref-for-signal-base-value-signals-fetch-time\">signals-fetch-time</a></code>\":\nSwitch on the associated <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#worklet-function\" id=\"ref-for-worklet-function②\">worklet function</a>:",
          "rationale": ".switch",
          "steps": [
            {
              "operation": "switch",
              "steps": [
                {
                  "case": "generate-bid",
                  "html": "<p>Return the number of milliseconds it took for the trusted bidding signals\nfetch to complete, or 0 if no fetch was made.</p>"
                },
                {
                  "case": "score-ad",
                  "html": "<p>Return the number of milliseconds it took for the trusted scoring signals\nfetch to complete or 0 if no fetch was made.</p>"
                },
                {
                  "case": "report-result",
                  "html": "<p>Return 0.</p>"
                },
                {
                  "case": "report-win",
                  "html": "<p>Return 0.</p>"
                }
              ]
            }
          ]
        },
        {
          "html": "If <var>signalBaseValue</var> is\n\"<code><a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#signal-base-value-bid-reject-reason\" id=\"ref-for-signal-base-value-bid-reject-reason\">bid-reject-reason</a></code>\":",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If the bid did not succeed purely because it didn’t meet the required <a data-link-type=\"dfn\" href=\"https://wicg.github.io/turtledove/#k-anonymity-threshold\" id=\"ref-for-k-anonymity-threshold\">k-anonymity threshold</a>, return 8.</p>"
            },
            {
              "html": "<p>Let <var>bidRejectReason</var> be \"<code>not-available</code>\".</p>"
            },
            {
              "html": "<p>If the seller provided a reject reason, set <var>bidRejectReason</var> to that\nvalue.</p>"
            },
            {
              "html": "If <var>bidRejectReason</var> is:",
              "rationale": ".switch",
              "steps": [
                {
                  "operation": "switch",
                  "steps": [
                    {
                      "case": "\"not-available\"",
                      "html": "<p>Return 0.</p>"
                    },
                    {
                      "case": "\"invalid-bid\"",
                      "html": "<p>Return 1.</p>"
                    },
                    {
                      "case": "\"bid-below-auction-floor\"",
                      "html": "<p>Return 2.</p>"
                    },
                    {
                      "case": "\"pending-approval-by-exchange\"",
                      "html": "<p>Return 3.</p>"
                    },
                    {
                      "case": "\"disapproved-by-exchange\"",
                      "html": "<p>Return 4.</p>"
                    },
                    {
                      "case": "\"blocked-by-publisher\"",
                      "html": "<p>Return 5.</p>"
                    },
                    {
                      "case": "\"language-exclusions\"",
                      "html": "<p>Return 6.</p>"
                    },
                    {
                      "case": "\"category-exclusions\"",
                      "html": "<p>Return 7.</p>"
                    },
                    {
                      "case": "None of the above values",
                      "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert①⑨\">Assert</a>: false</p>"
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "maybe obtain an interest group",
      "href": "https://patcg-individual-drafts.github.io/private-aggregation-api/#maybe-obtain-an-interest-group",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"maybe-obtain-an-interest-group\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">maybe obtain an interest group</dfn> given an <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/turtledove/#interestgroupscriptrunnerglobalscope\" id=\"ref-for-interestgroupscriptrunnerglobalscope③\">InterestGroupScriptRunnerGlobalScope</a></code> <var>global</var>, perform the following steps.\nThey return an <a data-link-type=\"dfn\" href=\"https://www.w3.org/Consortium/Process/#GroupsIG\" id=\"ref-for-GroupsIG④\">interest group</a> or null:",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "Switch on <var>global</var>’s type:",
          "rationale": ".switch",
          "steps": [
            {
              "operation": "switch",
              "steps": [
                {
                  "case": "InterestGroupBiddingScriptRunnerGlobalScope",
                  "html": "<p>Return <var>global</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/turtledove/#interestgroupbiddingscriptrunnerglobalscope-interest-group\" id=\"ref-for-interestgroupbiddingscriptrunnerglobalscope-interest-group①\">interest group</a>.</p>"
                },
                {
                  "case": "InterestGroupScoringScriptRunnerGlobalScope",
                  "html": "<p>Return null.</p>"
                },
                {
                  "case": "InterestGroupReportingScriptRunnerGlobalScope",
                  "html": "<p>Return <var>global</var>’s <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#interestgroupreportingscriptrunnerglobalscope-interest-group\" id=\"ref-for-interestgroupreportingscriptrunnerglobalscope-interest-group①\">interest\ngroup</a>.</p>"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "obtain the Private Aggregation coordinator",
      "href": "https://patcg-individual-drafts.github.io/private-aggregation-api/#obtain-the-private-aggregation-coordinator",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"obtain-the-private-aggregation-coordinator\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">obtain the Private Aggregation coordinator</dfn> given a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dictdef-protectedaudienceprivateaggregationconfig\" id=\"ref-for-dictdef-protectedaudienceprivateaggregationconfig②\">ProtectedAudiencePrivateAggregationConfig</a></code> <var>config</var>, perform the following\nsteps. They return an <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregation-coordinator\" id=\"ref-for-aggregation-coordinator①④\">aggregation coordinator</a>, null or a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException①⑦\">DOMException</a></code>.",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>If <var>config</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-protectedaudienceprivateaggregationconfig-aggregationcoordinatororigin\" id=\"ref-for-dom-protectedaudienceprivateaggregationconfig-aggregationcoordinatororigin\">aggregationCoordinatorOrigin</a></code>\"]\ndoes not <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists②④\">exist</a>, return null.</p>"
        },
        {
          "html": "<p>Return the result of <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#obtain-the-private-aggregation-coordinator-from-a-string\" id=\"ref-for-obtain-the-private-aggregation-coordinator-from-a-string①\">obtaining the Private Aggregation coordinator</a> given <var>config</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#dom-protectedaudienceprivateaggregationconfig-aggregationcoordinatororigin\" id=\"ref-for-dom-protectedaudienceprivateaggregationconfig-aggregationcoordinatororigin①\">aggregationCoordinatorOrigin</a></code>\"].</p>"
        }
      ]
    },
    {
      "name": "obtain the Private Aggregation coordinator from a string",
      "href": "https://patcg-individual-drafts.github.io/private-aggregation-api/#obtain-the-private-aggregation-coordinator-from-a-string",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-lt=\"obtain the Private Aggregation coordinator from a string\" data-noexport=\"\" id=\"obtain-the-private-aggregation-coordinator-from-a-string\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">obtain the\nPrivate Aggregation coordinator</dfn> given a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-USVString\" id=\"ref-for-idl-USVString③\">USVString</a></code> <var>originString</var>,\nperform the following steps. They return an <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#aggregation-coordinator\" id=\"ref-for-aggregation-coordinator①⑤\">aggregation coordinator</a> or a <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException①⑧\">DOMException</a></code>.",
      "rationale": ".algorithm",
      "steps": [
        {
          "html": "<p>Let <var>url</var> be the result of running the <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-parser\" id=\"ref-for-concept-url-parser③\">URL parser</a> on <var>originString</var>.</p>"
        },
        {
          "html": "<p>If <var>url</var> is failure or null, return a new <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException①⑨\">DOMException</a></code> with name\n\"<code>SyntaxError</code>\".</p>"
        },
        {
          "html": "<p>Let <var>origin</var> be <var>url</var>’s <a data-link-type=\"dfn\" href=\"https://url.spec.whatwg.org/#concept-url-origin\" id=\"ref-for-concept-url-origin①\">origin</a>.</p>"
        },
        {
          "html": "<p>If the result of <a data-link-type=\"dfn\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#determine-if-an-origin-is-an-aggregation-coordinator\" id=\"ref-for-determine-if-an-origin-is-an-aggregation-coordinator①\">determining if an origin is an aggregation coordinator</a> given <var>origin</var> is false, return a new <code class=\"idl\"><a data-link-type=\"idl\" href=\"https://webidl.spec.whatwg.org/#idl-DOMException\" id=\"ref-for-idl-DOMException②⓪\">DOMException</a></code> with name\n\"<code>DataError</code>\".</p>"
        },
        {
          "html": "<p>Return <var>origin</var>.</p>"
        }
      ]
    },
    {
      "html": "Possible mitigations include:",
      "rationale": "send",
      "steps": [
        {
          "html": "<p>Only sending reports with a given reporting origin when the browser has\nalready made a request to that origin on the same network: This prevents the\nnetwork administrator from gaining additional information from the Private\nAggregation API. However, it increases report loss and report delays, which\nreduces the utility of the API for the reporting origin. It might also\nincrease the effectiveness of timing attacks, as the origin may be able to\nbetter link the report with the user’s request that allowed the report to be\nreleased.</p>"
        },
        {
          "html": "<p>Send reports immediately: This reduces the likelihood of a report being\nstored and sent on different networks. However, it increases the likelihood\nthat the reporting origin can correlate the original API invocation to the\nreport being sent, which weakens the privacy controls of the API, see <a href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#protecting-against-leaks-via-the-number-of-reports\">Protecting against leaks via the number of\nreports</a>.</p>"
        },
        {
          "html": "<p>Use a trusted proxy server to send reports: This effectively moves the\nreporting origin into the report body, so only the proxy server would be\nvisible to the network administrator.</p>"
        },
        {
          "html": "<p>Require <a data-link-type=\"biblio\" href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#biblio-rfc8484\" title=\"DNS Queries over HTTPS (DoH)\">DNS over HTTPS</a>: This effectively hides the reporting\norigin from the network administrator, but is likely impractical to enforce\nand is itself perhaps circumventable by the network administrator, e.g. by\nmonitoring IP addresses instead.</p>"
        }
      ]
    },
    {
      "html": "Possible mitigations include:",
      "rationale": "send",
      "steps": [
        {
          "html": "<p>Send reports immediately: This effectively eliminates the presence tracking,\nas the original request made to the reporting origin is in close temporal\nproximity to the report request. However, it increases the likelihood that\nthe reporting origin can correlate the original API invocation to the report\nbeing sent, which weakens the privacy controls of the API, see <a href=\"https://patcg-individual-drafts.github.io/private-aggregation-api/#protecting-against-leaks-via-the-number-of-reports\">Protecting\nagainst leaks via the number of\nreports</a>.</p>"
        },
        {
          "html": "<p>Send reports immediately to a trusted proxy server, which would itself apply\nadditional delay: This would effectively hide both the user’s IP address and\ntheir online-offline presence from the reporting origin.</p>"
        }
      ]
    }
  ]
}